<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionnaire de Rapaces</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'><circle cx='100' cy='100' r='95' fill='white' stroke='%23333' stroke-width='10'/><g transform='translate(100,100) scale(0.8)'><path d='M-60,-20 Q-40,-60 0,-40 Q40,-60 60,-20 Q50,-40 20,-30 Q10,-50 0,-35 Q-10,-50 -20,-30 Q-50,-40 -60,-20' fill='%23333'/><circle cx='-25' cy='-25' r='5' fill='%23333'/><path d='M-10,-10 Q0,0 10,-10 Q15,-5 5,-5 Q-5,-5 -10,-10' fill='%23333'/><path d='M-40,10 Q-20,20 0,10 Q20,20 40,10 Q30,30 0,25 Q-30,30 -40,10' fill='%23333'/><path d='M-30,-10 Q-20,0 -10,-10 M10,-10 Q20,0 30,-10' stroke='%23333' stroke-width='2' fill='none'/><path d='M-70,-30 Q-50,-10 -30,-20 M30,-20 Q50,-10 70,-30' stroke='%23333' stroke-width='3' fill='none'/><path d='M-60,20 Q-40,40 -20,30 M20,30 Q40,40 60,20' stroke='%23333' stroke-width='3' fill='none'/><circle cx='45' cy='45' r='2' fill='%23333'/><circle cx='-35' cy='55' r='1.5' fill='%23333'/><rect x='-15' y='35' width='4' height='2' fill='%23333'/></g></svg>" type="image/svg+xml">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
            z-index: 1;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            text-align: center;
            padding: 30px 20px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .weather-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            margin-top: 15px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            min-width: 100px;
            padding: 15px 10px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            color: #2a5298;
            border-bottom-color: #2a5298;
            background: white;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            align-items: end;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2a5298;
        }

        button {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button.btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        button.btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #545b62 100%);
        }

        button.btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #212529;
        }

        button.btn-success {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
        }

        .entry-item {
            background: #f0f4f8;
            margin: 15px 0;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #2a5298;
            position: relative;
        }

        .entry-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }

        .entry-actions button {
            padding: 4px 8px;
            font-size: 12px;
            min-width: auto;
        }

        .entry-item .date {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .entry-item .content {
            color: #333;
        }

        .rapace-card {
            background: #f0f4f8;
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
            border: 2px solid #e3f2fd;
            position: relative;
        }

        .rapace-card h3 {
            color: #1e3c72;
            margin-bottom: 10px;
        }

        .rapace-actions {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
        }

        .rapace-actions button {
            padding: 8px 12px;
            font-size: 12px;
        }

        .weather-info {
            color: #e3f2fd;
            font-size: 14px;
        }

        .conditional-fields {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #f0f4f8;
            border-radius: 8px;
        }

        .conditional-fields.active {
            display: block;
        }

        .rating-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .rating-group input[type="radio"] {
            width: auto;
        }

        .hunt-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .hunt-item {
            background: #f0f4f8;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #e3f2fd;
        }

        .checkbox-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
        }

        .day-card {
            background: #f0f4f8;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #2a5298;
        }

        .day-card h4 {
            color: #1e3c72;
            margin-bottom: 10px;
        }

        .day-navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-card h3 {
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .photo-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            margin: 10px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .rapace-photo {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 10px;
            border: 2px solid #e3f2fd;
            margin-right: 15px;
            float: left;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: inline-block;
            padding: 12px 24px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .file-input-label:hover {
            transform: translateY(-2px);
        }

        .session-status {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 10px;
        }

        .session-fin {
            background: #dc3545;
            color: white;
        }

        .session-reprise {
            background: #28a745;
            color: white;
        }

        .session-jour {
            background: #6f42c1;
            color: white;
            font-size: 0.9em;
        }

        .session-history-card {
            background: #f8f9fa;
            border-left: 4px solid #6f42c1;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
        }

        .session-active {
            background: #e8f5e8;
            border-left-color: #28a745;
        }

        .session-terminated {
            background: #f8f9fa;
            border-left-color: #6c757d;
        }

        .affaitage-photo {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 10px;
            border: 2px solid #e3f2fd;
            margin: 10px 15px 10px 0;
            float: left;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            cursor: pointer;
            position: relative;
        }

        .photo-container {
            position: relative;
            display: inline-block;
            float: left;
        }

        .photo-delete-btn {
            position: absolute;
            top: -5px;
            right: 10px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .photo-delete-btn:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        .chasse-photo {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 10px;
            border: 2px solid #e3f2fd;
            margin: 10px 15px 10px 0;
            float: left;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            cursor: pointer;
        }

        .chasse-content {
            margin-left: 0;
        }

        .chasse-content::after {
            content: "";
            display: table;
            clear: both;
        }

        .affaitage-content {
            margin-left: 0;
        }

        .affaitage-content::after {
            content: "";
            display: table;
            clear: both;
        }

        /* Styles pour l'onglet Documents */
        .document-card {
            background: #f0f4f8;
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
            border: 2px solid #e3f2fd;
            position: relative;
        }

        .document-actions {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
        }

        .document-preview {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 10px;
            border: 2px solid #e3f2fd;
            margin-right: 15px;
            float: left;
        }

        .document-icon {
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #e3f2fd;
            border-radius: 10px;
            margin-right: 15px;
            float: left;
            font-size: 30px;
        }

        .category-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .category-btn {
            padding: 8px 16px;
            border: 2px solid #2a5298;
            background: white;
            color: #2a5298;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .category-btn.active {
            background: #2a5298;
            color: white;
        }

        /* Styles pour l'onglet Leurre */
        .leurre-card {
            background: #f0f4f8;
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
            border: 2px solid #e3f2fd;
            position: relative;
        }

        .leurre-actions {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
        }

        .leurre-photo {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 10px;
            border: 2px solid #e3f2fd;
            margin-right: 15px;
            float: left;
        }

        .efficacite-bar {
            background: #e9ecef;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .efficacite-fill {
            height: 100%;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            transition: width 0.3s ease;
        }

        .session-leurre {
            background: #e8f5e8;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
            <svg width="80" height="80" viewBox="0 0 200 200" style="filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));">
                <circle cx="100" cy="100" r="95" fill="white" stroke="#1e3c72" stroke-width="8"/>
                <g transform="translate(100,100) scale(0.7)">
                    <path d="M-70,-30 Q-50,-70 0,-50 Q50,-70 70,-30 Q60,-50 30,-40 Q15,-65 0,-45 Q-15,-65 -30,-40 Q-60,-50 -70,-30" fill="#1e3c72"/>
                    <circle cx="-30" cy="-30" r="8" fill="white"/>
                    <circle cx="-28" cy="-32" r="5" fill="#1e3c72"/>
                    <circle cx="-26" cy="-34" r="2" fill="white"/>
                    <path d="M-15,-15 Q5,5 15,-15 Q20,-10 10,-8 Q-10,-8 -15,-15" fill="#2a5298"/>
                    <path d="M-50,15 Q-30,30 0,15 Q30,30 50,15 Q40,40 0,35 Q-40,40 -50,15" fill="#1e3c72"/>
                </g>
            </svg>
            <div>
                <h1>ü¶Ö Gestionnaire de Rapaces</h1>
                <p>Suivi quotidien de vos compagnons ail√©s</p>
            </div>
        </div>
        <div class="weather-controls">
            <p id="weather-info" class="weather-info">üå¶Ô∏è Chargement m√©t√©o...</p>
            <button onclick="refreshWeather()" style="padding: 8px 16px; font-size: 12px;">üîÑ</button>
            <button onclick="changeLocation()" style="padding: 8px 16px; font-size: 12px;">üìç</button>
        </div>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="showTab('gestion')">Gestion</button>
        <button class="tab" onclick="showTab('suivi')">Suivi</button>
        <button class="tab" onclick="showTab('chasse')">Chasse</button>
        <button class="tab" onclick="showTab('affaitage')">Affaitage</button>
        <button class="tab" onclick="showTab('leurre')">üéØ Leurre</button>
        <button class="tab" onclick="showTab('documents')">üìÅ Documents</button>
        <button class="tab" onclick="showTab('sync')">Sync</button>
        <button class="tab" onclick="showTab('stats')">Stats</button>
    </div>

    <!-- Onglet Gestion -->
    <div id="gestion" class="tab-content active">
        <h2>Ajouter un Rapace</h2>
        <div class="form-group">
            <label for="rapace-name">Nom du rapace :</label>
            <input type="text" id="rapace-name" placeholder="Ex: Aigle royal">
        </div>
        <div class="form-group">
            <label for="rapace-species">Esp√®ce :</label>
            <input type="text" id="rapace-species" placeholder="Ex: Aquila chrysaetos">
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="rapace-bague">Num√©ro de bague :</label>
                <input type="text" id="rapace-bague" placeholder="Ex: AB123456">
            </div>
            <div class="form-group">
                <label for="rapace-birthdate">Date de naissance :</label>
                <input type="date" id="rapace-birthdate">
            </div>
            <div class="form-group">
                <label for="rapace-sex">Sexe :</label>
                <select id="rapace-sex">
                    <option value="forme">Forme</option>
                    <option value="tiercelet">Tiercelet</option>
                </select>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="rapace-poids-plein">Poids plein (g) :</label>
                <input type="number" id="rapace-poids-plein" min="0" placeholder="Ex: 1200">
            </div>
            <div class="form-group">
                <label for="rapace-poids-vol">Poids vol (g) :</label>
                <input type="number" id="rapace-poids-vol" min="0" placeholder="Ex: 1100">
            </div>
            <div class="form-group">
                <label for="rapace-poids-chasse">Poids chasse (g) :</label>
                <input type="number" id="rapace-poids-chasse" min="0" placeholder="Ex: 1000">
            </div>
        </div>
        <div class="form-group">
            <label for="rapace-photo">Photo du rapace :</label>
            <div class="file-input-wrapper">
                <input type="file" id="rapace-photo" accept="image/*" onchange="previewRapacePhoto(this)">
                <label for="rapace-photo" class="file-input-label">üì∑ Choisir une photo</label>
            </div>
            <div id="photo-preview-container"></div>
        </div>
        <button onclick="addRapace()">Ajouter le Rapace</button>

        <h2 style="margin-top: 40px;">Mes Rapaces</h2>
        <div id="rapace-list"></div>
    </div>

    <!-- Onglet Suivi -->
    <div id="suivi" class="tab-content">
        <h2>Suivi Quotidien</h2>
        <div class="form-group">
            <label for="rapace-select">S√©lectionner un rapace :</label>
            <select id="rapace-select" onchange="updateEntryList()">
                <option value="">Choisir un rapace</option>
            </select>
        </div>
        <div class="form-group">
            <label for="event-type">Type d'√©v√©nement :</label>
            <select id="event-type" onchange="showEventFields()">
                <option value="nourriture">Nourriture</option>
                <option value="vol">Vol</option>
                <option value="comportement">Comportement</option>
                <option value="sante">Sant√©</option>
                <option value="entrainement">Entra√Ænement</option>
            </select>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="event-date">Date :</label>
                <input type="date" id="event-date">
            </div>
            <div class="form-group">
                <label for="event-time">Heure :</label>
                <input type="time" id="event-time">
            </div>
        </div>
        
        <div class="form-group">
            <label for="event-notes">Notes :</label>
            <textarea id="event-notes" rows="3" placeholder="Observations..."></textarea>
        </div>

        <div id="nourriture-fields" class="conditional-fields active">
            <div class="form-row">
                <div class="form-group">
                    <label for="poids-avant">Poids avant (g) :</label>
                    <input type="number" id="poids-avant" min="0" onchange="calculateWeightDifference()">
                </div>
                <div class="form-group">
                    <label for="poids-apres">Poids apr√®s (g) :</label>
                    <input type="number" id="poids-apres" min="0" onchange="calculateWeightDifference()">
                </div>
                <div class="form-group">
                    <label for="difference-poids">Diff√©rence (g) :</label>
                    <input type="text" id="difference-poids" readonly style="background: #f8f9fa; color: #666;">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="detail-nourriture">Menu :</label>
                    <select id="detail-nourriture">
                        <option value="poussin">Poussin</option>
                        <option value="caille">Caille</option>
                        <option value="pigeon">Pigeon</option>
                        <option value="lapin">Lapin</option>
                        <option value="lievre">Li√®vre</option>
                        <option value="canard">Canard</option>
                        <option value="faisan">Faisan</option>
                        <option value="perdrix">Perdrix</option>
                        <option value="boeuf">B≈ìuf</option>
                        <option value="autre">Autre</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="quantite-nourriture">Quantit√© :</label>
                    <input type="text" id="quantite-nourriture" placeholder="Ex: 200g">
                </div>
            </div>
        </div>

        <div id="vol-fields" class="conditional-fields">
            <div class="form-group">
                <label for="type-vol">Type de vol :</label>
                <select id="type-vol">
                    <option value="suite">Suit√©</option>
                    <option value="chasse">Chasse</option>
                    <option value="entrainement">Entra√Ænement</option>
                </select>
            </div>
        </div>

        <div id="comportement-fields" class="conditional-fields">
            <div class="form-group">
                <label>R√©activit√© (1-5) :</label>
                <div class="rating-group">
                    <input type="radio" id="react1" name="reactivite" value="1">
                    <label for="react1">1</label>
                    <input type="radio" id="react2" name="reactivite" value="2">
                    <label for="react2">2</label>
                    <input type="radio" id="react3" name="reactivite" value="3">
                    <label for="react3">3</label>
                    <input type="radio" id="react4" name="reactivite" value="4">
                    <label for="react4">4</label>
                    <input type="radio" id="react5" name="reactivite" value="5">
                    <label for="react5">5</label>
                </div>
            </div>
        </div>

        <div id="sante-fields" class="conditional-fields">
            <div class="form-group">
                <label for="etat-sante">√âtat :</label>
                <select id="etat-sante">
                    <option value="ras">RAS</option>
                    <option value="pb">PB</option>
                </select>
            </div>
        </div>

        <div id="entrainement-fields" class="conditional-fields">
            <div class="form-group">
                <label for="type-entrainement">Type d'entra√Ænement :</label>
                <select id="type-entrainement">
                    <option value="filiere">Fili√®re</option>
                    <option value="charriot">Charriot + leurre</option>
                    <option value="rc-voiture">RC Voiture + leurre</option>
                    <option value="drone">Drone + leurre</option>
                    <option value="leurre">Leurre</option>
                    <option value="vivant">Vivant</option>
                    <option value="corde">Corde</option>
                    <option value="ascendant">Ascendant</option>
                </select>
            </div>
        </div>

        <button onclick="addEntry()">Ajouter l'Entr√©e</button>

        <h2 style="margin-top: 40px;">Historique R√©cent</h2>
        <div id="entry-list"></div>
    </div>

    <!-- Onglet Chasse -->
    <div id="chasse" class="tab-content">
        <h2>Registre de Chasse</h2>
        <div class="form-group">
            <label for="chasse-rapace">Rapace :</label>
            <select id="chasse-rapace" onchange="updatePoidsChaseReference()">
                <option value="">Choisir un rapace</option>
            </select>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="chasse-date">Date :</label>
                <input type="date" id="chasse-date">
            </div>
            <div class="form-group">
                <label for="chasse-time">Heure :</label>
                <input type="time" id="chasse-time">
            </div>
        </div>
        
        <div class="hunt-grid">
            <div class="hunt-item">
                <label for="chasse-faisan">Faisan :</label>
                <input type="number" id="chasse-faisan" min="0" max="10" value="0">
            </div>
            <div class="hunt-item">
                <label for="chasse-perdrix">Perdrix :</label>
                <input type="number" id="chasse-perdrix" min="0" max="10" value="0">
            </div>
            <div class="hunt-item">
                <label for="chasse-lapin">Lapin :</label>
                <input type="number" id="chasse-lapin" min="0" max="10" value="0">
            </div>
            <div class="hunt-item">
                <label for="chasse-lievre">Li√®vre :</label>
                <input type="number" id="chasse-lievre" min="0" max="10" value="0">
            </div>
            <div class="hunt-item">
                <label for="chasse-canard">Canard :</label>
                <input type="number" id="chasse-canard" min="0" max="10" value="0">
            </div>
            <div class="hunt-item">
                <label for="chasse-oie">Oie :</label>
                <input type="number" id="chasse-oie" min="0" max="10" value="0">
            </div>
            <div class="hunt-item">
                <label for="chasse-autre">Autre :</label>
                <input type="number" id="chasse-autre" min="0" max="10" value="0">
            </div>
        </div>
        
        <div class="form-row" style="margin-top: 20px;">
            <div class="form-group">
                <label for="chasse-poids-jour">Poids du jour (g) :</label>
                <input type="number" id="chasse-poids-jour" min="0" placeholder="Poids avant la chasse">
            </div>
            <div class="form-group" id="poids-chasse-reference" style="padding: 12px; background: #f8f9fa; border-radius: 8px; display: flex; align-items: center;">
                <span style="color: #666;">S√©lectionnez un rapace pour voir son poids de chasse</span>
            </div>
        </div>
        
        <div class="form-group">
            <label for="chasse-notes">Notes :</label>
            <textarea id="chasse-notes" rows="3" placeholder="Observations sur la chasse..."></textarea>
        </div>
        
        <div class="form-group">
            <label for="chasse-photo">üì∑ Photo de la chasse :</label>
            <div class="file-input-wrapper">
                <input type="file" id="chasse-photo" accept="image/*" onchange="previewChassePhoto(this)">
                <label for="chasse-photo" class="file-input-label">üì∑ Prendre/Choisir une photo</label>
            </div>
            <div id="chasse-photo-preview"></div>
        </div>
        
        <button onclick="addChasse()">Enregistrer la Chasse</button>
        
        <h2 style="margin-top: 40px;">Historique des Chasses</h2>
        <div id="chasse-list"></div>
    </div>

    <!-- Onglet Affaitage -->
    <div id="affaitage" class="tab-content">
        <h2>Affaitage</h2>
        <div class="form-group">
            <label for="affaitage-rapace">Rapace :</label>
            <select id="affaitage-rapace">
                <option value="">Choisir un rapace</option>
            </select>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="affaitage-date">Date :</label>
                <input type="date" id="affaitage-date">
            </div>
            <div class="form-group">
                <label for="affaitage-time">Heure :</label>
                <input type="time" id="affaitage-time">
            </div>
        </div>
        
        <div class="form-group">
            <label for="affaitage-poids">Poids (g) :</label>
            <input type="number" id="affaitage-poids" min="0" placeholder="Ex: 1050">
        </div>
        
        <div class="form-group">
            <label>Activit√©s :</label>
            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="voliere">
                    <label for="voliere">üè† Voli√®re</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="prise-nourriture">
                    <label for="prise-nourriture">üçΩÔ∏è Prise de nourriture</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="gant">
                    <label for="gant">üß§ Gant</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="filiere">
                    <label for="filiere">üéØ Fili√®re</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="bloc">
                    <label for="bloc">üß± Bloc</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="libre">
                    <label for="libre">üïäÔ∏è Libre</label>
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label>Gestion de session :</label>
            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="fin-affaitage">
                    <label for="fin-affaitage">üîö Fin d'affaitage</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="reprise-affaitage">
                    <label for="reprise-affaitage">üîÑ Reprise affaitage</label>
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label for="affaitage-notes">Notes :</label>
            <textarea id="affaitage-notes" rows="3" placeholder="Observations sur l'affaitage..."></textarea>
        </div>
        
        <div class="form-group">
            <label for="affaitage-evenement">üåü √âv√©nement marquant (optionnel) :</label>
            <textarea id="affaitage-evenement" rows="2" placeholder="Ex: Premier vol libre r√©ussi, Refus de prendre la nourriture, Agressivit√© inhabituelle..."></textarea>
        </div>
        
        <div class="form-group">
            <label for="affaitage-photo">üì∑ Photo de la session :</label>
            <div class="file-input-wrapper">
                <input type="file" id="affaitage-photo" accept="image/*" onchange="previewAffaitagePhoto(this)">
                <label for="affaitage-photo" class="file-input-label">üì∑ Prendre/Choisir une photo</label>
            </div>
            <div id="affaitage-photo-preview"></div>
        </div>
        
        <button onclick="addAffaitage()">Enregistrer l'Affaitage</button>
        
        <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 40px;">
            <h2>Historique d'Affaitage</h2>
            <button onclick="showEvenementsMarquants()" class="btn-warning">üåü √âv√©nements marquants</button>
        </div>
        <div id="affaitage-list"></div>
    </div>

    <!-- NOUVEL ONGLET LEURRE -->
    <div id="leurre" class="tab-content">
        <h2>üéØ Gestion des Leurres</h2>
        
        <!-- Ajouter un nouveau leurre -->
        <div class="day-card">
            <h3>Ajouter un Leurre</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="leurre-nom">Nom du leurre :</label>
                    <input type="text" id="leurre-nom" placeholder="Ex: Leurre plume rouge">
                </div>
                <div class="form-group">
                    <label for="leurre-type">Type :</label>
                    <select id="leurre-type">
                        <option value="plume">Plume</option>
                        <option value="fourrure">Fourrure</option>
                        <option value="mixte">Mixte</option>
                        <option value="proie-artificielle">Proie artificielle</option>
                        <option value="drone">Drone + leurre</option>
                        <option value="autre">Autre</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="leurre-couleur">Couleur principale :</label>
                    <input type="text" id="leurre-couleur" placeholder="Ex: Rouge, Brun, Blanc...">
                </div>
                <div class="form-group">
                    <label for="leurre-taille">Taille (cm) :</label>
                    <input type="number" id="leurre-taille" min="1" placeholder="Ex: 25">
                </div>
                <div class="form-group">
                    <label for="leurre-poids-g">Poids (g) :</label>
                    <input type="number" id="leurre-poids-g" min="1" placeholder="Ex: 150">
                </div>
            </div>
            
            <div class="form-group">
                <label for="leurre-description">Description :</label>
                <textarea id="leurre-description" rows="2" placeholder="Description d√©taill√©e du leurre..."></textarea>
            </div>
            
            <div class="form-group">
                <label for="leurre-photo">üì∑ Photo du leurre :</label>
                <div class="file-input-wrapper">
                    <input type="file" id="leurre-photo" accept="image/*" onchange="previewLeurrePhoto(this)">
                    <label for="leurre-photo" class="file-input-label">üì∑ Prendre/Choisir une photo</label>
                </div>
                <div id="leurre-photo-preview"></div>
            </div>
            
            <button onclick="addLeurre()">Cr√©er le Leurre</button>
        </div>

        <!-- Session d'utilisation -->
        <div class="day-card">
            <h3>üìù Enregistrer une Session de Leurre</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="session-leurre">Leurre utilis√© :</label>
                    <select id="session-leurre">
                        <option value="">Choisir un leurre</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="session-rapace">Rapace :</label>
                    <select id="session-rapace">
                        <option value="">Choisir un rapace</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="session-date">Date :</label>
                    <input type="date" id="session-date">
                </div>
                <div class="form-group">
                    <label for="session-time">Heure :</label>
                    <input type="time" id="session-time">
                </div>
                <div class="form-group">
                    <label for="session-duree">Dur√©e (min) :</label>
                    <input type="number" id="session-duree" min="1" placeholder="Ex: 30">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="session-reussite">R√©ussite :</label>
                    <select id="session-reussite">
                        <option value="excellente">Excellente - Rapace tr√®s r√©actif</option>
                        <option value="bonne">Bonne - Rapace r√©actif</option>
                        <option value="moyenne">Moyenne - Quelques h√©sitations</option>
                        <option value="difficile">Difficile - Peu d'int√©r√™t</option>
                        <option value="echec">√âchec - Aucun int√©r√™t</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="session-nb-passes">Nombre de passes :</label>
                    <input type="number" id="session-nb-passes" min="0" placeholder="Ex: 15">
                </div>
            </div>
            
            <div class="form-group">
                <label>Conditions :</label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="session-vent-fort">
                        <label for="session-vent-fort">üí® Vent fort</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="session-pluie">
                        <label for="session-pluie">üåßÔ∏è Pluie</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="session-premiere-fois">
                        <label for="session-premiere-fois">üÜï Premi√®re utilisation</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="session-rapace-affame">
                        <label for="session-rapace-affame">üçñ Rapace affam√©</label>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="session-notes">Notes de session :</label>
                <textarea id="session-notes" rows="3" placeholder="Observations, comportement du rapace, am√©lioration √† apporter..."></textarea>
            </div>
            
            <button onclick="addSessionLeurre()">Enregistrer la Session</button>
        </div>

        <!-- Liste des leurres -->
        <h2 style="margin-top: 40px;">üéØ Mes Leurres</h2>
        <div id="leurre-list"></div>
        
        <!-- Historique des sessions -->
        <h2 style="margin-top: 40px;">üìä Historique des Sessions</h2>
        <div id="sessions-leurre-list"></div>
    </div>

    <!-- NOUVEL ONGLET DOCUMENTS -->
    <div id="documents" class="tab-content">
        <h2>üìÅ Gestion des Documents</h2>
        
        <!-- Ajouter un document -->
        <div class="day-card">
            <h3>üìé Ajouter un Document</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="doc-nom">Nom du document :</label>
                    <input type="text" id="doc-nom" placeholder="Ex: Certificat v√©t√©rinaire">
                </div>
                <div class="form-group">
                    <label for="doc-categorie">Cat√©gorie :</label>
                    <select id="doc-categorie">
                        <option value="sante">üè• Sant√©</option>
                        <option value="legal">‚öñÔ∏è L√©gal/Administratif</option>
                        <option value="formation">üéì Formation</option>
                        <option value="equipement">üîß √âquipement</option>
                        <option value="chasse">üèπ Chasse</option>
                        <option value="elevage">ü•ö √âlevage</option>
                        <option value="autre">üìã Autre</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="doc-rapace">Rapace concern√© (optionnel) :</label>
                    <select id="doc-rapace">
                        <option value="">G√©n√©ral/Tous les rapaces</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="doc-date">Date du document :</label>
                    <input type="date" id="doc-date">
                </div>
            </div>
            
            <div class="form-group">
                <label for="doc-description">Description :</label>
                <textarea id="doc-description" rows="2" placeholder="Description ou r√©sum√© du document..."></textarea>
            </div>
            
            <div class="form-group">
                <label for="doc-file">üìÅ Fichier :</label>
                <div class="file-input-wrapper">
                    <input type="file" id="doc-file" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif,.txt" onchange="previewDocument(this)">
                    <label for="doc-file" class="file-input-label">üìÅ Choisir un fichier</label>
                </div>
                <div id="doc-file-preview"></div>
                <small style="color: #666;">Formats support√©s: PDF, Word, Images, Texte</small>
            </div>
            
            <button onclick="addDocument()">Ajouter le Document</button>
        </div>

        <!-- Filtres par cat√©gorie -->
        <div style="margin: 30px 0;">
            <h3>üè∑Ô∏è Filtrer par cat√©gorie</h3>
            <div class="category-filter">
                <button class="category-btn active" onclick="filterDocuments('all')">Tous</button>
                <button class="category-btn" onclick="filterDocuments('sante')">üè• Sant√©</button>
                <button class="category-btn" onclick="filterDocuments('legal')">‚öñÔ∏è L√©gal</button>
                <button class="category-btn" onclick="filterDocuments('formation')">üéì Formation</button>
                <button class="category-btn" onclick="filterDocuments('equipement')">üîß √âquipement</button>
                <button class="category-btn" onclick="filterDocuments('chasse')">üèπ Chasse</button>
                <button class="category-btn" onclick="filterDocuments('elevage')">ü•ö √âlevage</button>
                <button class="category-btn" onclick="filterDocuments('autre')">üìã Autre</button>
            </div>
        </div>

        <!-- Liste des documents -->
        <h2>üìã Mes Documents</h2>
        <div id="documents-list"></div>
    </div>

    <!-- Onglet Sync -->
    <div id="sync" class="tab-content">
        <h2>üî• Synchronisation Firebase</h2>
        
        <div class="day-card">
            <h4 id="sync-status">üìä √âtat de la synchronisation</h4>
            <p id="sync-details">üîÑ Non configur√©</p>
            <p id="last-sync-time">Derni√®re sync : Jamais</p>
        </div>

        <div style="margin: 20px 0;">
            <h3>üîß Configuration</h3>
            <div style="display: flex; gap: 10px; margin: 15px 0; flex-wrap: wrap;">
                <button onclick="initFirebaseSync()" id="connect-drive-btn">üîó Activer Firebase</button>
                <button onclick="manualFirebaseSync()" id="manual-sync-btn" style="display: none;">‚ö° Synchroniser maintenant</button>
                <button onclick="forceUploadToFirebase()" id="force-upload-btn" style="display: none;" class="btn-warning">üöÄ Forcer upload local ‚Üí Firebase</button>
                <button onclick="forceDownloadFromFirebase()" id="force-download-btn" style="display: none;" class="btn-warning">üì• Forcer download Firebase ‚Üí local</button>
                <button onclick="refreshAllData()" id="refresh-btn" style="display: none;">üîÑ Actualiser tout</button>
                <button onclick="disconnectFirebase()" id="disconnect-drive-btn" style="display: none;" class="btn-secondary">‚ùå D√©connecter</button>
            </div>
            <p style="font-size: 14px; color: #666;">
                La synchronisation Firebase permet de garder vos donn√©es √† jour sur tous vos appareils automatiquement.
            </p>
        </div>

        <div style="margin: 20px 0;">
            <h3>‚öôÔ∏è Param√®tres de synchronisation</h3>
            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="auto-sync-enabled" checked>
                    <label for="auto-sync-enabled">Synchronisation automatique (toutes les 30 secondes)</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="sync-on-change-enabled" checked>
                    <label for="sync-on-change-enabled">Synchroniser √† chaque modification</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="sync-notifications" checked>
                    <label for="sync-notifications">Notifications de synchronisation</label>
                </div>
            </div>
        </div>

        <div style="margin: 20px 0;">
            <h3>üìä Historique de synchronisation</h3>
            <div id="sync-history" style="max-height: 200px; overflow-y: auto;">
                <p style="color: #666; font-style: italic;">Aucune synchronisation effectu√©e</p>
            </div>
        </div>
    </div>

    <!-- Onglet Stats -->
    <div id="stats" class="tab-content">
        <h2>Statistiques</h2>
        <div style="margin-bottom: 20px;">
            <div class="day-navigation">
                <button onclick="changeStatsDate(-1)">‚Üê Jour pr√©c√©dent</button>
                <input type="date" id="stats-date" onchange="updateStats()">
                <button onclick="changeStatsDate(1)">Jour suivant ‚Üí</button>
                <button onclick="showMultipleDays()">Voir 4 jours</button>
                <button onclick="showBirdStats()">üìä Stats par oiseau</button>
                <button onclick="showWeightGraphs()">üìà Graphiques poids</button>
            </div>
            <div style="margin-top: 10px;">
                <button onclick="exportAllData()">üíæ Exporter</button>
                <button onclick="importAllData()" style="margin-left: 10px;">üìÅ Importer</button>
                <button onclick="clearAllData()" class="btn-danger" style="margin-left: 10px;">üóëÔ∏è Vider</button>
            </div>
        </div>
        <div id="stats-content"></div>
    </div>
</div>

<!-- Modal pour affichage photo en grand -->
<div id="photoModal" class="modal">
    <div class="modal-content" style="max-width: 90%; max-height: 90%; padding: 10px; text-align: center;">
        <span class="close" onclick="closePhotoModal()">&times;</span>
        <img id="modal-photo" style="max-width: 100%; max-height: 80vh; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <p style="margin-top: 15px; color: #666; font-size: 14px;">üì∑ Photo</p>
    </div>
</div>

<!-- Modal pour les √©v√©nements marquants -->
<div id="evenementsModal" class="modal">
    <div class="modal-content" style="max-width: 80%; max-height: 90%;">
        <span class="close" onclick="closeEvenementsModal()">&times;</span>
        <h2 style="color: #1e3c72; margin-bottom: 20px;">üåü √âv√©nements Marquants d'Affaitage</h2>
        <div id="evenements-content" style="max-height: 70vh; overflow-y: auto;">
            <!-- Contenu g√©n√©r√© dynamiquement -->
        </div>
    </div>
</div>

<!-- Modal pour √©dition affaitage -->
<div id="editAffaitageModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeEditAffaitageModal()">&times;</span>
        <h2>Modifier l'Affaitage</h2>
        
        <div id="edit-affaitage-info" style="background: #f0f4f8; padding: 15px; border-radius: 8px; margin-bottom: 20px; color: #666;">
            <!-- Infos sur l'affaitage √† modifier -->
        </div>
        
        <div class="form-group">
            <label for="edit-affaitage-notes">Notes :</label>
            <textarea id="edit-affaitage-notes" rows="3" placeholder="Observations sur l'affaitage..."></textarea>
        </div>
        
        <div class="form-group">
            <label for="edit-affaitage-evenement">üåü √âv√©nement marquant (optionnel) :</label>
            <textarea id="edit-affaitage-evenement" rows="2" placeholder="Ex: Premier vol libre r√©ussi, Refus de prendre la nourriture, Agressivit√© inhabituelle..."></textarea>
            <div style="margin-top: 10px;">
                <button onclick="clearEvenementMarquant()" class="btn-secondary" style="font-size: 12px; padding: 6px 12px;">üóëÔ∏è Effacer l'√©v√©nement marquant</button>
            </div>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button onclick="saveAffaitageEdit()">üíæ Sauvegarder</button>
            <button onclick="closeEditAffaitageModal()" class="btn-secondary">‚ùå Annuler</button>
        </div>
    </div>
</div>

<!-- Modal pour √©dition rapaces -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeEditModal()">&times;</span>
        <h2>Modifier le Rapace</h2>
        <div class="form-group">
            <label for="edit-name">Nom :</label>
            <input type="text" id="edit-name">
        </div>
        <div class="form-group">
            <label for="edit-species">Esp√®ce :</label>
            <input type="text" id="edit-species">
        </div>
        <div class="form-group">
            <label for="edit-bague">Num√©ro de bague :</label>
            <input type="text" id="edit-bague">
        </div>
        <div class="form-group">
            <label for="edit-birthdate">Date de naissance :</label>
            <input type="date" id="edit-birthdate">
        </div>
        <div class="form-group">
            <label for="edit-sex">Sexe :</label>
            <select id="edit-sex">
                <option value="forme">Forme</option>
                <option value="tiercelet">Tiercelet</option>
            </select>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="edit-poids-plein">Poids plein (g) :</label>
                <input type="number" id="edit-poids-plein" min="0">
            </div>
            <div class="form-group">
                <label for="edit-poids-vol">Poids vol (g) :</label>
                <input type="number" id="edit-poids-vol" min="0">
            </div>
            <div class="form-group">
                <label for="edit-poids-chasse">Poids chasse (g) :</label>
                <input type="number" id="edit-poids-chasse" min="0">
            </div>
        </div>
        <div class="form-group">
            <label for="edit-photo">Photo du rapace :</label>
            <div class="file-input-wrapper">
                <input type="file" id="edit-photo" accept="image/*" onchange="previewEditPhoto(this)">
                <label for="edit-photo" class="file-input-label">üì∑ Changer la photo</label>
            </div>
            <div id="edit-photo-preview-container"></div>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button onclick="saveRapaceEdit()">üíæ Sauvegarder</button>
            <button onclick="closeEditModal()" class="btn-secondary">‚ùå Annuler</button>
        </div>
    </div>
</div>

<script>
// Variables globales
var rapaces = [];
var entries = [];
var chasseEntries = [];
var affaitageEntries = [];
var leurres = [];
var sessionsLeurre = [];
var documents = [];
var currentWeather = null;
var currentLocation = "Orthez (64300)";
var currentStatsDate = new Date();
var editingRapaceId = null;
var editingAffaitageId = null;
var currentDocumentFilter = 'all';

// Variables pour la synchronisation
var syncIntervalId = null;
var lastSyncTime = null;
var syncHistory = [];

// === FIREBASE CONFIGURATION ===
const firebaseConfig = {
  apiKey: "AIzaSyB5nXyJU-FO5YClrS-NZYOJ5hPmW0toEPA",
  authDomain: "rapaces-d00a2.firebaseapp.com",
  projectId: "rapaces-d00a2",
  storageBucket: "rapaces-d00a2.firebasestorage.app",
  messagingSenderId: "404149284295",
  appId: "1:404149284295:web:d71ab1d727c8806b3a7de2",
  measurementId: "G-Y4C19XG2P7"
};

// Variables Firebase
var db = null;
var isFirebaseReady = false;
var firebaseUserId = null;

// === GESTION DES ONGLETS ===
function showTab(tabName) {
    var contents = document.querySelectorAll('.tab-content');
    for (var i = 0; i < contents.length; i++) {
        contents[i].classList.remove('active');
    }
    
    var tabs = document.querySelectorAll('.tab');
    for (var i = 0; i < tabs.length; i++) {
        tabs[i].classList.remove('active');
    }
    
    document.getElementById(tabName).classList.add('active');
    
    var tabButtons = document.querySelectorAll('.tab');
    for (var i = 0; i < tabButtons.length; i++) {
        if (tabButtons[i].onclick && tabButtons[i].onclick.toString().includes(tabName)) {
            tabButtons[i].classList.add('active');
            break;
        }
    }
    
    if (tabName === 'gestion') {
        updateRapaceList();
    } else if (tabName === 'suivi') {
        updateRapaceSelects();
        updateEntryList();
    } else if (tabName === 'chasse') {
        updateRapaceSelects();
        updatechasseList();
    } else if (tabName === 'affaitage') {
        updateRapaceSelects();
        updateAffaitageList();
    } else if (tabName === 'leurre') {
        updateRapaceSelects();
        updateLeurreList();
        updateSessionsLeurreList();
        updateLeurreSelects();
    } else if (tabName === 'documents') {
        updateRapaceSelects();
        updateDocumentsList();
    } else if (tabName === 'stats') {
        document.getElementById('stats-date').value = currentStatsDate.toISOString().split('T')[0];
        updateStats();
    } else if (tabName === 'sync') {
        updateSyncUI();
    }
}

// === GESTION DES RAPACES ===
function addRapace() {
    var name = document.getElementById('rapace-name').value.trim();
    var species = document.getElementById('rapace-species').value.trim();
    var bague = document.getElementById('rapace-bague').value.trim();
    var birthdate = document.getElementById('rapace-birthdate').value;
    var sex = document.getElementById('rapace-sex').value;
    var poidsPlein = document.getElementById('rapace-poids-plein').value;
    var poidsVol = document.getElementById('rapace-poids-vol').value;
    var poidsChasse = document.getElementById('rapace-poids-chasse').value;
    var photoInput = document.getElementById('rapace-photo');
    
    if (!name || !species) {
        alert('Veuillez remplir le nom et l\'esp√®ce du rapace.');
        return;
    }
    
    var rapace = {
        id: Date.now(),
        name: name,
        species: species,
        bague: bague,
        birthdate: birthdate,
        sex: sex,
        poidsPlein: poidsPlein ? parseInt(poidsPlein) : null,
        poidsVol: poidsVol ? parseInt(poidsVol) : null,
        poidsChasse: poidsChasse ? parseInt(poidsChasse) : null,
        dateAdded: new Date().toISOString()
    };
    
    if (photoInput.files && photoInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            rapace.photo = e.target.result;
            finalizeAddRapace(rapace);
        };
        reader.readAsDataURL(photoInput.files[0]);
    } else {
        finalizeAddRapace(rapace);
    }
}

function finalizeAddRapace(rapace) {
    rapaces.push(rapace);
    saveAllData();
    updateRapaceList();
    updateRapaceSelects();
    
    // Nettoyer le formulaire
    document.getElementById('rapace-name').value = '';
    document.getElementById('rapace-species').value = '';
    document.getElementById('rapace-bague').value = '';
    document.getElementById('rapace-birthdate').value = '';
    document.getElementById('rapace-sex').value = 'forme';
    document.getElementById('rapace-poids-plein').value = '';
    document.getElementById('rapace-poids-vol').value = '';
    document.getElementById('rapace-poids-chasse').value = '';
    document.getElementById('rapace-photo').value = '';
    document.getElementById('photo-preview-container').innerHTML = '';
}

function updateRapaceList() {
    var list = document.getElementById('rapace-list');
    if (!list) return;
    
    if (rapaces.length === 0) {
        list.innerHTML = '<p style="color: #666; font-style: italic;">Aucun rapace enregistr√©.</p>';
        return;
    }
    
    var html = '';
    for (var i = 0; i < rapaces.length; i++) {
        var rapace = rapaces[i];
        var age = rapace.birthdate ? calculateAge(rapace.birthdate) + ' ans' : '√¢ge inconnu';
        
        html += '<div class="rapace-card">';
        html += '<div class="rapace-actions">';
        html += '<button onclick="editRapace(' + rapace.id + ')" class="btn-warning">‚úèÔ∏è</button>';
        html += '<button onclick="deleteRapace(' + rapace.id + ')" class="btn-danger">üóëÔ∏è</button>';
        html += '</div>';
        
        if (rapace.photo) {
            html += '<img src="' + rapace.photo + '" class="rapace-photo" alt="Photo de ' + rapace.name + '">';
        }
        
        html += '<h3>' + rapace.name + '</h3>';
        html += '<p><strong>Esp√®ce:</strong> ' + rapace.species + '</p>';
        
        if (rapace.bague) {
            html += '<p><strong>Bague:</strong> ' + rapace.bague + '</p>';
        }
        
        html += '<p><strong>Sexe:</strong> ' + (rapace.sex === 'forme' ? 'Forme' : 'Tiercelet') + '</p>';
        html += '<p><strong>√Çge:</strong> ' + age + '</p>';
        if (rapace.birthdate) {
            html += '<p><strong>Naissance:</strong> ' + new Date(rapace.birthdate).toLocaleDateString('fr-FR') + '</p>';
        }
        
        if (rapace.poidsPlein || rapace.poidsVol || rapace.poidsChasse) {
            html += '<div style="margin-top: 10px; padding: 10px; background: #e3f2fd; border-radius: 5px;">';
            html += '<strong>Poids de r√©f√©rence:</strong><br>';
            if (rapace.poidsPlein) html += 'üçñ Plein: ' + rapace.poidsPlein + 'g ';
            if (rapace.poidsVol) html += 'üïäÔ∏è Vol: ' + rapace.poidsVol + 'g ';
            if (rapace.poidsChasse) html += 'üéØ Chasse: ' + rapace.poidsChasse + 'g';
            html += '</div>';
        }
        html += '</div>';
    }
    
    list.innerHTML = html;
}

function updateRapaceSelects() {
    var selects = ['rapace-select', 'chasse-rapace', 'affaitage-rapace', 'session-rapace', 'doc-rapace'];
    
    for (var s = 0; s < selects.length; s++) {
        var select = document.getElementById(selects[s]);
        if (!select) continue;
        
        var currentValue = select.value;
        
        var html = '<option value="">Choisir un rapace</option>';
        for (var i = 0; i < rapaces.length; i++) {
            var rapace = rapaces[i];
            html += '<option value="' + rapace.id + '">' + rapace.name + ' (' + rapace.species + ')</option>';
        }
        
        select.innerHTML = html;
        select.value = currentValue;
        
        if (select.id === 'chasse-rapace') {
            updatePoidsChaseReference();
        }
    }
}

function calculateAge(birthDate) {
    var today = new Date();
    var birth = new Date(birthDate);
    var age = today.getFullYear() - birth.getFullYear();
    var monthDiff = today.getMonth() - birth.getMonth();
    
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
        age--;
    }
    
    return age;
}

function editRapace(id) {
    var rapace = rapaces.find(r => r.id === id);
    if (!rapace) return;
    
    editingRapaceId = id;
    
    document.getElementById('edit-name').value = rapace.name;
    document.getElementById('edit-species').value = rapace.species;
    document.getElementById('edit-bague').value = rapace.bague || '';
    document.getElementById('edit-birthdate').value = rapace.birthdate || '';
    document.getElementById('edit-sex').value = rapace.sex;
    document.getElementById('edit-poids-plein').value = rapace.poidsPlein || '';
    document.getElementById('edit-poids-vol').value = rapace.poidsVol || '';
    document.getElementById('edit-poids-chasse').value = rapace.poidsChasse || '';
    
    var photoContainer = document.getElementById('edit-photo-preview-container');
    photoContainer.innerHTML = '';
    if (rapace.photo) {
        var img = document.createElement('img');
        img.src = rapace.photo;
        img.className = 'photo-preview';
        photoContainer.appendChild(img);
    }
    
    document.getElementById('editModal').style.display = 'block';
}

function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
    editingRapaceId = null;
}

function saveRapaceEdit() {
    if (!editingRapaceId) return;
    
    var rapace = rapaces.find(r => r.id === editingRapaceId);
    if (!rapace) return;
    
    var name = document.getElementById('edit-name').value.trim();
    var species = document.getElementById('edit-species').value.trim();
    
    if (!name || !species) {
        alert('Veuillez remplir le nom et l\'esp√®ce du rapace.');
        return;
    }
    
    rapace.name = name;
    rapace.species = species;
    rapace.bague = document.getElementById('edit-bague').value.trim();
    rapace.birthdate = document.getElementById('edit-birthdate').value;
    rapace.sex = document.getElementById('edit-sex').value;
    
    var poidsPlein = document.getElementById('edit-poids-plein').value;
    var poidsVol = document.getElementById('edit-poids-vol').value;
    var poidsChasse = document.getElementById('edit-poids-chasse').value;
    
    rapace.poidsPlein = poidsPlein ? parseInt(poidsPlein) : null;
    rapace.poidsVol = poidsVol ? parseInt(poidsVol) : null;
    rapace.poidsChasse = poidsChasse ? parseInt(poidsChasse) : null;
    
    var photoInput = document.getElementById('edit-photo');
    if (photoInput.files && photoInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            rapace.photo = e.target.result;
            finalizeSaveRapaceEdit();
        };
        reader.readAsDataURL(photoInput.files[0]);
    } else {
        finalizeSaveRapaceEdit();
    }
}

function finalizeSaveRapaceEdit() {
    saveAllData();
    updateRapaceList();
    updateRapaceSelects();
    closeEditModal();
}

function deleteRapace(id) {
    var rapace = rapaces.find(r => r.id === id);
    if (!rapace) return;
    
    if (confirm('√ätes-vous s√ªr de vouloir supprimer ' + rapace.name + ' ?')) {
        rapaces = rapaces.filter(r => r.id !== id);
        entries = entries.filter(e => e.rapaceId !== id);
        chasseEntries = chasseEntries.filter(c => c.rapaceId !== id);
        affaitageEntries = affaitageEntries.filter(a => a.rapaceId !== id);
        sessionsLeurre = sessionsLeurre.filter(s => s.rapaceId !== id);
        documents = documents.filter(d => d.rapaceId !== id);
        
        saveAllData();
        updateRapaceList();
        updateRapaceSelects();
        updateEntryList();
        updatechasseList();
        updateAffaitageList();
        updateLeurreList();
        updateSessionsLeurreList();
        updateDocumentsList();
    }
}

// === GESTION DES PHOTOS ===
function previewRapacePhoto(input) {
    var container = document.getElementById('photo-preview-container');
    container.innerHTML = '';
    
    if (input.files && input.files[0]) {
        var file = input.files[0];
        
        if (file.size > 5 * 1024 * 1024) {
            alert('La photo est trop volumineuse. Taille maximale : 5MB');
            input.value = '';
            return;
        }
        
        var reader = new FileReader();
        reader.onload = function(e) {
            var img = document.createElement('img');
            img.src = e.target.result;
            img.className = 'photo-preview';
            container.appendChild(img);
        };
        reader.readAsDataURL(file);
    }
}

function previewEditPhoto(input) {
    var container = document.getElementById('edit-photo-preview-container');
    container.innerHTML = '';
    
    if (input.files && input.files[0]) {
        var file = input.files[0];
        
        if (file.size > 5 * 1024 * 1024) {
            alert('La photo est trop volumineuse. Taille maximale : 5MB');
            input.value = '';
            return;
        }
        
        var reader = new FileReader();
        reader.onload = function(e) {
            var img = document.createElement('img');
            img.src = e.target.result;
            img.className = 'photo-preview';
            container.appendChild(img);
        };
        reader.readAsDataURL(file);
    }
}

function previewAffaitagePhoto(input) {
    var container = document.getElementById('affaitage-photo-preview');
    container.innerHTML = '';
    
    if (input.files && input.files[0]) {
        var file = input.files[0];
        
        if (file.size > 5 * 1024 * 1024) {
            alert('La photo est trop volumineuse. Taille maximale : 5MB');
            input.value = '';
            return;
        }
        
        var reader = new FileReader();
        reader.onload = function(e) {
            var img = document.createElement('img');
            img.src = e.target.result;
            img.className = 'photo-preview';
            container.appendChild(img);
        };
        reader.readAsDataURL(file);
    }
}

function previewChassePhoto(input) {
    var container = document.getElementById('chasse-photo-preview');
    container.innerHTML = '';
    
    if (input.files && input.files[0]) {
        var file = input.files[0];
        
        if (file.size > 5 * 1024 * 1024) {
            alert('La photo est trop volumineuse. Taille maximale : 5MB');
            input.value = '';
            return;
        }
        
        var reader = new FileReader();
        reader.onload = function(e) {
            var img = document.createElement('img');
            img.src = e.target.result;
            img.className = 'photo-preview';
            container.appendChild(img);
        };
        reader.readAsDataURL(file);
    }
}

function previewLeurrePhoto(input) {
    var container = document.getElementById('leurre-photo-preview');
    container.innerHTML = '';
    
    if (input.files && input.files[0]) {
        var file = input.files[0];
        
        if (file.size > 5 * 1024 * 1024) {
            alert('La photo est trop volumineuse. Taille maximale : 5MB');
            input.value = '';
            return;
        }
        
        var reader = new FileReader();
        reader.onload = function(e) {
            var img = document.createElement('img');
            img.src = e.target.result;
            img.className = 'photo-preview';
            container.appendChild(img);
        };
        reader.readAsDataURL(file);
    }
}

function previewDocument(input) {
    var container = document.getElementById('doc-file-preview');
    container.innerHTML = '';
    
    if (input.files && input.files[0]) {
        var file = input.files[0];
        
        if (file.size > 10 * 1024 * 1024) {
            alert('Le fichier est trop volumineux. Taille maximale : 10MB');
            input.value = '';
            return;
        }
        
        var reader = new FileReader();
        reader.onload = function(e) {
            if (file.type.includes('image/')) {
                var img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'photo-preview';
                container.appendChild(img);
            } else {
                var info = document.createElement('div');
                info.style.cssText = 'padding: 10px; background: #f0f4f8; border-radius: 8px; margin-top: 10px;';
                info.innerHTML = '<strong>üìÅ ' + file.name + '</strong><br><small>Taille: ' + (file.size / 1024).toFixed(1) + ' KB</small>';
                container.appendChild(info);
            }
        };
        
        if (file.type.includes('image/')) {
            reader.readAsDataURL(file);
        } else {
            reader.readAsText(file);
        }
    }
}

// === GESTION DU SUIVI QUOTIDIEN ===
function showEventFields() {
    var eventType = document.getElementById('event-type').value;
    var fields = ['nourriture-fields', 'vol-fields', 'comportement-fields', 'sante-fields', 'entrainement-fields'];
    
    for (var i = 0; i < fields.length; i++) {
        document.getElementById(fields[i]).classList.remove('active');
    }
    
    var targetField = eventType + '-fields';
    var targetElement = document.getElementById(targetField);
    if (targetElement) {
        targetElement.classList.add('active');
    }
}

function calculateWeightDifference() {
    var poidsAvant = parseFloat(document.getElementById('poids-avant').value) || 0;
    var poidsApres = parseFloat(document.getElementById('poids-apres').value) || 0;
    var difference = poidsAvant - poidsApres;
    
    var diffField = document.getElementById('difference-poids');
    if (poidsAvant && poidsApres) {
        if (difference > 0) {
            diffField.value = '-' + difference + 'g (perte)';
            diffField.style.color = '#d73527';
        } else if (difference < 0) {
            diffField.value = '+' + Math.abs(difference) + 'g (gain)';
            diffField.style.color = '#28a745';
        } else {
            diffField.value = '0g (stable)';
            diffField.style.color = '#6c757d';
        }
    } else {
        diffField.value = '';
    }
}

function addEntry() {
    var rapaceId = document.getElementById('rapace-select').value;
    var eventType = document.getElementById('event-type').value;
    var eventDate = document.getElementById('event-date').value;
    var eventTime = document.getElementById('event-time').value;
    var notes = document.getElementById('event-notes').value.trim();
    
    if (!rapaceId) {
        alert('Veuillez s√©lectionner un rapace.');
        return;
    }
    
    if (!eventDate) {
        eventDate = new Date().toISOString().split('T')[0];
    }
    
    if (!eventTime) {
        eventTime = new Date().toTimeString().split(' ')[0].substring(0, 5);
    }
    
    var entry = {
        id: Date.now(),
        rapaceId: parseInt(rapaceId),
        type: eventType,
        date: eventDate,
        time: eventTime,
        notes: notes,
        weather: currentWeather,
        timestamp: new Date().toISOString()
    };
    
    if (eventType === 'nourriture') {
        entry.poidsAvant = document.getElementById('poids-avant').value;
        entry.poidsApres = document.getElementById('poids-apres').value;
        entry.menu = document.getElementById('detail-nourriture').value;
        entry.quantite = document.getElementById('quantite-nourriture').value;
    } else if (eventType === 'vol') {
        entry.typeVol = document.getElementById('type-vol').value;
    } else if (eventType === 'comportement') {
        var reactivite = document.querySelector('input[name="reactivite"]:checked');
        entry.reactivite = reactivite ? reactivite.value : '';
    } else if (eventType === 'sante') {
        entry.etatSante = document.getElementById('etat-sante').value;
    } else if (eventType === 'entrainement') {
        entry.typeEntrainement = document.getElementById('type-entrainement').value;
    }
    
    entries.push(entry);
    saveAllData();
    updateEntryList();
    
    clearEntryForm();
}

function clearEntryForm() {
    document.getElementById('event-notes').value = '';
    document.getElementById('poids-avant').value = '';
    document.getElementById('poids-apres').value = '';
    document.getElementById('difference-poids').value = '';
    document.getElementById('quantite-nourriture').value = '';
    
    var radios = document.querySelectorAll('input[name="reactivite"]');
    for (var i = 0; i < radios.length; i++) {
        radios[i].checked = false;
    }
}

function updateEntryList() {
    var list = document.getElementById('entry-list');
    if (!list) return;
    
    var selectedRapaceId = document.getElementById('rapace-select').value;
    var filteredEntries;
    
    if (selectedRapaceId) {
        filteredEntries = entries.filter(e => e.rapaceId === parseInt(selectedRapaceId));
    } else {
        filteredEntries = entries;
    }
    
    filteredEntries.sort((a, b) => {
        var dateTimeA = new Date(a.date + 'T' + a.time);
        var dateTimeB = new Date(b.date + 'T' + b.time);
        return dateTimeB - dateTimeA;
    });
    
    if (filteredEntries.length === 0) {
        list.innerHTML = '<p style="color: #666; font-style: italic;">Aucune entr√©e trouv√©e.</p>';
        return;
    }
    
    var html = '';
    for (var i = 0; i < Math.min(filteredEntries.length, 10); i++) {
        var entry = filteredEntries[i];
        var rapace = rapaces.find(r => r.id === entry.rapaceId);
        var rapaceName = rapace ? rapace.name : 'Rapace supprim√©';
        
        html += '<div class="entry-item">';
        html += '<div class="date">' + new Date(entry.date + 'T' + entry.time).toLocaleDateString('fr-FR') + ' √† ' + entry.time;
        html += ' - ' + rapaceName + ' (' + getEventTypeLabel(entry.type) + ')</div>';
        html += '<div class="content">';
        
        if (entry.type === 'nourriture') {
            html += '<strong>Menu:</strong> ' + entry.menu;
            if (entry.quantite) html += ' (' + entry.quantite + ')';
            if (entry.poidsAvant && entry.poidsApres) {
                var difference = parseFloat(entry.poidsAvant) - parseFloat(entry.poidsApres);
                var diffText = '';
                if (difference > 0) {
                    diffText = ' (-' + difference + 'g)';
                } else if (difference < 0) {
                    diffText = ' (+' + Math.abs(difference) + 'g)';
                } else {
                    diffText = ' (0g)';
                }
                html += '<br><strong>Poids:</strong> ' + entry.poidsAvant + 'g ‚Üí ' + entry.poidsApres + 'g' + diffText;
            }
        } else if (entry.type === 'vol') {
            html += '<strong>Type de vol:</strong> ' + entry.typeVol;
        } else if (entry.type === 'comportement') {
            html += '<strong>R√©activit√©:</strong> ' + entry.reactivite + '/5';
        } else if (entry.type === 'sante') {
            html += '<strong>√âtat:</strong> ' + entry.etatSante;
        } else if (entry.type === 'entrainement') {
            html += '<strong>Type:</strong> ' + entry.typeEntrainement;
        }
        
        if (entry.notes) {
            html += '<br><strong>Notes:</strong> ' + entry.notes;
        }
        html += '</div></div>';
    }
    
    list.innerHTML = html;
}

function getEventTypeLabel(type) {
    switch (type) {
        case 'nourriture': return 'Nourriture';
        case 'vol': return 'Vol';
        case 'comportement': return 'Comportement';
        case 'sante': return 'Sant√©';
        case 'entrainement': return 'Entra√Ænement';
        default: return type;
    }
}

// === GESTION DE LA CHASSE ===
function updatePoidsChaseReference() {
    var rapaceId = document.getElementById('chasse-rapace').value;
    var referenceDiv = document.getElementById('poids-chasse-reference');
    
    if (!referenceDiv) return;
    
    if (rapaceId) {
        var rapace = rapaces.find(r => r.id == rapaceId);
        if (rapace && rapace.poidsChasse) {
            referenceDiv.innerHTML = '<strong>üéØ Poids de chasse de ' + rapace.name + ':</strong> ' + rapace.poidsChasse + 'g';
            referenceDiv.style.background = '#e3f2fd';
            referenceDiv.style.color = '#1e3c72';
        } else if (rapace) {
            referenceDiv.innerHTML = '<strong>‚ö†Ô∏è ' + rapace.name + ':</strong> Poids de chasse non d√©fini';
            referenceDiv.style.background = '#fff3cd';
            referenceDiv.style.color = '#856404';
        }
    } else {
        referenceDiv.innerHTML = '<span style="color: #666;">S√©lectionnez un rapace pour voir son poids de chasse</span>';
        referenceDiv.style.background = '#f8f9fa';
        referenceDiv.style.color = '#666';
    }
}

function addChasse() {
    var rapaceId = document.getElementById('chasse-rapace').value;
    var date = document.getElementById('chasse-date').value;
    var time = document.getElementById('chasse-time').value;
    var notes = document.getElementById('chasse-notes').value.trim();
    var poidsJour = document.getElementById('chasse-poids-jour').value;
    var photoInput = document.getElementById('chasse-photo');
    
    if (!rapaceId) {
        alert('Veuillez s√©lectionner un rapace.');
        return;
    }
    
    if (!date) {
        date = new Date().toISOString().split('T')[0];
    }
    
    if (!time) {
        time = new Date().toTimeString().split(' ')[0].substring(0, 5);
    }
    
    var chasse = {
        id: Date.now(),
        rapaceId: parseInt(rapaceId),
        date: date,
        time: time,
        notes: notes,
        weather: currentWeather,
        timestamp: new Date().toISOString(),
        poidsJour: poidsJour ? parseInt(poidsJour) : null,
        faisan: parseInt(document.getElementById('chasse-faisan').value) || 0,
        perdrix: parseInt(document.getElementById('chasse-perdrix').value) || 0,
        lapin: parseInt(document.getElementById('chasse-lapin').value) || 0,
        lievre: parseInt(document.getElementById('chasse-lievre').value) || 0,
        canard: parseInt(document.getElementById('chasse-canard').value) || 0,
        oie: parseInt(document.getElementById('chasse-oie').value) || 0,
        autre: parseInt(document.getElementById('chasse-autre').value) || 0
    };
    
    if (photoInput.files && photoInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            chasse.photo = e.target.result;
            finalizeAddChasse(chasse);
        };
        reader.readAsDataURL(photoInput.files[0]);
    } else {
        finalizeAddChasse(chasse);
    }
}

function finalizeAddChasse(chasse) {
    chasseEntries.push(chasse);
    saveAllData();
    updatechasseList();
    
    // Nettoyer le formulaire
    document.getElementById('chasse-notes').value = '';
    document.getElementById('chasse-poids-jour').value = '';
    document.getElementById('chasse-photo').value = '';
    document.getElementById('chasse-photo-preview').innerHTML = '';
    var huntInputs = document.querySelectorAll('.hunt-item input[type="number"]');
    for (var i = 0; i < huntInputs.length; i++) {
        huntInputs[i].value = '0';
    }
}

function updatechasseList() {
    var list = document.getElementById('chasse-list');
    if (!list) return;
    
    var sortedChasses = [...chasseEntries].sort((a, b) => {
        var dateTimeA = new Date(a.date + 'T' + a.time);
        var dateTimeB = new Date(b.date + 'T' + b.time);
        return dateTimeB - dateTimeA;
    });
    
    if (sortedChasses.length === 0) {
        list.innerHTML = '<p style="color: #666; font-style: italic;">Aucune chasse enregistr√©e.</p>';
        return;
    }
    
    var html = '';
    for (var i = 0; i < sortedChasses.length; i++) {
        var chasse = sortedChasses[i];
        var rapace = rapaces.find(r => r.id === chasse.rapaceId);
        var rapaceName = rapace ? rapace.name : 'Rapace supprim√©';
        
        var total = chasse.faisan + chasse.perdrix + chasse.lapin + chasse.lievre + chasse.canard + chasse.oie + chasse.autre;
        
        html += '<div class="entry-item">';
        html += '<div class="entry-actions">';
        html += '<button onclick="deleteChasseEntry(' + chasse.id + ')" class="btn-danger" title="Supprimer">üóëÔ∏è</button>';
        html += '</div>';
        
        html += '<div class="chasse-content">';
        
        if (chasse.photo) {
            html += '<div class="photo-container">';
            html += '<img src="' + chasse.photo + '" class="chasse-photo" alt="Photo de la chasse" title="Cliquez pour agrandir" onclick="showPhotoModal(\'' + chasse.photo + '\')">';
            html += '<button class="photo-delete-btn" onclick="deleteChassePhoto(' + chasse.id + ')" title="Supprimer la photo">√ó</button>';
            html += '</div>';
        }
        
        html += '<div class="date">' + new Date(chasse.date + 'T' + chasse.time).toLocaleDateString('fr-FR') + ' √† ' + chasse.time;
        html += ' - ' + rapaceName + ' (Total: ' + total + ' prises)';
        
        if (chasse.photo) {
            html += ' <span style="color: #28a745; font-size: 16px;" title="Photo disponible">üì∑</span>';
        }
        
        html += '</div>';
        html += '<div class="content">';
        
        if (chasse.poidsJour) {
            html += '<strong>Poids du jour:</strong> ' + chasse.poidsJour + 'g';
            
            if (rapace && rapace.poidsChasse) {
                var diffPoids = chasse.poidsJour - rapace.poidsChasse;
                var diffColor = diffPoids >= 0 ? '#28a745' : '#dc3545';
                var diffSign = diffPoids >= 0 ? '+' : '';
                html += ' <span style="color: ' + diffColor + '; font-weight: bold;">(' + diffSign + diffPoids + 'g vs poids chasse)</span>';
            }
            html += '<br>';
        }
        
        var details = [];
        if (chasse.faisan > 0) details.push(chasse.faisan + ' faisan(s)');
        if (chasse.perdrix > 0) details.push(chasse.perdrix + ' perdrix');
        if (chasse.lapin > 0) details.push(chasse.lapin + ' lapin(s)');
        if (chasse.lievre > 0) details.push(chasse.lievre + ' li√®vre(s)');
        if (chasse.canard > 0) details.push(chasse.canard + ' canard(s)');
        if (chasse.oie > 0) details.push(chasse.oie + ' oie(s)');
        if (chasse.autre > 0) details.push(chasse.autre + ' autre(s)');
        
        if (details.length > 0) {
            html += '<strong>Prises:</strong> ' + details.join(', ');
        } else {
            html += '<strong>Prises:</strong> Aucune';
        }
        
        if (chasse.notes) {
            html += '<br><strong>Notes:</strong> ' + chasse.notes;
        }
        html += '</div></div></div>';
    }
    
    list.innerHTML = html;
}

function deleteChassePhoto(id) {
    if (confirm('√ätes-vous s√ªr de vouloir supprimer cette photo ?')) {
        var entry = chasseEntries.find(e => e.id === id);
        if (entry) {
            delete entry.photo;
            saveAllData();
            updatechasseList();
        }
    }
}

function deleteChasseEntry(id) {
    var entry = chasseEntries.find(e => e.id === id);
    if (!entry) return;
    
    var rapace = rapaces.find(r => r.id === entry.rapaceId);
    var rapaceName = rapace ? rapace.name : 'Rapace supprim√©';
    
    if (confirm('√ätes-vous s√ªr de vouloir supprimer cette chasse de ' + rapaceName + ' du ' + new Date(entry.date).toLocaleDateString('fr-FR') + ' ?')) {
        chasseEntries = chasseEntries.filter(e => e.id !== id);
        saveAllData();
        updatechasseList();
    }
}

// === GESTION DE L'AFFAITAGE ===
function addAffaitage() {
    var rapaceId = document.getElementById('affaitage-rapace').value;
    var date = document.getElementById('affaitage-date').value;
    var time = document.getElementById('affaitage-time').value;
    var notes = document.getElementById('affaitage-notes').value.trim();
    var evenementMarquant = document.getElementById('affaitage-evenement').value.trim();
    var poids = document.getElementById('affaitage-poids').value;
    var photoInput = document.getElementById('affaitage-photo');
    
    if (!rapaceId) {
        alert('Veuillez s√©lectionner un rapace.');
        return;
    }
    
    if (!date) {
        date = new Date().toISOString().split('T')[0];
    }
    
    if (!time) {
        time = new Date().toTimeString().split(' ')[0].substring(0, 5);
    }
    
    var affaitage = {
        id: Date.now(),
        rapaceId: parseInt(rapaceId),
        date: date,
        time: time,
        notes: notes,
        evenementMarquant: evenementMarquant,
        poids: poids ? parseInt(poids) : null,
        weather: currentWeather,
        timestamp: new Date().toISOString(),
        priseNourriture: document.getElementById('prise-nourriture').checked,
        voliere: document.getElementById('voliere').checked,
        gant: document.getElementById('gant').checked,
        filiere: document.getElementById('filiere').checked,
        bloc: document.getElementById('bloc').checked,
        libre: document.getElementById('libre').checked,
        finAffaitage: document.getElementById('fin-affaitage').checked,
        repriseAffaitage: document.getElementById('reprise-affaitage').checked
    };
    
    if (photoInput.files && photoInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            affaitage.photo = e.target.result;
            finalizeAddAffaitage(affaitage);
        };
        reader.readAsDataURL(photoInput.files[0]);
    } else {
        finalizeAddAffaitage(affaitage);
    }
}

function finalizeAddAffaitage(affaitage) {
    affaitageEntries.push(affaitage);
    saveAllData();
    updateAffaitageList();
    
    // Nettoyer le formulaire
    document.getElementById('affaitage-notes').value = '';
    document.getElementById('affaitage-evenement').value = '';
    document.getElementById('affaitage-poids').value = '';
    document.getElementById('affaitage-photo').value = '';
    document.getElementById('affaitage-photo-preview').innerHTML = '';
    document.getElementById('prise-nourriture').checked = false;
    document.getElementById('voliere').checked = false;
    document.getElementById('gant').checked = false;
    document.getElementById('filiere').checked = false;
    document.getElementById('bloc').checked = false;
    document.getElementById('libre').checked = false;
    document.getElementById('fin-affaitage').checked = false;
    document.getElementById('reprise-affaitage').checked = false;
}

// === NOUVELLES FONCTIONS DE MODIFICATION D'AFFAITAGE ===
function editAffaitageEntry(id) {
    var affaitage = affaitageEntries.find(a => a.id === id);
    if (!affaitage) return;
    
    var rapace = rapaces.find(r => r.id === affaitage.rapaceId);
    var rapaceName = rapace ? rapace.name : 'Rapace supprim√©';
    
    editingAffaitageId = id;
    
    // Remplir les informations de l'affaitage
    var infoDiv = document.getElementById('edit-affaitage-info');
    infoDiv.innerHTML = '<strong>üìÖ ' + new Date(affaitage.date + 'T' + affaitage.time).toLocaleDateString('fr-FR') + ' √† ' + affaitage.time + '</strong><br>' +
                        '<strong>ü¶Ö Rapace:</strong> ' + rapaceName + '<br>' +
                        (affaitage.poids ? '<strong>‚öñÔ∏è Poids:</strong> ' + affaitage.poids + 'g<br>' : '') +
                        '<strong>üéØ Activit√©s:</strong> ' + getActivitiesText(affaitage);
    
    // Remplir les champs modifiables
    document.getElementById('edit-affaitage-notes').value = affaitage.notes || '';
    document.getElementById('edit-affaitage-evenement').value = affaitage.evenementMarquant || '';
    
    document.getElementById('editAffaitageModal').style.display = 'block';
}

function getActivitiesText(affaitage) {
    var activites = [];
    if (affaitage.priseNourriture) activites.push('üçΩÔ∏è Prise de nourriture');
    if (affaitage.voliere) activites.push('üè† Voli√®re');
    if (affaitage.gant) activites.push('üß§ Gant');
    if (affaitage.filiere) activites.push('üéØ Fili√®re');
    if (affaitage.bloc) activites.push('üß± Bloc');
    if (affaitage.libre) activites.push('üïäÔ∏è Libre');
    
    return activites.length > 0 ? activites.join(', ') : 'Aucune';
}

function closeEditAffaitageModal() {
    document.getElementById('editAffaitageModal').style.display = 'none';
    editingAffaitageId = null;
}

function clearEvenementMarquant() {
    if (confirm('√ätes-vous s√ªr de vouloir effacer l\'√©v√©nement marquant ?')) {
        document.getElementById('edit-affaitage-evenement').value = '';
    }
}

function saveAffaitageEdit() {
    if (!editingAffaitageId) return;
    
    var affaitage = affaitageEntries.find(a => a.id === editingAffaitageId);
    if (!affaitage) return;
    
    // Sauvegarder les modifications
    affaitage.notes = document.getElementById('edit-affaitage-notes').value.trim();
    affaitage.evenementMarquant = document.getElementById('edit-affaitage-evenement').value.trim();
    
    // Ajouter une note de modification
    affaitage.lastModified = new Date().toISOString();
    
    saveAllData();
    updateAffaitageList();
    closeEditAffaitageModal();
    
    // Afficher une confirmation
    showMiniNotification('‚úÖ Affaitage modifi√© avec succ√®s');
}

function updateAffaitageList() {
    var list = document.getElementById('affaitage-list');
    if (!list) return;
    
    var sortedAffaitages = [...affaitageEntries].sort((a, b) => {
        var dateTimeA = new Date(a.date + 'T' + a.time);
        var dateTimeB = new Date(b.date + 'T' + b.time);
        return dateTimeB - dateTimeA;
    });
    
    if (sortedAffaitages.length === 0) {
        list.innerHTML = '<p style="color: #666; font-style: italic;">Aucun affaitage enregistr√©.</p>';
        return;
    }
    
    var html = '';
    for (var i = 0; i < sortedAffaitages.length; i++) {
        var affaitage = sortedAffaitages[i];
        var rapace = rapaces.find(r => r.id === affaitage.rapaceId);
        var rapaceName = rapace ? rapace.name : 'Rapace supprim√©';
        
        html += '<div class="entry-item">';
        html += '<div class="entry-actions">';
        html += '<button onclick="editAffaitageEntry(' + affaitage.id + ')" class="btn-warning" title="Modifier">‚úèÔ∏è</button>';
        html += '<button onclick="deleteAffaitageEntry(' + affaitage.id + ')" class="btn-danger" title="Supprimer">üóëÔ∏è</button>';
        html += '</div>';
        
        html += '<div class="affaitage-content">';
        
        if (affaitage.photo) {
            html += '<div class="photo-container">';
            html += '<img src="' + affaitage.photo + '" class="affaitage-photo" alt="Photo de la session d\'affaitage" title="Cliquez pour agrandir" onclick="showPhotoModal(\'' + affaitage.photo + '\')">';
            html += '<button class="photo-delete-btn" onclick="deleteAffaitagePhoto(' + affaitage.id + ')" title="Supprimer la photo">√ó</button>';
            html += '</div>';
        }
        
        html += '<div class="date">' + new Date(affaitage.date + 'T' + affaitage.time).toLocaleDateString('fr-FR') + ' √† ' + affaitage.time;
        html += ' - ' + rapaceName;
        
        // Afficher la m√©t√©o si disponible
        if (affaitage.weather) {
            var weatherInfo = affaitage.weather.split(',')[0]; // Prendre la premi√®re partie (description + temp√©rature)
            html += ' (' + weatherInfo + ')';
        }
        
        if (affaitage.photo) {
            html += ' <span style="color: #28a745; font-size: 16px;" title="Photo disponible">üì∑</span>';
        }
        
        // Marquer les √©v√©nements marquants
        if (affaitage.evenementMarquant && affaitage.evenementMarquant.trim()) {
            html += ' <span style="color: #ffc107; font-size: 16px;" title="√âv√©nement marquant">üåü</span>';
        }
        
        // Indicateur de modification
        if (affaitage.lastModified) {
            html += ' <span style="color: #17a2b8; font-size: 12px;" title="Modifi√© le ' + new Date(affaitage.lastModified).toLocaleDateString('fr-FR') + '">‚úèÔ∏è</span>';
        }
        
        if (affaitage.finAffaitage) {
            html += '<span class="session-status session-fin">üîö FIN</span>';
        }
        if (affaitage.repriseAffaitage) {
            html += '<span class="session-status session-reprise">üîÑ REPRISE</span>';
        }
        
        html += '</div>';
        html += '<div class="content">';
        
        if (affaitage.poids) {
            html += '<strong>Poids:</strong> ' + affaitage.poids + 'g';
            
            if (rapace && (rapace.poidsChasse || rapace.poidsVol || rapace.poidsPlein)) {
                var comparisons = [];
                if (rapace.poidsChasse) {
                    var diffChasse = affaitage.poids - rapace.poidsChasse;
                    var colorChasse = diffChasse >= 0 ? '#28a745' : '#dc3545';
                    var signChasse = diffChasse >= 0 ? '+' : '';
                    comparisons.push('<span style="color: ' + colorChasse + ';">üéØ(' + signChasse + diffChasse + 'g)</span>');
                }
                if (rapace.poidsVol) {
                    var diffVol = affaitage.poids - rapace.poidsVol;
                    var colorVol = diffVol >= 0 ? '#28a745' : '#dc3545';
                    var signVol = diffVol >= 0 ? '+' : '';
                    comparisons.push('<span style="color: ' + colorVol + ';">üïäÔ∏è(' + signVol + diffVol + 'g)</span>');
                }
                if (comparisons.length > 0) {
                    html += ' ' + comparisons.join(' ');
                }
            }
            html += '<br>';
        }
        
        var activites = [];
        if (affaitage.priseNourriture) activites.push('üçΩÔ∏è Prise de nourriture');
        if (affaitage.voliere) activites.push('üè† Voli√®re');
        if (affaitage.gant) activites.push('üß§ Gant');
        if (affaitage.filiere) activites.push('üéØ Fili√®re');
        if (affaitage.bloc) activites.push('üß± Bloc');
        if (affaitage.libre) activites.push('üïäÔ∏è Libre');
        
        if (activites.length > 0) {
            html += '<strong>Activit√©s:</strong> ' + activites.join(', ');
        } else {
            html += '<strong>Activit√©s:</strong> Aucune';
        }
        
        // Afficher l'√©v√©nement marquant s'il existe
        if (affaitage.evenementMarquant && affaitage.evenementMarquant.trim()) {
            html += '<br><div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 8px; margin: 8px 0; border-radius: 4px;">';
            html += '<strong>üåü √âV√âNEMENT MARQUANT:</strong> ' + affaitage.evenementMarquant;
            html += '</div>';
        }
        
        if (affaitage.notes) {
            html += '<br><strong>Notes:</strong> ' + affaitage.notes;
        }
        html += '</div></div></div>';
    }
    
    list.innerHTML = html;
}

function deleteAffaitagePhoto(id) {
    if (confirm('√ätes-vous s√ªr de vouloir supprimer cette photo ?')) {
        var entry = affaitageEntries.find(e => e.id === id);
        if (entry) {
            delete entry.photo;
            saveAllData();
            updateAffaitageList();
        }
    }
}

function deleteAffaitageEntry(id) {
    var entry = affaitageEntries.find(e => e.id === id);
    if (!entry) return;
    
    var rapace = rapaces.find(r => r.id === entry.rapaceId);
    var rapaceName = rapace ? rapace.name : 'Rapace supprim√©';
    
    if (confirm('√ätes-vous s√ªr de vouloir supprimer cette entr√©e d\'affaitage pour ' + rapaceName + ' du ' + new Date(entry.date).toLocaleDateString('fr-FR') + ' ?')) {
        affaitageEntries = affaitageEntries.filter(e => e.id !== id);
        saveAllData();
        updateAffaitageList();
    }
}

// === GESTION DES √âV√âNEMENTS MARQUANTS ===
function showEvenementsMarquants() {
    var modal = document.getElementById('evenementsModal');
    var content = document.getElementById('evenements-content');
    
    // Filtrer les affaitages avec √©v√©nements marquants
    var evenements = affaitageEntries.filter(a => a.evenementMarquant && a.evenementMarquant.trim());
    
    if (evenements.length === 0) {
        content.innerHTML = '<p style="color: #666; font-style: italic; text-align: center; padding: 40px;">Aucun √©v√©nement marquant enregistr√© pour le moment.</p>';
    } else {
        // Grouper par rapace
        var evenementsParRapace = {};
        for (var i = 0; i < evenements.length; i++) {
            var evt = evenements[i];
            var rapace = rapaces.find(r => r.id === evt.rapaceId);
            var rapaceName = rapace ? rapace.name : 'Rapace supprim√©';
            
            if (!evenementsParRapace[rapaceName]) {
                evenementsParRapace[rapaceName] = [];
            }
            evenementsParRapace[rapaceName].push(evt);
        }
        
        var html = '';
        
        // Afficher par rapace
        for (var rapaceName in evenementsParRapace) {
            var rapaceEvenements = evenementsParRapace[rapaceName];
            
            // Trier par date (plus r√©cent d'abord)
            rapaceEvenements.sort((a, b) => {
                var dateTimeA = new Date(a.date + 'T' + a.time);
                var dateTimeB = new Date(b.date + 'T' + b.time);
                return dateTimeB - dateTimeA;
            });
            
            html += '<div style="margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; border: 2px solid #e3f2fd;">';
            html += '<h3 style="color: #1e3c72; margin-bottom: 15px; font-size: 1.4em;">ü¶Ö ' + rapaceName + '</h3>';
            
            for (var j = 0; j < rapaceEvenements.length; j++) {
                var evt = rapaceEvenements[j];
                
                html += '<div style="margin: 15px 0; padding: 15px; background: white; border-radius: 8px; border-left: 4px solid #ffc107;">';
                html += '<div style="display: flex; align-items: center; margin-bottom: 8px;">';
                html += '<span style="color: #ffc107; font-size: 18px; margin-right: 8px;">üåü</span>';
                html += '<strong style="color: #1e3c72;">' + new Date(evt.date + 'T' + evt.time).toLocaleDateString('fr-FR') + ' √† ' + evt.time + '</strong>';
                
                // Indicateur de modification
                if (evt.lastModified) {
                    html += '<span style="margin-left: 10px; color: #17a2b8; font-size: 11px;" title="Modifi√© le ' + new Date(evt.lastModified).toLocaleDateString('fr-FR') + ' √† ' + new Date(evt.lastModified).toLocaleTimeString('fr-FR') + '">‚úèÔ∏è modifi√©</span>';
                }
                
                // Afficher la m√©t√©o si disponible
                if (evt.weather) {
                    var weatherInfo = evt.weather.split(',')[0]; // Prendre la premi√®re partie
                    html += '<span style="margin-left: 15px; color: #666; font-size: 0.9em;">(' + weatherInfo + ')</span>';
                }
                
                html += '</div>';
                html += '<div style="color: #333; line-height: 1.4;">' + evt.evenementMarquant + '</div>';
                html += '</div>';
            }
            
            html += '</div>';
        }
        
        content.innerHTML = html;
    }
    
    modal.style.display = 'block';
}

function closeEvenementsModal() {
    document.getElementById('evenementsModal').style.display = 'none';
}

// === GESTION DES LEURRES ===
function addLeurre() {
    var nom = document.getElementById('leurre-nom').value.trim();
    var type = document.getElementById('leurre-type').value;
    var couleur = document.getElementById('leurre-couleur').value.trim();
    var taille = document.getElementById('leurre-taille').value;
    var poids = document.getElementById('leurre-poids-g').value;
    var description = document.getElementById('leurre-description').value.trim();
    var photoInput = document.getElementById('leurre-photo');
    
    if (!nom || !type) {
        alert('Veuillez remplir le nom et le type du leurre.');
        return;
    }
    
    var leurre = {
        id: Date.now(),
        nom: nom,
        type: type,
        couleur: couleur,
        taille: taille ? parseInt(taille) : null,
        poids: poids ? parseInt(poids) : null,
        description: description,
        dateAdded: new Date().toISOString(),
        utilisations: 0,
        efficacite: 0
    };
    
    if (photoInput.files && photoInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            leurre.photo = e.target.result;
            finalizeAddLeurre(leurre);
        };
        reader.readAsDataURL(photoInput.files[0]);
    } else {
        finalizeAddLeurre(leurre);
    }
}

function finalizeAddLeurre(leurre) {
    leurres.push(leurre);
    saveAllData();
    updateLeurreList();
    updateLeurreSelects();
    
    // Nettoyer le formulaire
    document.getElementById('leurre-nom').value = '';
    document.getElementById('leurre-type').value = 'plume';
    document.getElementById('leurre-couleur').value = '';
    document.getElementById('leurre-taille').value = '';
    document.getElementById('leurre-poids-g').value = '';
    document.getElementById('leurre-description').value = '';
    document.getElementById('leurre-photo').value = '';
    document.getElementById('leurre-photo-preview').innerHTML = '';
}

function updateLeurreSelects() {
    var select = document.getElementById('session-leurre');
    if (!select) return;
    
    var currentValue = select.value;
    
    var html = '<option value="">Choisir un leurre</option>';
    for (var i = 0; i < leurres.length; i++) {
        var leurre = leurres[i];
        html += '<option value="' + leurre.id + '">' + leurre.nom + ' (' + leurre.type + ')</option>';
    }
    
    select.innerHTML = html;
    select.value = currentValue;
}

function updateLeurreList() {
    var list = document.getElementById('leurre-list');
    if (!list) return;
    
    if (leurres.length === 0) {
        list.innerHTML = '<p style="color: #666; font-style: italic;">Aucun leurre enregistr√©.</p>';
        return;
    }
    
    var html = '';
    for (var i = 0; i < leurres.length; i++) {
        var leurre = leurres[i];
        
        html += '<div class="leurre-card">';
        html += '<div class="leurre-actions">';
        html += '<button onclick="deleteLeurre(' + leurre.id + ')" class="btn-danger">üóëÔ∏è</button>';
        html += '</div>';
        
        if (leurre.photo) {
            html += '<img src="' + leurre.photo + '" class="leurre-photo" alt="Photo de ' + leurre.nom + '">';
        }
        
        html += '<h3>üéØ ' + leurre.nom + '</h3>';
        html += '<p><strong>Type:</strong> ' + leurre.type.charAt(0).toUpperCase() + leurre.type.slice(1) + '</p>';
        
        if (leurre.couleur) {
            html += '<p><strong>Couleur:</strong> ' + leurre.couleur + '</p>';
        }
        
        if (leurre.taille || leurre.poids) {
            html += '<p><strong>Dimensions:</strong> ';
            if (leurre.taille) html += leurre.taille + 'cm ';
            if (leurre.poids) html += '‚Ä¢ ' + leurre.poids + 'g';
            html += '</p>';
        }
        
        if (leurre.description) {
            html += '<p><strong>Description:</strong> ' + leurre.description + '</p>';
        }
        
        // Statistiques d'utilisation
        html += '<div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 8px;">';
        html += '<strong>üìä Statistiques:</strong><br>';
        html += '‚Ä¢ Utilisations: ' + leurre.utilisations + '<br>';
        html += '‚Ä¢ Efficacit√© moyenne: ' + leurre.efficacite.toFixed(1) + '%';
        
        if (leurre.efficacite > 0) {
            html += '<div class="efficacite-bar">';
            html += '<div class="efficacite-fill" style="width: ' + leurre.efficacite + '%"></div>';
            html += '</div>';
        }
        html += '</div>';
        
        html += '</div>';
    }
    
    list.innerHTML = html;
}

function deleteLeurre(id) {
    var leurre = leurres.find(l => l.id === id);
    if (!leurre) return;
    
    if (confirm('√ätes-vous s√ªr de vouloir supprimer le leurre "' + leurre.nom + '" ?')) {
        leurres = leurres.filter(l => l.id !== id);
        sessionsLeurre = sessionsLeurre.filter(s => s.leurreId !== id);
        
        saveAllData();
        updateLeurreList();
        updateLeurreSelects();
        updateSessionsLeurreList();
    }
}

function addSessionLeurre() {
    var leurreId = document.getElementById('session-leurre').value;
    var rapaceId = document.getElementById('session-rapace').value;
    var date = document.getElementById('session-date').value;
    var time = document.getElementById('session-time').value;
    var duree = document.getElementById('session-duree').value;
    var reussite = document.getElementById('session-reussite').value;
    var nbPasses = document.getElementById('session-nb-passes').value;
    var notes = document.getElementById('session-notes').value.trim();
    
    if (!leurreId || !rapaceId) {
        alert('Veuillez s√©lectionner un leurre et un rapace.');
        return;
    }
    
    if (!date) {
        date = new Date().toISOString().split('T')[0];
    }
    
    if (!time) {
        time = new Date().toTimeString().split(' ')[0].substring(0, 5);
    }
    
    var session = {
        id: Date.now(),
        leurreId: parseInt(leurreId),
        rapaceId: parseInt(rapaceId),
        date: date,
        time: time,
        duree: duree ? parseInt(duree) : null,
        reussite: reussite,
        nbPasses: nbPasses ? parseInt(nbPasses) : null,
        notes: notes,
        weather: currentWeather,
        timestamp: new Date().toISOString(),
        ventFort: document.getElementById('session-vent-fort').checked,
        pluie: document.getElementById('session-pluie').checked,
        premiereFois: document.getElementById('session-premiere-fois').checked,
        rapaceAffame: document.getElementById('session-rapace-affame').checked
    };
    
    sessionsLeurre.push(session);
    
    // Mettre √† jour les statistiques du leurre
    updateLeurreStats(parseInt(leurreId));
    
    saveAllData();
    updateSessionsLeurreList();
    updateLeurreList();
    
    // Nettoyer le formulaire
    document.getElementById('session-duree').value = '';
    document.getElementById('session-reussite').value = 'excellente';
    document.getElementById('session-nb-passes').value = '';
    document.getElementById('session-notes').value = '';
    document.getElementById('session-vent-fort').checked = false;
    document.getElementById('session-pluie').checked = false;
    document.getElementById('session-premiere-fois').checked = false;
    document.getElementById('session-rapace-affame').checked = false;
}

function updateLeurreStats(leurreId) {
    var leurre = leurres.find(l => l.id === leurreId);
    if (!leurre) return;
    
    var sessions = sessionsLeurre.filter(s => s.leurreId === leurreId);
    leurre.utilisations = sessions.length;
    
    if (sessions.length > 0) {
        var totalEfficacite = 0;
        for (var i = 0; i < sessions.length; i++) {
            var session = sessions[i];
            switch (session.reussite) {
                case 'excellente': totalEfficacite += 100; break;
                case 'bonne': totalEfficacite += 80; break;
                case 'moyenne': totalEfficacite += 60; break;
                case 'difficile': totalEfficacite += 30; break;
                case 'echec': totalEfficacite += 0; break;
            }
        }
        leurre.efficacite = totalEfficacite / sessions.length;
    } else {
        leurre.efficacite = 0;
    }
}

function updateSessionsLeurreList() {
    var list = document.getElementById('sessions-leurre-list');
    if (!list) return;
    
    var sortedSessions = [...sessionsLeurre].sort((a, b) => {
        var dateTimeA = new Date(a.date + 'T' + a.time);
        var dateTimeB = new Date(b.date + 'T' + b.time);
        return dateTimeB - dateTimeA;
    });
    
    if (sortedSessions.length === 0) {
        list.innerHTML = '<p style="color: #666; font-style: italic;">Aucune session enregistr√©e.</p>';
        return;
    }
    
    var html = '';
    for (var i = 0; i < sortedSessions.length; i++) {
        var session = sortedSessions[i];
        var leurre = leurres.find(l => l.id === session.leurreId);
        var rapace = rapaces.find(r => r.id === session.rapaceId);
        
        var leurreNom = leurre ? leurre.nom : 'Leurre supprim√©';
        var rapaceNom = rapace ? rapace.name : 'Rapace supprim√©';
        
        html += '<div class="session-leurre">';
        html += '<div class="entry-actions">';
        html += '<button onclick="deleteSessionLeurre(' + session.id + ')" class="btn-danger" title="Supprimer">üóëÔ∏è</button>';
        html += '</div>';
        
        html += '<div class="date">' + new Date(session.date + 'T' + session.time).toLocaleDateString('fr-FR') + ' √† ' + session.time;
        html += ' - ' + rapaceNom + ' avec ' + leurreNom + '</div>';
        html += '<div class="content">';
        
        if (session.duree) {
            html += '<strong>Dur√©e:</strong> ' + session.duree + ' minutes<br>';
        }
        
        var reussiteLabel = '';
        var reussiteColor = '';
        switch (session.reussite) {
            case 'excellente': reussiteLabel = 'Excellente'; reussiteColor = '#28a745'; break;
            case 'bonne': reussiteLabel = 'Bonne'; reussiteColor = '#20c997'; break;
            case 'moyenne': reussiteLabel = 'Moyenne'; reussiteColor = '#ffc107'; break;
            case 'difficile': reussiteLabel = 'Difficile'; reussiteColor = '#fd7e14'; break;
            case 'echec': reussiteLabel = '√âchec'; reussiteColor = '#dc3545'; break;
        }
        
        html += '<strong>R√©ussite:</strong> <span style="color: ' + reussiteColor + '; font-weight: bold;">' + reussiteLabel + '</span>';
        
        if (session.nbPasses) {
            html += ' (' + session.nbPasses + ' passes)';
        }
        html += '<br>';
        
        var conditions = [];
        if (session.ventFort) conditions.push('üí® Vent fort');
        if (session.pluie) conditions.push('üåßÔ∏è Pluie');
        if (session.premiereFois) conditions.push('üÜï Premi√®re fois');
        if (session.rapaceAffame) conditions.push('üçñ Rapace affam√©');
        
        if (conditions.length > 0) {
            html += '<strong>Conditions:</strong> ' + conditions.join(', ') + '<br>';
        }
        
        if (session.notes) {
            html += '<strong>Notes:</strong> ' + session.notes;
        }
        html += '</div></div>';
    }
    
    list.innerHTML = html;
}

function deleteSessionLeurre(id) {
    var session = sessionsLeurre.find(s => s.id === id);
    if (!session) return;
    
    if (confirm('√ätes-vous s√ªr de vouloir supprimer cette session ?')) {
        sessionsLeurre = sessionsLeurre.filter(s => s.id !== id);
        
        // Mettre √† jour les stats du leurre
        updateLeurreStats(session.leurreId);
        
        saveAllData();
        updateSessionsLeurreList();
        updateLeurreList();
    }
}

// === GESTION DES DOCUMENTS ===
function addDocument() {
    var nom = document.getElementById('doc-nom').value.trim();
    var categorie = document.getElementById('doc-categorie').value;
    var rapaceId = document.getElementById('doc-rapace').value;
    var date = document.getElementById('doc-date').value;
    var description = document.getElementById('doc-description').value.trim();
    var fileInput = document.getElementById('doc-file');
    
    if (!nom || !categorie) {
        alert('Veuillez remplir le nom et la cat√©gorie du document.');
        return;
    }
    
    var document_obj = {
        id: Date.now(),
        nom: nom,
        categorie: categorie,
        rapaceId: rapaceId ? parseInt(rapaceId) : null,
        date: date,
        description: description,
        dateAdded: new Date().toISOString()
    };
    
    if (fileInput.files && fileInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document_obj.file = e.target.result;
            document_obj.fileName = fileInput.files[0].name;
            document_obj.fileType = fileInput.files[0].type;
            document_obj.fileSize = fileInput.files[0].size;
            finalizeAddDocument(document_obj);
        };
        reader.readAsDataURL(fileInput.files[0]);
    } else {
        finalizeAddDocument(document_obj);
    }
}

function finalizeAddDocument(document_obj) {
    documents.push(document_obj);
    saveAllData();
    updateDocumentsList();
    
    // Nettoyer le formulaire
    document.getElementById('doc-nom').value = '';
    document.getElementById('doc-categorie').value = 'sante';
    document.getElementById('doc-rapace').value = '';
    document.getElementById('doc-date').value = '';
    document.getElementById('doc-description').value = '';
    document.getElementById('doc-file').value = '';
    document.getElementById('doc-file-preview').innerHTML = '';
}

function filterDocuments(category) {
    currentDocumentFilter = category;
    
    // Mettre √† jour l'apparence des boutons
    var buttons = document.querySelectorAll('.category-btn');
    for (var i = 0; i < buttons.length; i++) {
        buttons[i].classList.remove('active');
    }
    event.target.classList.add('active');
    
    updateDocumentsList();
}

function updateDocumentsList() {
    var list = document.getElementById('documents-list');
    if (!list) return;
    
    var filteredDocuments = documents;
    if (currentDocumentFilter !== 'all') {
        filteredDocuments = documents.filter(d => d.categorie === currentDocumentFilter);
    }
    
    var sortedDocuments = [...filteredDocuments].sort((a, b) => {
        return new Date(b.dateAdded) - new Date(a.dateAdded);
    });
    
    if (sortedDocuments.length === 0) {
        list.innerHTML = '<p style="color: #666; font-style: italic;">Aucun document trouv√©.</p>';
        return;
    }
    
    var html = '';
    for (var i = 0; i < sortedDocuments.length; i++) {
        var doc = sortedDocuments[i];
        var rapace = doc.rapaceId ? rapaces.find(r => r.id === doc.rapaceId) : null;
        var rapaceNom = rapace ? rapace.name : null;
        
        html += '<div class="document-card">';
        html += '<div class="document-actions">';
        if (doc.file) {
            html += '<button onclick="downloadDocument(' + doc.id + ')" class="btn-success" title="T√©l√©charger">üì•</button>';
        }
        html += '<button onclick="deleteDocument(' + doc.id + ')" class="btn-danger" title="Supprimer">üóëÔ∏è</button>';
        html += '</div>';
        
        // Ic√¥ne ou aper√ßu
        if (doc.file && doc.fileType && doc.fileType.includes('image/')) {
            html += '<img src="' + doc.file + '" class="document-preview" alt="Aper√ßu">';
        } else {
            var icon = getDocumentIcon(doc.categorie, doc.fileType);
            html += '<div class="document-icon">' + icon + '</div>';
        }
        
        html += '<h3>üìÑ ' + doc.nom + '</h3>';
        html += '<p><strong>Cat√©gorie:</strong> ' + getCategorieLabel(doc.categorie) + '</p>';
        
        if (rapaceNom) {
            html += '<p><strong>Rapace:</strong> ' + rapaceNom + '</p>';
        }
        
        if (doc.date) {
            html += '<p><strong>Date:</strong> ' + new Date(doc.date).toLocaleDateString('fr-FR') + '</p>';
        }
        
        if (doc.description) {
            html += '<p><strong>Description:</strong> ' + doc.description + '</p>';
        }
        
        if (doc.fileName) {
            html += '<div style="margin-top: 10px; padding: 8px; background: #e3f2fd; border-radius: 5px; font-size: 14px;">';
            html += '<strong>Fichier:</strong> ' + doc.fileName;
            if (doc.fileSize) {
                html += ' (' + (doc.fileSize / 1024).toFixed(1) + ' KB)';
            }
            html += '</div>';
        }
        
        html += '<p style="color: #666; font-size: 12px; margin-top: 10px;">Ajout√© le ' + new Date(doc.dateAdded).toLocaleDateString('fr-FR') + '</p>';
        html += '</div>';
    }
    
    list.innerHTML = html;
}

function getCategorieLabel(categorie) {
    switch (categorie) {
        case 'sante': return 'üè• Sant√©';
        case 'legal': return '‚öñÔ∏è L√©gal/Administratif';
        case 'formation': return 'üéì Formation';
        case 'equipement': return 'üîß √âquipement';
        case 'chasse': return 'üèπ Chasse';
        case 'elevage': return 'ü•ö √âlevage';
        case 'autre': return 'üìã Autre';
        default: return categorie;
    }
}

function getDocumentIcon(categorie, fileType) {
    if (fileType) {
        if (fileType.includes('pdf')) return 'üìÑ';
        if (fileType.includes('word')) return 'üìù';
        if (fileType.includes('image/')) return 'üñºÔ∏è';
        if (fileType.includes('text')) return 'üìÉ';
    }
    
    switch (categorie) {
        case 'sante': return 'üè•';
        case 'legal': return '‚öñÔ∏è';
        case 'formation': return 'üéì';
        case 'equipement': return 'üîß';
        case 'chasse': return 'üèπ';
        case 'elevage': return 'ü•ö';
        default: return 'üìã';
    }
}

function downloadDocument(id) {
    var doc = documents.find(d => d.id === id);
    if (!doc || !doc.file) return;
    
    var link = document.createElement('a');
    link.href = doc.file;
    link.download = doc.fileName || 'document';
    link.click();
}

function deleteDocument(id) {
    var doc = documents.find(d => d.id === id);
    if (!doc) return;
    
    if (confirm('√ätes-vous s√ªr de vouloir supprimer le document "' + doc.nom + '" ?')) {
        documents = documents.filter(d => d.id !== id);
        saveAllData();
        updateDocumentsList();
    }
}

// === GESTION DE LA M√âT√âO ===
function loadWeather() {
    var weatherElement = document.getElementById('weather-info');
    if (weatherElement) {
        weatherElement.innerHTML = 'üå¶Ô∏è <small>Chargement m√©t√©o...</small>';
    }
    
    if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                loadWeatherByCoords(position.coords.latitude, position.coords.longitude);
            },
            function(error) {
                console.log("G√©olocalisation √©chou√©e:", error.message);
                loadWeatherByCity(currentLocation);
            },
            { timeout: 10000, maximumAge: 300000 }
        );
    } else {
        loadWeatherByCity(currentLocation);
    }
}

function loadWeatherByCoords(lat, lon) {
    var apiKey = "b4d68d2dedd2d6d43f81f804010b0673";
    var url = "https://api.openweathermap.org/data/2.5/weather?lat=" + lat + "&lon=" + lon + "&appid=" + apiKey + "&units=metric&lang=fr";
    
    fetch(url)
        .then(response => {
            if (!response.ok) throw new Error('API Error: ' + response.status);
            return response.json();
        })
        .then(data => {
            processWeatherData(data);
            currentLocation = data.name + " (" + data.sys.country + ")";
            saveAllData();
        })
        .catch(error => {
            console.log("Erreur API coords:", error);
            loadWeatherByCity(currentLocation);
        });
}

function loadWeatherByCity(cityName) {
    var city = cityName.split("(")[0].trim();
    var apiKey = "b4d68d2dedd2d6d43f81f804010b0673";
    var url = "https://api.openweathermap.org/data/2.5/weather?q=" + encodeURIComponent(city) + ",FR&appid=" + apiKey + "&units=metric&lang=fr";
    
    fetch(url)
        .then(response => {
            if (!response.ok) throw new Error('API Error: ' + response.status);
            return response.json();
        })
        .then(data => {
            processWeatherData(data);
        })
        .catch(error => {
            console.log("Erreur API ville:", error);
            loadWeatherFallback();
        });
}

function processWeatherData(data) {
    var temp = Math.round(data.main.temp);
    var description = data.weather[0].description;
    var humidity = data.main.humidity;
    var windSpeed = Math.round(data.wind.speed * 3.6);
    var precipitation = 0;
    
    if (data.rain && data.rain["1h"]) {
        precipitation = Math.round((data.rain["1h"] / 1) * 100);
    } else if (data.snow && data.snow["1h"]) {
        precipitation = Math.round((data.snow["1h"] / 1) * 100);
    } else if (data.clouds && data.clouds.all > 80) {
        precipitation = Math.floor(data.clouds.all / 4);
    }
    
    precipitation = Math.min(precipitation, 100);
    var icon = getWeatherIcon(data.weather[0].main, data.weather[0].id);
    
    var detailedWeather = temp + "¬∞C\n" +
                         "Pr√©cipitations : " + precipitation + "%\n" +
                         "Humidit√© : " + humidity + "%\n" +
                         "Vent : " + windSpeed + " km/h";
    
    currentWeather = description + ", " + detailedWeather + " √† " + currentLocation;
    
    var weatherElement = document.getElementById('weather-info');
    if (weatherElement) {
        weatherElement.innerHTML = icon + " <strong>" + description.charAt(0).toUpperCase() + description.slice(1) + "</strong><br>" +
                                  "<span style='font-size: 12px; line-height: 1.4;'>" +
                                  temp + "¬∞C<br>" +
                                  "Pr√©cipitations : " + precipitation + "%<br>" +
                                  "Humidit√© : " + humidity + "%<br>" +
                                  "Vent : " + windSpeed + " km/h<br>" +
                                  "<em>" + currentLocation + "</em>" +
                                  "</span>";
    }
}

function getWeatherIcon(main, id) {
    switch (main) {
        case "Clear":
            return "‚òÄÔ∏è";
        case "Clouds":
            return id < 803 ? "‚õÖ" : "‚òÅÔ∏è";
        case "Rain":
            return "üåßÔ∏è";
        case "Drizzle":
            return "üå¶Ô∏è";
        case "Thunderstorm":
            return "‚õàÔ∏è";
        case "Snow":
            return "‚ùÑÔ∏è";
        case "Mist":
        case "Fog":
            return "üå´Ô∏è";
        case "Haze":
            return "üå§Ô∏è";
        default:
            return "üå§Ô∏è";
    }
}

function loadWeatherFallback() {
    var weatherElement = document.getElementById('weather-info');
    if (weatherElement) {
        weatherElement.innerHTML = 'üå§Ô∏è <strong>Mode hors ligne</strong><br>' +
                                  '<span style="font-size: 12px; line-height: 1.4;">' +
                                  '15¬∞C<br>' +
                                  'Pr√©cipitations : 20%<br>' +
                                  'Humidit√© : 60%<br>' +
                                  'Vent : 10 km/h<br>' +
                                  '<em style="color: #ffeb3b;">' + currentLocation + ' (Mode hors ligne)</em>' +
                                  '</span>';
    }
    currentWeather = "Mode hors ligne, 15¬∞C, 20% pr√©cipitations, 60% humidit√©, vent 10 km/h √† " + currentLocation;
}

function refreshWeather() {
    console.log("üîÑ Tentative de rechargement de la m√©t√©o...");
    loadWeather();
    
    setTimeout(function() {
        var weatherElement = document.getElementById('weather-info');
        if (weatherElement && weatherElement.innerHTML.includes('Chargement')) {
            console.log("‚ö†Ô∏è Timeout m√©t√©o, passage en mode hors ligne");
            loadWeatherFallback();
        }
    }, 10000);
}

function changeLocation() {
    var newLocation = prompt("Entrez votre localisation (ex: Paris, Toulouse, Lyon...) :", currentLocation);
    if (newLocation && newLocation.trim()) {
        currentLocation = newLocation.trim();
        saveAllData();
        console.log("üìç Nouvelle localisation:", currentLocation);
        
        var weatherElement = document.getElementById('weather-info');
        if (weatherElement) {
            weatherElement.innerHTML = 'üå¶Ô∏è <small>Chargement m√©t√©o pour ' + currentLocation + '...</small>';
        }
        
        loadWeatherByCity(currentLocation);
    }
}

// === GESTION DES STATISTIQUES ===
function updateStats() {
    var selectedDate = new Date(document.getElementById('stats-date').value);
    currentStatsDate = selectedDate;
    generateStatsForDate(selectedDate);
}

function changeStatsDate(days) {
    currentStatsDate.setDate(currentStatsDate.getDate() + days);
    document.getElementById('stats-date').value = currentStatsDate.toISOString().split('T')[0];
    updateStats();
}

function showMultipleDays() {
    var html = '';
    for (var i = 0; i < 4; i++) {
        var date = new Date(currentStatsDate);
        date.setDate(date.getDate() - i);
        html += generateStatsForDateHTML(date);
    }
    document.getElementById('stats-content').innerHTML = html;
}

function generateStatsForDate(date) {
    var html = generateStatsForDateHTML(date);
    document.getElementById('stats-content').innerHTML = html;
}

function generateStatsForDateHTML(date) {
    var dateStr = date.toISOString().split('T')[0];
    var dayEntries = entries.filter(e => e.date === dateStr);
    var dayChasses = chasseEntries.filter(c => c.date === dateStr);
    var dayAffaitages = affaitageEntries.filter(a => a.date === dateStr);
    var daySessions = sessionsLeurre.filter(s => s.date === dateStr);
    
    var html = '<div class="day-card">';
    html += '<h4>' + date.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) + '</h4>';
    
    if (dayEntries.length === 0 && dayChasses.length === 0 && dayAffaitages.length === 0 && daySessions.length === 0) {
        html += '<p style="color: #666; font-style: italic;">Aucune activit√© enregistr√©e ce jour.</p>';
    } else {
        html += '<div class="stats-grid">';
        
        html += '<div class="stat-card">';
        html += '<h3>üìù Entr√©es de suivi</h3>';
        html += '<div class="value">' + dayEntries.length + '</div>';
        html += '</div>';
        
        html += '<div class="stat-card">';
        html += '<h3>üèπ Sorties de chasse</h3>';
        html += '<div class="value">' + dayChasses.length + '</div>';
        html += '</div>';
        
        html += '<div class="stat-card">';
        html += '<h3>ü¶Ö Sessions d\'affaitage</h3>';
        html += '<div class="value">' + dayAffaitages.length + '</div>';
        html += '</div>';
        
        html += '<div class="stat-card">';
        html += '<h3>üéØ Sessions de leurre</h3>';
        html += '<div class="value">' + daySessions.length + '</div>';
        html += '</div>';
        
        html += '</div>';
    }
    
    html += '</div>';
    return html;
}

function showBirdStats() {
    var html = '<h3>üìä Statistiques compl√®tes par oiseau</h3>';
    
    if (rapaces.length === 0) {
        html += '<p style="color: #666; font-style: italic;">Aucun rapace enregistr√©.</p>';
        document.getElementById('stats-content').innerHTML = html;
        return;
    }
    
    for (var i = 0; i < rapaces.length; i++) {
        var rapace = rapaces[i];
        var birdEntries = entries.filter(e => e.rapaceId === rapace.id);
        var birdChasses = chasseEntries.filter(c => c.rapaceId === rapace.id);
        var birdAffaitages = affaitageEntries.filter(a => a.rapaceId === rapace.id);
        var birdSessions = sessionsLeurre.filter(s => s.rapaceId === rapace.id);
        
        html += '<div class="day-card" style="margin: 20px 0; background: linear-gradient(135deg, #f8f9fa 0%, #e3f2fd 100%);">';
        html += '<h4 style="color: #1e3c72; margin-bottom: 20px; font-size: 1.8em; text-align: center; border-bottom: 2px solid #2a5298; padding-bottom: 10px;">';
        
        if (rapace.photo) {
            html += '<img src="' + rapace.photo + '" style="width: 60px; height: 60px; object-fit: cover; border-radius: 50%; margin-right: 15px; vertical-align: middle;">';
        }
        
        html += 'ü¶Ö ' + rapace.name + ' (' + rapace.species + ')';
        
        if (rapace.bague) {
            html += '<br><small style="font-size: 0.7em; color: #666;">Bague: ' + rapace.bague + '</small>';
        }
        
        html += '</h4>';
        
        var totalEntries = birdEntries.length;
        var totalChasses = birdChasses.length;
        var totalAffaitages = birdAffaitages.length;
        var totalSessions = birdSessions.length;
        
        html += '<div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">';
        html += '<h5 style="color: #1e3c72; margin-bottom: 15px; font-size: 1.3em;">üìà R√©sum√©</h5>';
        html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">';
        
        html += '<div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #28a745, #20c997); color: white; border-radius: 10px;">';
        html += '<div style="font-size: 2em; font-weight: bold;">' + totalEntries + '</div>';
        html += '<div style="font-size: 0.9em;">Entr√©es totales</div>';
        html += '</div>';
        
        html += '<div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #dc3545, #c82333); color: white; border-radius: 10px;">';
        html += '<div style="font-size: 2em; font-weight: bold;">' + totalChasses + '</div>';
        html += '<div style="font-size: 0.9em;">Chasses</div>';
        html += '</div>';
        
        html += '<div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #6f42c1, #563d7c); color: white; border-radius: 10px;">';
        html += '<div style="font-size: 2em; font-weight: bold;">' + totalAffaitages + '</div>';
        html += '<div style="font-size: 0.9em;">Affaitages</div>';
        html += '</div>';
        
        html += '<div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #ffc107, #e0a800); color: #212529; border-radius: 10px;">';
        html += '<div style="font-size: 2em; font-weight: bold;">' + totalSessions + '</div>';
        html += '<div style="font-size: 0.9em;">Sessions leurre</div>';
        html += '</div>';
        
        html += '</div>';
        html += '</div>';
        html += '</div>';
    }
    
    document.getElementById('stats-content').innerHTML = html;
}

function showWeightGraphs() {
    var html = '<h3>üìà Courbes de poids (7 derniers jours)</h3>';
    
    if (rapaces.length === 0) {
        html += '<p style="color: #666; font-style: italic;">Aucun rapace enregistr√©.</p>';
        document.getElementById('stats-content').innerHTML = html;
        return;
    }
    
    for (var i = 0; i < rapaces.length; i++) {
        var rapace = rapaces[i];
        html += generateWeightGraph(rapace);
    }
    
    document.getElementById('stats-content').innerHTML = html;
}

function generateWeightGraph(rapace) {
    var html = '<div class="day-card" style="margin: 15px 0;">';
    html += '<h4 style="color: #1e3c72; margin-bottom: 15px;">üìà ' + rapace.name + '</h4>';
    
    var weightData = [];
    var today = new Date();
    
    for (var d = 6; d >= 0; d--) {
        var checkDate = new Date(today);
        checkDate.setDate(checkDate.getDate() - d);
        var dateStr = checkDate.toISOString().split('T')[0];
        
        var dayEntries = entries.filter(e => 
            e.rapaceId === rapace.id && 
            e.date === dateStr && 
            e.type === 'nourriture' && 
            e.poidsApres
        );
        
        var weight = null;
        if (dayEntries.length > 0) {
            var lastEntry = dayEntries[dayEntries.length - 1];
            weight = parseFloat(lastEntry.poidsApres);
        }
        
        weightData.push({
            date: checkDate.toLocaleDateString('fr-FR', { month: 'short', day: 'numeric' }),
            weight: weight
        });
    }
    
    html += '<div style="background: #f8f9fa; padding: 20px; border-radius: 8px; font-family: monospace; font-size: 12px; overflow-x: auto;">';
    
    var hasData = weightData.some(d => d.weight !== null);
    
    if (!hasData) {
        html += '<p style="color: #666; font-style: italic; font-family: Arial;">Aucune donn√©e de poids disponible sur les 7 derniers jours.</p>';
    } else {
        html += '<p style="color: #666; font-family: Arial;">Graphique simplifi√© des poids r√©cents</p>';
        
        for (var x = 0; x < weightData.length; x++) {
            var dataPoint = weightData[x];
            if (dataPoint.weight !== null) {
                html += dataPoint.date + ': ' + dataPoint.weight + 'g<br>';
            } else {
                html += dataPoint.date + ': -<br>';
            }
        }
        
        if (rapace.poidsChasse || rapace.poidsVol || rapace.poidsPlein) {
            html += '<div style="font-family: Arial; font-size: 12px; margin-top: 10px;">';
            html += '<strong>Poids de r√©f√©rence:</strong> ';
            if (rapace.poidsChasse) html += 'üéØ Chasse: ' + rapace.poidsChasse + 'g ';
            if (rapace.poidsVol) html += 'üïäÔ∏è Vol: ' + rapace.poidsVol + 'g ';
            if (rapace.poidsPlein) html += 'üçñ Plein: ' + rapace.poidsPlein + 'g';
            html += '</div>';
        }
    }
    
    html += '</div>';
    html += '</div>';
    
    return html;
}

function exportAllData() {
    var data = {
        rapaces: rapaces,
        entries: entries,
        chasseEntries: chasseEntries,
        affaitageEntries: affaitageEntries,
        leurres: leurres,
        sessionsLeurre: sessionsLeurre,
        documents: documents,
        currentLocation: currentLocation,
        exportDate: new Date().toISOString(),
        version: "2.0"
    };
    
    var dataStr = JSON.stringify(data, null, 2);
    var dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    var link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = 'rapaces_data_' + new Date().toISOString().split('T')[0] + '.json';
    link.click();
}

function importAllData() {
    var input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = function(e) {
        var file = e.target.files[0];
        if (!file) return;
        
        var reader = new FileReader();
        reader.onload = function(e) {
            try {
                var data = JSON.parse(e.target.result);
                
                if (data.rapaces && Array.isArray(data.rapaces)) {
                    if (confirm('Cette action va remplacer toutes vos donn√©es actuelles. Continuer ?')) {
                        rapaces = data.rapaces || [];
                        entries = data.entries || [];
                        chasseEntries = data.chasseEntries || [];
                        affaitageEntries = data.affaitageEntries || [];
                        leurres = data.leurres || [];
                        sessionsLeurre = data.sessionsLeurre || [];
                        documents = data.documents || [];
                        currentLocation = data.currentLocation || currentLocation;
                        
                        saveAllData();
                        updateRapaceList();
                        updateRapaceSelects();
                        updateEntryList();
                        updatechasseList();
                        updateAffaitageList();
                        updateLeurreList();
                        updateSessionsLeurreList();
                        updateDocumentsList();
                        updateLeurreSelects();
                        
                        alert('Donn√©es import√©es avec succ√®s !');
                    }
                } else {
                    alert('Format de fichier invalide.');
                }
            } catch (error) {
                alert('Erreur lors de l\'importation : ' + error.message);
            }
        };
        reader.readAsText(file);
    };
    input.click();
}

function clearAllData() {
    if (confirm('√ätes-vous s√ªr de vouloir supprimer TOUTES les donn√©es ? Cette action est irr√©versible.')) {
        if (confirm('Derni√®re confirmation : toutes vos donn√©es seront perdues !')) {
            rapaces = [];
            entries = [];
            chasseEntries = [];
            affaitageEntries = [];
            leurres = [];
            sessionsLeurre = [];
            documents = [];
            
            localStorage.removeItem('rapaces_data');
            
            updateRapaceList();
            updateRapaceSelects();
            updateEntryList();
            updatechasseList();
            updateAffaitageList();
            updateLeurreList();
            updateSessionsLeurreList();
            updateDocumentsList();
            updateLeurreSelects();
            
            alert('Toutes les donn√©es ont √©t√© supprim√©es.');
        }
    }
}

// === FONCTIONS FIREBASE SIMPLIFI√âES ===
var db = null;
var isFirebaseReady = false;
var firebaseUserId = null;

function initFirebaseSync() {
    alert('Fonctionnalit√© Firebase en cours de d√©veloppement');
}

function manualFirebaseSync() {
    alert('Synchronisation Firebase non disponible');
}

function forceUploadToFirebase() {
    alert('Upload Firebase non disponible');
}

function forceDownloadFromFirebase() {
    alert('Download Firebase non disponible');
}

function refreshAllData() {
    loadAllData();
    updateRapaceList();
    updateRapaceSelects();
    updateEntryList();
    updatechasseList();
    updateAffaitageList();
    updateLeurreList();
    updateSessionsLeurreList();
    updateDocumentsList();
    updateLeurreSelects();
    addSyncHistoryEntry('üîÑ Donn√©es recharg√©es depuis le stockage local');
}

function disconnectFirebase() {
    alert('Firebase non connect√©');
}

function updateSyncUI() {
    var statusEl = document.getElementById('sync-status');
    var detailsEl = document.getElementById('sync-details');
    var lastSyncEl = document.getElementById('last-sync-time');
    
    if (statusEl) {
        statusEl.textContent = '‚ùå Firebase non connect√©';
        statusEl.style.color = 'red';
        detailsEl.textContent = 'Fonctionnalit√© en d√©veloppement';
        detailsEl.style.color = '#666';
        lastSyncEl.textContent = 'Derni√®re sync : Jamais';
    }
}

function addSyncHistoryEntry(message) {
    var now = new Date();
    var timeStr = now.toLocaleTimeString('fr-FR');
    syncHistory.unshift(timeStr + ' - ' + message);
    
    if (syncHistory.length > 10) {
        syncHistory = syncHistory.slice(0, 10);
    }
    
    var historyEl = document.getElementById('sync-history');
    if (historyEl) {
        historyEl.innerHTML = syncHistory.map(entry => 
            '<p style="margin: 5px 0; font-size: 14px;">' + entry + '</p>'
        ).join('');
    }
}

function showMiniNotification(message) {
    var notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #4285f4;
        color: white;
        padding: 10px 15px;
        border-radius: 5px;
        z-index: 10000;
        font-size: 14px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    `;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(function() {
        notification.remove();
    }, 3000);
}

// === GESTION DES MODALES ===
window.onclick = function(event) {
    var editModal = document.getElementById('editModal');
    var editAffaitageModal = document.getElementById('editAffaitageModal');
    var photoModal = document.getElementById('photoModal');
    var evenementsModal = document.getElementById('evenementsModal');
    
    if (event.target === editModal) {
        closeEditModal();
    }
    if (event.target === editAffaitageModal) {
        closeEditAffaitageModal();
    }
    if (event.target === photoModal) {
        closePhotoModal();
    }
    if (event.target === evenementsModal) {
        closeEvenementsModal();
    }
}

// === MODALES ===
function showPhotoModal(photoSrc) {
    var modal = document.getElementById('photoModal');
    var modalPhoto = document.getElementById('modal-photo');
    
    modalPhoto.src = photoSrc;
    modal.style.display = 'block';
}

function closePhotoModal() {
    document.getElementById('photoModal').style.display = 'none';
}

// === GESTION DES DONN√âES ===
function saveAllData() {
    try {
        var data = {
            rapaces: rapaces,
            entries: entries,
            chasseEntries: chasseEntries,
            affaitageEntries: affaitageEntries,
            leurres: leurres,
            sessionsLeurre: sessionsLeurre,
            documents: documents,
            currentLocation: currentLocation,
            lastSave: new Date().toISOString()
        };
        localStorage.setItem('rapaces_data', JSON.stringify(data));
        
        if (isFirebaseReady && document.getElementById('sync-on-change-enabled') && document.getElementById('sync-on-change-enabled').checked) {
            syncToFirebase();
        }
    } catch (e) {
        console.error('Erreur sauvegarde:', e);
    }
}

function loadAllData() {
    try {
        var savedData = localStorage.getItem('rapaces_data');
        if (savedData) {
            var data = JSON.parse(savedData);
            rapaces = data.rapaces || [];
            entries = data.entries || [];
            chasseEntries = data.chasseEntries || [];
            affaitageEntries = data.affaitageEntries || [];
            leurres = data.leurres || [];
            sessionsLeurre = data.sessionsLeurre || [];
            documents = data.documents || [];
            currentLocation = data.currentLocation || "Orthez (64300)";
            return true;
        }
    } catch (e) {
        console.error('Erreur chargement:', e);
    }
    return false;
}

// === INITIALISATION DE L'APPLICATION ===
function initApp() {
    loadAllData();
    
    updateRapaceList();
    updateRapaceSelects();
    updateEntryList();
    updatechasseList();
    updateAffaitageList();
    updateLeurreList();
    updateSessionsLeurreList();
    updateDocumentsList();
    updateLeurreSelects();
    
    var today = new Date().toISOString().split('T')[0];
    var now = new Date().toTimeString().split(' ')[0].substring(0, 5);
    
    var eventDateEl = document.getElementById('event-date');
    var eventTimeEl = document.getElementById('event-time');
    var chasseDateEl = document.getElementById('chasse-date');
    var chasseTimeEl = document.getElementById('chasse-time');
    var affaitageeDateEl = document.getElementById('affaitage-date');
    var affaitageTimeEl = document.getElementById('affaitage-time');
    var sessionDateEl = document.getElementById('session-date');
    var sessionTimeEl = document.getElementById('session-time');
    var docDateEl = document.getElementById('doc-date');
    var statsDateEl = document.getElementById('stats-date');
    
    if (eventDateEl) eventDateEl.value = today;
    if (eventTimeEl) eventTimeEl.value = now;
    if (chasseDateEl) chasseDateEl.value = today;
    if (chasseTimeEl) chasseTimeEl.value = now;
    if (affaitageeDateEl) affaitageeDateEl.value = today;
    if (affaitageTimeEl) affaitageTimeEl.value = now;
    if (sessionDateEl) sessionDateEl.value = today;
    if (sessionTimeEl) sessionTimeEl.value = now;
    if (docDateEl) docDateEl.value = today;
    if (statsDateEl) statsDateEl.value = today;
    
    loadWeather();
    showEventFields();
    updateStats();
    updatePoidsChaseReference();
    updateSyncUI();
}

document.addEventListener('DOMContentLoaded', function() {
    initApp();
});
</script>

<!-- === ENHANCEMENTS ‚Äî ao√ªt 2025 === -->
<script>
// ====== Donn√©es & helpers Fauconniers ======
window.fauconniers = window.fauconniers || [];

function getFauconnierName(id) {
  if (!id && id !== 0) return null;
  var f = (window.fauconniers || []).find(x => x.id === parseInt(id));
  return f ? f.nom : null;
}

// Sauvegarde/chargement: inclure les fauconniers
(function patchStorage(){
  const _origSave = window.saveAllData;
  window.saveAllData = function() {
    try {
      var data = {
        rapaces: window.rapaces || [],
        entries: window.entries || [],
        chasseEntries: window.chasseEntries || [],
        affaitageEntries: window.affaitageEntries || [],
        leurres: window.leurres || [],
        sessionsLeurre: window.sessionsLeurre || [],
        documents: window.documents || [],
        currentLocation: window.currentLocation || "Orthez (64300)",
        fauconniers: window.fauconniers || [],
        lastSave: new Date().toISOString()
      };
      localStorage.setItem('rapaces_data', JSON.stringify(data));
    } catch(e){ console.error('Erreur sauvegarde:', e); }
    if (typeof _origSave === "function") {
      try { _origSave(); } catch(e) { /* ignore */ }
    }
  };

  const _origLoad = window.loadAllData;
  window.loadAllData = function() {
    try {
      var saved = localStorage.getItem('rapaces_data');
      if (saved) {
        var data = JSON.parse(saved);
        window.rapaces = data.rapaces || [];
        window.entries = data.entries || [];
        window.chasseEntries = data.chasseEntries || [];
        window.affaitageEntries = data.affaitageEntries || [];
        window.leurres = data.leurres || [];
        window.sessionsLeurre = data.sessionsLeurre || [];
        window.documents = data.documents || [];
        window.currentLocation = data.currentLocation || window.currentLocation || "Orthez (64300)";
        window.fauconniers = data.fauconniers || [];
        return true;
      }
    } catch(e){ console.error('Erreur chargement:', e); }
    if (typeof _origLoad === "function") {
      try { return _origLoad(); } catch(e) { return false; }
    }
    return false;
  };
})();

// ====== Injection UI Fauconniers & s√©lecteurs ======
function ensureEnhancementUI() {
  // Bloc gestion Fauconniers (dans l'onglet Gestion)
  var gestion = document.getElementById('gestion');
  if (gestion && !document.getElementById('fauconnier-manager')) {
    var wrapper = document.createElement('div');
    wrapper.innerHTML = `
      <h2 style="margin-top: 40px;">üë§ Fauconniers</h2>
      <div id="fauconnier-manager" class="day-card">
        <h3>G√©rer les fauconniers</h3>
        <div class="form-row">
          <div class="form-group" style="flex:1;">
            <label for="fauconnier-nom">Nom :</label>
            <input type="text" id="fauconnier-nom" placeholder="Ex: Philippe">
          </div>
          <div class="form-group" style="align-self:flex-end;">
            <button id="btn-add-fauconnier" type="button">Ajouter</button>
          </div>
        </div>
        <div id="fauconnier-list" style="margin-top:10px;"></div>
      </div>
    `;
    gestion.appendChild(wrapper);
    document.getElementById('btn-add-fauconnier').addEventListener('click', addFauconnier);
  }

  // S√©lecteurs Fauconnier pour chaque section
  function addFSelect(afterInputId, newId, labelText) {
    var after = document.getElementById(afterInputId);
    if (!after) return;
    // trouver le container .form-group parent pour l'ins√©rer juste apr√®s
    var parentFG = after.closest('.form-group') || after.parentElement;
    if (!document.getElementById(newId)) {
      var fg = document.createElement('div');
      fg.className = 'form-group';
      fg.innerHTML = `
        <label for="${newId}">${labelText} :</label>
        <select id="${newId}">
          <option value="">Choisir</option>
        </select>
      `;
      parentFG.parentElement.insertBefore(fg, parentFG.nextSibling);
    }
  }
  addFSelect('rapace-select','suivi-fauconnier','Fauconnier');
  addFSelect('chasse-rapace','chasse-fauconnier','Fauconnier');
  addFSelect('affaitage-rapace','affaitage-fauconnier','Fauconnier');
  addFSelect('session-rapace','session-fauconnier','Fauconnier');

  // Ajout de l'input photo dans la modale d'√©dition d'affaitage
  var modal = document.getElementById('editAffaitageModal');
  if (modal && !document.getElementById('edit-affaitage-photo')) {
    var content = modal.querySelector('.modal-content');
    var btnRow = Array.from(content.children).reverse().find(el => el.tagName === 'DIV' && el.innerHTML && el.innerHTML.includes('Sauvegarder'));
    var photoGroup = document.createElement('div');
    photoGroup.className = 'form-group';
    photoGroup.innerHTML = `
      <label for="edit-affaitage-photo">üì∑ Ajouter / remplacer une photo :</label>
      <div class="file-input-wrapper">
        <input type="file" id="edit-affaitage-photo" accept="image/*">
        <label for="edit-affaitage-photo" class="file-input-label">üì∑ Prendre/Choisir une photo</label>
      </div>
      <div id="edit-affaitage-photo-preview" style="margin-top:8px;"></div>
    `;
    if (btnRow) content.insertBefore(photoGroup, btnRow);
    else content.appendChild(photoGroup);
    document.getElementById('edit-affaitage-photo').addEventListener('change', function(ev){
      var prev = document.getElementById('edit-affaitage-photo-preview');
      prev.innerHTML = '';
      var f = ev.target.files && ev.target.files[0];
      if (!f) return;
      var reader = new FileReader();
      reader.onload = function(e){
        var img = document.createElement('img');
        img.src = e.target.result;
        img.className = 'photo-preview';
        prev.appendChild(img);
      };
      reader.readAsDataURL(f);
    });
  }
}

// Liste + s√©lecteurs Fauconniers
function updateFauconnierSelects() {
  var selects = ['suivi-fauconnier','chasse-fauconnier','affaitage-fauconnier','session-fauconnier'];
  selects.forEach(function(id){
    var sel = document.getElementById(id);
    if (!sel) return;
    var current = sel.value;
    var html = '<option value=\"\">Choisir</option>';
    (window.fauconniers || []).forEach(function(f){
      html += '<option value=\"'+f.id+'\">'+f.nom+'</option>';
    });
    sel.innerHTML = html;
    sel.value = current;
  });
}

function updateFauconnierList() {
  var list = document.getElementById('fauconnier-list');
  if (!list) return;
  if (!window.fauconniers || window.fauconniers.length === 0) {
    list.innerHTML = '<p style="color:#666;font-style:italic;">Aucun fauconnier enregistr√©.</p>';
    return;
  }
  var html = '';
  window.fauconniers.forEach(function(f){
    html += '<div class="entry-item" style="padding:10px;">';
    html += '<div style="display:flex;justify-content:space-between;align-items:center;">';
    html += '<div>üë§ <strong>'+f.nom+'</strong></div>';
    html += '<div><button class="btn-danger" onclick="deleteFauconnier('+f.id+')">üóëÔ∏è</button></div>';
    html += '</div></div>';
  });
  list.innerHTML = html;
}

function addFauconnier() {
  var input = document.getElementById('fauconnier-nom');
  if (!input) return;
  var nom = (input.value || '').trim();
  if (!nom) { alert('Entrez un nom de fauconnier.'); return; }
  var f = { id: Date.now(), nom: nom };
  window.fauconniers.push(f);
  input.value = '';
  saveAllData();
  updateFauconnierList();
  updateFauconnierSelects();
  if (window.showMiniNotification) showMiniNotification('‚úÖ Fauconnier ajout√©');
}

function deleteFauconnier(id) {
  if (!confirm('Supprimer ce fauconnier ? Les historiques garderont l\\'ID (affich√© comme "Fauconnier supprim√©").')) return;
  window.fauconniers = (window.fauconniers || []).filter(f => f.id !== id);
  saveAllData();
  updateFauconnierList();
  updateFauconnierSelects();
}

// ====== Saisie: inclure fauconnierId ======
(function patchAdders(){
  // Suivi
  const _origAddEntry = window.addEntry;
  window.addEntry = function() {
    if (typeof _origAddEntry === 'function') {
      try {
        _origAddEntry();
      } catch(e){ console.warn('fallback addEntry', e); }
    }
    // R√©cup√©rer la derni√®re entr√©e (celle qu'on vient d'ajouter) et lui injecter le fauconnier
    try {
      var rapaceId = parseInt(document.getElementById('rapace-select').value || '0');
      var fId = document.getElementById('suivi-fauconnier') ? parseInt(document.getElementById('suivi-fauconnier').value || '0') : null;
      if (rapaceId && window.entries && window.entries.length) {
        // Trouver la plus r√©cente pour ce rapace √† l'instant (heuristique)
        var last = window.entries[window.entries.length - 1];
        if (last && last.rapaceId === rapaceId) {
          last.fauconnierId = fId || null;
          saveAllData();
          updateEntryList();
        }
      }
    } catch(e){ /* noop */ }
  };

  // Chasse
  const _origAddChasse = window.addChasse;
  window.addChasse = function() {
    var beforeCount = (window.chasseEntries||[]).length;
    if (typeof _origAddChasse === 'function') {
      try { _origAddChasse(); } catch(e){ console.warn('fallback addChasse', e); }
    }
    try {
      var fId = document.getElementById('chasse-fauconnier') ? parseInt(document.getElementById('chasse-fauconnier').value || '0') : null;
      if ((window.chasseEntries||[]).length > beforeCount) {
        var last = window.chasseEntries[window.chasseEntries.length-1];
        last.fauconnierId = fId || null;
        saveAllData();
        if (typeof updatechasseList==='function') updatechasseList();
      }
    } catch(e){ /*noop*/ }
  };

  // Affaitage
  const _origAddAff = window.addAffaitage;
  window.addAffaitage = function() {
    var beforeCount = (window.affaitageEntries||[]).length;
    if (typeof _origAddAff === 'function') {
      try { _origAddAff(); } catch(e){ console.warn('fallback addAffaitage', e); }
    }
    try {
      var fId = document.getElementById('affaitage-fauconnier') ? parseInt(document.getElementById('affaitage-fauconnier').value || '0') : null;
      if ((window.affaitageEntries||[]).length > beforeCount) {
        var last = window.affaitageEntries[window.affaitageEntries.length-1];
        last.fauconnierId = fId || null;
        // Capturer la temp√©rature (extraction simple du texte m√©t√©o)
        if (last.weather && !last.temperature) {
          var m = /([+-]?[0-9]+(?:\\.[0-9]+)?)\\s*¬∞C/.exec(last.weather);
          if (m) last.temperature = m[1] + '¬∞C';
        }
        saveAllData();
        if (typeof updateAffaitageList==='function') updateAffaitageList();
      }
    } catch(e){ /*noop*/ }
  };

  // Session Leurre
  const _origAddSess = window.addSessionLeurre;
  window.addSessionLeurre = function() {
    var beforeCount = (window.sessionsLeurre||[]).length;
    if (typeof _origAddSess === 'function') {
      try { _origAddSess(); } catch(e){ console.warn('fallback addSessionLeurre', e); }
    }
    try {
      var fId = document.getElementById('session-fauconnier') ? parseInt(document.getElementById('session-fauconnier').value || '0') : null;
      if ((window.sessionsLeurre||[]).length > beforeCount) {
        var last = window.sessionsLeurre[window.sessionsLeurre.length-1];
        last.fauconnierId = fId || null;
        saveAllData();
        if (typeof updateSessionsLeurreList==='function') updateSessionsLeurreList();
      }
    } catch(e){ /*noop*/ }
  };
})();

// ====== Pr√©-remplissage du poids Affaitage ======
function prefillAffaitageWeight() {
  var rapaceSel = document.getElementById('affaitage-rapace');
  var poidsInput = document.getElementById('affaitage-poids');
  if (!rapaceSel || !poidsInput) return;
  if (poidsInput.value) return; // ne pas √©craser si l'utilisateur a d√©j√† tap√©
  var rapaceId = parseInt(rapaceSel.value || '0');
  if (!rapaceId) return;
  // Dernier poids d'affaitage pour ce rapace
  var list = (window.affaitageEntries || []).filter(a=>a.rapaceId===rapaceId && a.poids!=null);
  list.sort(function(a,b){ return new Date(b.date+'T'+b.time) - new Date(a.date+'T'+a.time); });
  var val = null;
  if (list.length > 0) val = list[0].poids;
  else {
    var R = (window.rapaces||[]).find(r=>r.id===rapaceId);
    val = (R && (R.poidsVol || R.poidsChasse || R.poidsPlein)) || null;
  }
  if (val!=null) poidsInput.value = val;
}

// ====== Filtrage & affichage avec Fauconnier + compteur de jours ======
function sessionStartDateFor(rapaceId, untilDateTime) {
  // Chercher la derni√®re "repriseAffaitage" avant la date courante
  var arr = (window.affaitageEntries || []).filter(a=>a.rapaceId===rapaceId);
  if (!arr.length) return null;
  arr.sort(function(a,b){ return new Date(a.date+'T'+a.time)-new Date(b.date+'T'+b.time); });
  var start = null;
  for (var i=0;i<arr.length;i++){
    var dt = new Date(arr[i].date+'T'+arr[i].time);
    if (untilDateTime && dt>untilDateTime) break;
    if (!start) start = dt; // premier affaitage
    if (arr[i].repriseAffaitage) start = dt; // red√©finit le d√©but
    if (arr[i].finAffaitage) start = null;   // stoppe jusqu'√† prochaine reprise
  }
  return start;
}

(function patchLists(){
  // Affaitage: filtre par oiseau + affichage fauconnier + temp√©rature + jour N
  const _origUpdAff = window.updateAffaitageList;
  window.updateAffaitageList = function(){
    var list = document.getElementById('affaitage-list');
    if (!list) return (typeof _origUpdAff==='function'?_origUpdAff():undefined);

    var selectedRapaceIdEl = document.getElementById('affaitage-rapace');
    var selectedId = selectedRapaceIdEl && selectedRapaceIdEl.value ? parseInt(selectedRapaceIdEl.value) : null;

    var items = (window.affaitageEntries || []).slice();
    if (selectedId) items = items.filter(a=>a.rapaceId===selectedId);

    items.sort(function(a,b){ return new Date(b.date+'T'+b.time) - new Date(a.date+'T'+a.time); });
    if (!items.length) { list.innerHTML = '<p style="color:#666;font-style:italic;">Aucun affaitage enregistr√©.</p>'; return; }

    var html='';
    items.forEach(function(a){
      var rapace = (window.rapaces||[]).find(r=>r.id===a.rapaceId);
      var rapaceName = rapace ? rapace.name : 'Rapace supprim√©';
      var dt = new Date(a.date+'T'+a.time);
      var start = sessionStartDateFor(a.rapaceId, dt);
      var dayBadge = '';
      if (start) {
        var d = Math.floor((dt - start)/(1000*60*60*24)) + 1;
        if (d>0) dayBadge = ' <span class="session-status" style="background:#e3f2fd;color:#1e3c72;border:1px solid #2a5298;">Jour '+d+'</span>';
      }
      var fName = a.fauconnierId ? (getFauconnierName(a.fauconnierId) || 'Fauconnier supprim√©') : null;

      html += '<div class="entry-item">';
      html += '<div class="entry-actions">';
      html += '<button onclick="editAffaitageEntry('+a.id+')" class="btn-warning" title="Modifier">‚úèÔ∏è</button>';
      html += '<button onclick="deleteAffaitageEntry('+a.id+')" class="btn-danger" title="Supprimer">üóëÔ∏è</button>';
      html += '</div>';

      html += '<div class="affaitage-content">';

      if (a.photo) {
        html += '<div class="photo-container">';
        html += '<img src="'+a.photo+'" class="affaitage-photo" alt="Photo" title="Cliquez pour agrandir" onclick="showPhotoModal(\\''+a.photo+'\\')">';
        html += '<button class="photo-delete-btn" onclick="deleteAffaitagePhoto('+a.id+')" title="Supprimer la photo">√ó</button>';
        html += '</div>';
      }

      html += '<div class="date">'+ dt.toLocaleDateString('fr-FR') +' √† '+ a.time +' - '+ rapaceName + dayBadge + '</div>';

      // M√©t√©o / Temp√©rature
      var temp = a.temperature;
      if (!temp && a.weather) {
        var m = /([+-]?[0-9]+(?:\\.[0-9]+)?)\\s*¬∞C/.exec(a.weather);
        if (m) temp = m[1] + '¬∞C';
      }
      if (temp) html += '<div class="content"><strong>üå°Ô∏è Temp√©rature:</strong> '+temp+'<br>'; else html += '<div class="content">';

      if (typeof a.poids !== 'undefined' && a.poids !== null) {
        html += '<strong>Poids:</strong> '+a.poids+'g<br>';
      }

      var activites = [];
      if (a.priseNourriture) activites.push('üçΩÔ∏è Prise de nourriture');
      if (a.voliere) activites.push('üè† Voli√®re');
      if (a.gant) activites.push('üß§ Gant');
      if (a.filiere) activites.push('üéØ Fili√®re');
      if (a.bloc) activites.push('üß± Bloc');
      if (a.libre) activites.push('üïäÔ∏è Libre');
      html += '<strong>Activit√©s:</strong> '+(activites.length?activites.join(', '):'Aucune')+'<br>';

      if (a.evenementMarquant && a.evenementMarquant.trim()) {
        html += '<div style="background:#fff3cd;border-left:4px solid #ffc107;padding:8px;margin:8px 0;border-radius:4px;"><strong>üåü √âV√âNEMENT MARQUANT:</strong> '+a.evenementMarquant+'</div>';
      }

      if (fName) {
        html += '<strong>üë§ Fauconnier:</strong> '+fName+'<br>';
      }

      if (a.notes) html += '<strong>Notes:</strong> '+a.notes;

      html += '</div></div></div>';
    });

    list.innerHTML = html;
  };

  // Chasse: filtrer par rapace s√©lectionn√© et afficher fauconnier si pr√©sent
  const _origUpdChasse = window.updatechasseList;
  window.updatechasseList = function(){
    var list = document.getElementById('chasse-list');
    if (!list) return (typeof _origUpdChasse==='function'?_origUpdChasse():undefined);

    var selectedRapaceIdEl = document.getElementById('chasse-rapace');
    var selectedId = selectedRapaceIdEl && selectedRapaceIdEl.value ? parseInt(selectedRapaceIdEl.value) : null;

    var items = (window.chasseEntries || []).slice();
    if (selectedId) items = items.filter(a=>a.rapaceId===selectedId);

    items.sort(function(a,b){ return new Date(b.date+'T'+b.time) - new Date(a.date+'T'+a.time); });
    if (!items.length) { list.innerHTML = '<p style="color:#666;font-style:italic;">Aucune chasse enregistr√©e.</p>'; return; }

    var html='';
    items.forEach(function(c){
      var rapace = (window.rapaces||[]).find(r=>r.id===c.rapaceId);
      var rapaceName = rapace ? rapace.name : 'Rapace supprim√©';
      var fName = c.fauconnierId ? (getFauconnierName(c.fauconnierId) || 'Fauconnier supprim√©') : null;

      var total = (c.faisan||0)+(c.perdrix||0)+(c.lapin||0)+(c.lievre||0)+(c.canard||0)+(c.oie||0)+(c.autre||0);

      html += '<div class="entry-item">';
      html += '<div class="entry-actions">';
      html += '<button onclick="deleteChasseEntry('+c.id+')" class="btn-danger" title="Supprimer">üóëÔ∏è</button>';
      html += '</div>';

      html += '<div class="date">'+ new Date(c.date+'T'+c.time).toLocaleDateString('fr-FR') +' √† '+ c.time +' - '+ rapaceName +'</div>';
      html += '<div class="content">';
      if (typeof c.poidsJour !== 'undefined' && c.poidsJour !== null) {
        html += '<strong>Poids du jour:</strong> '+c.poidsJour+'g<br>';
      }
      var details=[];
      if ((c.faisan||0) > 0) details.push(c.faisan+' faisan(s)');
      if ((c.perdrix||0) > 0) details.push(c.perdrix+' perdrix');
      if ((c.lapin||0) > 0) details.push(c.lapin+' lapin(s)');
      if ((c.lievre||0) > 0) details.push(c.lievre+' li√®vre(s)');
      if ((c.canard||0) > 0) details.push(c.canard+' canard(s)');
      if ((c.oie||0) > 0) details.push(c.oie+' oie(s)');
      if ((c.autre||0) > 0) details.push(c.autre+' autre(s)');
      html += '<strong>Prises:</strong> ' + (details.length?details.join(', '):'Aucune');
      if (fName) html += '<br><strong>üë§ Fauconnier:</strong> '+fName;
      if (c.notes) html += '<br><strong>Notes:</strong> '+c.notes;
      html += '</div></div>';
    });
    list.innerHTML = html;
  };

  // Suivi: afficher fauconnier si pr√©sent
  const _origUpdEntry = window.updateEntryList;
  window.updateEntryList = function(){
    if (typeof _origUpdEntry === 'function') _origUpdEntry();
    // Enrichir l'affichage en ajoutant le fauconnier (si pr√©sent) aux blocs rendus
    try {
      var list = document.getElementById('entry-list');
      if (!list) return;
      // On ne reconstruit pas tout: on ajoute l'info dans chaque .entry-item si invisible
      var items = list.querySelectorAll('.entry-item .content');
      var filtered = (window.entries||[]).slice().sort(function(a,b){ return new Date(b.date+'T'+b.time)-new Date(a.date+'T'+a.time); });
      var selectedRapaceId = document.getElementById('rapace-select') && document.getElementById('rapace-select').value ? parseInt(document.getElementById('rapace-select').value) : null;
      if (selectedRapaceId) filtered = filtered.filter(e=>e.rapaceId===selectedRapaceId);
      for (var i=0;i<Math.min(items.length, filtered.length);i++){
        var entry = filtered[i];
        if (entry && entry.fauconnierId && !items[i].innerHTML.includes('üë§ Fauconnier:')){
          var fName = getFauconnierName(entry.fauconnierId) || 'Fauconnier supprim√©';
          items[i].innerHTML += '<br><strong>üë§ Fauconnier:</strong> '+fName;
        }
      }
    } catch(e){ /* ignore */ }
  };
})();

// ====== √âdition Affaitage: ajouter photo ======
(function patchEditAff(){
  const _origSaveEdit = window.saveAffaitageEdit;
  window.saveAffaitageEdit = function(){
    // Avant sauvegarde, traiter la photo
    try {
      if (window.editingAffaitageId) {
        var a = (window.affaitageEntries||[]).find(x=>x.id===window.editingAffaitageId);
        var input = document.getElementById('edit-affaitage-photo');
        if (a && input && input.files && input.files[0]) {
          var reader = new FileReader();
          reader.onload = function(e){
            a.photo = e.target.result;
            if (typeof _origSaveEdit === 'function') _origSaveEdit();
          };
          reader.readAsDataURL(input.files[0]);
          return; // ne pas appeler _origSaveEdit tout de suite
        }
      }
    } catch(e){ /* continue */ }
    if (typeof _origSaveEdit === 'function') _origSaveEdit();
  };
})();

// ====== Initialise les am√©liorations ======
document.addEventListener('DOMContentLoaded', function(){
  ensureEnhancementUI();
  updateFauconnierList();
  updateFauconnierSelects();

  var affSel = document.getElementById('affaitage-rapace');
  if (affSel) {
    affSel.addEventListener('change', function(){
      // Nettoie le poids uniquement si vide, puis pr√©-remplit
      prefillAffaitageWeight();
      // Et filtre la liste
      if (typeof updateAffaitageList==='function') updateAffaitageList();
    });
  }
  // Au chargement, tenter de pr√©-remplir
  prefillAffaitageWeight();
});
</script>

</body>
</html>