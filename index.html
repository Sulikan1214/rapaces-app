<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionnaire de Rapaces</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'><circle cx='100' cy='100' r='95' fill='white' stroke='%23333' stroke-width='10'/><g transform='translate(100,100) scale(0.8)'><path d='M-60,-20 Q-40,-60 0,-40 Q40,-60 60,-20 Q50,-40 20,-30 Q10,-50 0,-35 Q-10,-50 -20,-30 Q-50,-40 -60,-20' fill='%23333'/><circle cx='-25' cy='-25' r='5' fill='%23333'/><path d='M-10,-10 Q0,0 10,-10 Q15,-5 5,-5 Q-5,-5 -10,-10' fill='%23333'/><path d='M-40,10 Q-20,20 0,10 Q20,20 40,10 Q30,30 0,25 Q-30,30 -40,10' fill='%23333'/><path d='M-30,-10 Q-20,0 -10,-10 M10,-10 Q20,0 30,-10' stroke='%23333' stroke-width='2' fill='none'/><path d='M-70,-30 Q-50,-10 -30,-20 M30,-20 Q50,-10 70,-30' stroke='%23333' stroke-width='3' fill='none'/><path d='M-60,20 Q-40,40 -20,30 M20,30 Q40,40 60,20' stroke='%23333' stroke-width='3' fill='none'/><circle cx='45' cy='45' r='2' fill='%23333'/><circle cx='-35' cy='55' r='1.5' fill='%23333'/><rect x='-15' y='35' width='4' height='2' fill='%23333'/></g></svg>" type="image/svg+xml">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            text-align: center;
            padding: 30px 20px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .weather-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            margin-top: 15px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            min-width: 120px;
            padding: 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            color: #2a5298;
            border-bottom-color: #2a5298;
            background: white;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            align-items: end;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2a5298;
        }

        button {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button.btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        button.btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #545b62 100%);
        }

        button.btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #212529;
        }

        .entry-item {
            background: #f0f4f8;
            margin: 15px 0;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #2a5298;
        }

        .entry-item .date {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .entry-item .content {
            color: #333;
        }

        .rapace-card {
            background: #f0f4f8;
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
            border: 2px solid #e3f2fd;
            position: relative;
        }

        .rapace-card h3 {
            color: #1e3c72;
            margin-bottom: 10px;
        }

        .rapace-actions {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
        }

        .rapace-actions button {
            padding: 8px 12px;
            font-size: 12px;
        }

        .weather-info {
            color: #e3f2fd;
            font-size: 14px;
        }

        .conditional-fields {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #f0f4f8;
            border-radius: 8px;
        }

        .conditional-fields.active {
            display: block;
        }

        .rating-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .rating-group input[type="radio"] {
            width: auto;
        }

        .hunt-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .hunt-item {
            background: #f0f4f8;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #e3f2fd;
        }

        .checkbox-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
        }

        .day-card {
            background: #f0f4f8;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #2a5298;
        }

        .day-card h4 {
            color: #1e3c72;
            margin-bottom: 10px;
        }

        .day-navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-card h3 {
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
            <svg width="80" height="80" viewBox="0 0 200 200" style="filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));">
                <circle cx="100" cy="100" r="95" fill="white" stroke="#1e3c72" stroke-width="8"/>
                <g transform="translate(100,100) scale(0.7)">
                    <path d="M-70,-30 Q-50,-70 0,-50 Q50,-70 70,-30 Q60,-50 30,-40 Q15,-65 0,-45 Q-15,-65 -30,-40 Q-60,-50 -70,-30" fill="#1e3c72"/>
                    <circle cx="-30" cy="-30" r="8" fill="white"/>
                    <circle cx="-28" cy="-32" r="5" fill="#1e3c72"/>
                    <circle cx="-26" cy="-34" r="2" fill="white"/>
                    <path d="M-15,-15 Q5,5 15,-15 Q20,-10 10,-8 Q-10,-8 -15,-15" fill="#2a5298"/>
                    <path d="M-50,15 Q-30,30 0,15 Q30,30 50,15 Q40,40 0,35 Q-40,40 -50,15" fill="#1e3c72"/>
                </g>
            </svg>
            <div>
                <h1>🦅 Gestionnaire de Rapaces</h1>
                <p>Suivi quotidien de vos compagnons ailés</p>
            </div>
        </div>
        <div class="weather-controls">
            <p id="weather-info" class="weather-info">🌦️ Chargement météo...</p>
            <button onclick="refreshWeather()" style="padding: 8px 16px; font-size: 12px;">🔄</button>
            <button onclick="changeLocation()" style="padding: 8px 16px; font-size: 12px;">📍</button>
        </div>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="showTab('gestion')">Gestion</button>
        <button class="tab" onclick="showTab('suivi')">Suivi</button>
        <button class="tab" onclick="showTab('chasse')">Chasse</button>
        <button class="tab" onclick="showTab('affaitage')">Affaitage</button>
        <button class="tab" onclick="showTab('stats')">Statistiques</button>
        <button class="tab" onclick="showTab('sync')">Sync</button>
    </div>

    <div id="gestion" class="tab-content active">
        <h2>Ajouter un Rapace</h2>
        <div class="form-group">
            <label for="rapace-name">Nom du rapace :</label>
            <input type="text" id="rapace-name" placeholder="Ex: Aigle royal">
        </div>
        <div class="form-group">
            <label for="rapace-species">Espèce :</label>
            <input type="text" id="rapace-species" placeholder="Ex: Aquila chrysaetos">
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="rapace-birthdate">Date de naissance :</label>
                <input type="date" id="rapace-birthdate">
            </div>
            <div class="form-group">
                <label for="rapace-sex">Sexe :</label>
                <select id="rapace-sex">
                    <option value="forme">Forme</option>
                    <option value="tiercelet">Tiercelet</option>
                </select>
            </div>
        </div>
        <button onclick="addRapace()">Ajouter le Rapace</button>

        <h2 style="margin-top: 40px;">Mes Rapaces</h2>
        <div id="rapace-list"></div>
    </div>

    <div id="suivi" class="tab-content">
        <h2>Suivi Quotidien</h2>
        <div class="form-group">
            <label for="rapace-select">Sélectionner un rapace :</label>
            <select id="rapace-select" onchange="updateEntryList()">
                <option value="">Choisir un rapace</option>
            </select>
        </div>
        <div class="form-group">
            <label for="event-type">Type d'événement :</label>
            <select id="event-type" onchange="showEventFields()">
                <option value="nourriture">Nourriture</option>
                <option value="vol">Vol</option>
                <option value="comportement">Comportement</option>
                <option value="sante">Santé</option>
                <option value="entrainement">Entraînement</option>
            </select>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="event-date">Date :</label>
                <input type="date" id="event-date">
            </div>
            <div class="form-group">
                <label for="event-time">Heure :</label>
                <input type="time" id="event-time">
            </div>
        </div>
        
        <div class="form-group">
            <label for="event-notes">Notes :</label>
            <textarea id="event-notes" rows="3" placeholder="Observations..."></textarea>
        </div>

        <!-- Champs conditionnels pour Nourriture -->
        <div id="nourriture-fields" class="conditional-fields active">
            <div class="form-row">
                <div class="form-group">
                    <label for="poids-avant">Poids avant (g) :</label>
                    <input type="number" id="poids-avant" min="0">
                </div>
                <div class="form-group">
                    <label for="poids-apres">Poids après (g) :</label>
                    <input type="number" id="poids-apres" min="0">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="detail-nourriture">Menu :</label>
                    <select id="detail-nourriture">
                        <option value="poussin">Poussin</option>
                        <option value="caille">Caille</option>
                        <option value="pigeon">Pigeon</option>
                        <option value="lapin">Lapin</option>
                        <option value="lievre">Lièvre</option>
                        <option value="canard">Canard</option>
                        <option value="faisan">Faisan</option>
                        <option value="perdrix">Perdrix</option>
                        <option value="boeuf">Bœuf</option>
                        <option value="autre">Autre</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="quantite-nourriture">Quantité :</label>
                    <input type="text" id="quantite-nourriture" placeholder="Ex: 200g">
                </div>
            </div>
        </div>

        <!-- Champs conditionnels pour Vol -->
        <div id="vol-fields" class="conditional-fields">
            <div class="form-group">
                <label for="type-vol">Type de vol :</label>
                <select id="type-vol">
                    <option value="suite">Suité</option>
                    <option value="chasse">Chasse</option>
                    <option value="entrainement">Entraînement</option>
                </select>
            </div>
        </div>

        <!-- Champs conditionnels pour Comportement -->
        <div id="comportement-fields" class="conditional-fields">
            <div class="form-group">
                <label>Réactivité (1-5) :</label>
                <div class="rating-group">
                    <input type="radio" id="react1" name="reactivite" value="1">
                    <label for="react1">1</label>
                    <input type="radio" id="react2" name="reactivite" value="2">
                    <label for="react2">2</label>
                    <input type="radio" id="react3" name="reactivite" value="3">
                    <label for="react3">3</label>
                    <input type="radio" id="react4" name="reactivite" value="4">
                    <label for="react4">4</label>
                    <input type="radio" id="react5" name="reactivite" value="5">
                    <label for="react5">5</label>
                </div>
            </div>
        </div>

        <!-- Champs conditionnels pour Santé -->
        <div id="sante-fields" class="conditional-fields">
            <div class="form-group">
                <label for="etat-sante">État :</label>
                <select id="etat-sante">
                    <option value="ras">RAS</option>
                    <option value="pb">PB</option>
                </select>
            </div>
        </div>

        <!-- Champs conditionnels pour Entraînement -->
        <div id="entrainement-fields" class="conditional-fields">
            <div class="form-group">
                <label for="type-entrainement">Type d'entraînement :</label>
                <select id="type-entrainement">
                    <option value="filiere">Filière</option>
                    <option value="charriot">Charriot</option>
                    <option value="rc-voiture">RC Voiture</option>
                    <option value="drone">Drone</option>
                    <option value="vivant">Vivant</option>
                    <option value="corde">Corde</option>
                    <option value="ascendant">Ascendant</option>
                </select>
            </div>
        </div>

        <button onclick="addEntry()">Ajouter l'Entrée</button>

        <h2 style="margin-top: 40px;">Historique Récent</h2>
        <div id="entry-list"></div>
    </div>

    <div id="chasse" class="tab-content">
        <h2>Registre de Chasse</h2>
        <div class="form-group">
            <label for="chasse-rapace">Rapace :</label>
            <select id="chasse-rapace">
                <option value="">Choisir un rapace</option>
            </select>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="chasse-date">Date :</label>
                <input type="date" id="chasse-date">
            </div>
            <div class="form-group">
                <label for="chasse-time">Heure :</label>
                <input type="time" id="chasse-time">
            </div>
        </div>
        
        <div class="hunt-grid">
            <div class="hunt-item">
                <label for="chasse-faisan">Faisan :</label>
                <input type="number" id="chasse-faisan" min="0" max="10" value="0">
            </div>
            <div class="hunt-item">
                <label for="chasse-perdrix">Perdrix :</label>
                <input type="number" id="chasse-perdrix" min="0" max="10" value="0">
            </div>
            <div class="hunt-item">
                <label for="chasse-lapin">Lapin :</label>
                <input type="number" id="chasse-lapin" min="0" max="10" value="0">
            </div>
            <div class="hunt-item">
                <label for="chasse-lievre">Lièvre :</label>
                <input type="number" id="chasse-lievre" min="0" max="10" value="0">
            </div>
            <div class="hunt-item">
                <label for="chasse-canard">Canard :</label>
                <input type="number" id="chasse-canard" min="0" max="10" value="0">
            </div>
            <div class="hunt-item">
                <label for="chasse-oie">Oie :</label>
                <input type="number" id="chasse-oie" min="0" max="10" value="0">
            </div>
            <div class="hunt-item">
                <label for="chasse-autre">Autre :</label>
                <input type="number" id="chasse-autre" min="0" max="10" value="0">
            </div>
        </div>
        
        <div class="form-group">
            <label for="chasse-notes">Notes :</label>
            <textarea id="chasse-notes" rows="3" placeholder="Observations sur la chasse..."></textarea>
        </div>
        
        <button onclick="addChasse()">Enregistrer la Chasse</button>
        
        <h2 style="margin-top: 40px;">Historique des Chasses</h2>
        <div id="chasse-list"></div>
    </div>

    <div id="affaitage" class="tab-content">
        <h2>Affaitage</h2>
        <div class="form-group">
            <label for="affaitage-rapace">Rapace :</label>
            <select id="affaitage-rapace">
                <option value="">Choisir un rapace</option>
            </select>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="affaitage-date">Date :</label>
                <input type="date" id="affaitage-date">
            </div>
            <div class="form-group">
                <label for="affaitage-time">Heure :</label>
                <input type="time" id="affaitage-time">
            </div>
        </div>
        
        <div class="form-group">
            <label>Activités :</label>
            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="prise-nourriture">
                    <label for="prise-nourriture">Prise de nourriture</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="gant">
                    <label for="gant">Gant</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="filiere">
                    <label for="filiere">Filière</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="libre">
                    <label for="libre">Libre</label>
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label for="affaitage-notes">Notes :</label>
            <textarea id="affaitage-notes" rows="3" placeholder="Observations sur l'affaitage..."></textarea>
        </div>
        
        <button onclick="addAffaitage()">Enregistrer l'Affaitage</button>
        
        <h2 style="margin-top: 40px;">Historique d'Affaitage</h2>
        <div id="affaitage-list"></div>
    </div>

    <div id="stats" class="tab-content">
        <h2>Statistiques</h2>
        <div style="margin-bottom: 20px;">
            <div class="day-navigation">
                <button onclick="changeStatsDate(-1)">← Jour précédent</button>
                <input type="date" id="stats-date" onchange="updateStats()">
                <button onclick="changeStatsDate(1)">Jour suivant →</button>
                <button onclick="showMultipleDays()">Voir 4 jours</button>
            </div>
            <div style="margin-top: 10px;">
                <button onclick="exportAllData()">💾 Exporter</button>
                <button onclick="importAllData()" style="margin-left: 10px;">📁 Importer</button>
                <button onclick="clearAllData()" class="btn-danger" style="margin-left: 10px;">🗑️ Vider</button>
            </div>
        </div>
        <div id="stats-content"></div>
    </div>

    <div id="sync" class="tab-content">
        <h2>🔥 Synchronisation Firebase</h2>
        
        <div class="day-card">
            <h4 id="sync-status">📊 État de la synchronisation</h4>
            <p id="sync-details">🔄 Non configuré</p>
            <p id="last-sync-time">Dernière sync : Jamais</p>
        </div>

        <div style="margin: 20px 0;">
            <h3>🔧 Configuration</h3>
            <div style="display: flex; gap: 10px; margin: 15px 0; flex-wrap: wrap;">
                <button onclick="initFirebaseSync()" id="connect-drive-btn">🔗 Activer Firebase</button>
                <button onclick="manualFirebaseSync()" id="manual-sync-btn" style="display: none;">⚡ Synchroniser maintenant</button>
                <button onclick="disconnectFirebase()" id="disconnect-drive-btn" style="display: none;" class="btn-secondary">❌ Déconnecter</button>
            </div>
            <p style="font-size: 14px; color: #666;">
                La synchronisation Firebase permet de garder vos données à jour sur tous vos appareils automatiquement.
            </p>
        </div>

        <div style="margin: 20px 0;">
            <h3>⚙️ Paramètres de synchronisation</h3>
            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="auto-sync-enabled" checked>
                    <label for="auto-sync-enabled">Synchronisation automatique (toutes les 2 minutes)</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="sync-on-change-enabled" checked>
                    <label for="sync-on-change-enabled">Synchroniser à chaque modification</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="sync-notifications" checked>
                    <label for="sync-notifications">Notifications de synchronisation</label>
                </div>
            </div>
        </div>

        <div style="margin: 20px 0;">
            <h3>📱 Instructions multi-appareils</h3>
            <div class="day-card" style="background: #e8f4fd;">
                <p><strong>1. Sur cet appareil :</strong></p>
                <p>• Cliquez "🔗 Activer Firebase"</p>
                <p>• Vos données seront sauvegardées automatiquement</p>
                
                <p><strong>2. Sur vos autres appareils :</strong></p>
                <p>• Ouvrez cette application</p>
                <p>• Allez dans l'onglet "Sync"</p>
                <p>• Cliquez "Activer Firebase"</p>
                <p>• Vos données se synchroniseront automatiquement !</p>
            </div>
        </div>

        <div style="margin: 20px 0;">
            <h3>📊 Historique de synchronisation</h3>
            <div id="sync-history" style="max-height: 200px; overflow-y: auto;">
                <p style="color: #666; font-style: italic;">Aucune synchronisation effectuée</p>
            </div>
        </div>

        <div class="day-card" style="background: #e3f2fd;">
            <h4>ℹ️ Comment ça marche</h4>
            <p>• Vos données sont stockées de manière sécurisée sur Firebase</p>
            <p>• Synchronisation automatique sur tous vos appareils</p>
            <p>• Fonctionnement hors ligne avec synchronisation au retour de connexion</p>
            <p>• En cas de conflit, la version la plus récente est conservée</p>
            <p>• Données sauvegardées de manière permanente dans le cloud</p>
        </div>
    </div>
</div>

<!-- Modal pour édition -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeEditModal()">&times;</span>
        <h2>Modifier le Rapace</h2>
        <div class="form-group">
            <label for="edit-name">Nom :</label>
            <input type="text" id="edit-name">
        </div>
        <div class="form-group">
            <label for="edit-species">Espèce :</label>
            <input type="text" id="edit-species">
        </div>
        <div class="form-group">
            <label for="edit-birthdate">Date de naissance :</label>
            <input type="date" id="edit-birthdate">
        </div>
        <div class="form-group">
            <label for="edit-sex">Sexe :</label>
            <select id="edit-sex">
                <option value="forme">Forme</option>
                <option value="tiercelet">Tiercelet</option>
            </select>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button onclick="saveRapaceEdit()">💾 Sauvegarder</button>
            <button onclick="closeEditModal()" class="btn-secondary">❌ Annuler</button>
        </div>
    </div>
</div>

<script>
// Variables globales
var rapaces = [];
var entries = [];
var chasseEntries = [];
var affaitageEntries = [];
var currentWeather = null;
var currentLocation = "Orthez (64300)";
var currentStatsDate = new Date();
var editingRapaceId = null;

// Variables pour la synchronisation
var syncIntervalId = null;
var lastSyncTime = null;
var syncHistory = [];

// === FIREBASE CONFIGURATION ===
const firebaseConfig = {
  apiKey: "AIzaSyB5nXyJU-FO5YClrS-NZYOJ5hPmW0toEPA",
  authDomain: "rapaces-d00a2.firebaseapp.com",
  projectId: "rapaces-d00a2",
  storageBucket: "rapaces-d00a2.firebasestorage.app",
  messagingSenderId: "404149284295",
  appId: "1:404149284295:web:d71ab1d727c8806b3a7de2",
  measurementId: "G-Y4C19XG2P7"
};

// Variables Firebase
let db = null;
let isFirebaseReady = false;
let firebaseUserId = null;

// Charger Firebase
function loadFirebase() {
    addSyncHistoryEntry('🔄 Chargement de Firebase...');
    
    // Charger les scripts Firebase
    const scripts = [
        'https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js',
        'https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js'
    ];
    
    let scriptsLoaded = 0;
    
    scripts.forEach(src => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = () => {
            scriptsLoaded++;
            if (scriptsLoaded === scripts.length) {
                initFirebase();
            }
        };
        script.onerror = () => {
            console.error('Erreur chargement Firebase:', src);
            addSyncHistoryEntry('❌ Erreur chargement Firebase');
        };
        document.head.appendChild(script);
    });
}

function initFirebase() {
    try {
        // Initialiser Firebase
        if (typeof firebase !== 'undefined') {
            firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
            
            // Générer un ID utilisateur unique
            firebaseUserId = localStorage.getItem('firebaseUserId');
            if (!firebaseUserId) {
                firebaseUserId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('firebaseUserId', firebaseUserId);
            }
            
            isFirebaseReady = true;
            addSyncHistoryEntry('✅ Firebase initialisé avec succès');
            updateSyncUI();
            
            // Première synchronisation
            loadFromFirebase();
            
            // Synchronisation automatique toutes les 2 minutes
            startAutoSync();
            
        } else {
            throw new Error('Firebase non chargé');
        }
    } catch (error) {
        console.error('Erreur initialisation Firebase:', error);
        addSyncHistoryEntry('❌ Erreur initialisation: ' + error.message);
    }
}

// Sauvegarder vers Firebase
function syncToFirebase() {
    if (!isFirebaseReady || !db) {
        console.log('Firebase pas prêt pour la sync');
        return;
    }
    
    const data = {
        rapaces: rapaces,
        entries: entries,
        chasseEntries: chasseEntries,
        affaitageEntries: affaitageEntries,
        currentLocation: currentLocation,
        lastSync: firebase.firestore.FieldValue.serverTimestamp(),
        deviceInfo: {
            userAgent: navigator.userAgent,
            platform: navigator.platform,
            timestamp: new Date().toISOString()
        }
    };
    
    db.collection('users').doc(firebaseUserId).set(data, { merge: true })
        .then(() => {
            addSyncHistoryEntry('📤 Données sauvegardées sur Firebase');
            lastSyncTime = new Date();
            updateSyncUI();
            
            // Mini notification
            if (document.getElementById('sync-notifications').checked) {
                showMiniNotification('☁️ Données synchronisées');
            }
        })
        .catch((error) => {
            console.error('Erreur sauvegarde Firebase:', error);
            addSyncHistoryEntry('❌ Erreur sauvegarde: ' + error.message);
        });
}

// Charger depuis Firebase
function loadFromFirebase() {
    if (!isFirebaseReady || !db) {
        console.log('Firebase pas prêt pour le chargement');
        return;
    }
    
    db.collection('users').doc(firebaseUserId).get()
        .then((doc) => {
            if (doc.exists) {
                const firebaseData = doc.data();
                
                // Comparer les timestamps pour voir quelle version est plus récente
                const localData = localStorage.getItem('rapaces_data');
                let localTimestamp = 0;
                
                if (localData) {
                    try {
                        const parsed = JSON.parse(localData);
                        localTimestamp = parsed.lastSave ? new Date(parsed.lastSave).getTime() : 0;
                    } catch (e) {
                        localTimestamp = 0;
                    }
                }
                
                const firebaseTimestamp = firebaseData.lastSync ? firebaseData.lastSync.toDate().getTime() : 0;
                
                if (firebaseTimestamp > localTimestamp) {
                    // Firebase plus récent, utiliser ces données
                    rapaces = firebaseData.rapaces || [];
                    entries = firebaseData.entries || [];
                    chasseEntries = firebaseData.chasseEntries || [];
                    affaitageEntries = firebaseData.affaitageEntries || [];
                    currentLocation = firebaseData.currentLocation || currentLocation;
                    
                    // Mettre à jour l'interface
                    updateRapaceList();
                    updateRapaceSelects();
                    updateEntryList();
                    updatechasseList();
                    updateAffaitageList();
                    
                    // Sauvegarder localement
                    saveAllData();
                    
                    addSyncHistoryEntry('📥 Données chargées depuis Firebase');
                    if (document.getElementById('sync-notifications').checked) {
                        showMiniNotification('📥 Données mises à jour depuis le cloud');
                    }
                } else {
                    addSyncHistoryEntry('📊 Données locales plus récentes');
                    // Sauvegarder vers Firebase si les données locales sont plus récentes
                    syncToFirebase();
                }
            } else {
                addSyncHistoryEntry('📊 Aucune donnée Firebase, première utilisation');
                // Première utilisation, sauvegarder les données locales vers Firebase
                syncToFirebase();
            }
        })
        .catch((error) => {
            console.error('Erreur chargement Firebase:', error);
            addSyncHistoryEntry('❌ Erreur chargement: ' + error.message);
        });
}

// Fonction de synchronisation manuelle Firebase
function manualFirebaseSync() {
    if (!isFirebaseReady) {
        addSyncHistoryEntry('🔄 Initialisation Firebase...');
        loadFirebase();
        return;
    }
    
    addSyncHistoryEntry('🔄 Synchronisation manuelle lancée...');
    
    // D'abord charger depuis Firebase
    loadFromFirebase();
    
    // Puis sauvegarder vers Firebase
    setTimeout(() => {
        syncToFirebase();
    }, 1000);
}

// Connecter Firebase
function initFirebaseSync() {
    addSyncHistoryEntry('🔄 Connexion à Firebase...');
    loadFirebase();
}

// Déconnecter Firebase
function disconnectFirebase() {
    isFirebaseReady = false;
    db = null;
    stopAutoSync();
    addSyncHistoryEntry('❌ Firebase déconnecté');
    updateSyncUI();
}

// Démarrer la synchronisation automatique
function startAutoSync() {
    stopAutoSync(); // Arrêter l'ancien timer
    
    if (isFirebaseReady && document.getElementById('auto-sync-enabled') && document.getElementById('auto-sync-enabled').checked) {
        syncIntervalId = setInterval(function() {
            loadFromFirebase(); // Vérifier les mises à jour
            syncToFirebase(); // Sauvegarder
        }, 2 * 60 * 1000); // Toutes les 2 minutes
        
        addSyncHistoryEntry('🔄 Synchronisation automatique activée (2 min)');
    }
}

function stopAutoSync() {
    if (syncIntervalId) {
        clearInterval(syncIntervalId);
        syncIntervalId = null;
        addSyncHistoryEntry('⏹️ Synchronisation automatique arrêtée');
    }
}

// Mettre à jour l'interface de synchronisation pour Firebase
function updateSyncUI() {
    const statusEl = document.getElementById('sync-status');
    const detailsEl = document.getElementById('sync-details');
    const lastSyncEl = document.getElementById('last-sync-time');
    const connectBtn = document.getElementById('connect-drive-btn');
    const syncBtn = document.getElementById('manual-sync-btn');
    const disconnectBtn = document.getElementById('disconnect-drive-btn');
    
    if (!statusEl) return; // Pas sur l'onglet sync
    
    if (isFirebaseReady) {
        statusEl.textContent = '✅ Firebase connecté';
        statusEl.style.color = 'green';
        detailsEl.textContent = '🔄 Synchronisation automatique active';
        detailsEl.style.color = 'green';
        
        if (lastSyncTime) {
            lastSyncEl.textContent = 'Dernière sync : ' + lastSyncTime.toLocaleString('fr-FR');
        }
        
        connectBtn.style.display = 'none';
        syncBtn.style.display = 'inline-block';
        disconnectBtn.style.display = 'inline-block';
    } else {
        statusEl.textContent = '❌ Firebase non connecté';
        statusEl.style.color = 'red';
        detailsEl.textContent = 'Cliquez pour activer la synchronisation automatique';
        detailsEl.style.color = '#666';
        lastSyncEl.textContent = 'Dernière sync : Jamais';
        
        connectBtn.style.display = 'inline-block';
        syncBtn.style.display = 'none';
        disconnectBtn.style.display = 'none';
    }
}

function addSyncHistoryEntry(message) {
    var now = new Date();
    var timeStr = now.toLocaleTimeString('fr-FR');
    syncHistory.unshift(timeStr + ' - ' + message);
    
    // Garder seulement les 10 dernières entrées
    if (syncHistory.length > 10) {
        syncHistory = syncHistory.slice(0, 10);
    }
    
    var historyEl = document.getElementById('sync-history');
    if (historyEl) {
        historyEl.innerHTML = syncHistory.map(entry => 
            '<p style="margin: 5px 0; font-size: 14px;">' + entry + '</p>'
        ).join('');
    }
}

function showMiniNotification(message) {
    var notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #4285f4;
        color: white;
        padding: 10px 15px;
        border-radius: 5px;
        z-index: 10000;
        font-size: 14px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    `;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(function() {
        notification.remove();
    }, 3000);
}

// === FONCTIONS EXISTANTES MODIFIÉES ===

// Sauvegarder avec sync Firebase
function saveAllData() {
    try {
        var data = {
            rapaces: rapaces,
            entries: entries,
            chasseEntries: chasseEntries,
            affaitageEntries: affaitageEntries,
            currentLocation: currentLocation,
            lastSave: new Date().toISOString()
        };
        localStorage.setItem('rapaces_data', JSON.stringify(data));
        
        // Synchroniser avec Firebase si connecté et activé
        if (isFirebaseReady && document.getElementById('sync-on-change-enabled') && document.getElementById('sync-on-change-enabled').checked) {
            syncToFirebase();
        }
    } catch (e) {
        console.error('Erreur sauvegarde:', e);
    }
}

// Compatibilité avec les anciennes fonctions Google Drive
function initGoogleDriveSync() {
    initFirebaseSync();
}

function manualSync() {
    manualFirebaseSync();
}

function disconnectDrive() {
    disconnectFirebase();
}

function loadAllData() {
    try {
        var savedData = localStorage.getItem('rapaces_data');
        if (savedData) {
            var data = JSON.parse(savedData);
            rapaces = data.rapaces || [];
            entries = data.entries || [];
            chasseEntries = data.chasseEntries || [];
            affaitageEntries = data.affaitageEntries || [];
            currentLocation = data.currentLocation || "Orthez (64300)";
            return true;
        }
    } catch (e) {
        console.error('Erreur chargement:', e);
    }
    return false;
}

// Météo avec OpenWeatherMap API
function loadWeather() {
    // Essayer d'abord de géolocaliser automatiquement
    if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                loadWeatherByCoords(position.coords.latitude, position.coords.longitude);
            },
            function(error) {
                // Si géolocalisation échoue, utiliser la ville configurée
                loadWeatherByCity(currentLocation);
            },
            { timeout: 5000, maximumAge: 300000 } // 5 min cache
        );
    } else {
        // Pas de géolocalisation, utiliser la ville
        loadWeatherByCity(currentLocation);
    }
}

function loadWeatherByCoords(lat, lon) {
    // Votre clé API OpenWeatherMap
    var apiKey = "b4d68d2dedd2d6d43f81f804010b0673";
    var url = "https://api.openweathermap.org/data/2.5/weather?lat=" + lat + "&lon=" + lon + "&appid=" + apiKey + "&units=metric&lang=fr";
    
    fetch(url)
        .then(response => {
            if (!response.ok) throw new Error('API Error');
            return response.json();
        })
        .then(data => {
            processWeatherData(data);
            // Mettre à jour la localisation détectée
            currentLocation = data.name + " (" + data.sys.country + ")";
            saveAllData();
        })
        .catch(error => {
            console.log("Erreur API coords:", error);
            loadWeatherFallback();
        });
}

function loadWeatherByCity(cityName) {
    // Extraire juste le nom de ville (enlever le code postal)
    var city = cityName.split("(")[0].trim();
    
    // Votre clé API OpenWeatherMap
    var apiKey = "b4d68d2dedd2d6d43f81f804010b0673";
    var url = "https://api.openweathermap.org/data/2.5/weather?q=" + encodeURIComponent(city) + ",FR&appid=" + apiKey + "&units=metric&lang=fr";
    
    fetch(url)
        .then(response => {
            if (!response.ok) throw new Error('API Error');
            return response.json();
        })
        .then(data => {
            processWeatherData(data);
        })
        .catch(error => {
            console.log("Erreur API ville:", error);
            loadWeatherFallback();
        });
}

function processWeatherData(data) {
    // Extraire les données de l'API OpenWeatherMap
    var temp = Math.round(data.main.temp);
    var description = data.weather[0].description;
    var humidity = data.main.humidity;
    var windSpeed = Math.round(data.wind.speed * 3.6); // Convertir m/s en km/h
    var precipitation = 0;
    
    // Calculer les précipitations si disponibles
    if (data.rain && data.rain["1h"]) {
        precipitation = Math.round((data.rain["1h"] / 1) * 100); // Approximation
    } else if (data.snow && data.snow["1h"]) {
        precipitation = Math.round((data.snow["1h"] / 1) * 100);
    } else if (data.clouds && data.clouds.all > 80) {
        precipitation = Math.floor(data.clouds.all / 4); // Estimation basée sur la couverture nuageuse
    }
    
    // Limiter les précipitations à 100%
    precipitation = Math.min(precipitation, 100);
    
    // Choisir l'icône selon les conditions
    var icon = getWeatherIcon(data.weather[0].main, data.weather[0].id);
    
    // Formatter la météo complète
    var detailedWeather = temp + "°C\n" +
                         "Précipitations : " + precipitation + "%\n" +
                         "Humidité : " + humidity + "%\n" +
                         "Vent : " + windSpeed + " km/h";
    
    currentWeather = description + ", " + detailedWeather + " à " + currentLocation;
    
    var weatherElement = document.getElementById('weather-info');
    if (weatherElement) {
        weatherElement.innerHTML = icon + " <strong>" + description.charAt(0).toUpperCase() + description.slice(1) + "</strong><br>" +
                                  "<span style='font-size: 12px; line-height: 1.4;'>" +
                                  temp + "°C<br>" +
                                  "Précipitations : " + precipitation + "%<br>" +
                                  "Humidité : " + humidity + "%<br>" +
                                  "Vent : " + windSpeed + " km/h<br>" +
                                  "<em>" + currentLocation + "</em>" +
                                  "</span>";
    }
}

function getWeatherIcon(main, id) {
    // Mapper les conditions OpenWeatherMap vers des emojis
    switch (main) {
        case "Clear":
            return "☀️";
        case "Clouds":
            return id < 803 ? "⛅" : "☁️";
        case "Rain":
            return "🌧️";
        case "Drizzle":
            return "🌦️";
        case "Thunderstorm":
            return "⛈️";
        case "Snow":
            return "❄️";
        case "Mist":
        case "Fog":
            return "🌫️";
        case "Haze":
            return "🌤️";
        default:
            return "🌤️";
    }
}

function loadWeatherFallback() {
    // Météo simulée si l'API ne fonctionne pas
    var now = new Date();
    var month = now.getMonth();
    var hour = now.getHours();
    
    var conditions;
    
    if (month >= 2 && month <= 4) { // Printemps
        conditions = [
            {desc: "ensoleillé", temp: 15 + Math.floor(Math.random() * 8), icon: "☀️", precipitation: 0 + Math.floor(Math.random() * 20), humidity: 45 + Math.floor(Math.random() * 20)},
            {desc: "partiellement nuageux", temp: 12 + Math.floor(Math.random() * 7), icon: "⛅", precipitation: 10 + Math.floor(Math.random() * 30), humidity: 50 + Math.floor(Math.random() * 25)},
            {desc: "nuageux", temp: 10 + Math.floor(Math.random() * 6), icon: "☁️", precipitation: 20 + Math.floor(Math.random() * 40), humidity: 60 + Math.floor(Math.random() * 25)},
            {desc: "pluvieux", temp: 8 + Math.floor(Math.random() * 8), icon: "🌧️", precipitation: 70 + Math.floor(Math.random() * 30), humidity: 75 + Math.floor(Math.random() * 20)}
        ];
    } else if (month >= 5 && month <= 7) { // Été
        conditions = [
            {desc: "ensoleillé", temp: 20 + Math.floor(Math.random() * 10), icon: "☀️", precipitation: 0 + Math.floor(Math.random() * 10), humidity: 35 + Math.floor(Math.random() * 20)},
            {desc: "très ensoleillé", temp: 25 + Math.floor(Math.random() * 8), icon: "☀️", precipitation: 0 + Math.floor(Math.random() * 5), humidity: 30 + Math.floor(Math.random() * 15)},
            {desc: "chaud", temp: 28 + Math.floor(Math.random() * 7), icon: "🌡️", precipitation: 0 + Math.floor(Math.random() * 15), humidity: 25 + Math.floor(Math.random() * 20)},
            {desc: "orageux", temp: 22 + Math.floor(Math.random() * 6), icon: "⛈️", precipitation: 60 + Math.floor(Math.random() * 40), humidity: 70 + Math.floor(Math.random() * 25)}
        ];
    } else if (month >= 8 && month <= 10) { // Automne
        conditions = [
            {desc: "doux", temp: 12 + Math.floor(Math.random() * 10), icon: "🍂", precipitation: 10 + Math.floor(Math.random() * 30), humidity: 50 + Math.floor(Math.random() * 25)},
            {desc: "nuageux", temp: 8 + Math.floor(Math.random() * 8), icon: "☁️", precipitation: 25 + Math.floor(Math.random() * 45), humidity: 65 + Math.floor(Math.random() * 25)},
            {desc: "pluvieux", temp: 6 + Math.floor(Math.random() * 10), icon: "🌧️", precipitation: 70 + Math.floor(Math.random() * 30), humidity: 80 + Math.floor(Math.random() * 15)},
            {desc: "brumeux", temp: 5 + Math.floor(Math.random() * 8), icon: "🌫️", precipitation: 30 + Math.floor(Math.random() * 40), humidity: 85 + Math.floor(Math.random() * 10)}
        ];
    } else { // Hiver
        conditions = [
            {desc: "frais", temp: 2 + Math.floor(Math.random() * 8), icon: "🌤️", precipitation: 15 + Math.floor(Math.random() * 35), humidity: 65 + Math.floor(Math.random() * 25)},
            {desc: "nuageux", temp: 0 + Math.floor(Math.random() * 10), icon: "☁️", precipitation: 30 + Math.floor(Math.random() * 50), humidity: 70 + Math.floor(Math.random() * 25)},
            {desc: "pluvieux", temp: 3 + Math.floor(Math.random() * 8), icon: "🌧️", precipitation: 75 + Math.floor(Math.random() * 25), humidity: 85 + Math.floor(Math.random() * 10)},
            {desc: "froid", temp: -2 + Math.floor(Math.random() * 8), icon: "❄️", precipitation: 40 + Math.floor(Math.random() * 40), humidity: 80 + Math.floor(Math.random() * 15)}
        ];
    }
    
    var weather = conditions[Math.floor(Math.random() * conditions.length)];
    
    // Ajuster selon l'heure
    if (hour < 8 || hour > 20) {
        weather.temp = Math.max(weather.temp - 3, -5);
        weather.humidity = Math.min(weather.humidity + 10, 95);
    }
    
    // Générer vitesse du vent
    var windSpeed = 3 + Math.floor(Math.random() * 15);
    
    var detailedWeather = weather.temp + "°C\n" +
                         "Précipitations : " + weather.precipitation + "%\n" +
                         "Humidité : " + weather.humidity + "%\n" +
                         "Vent : " + windSpeed + " km/h";
    
    currentWeather = weather.desc + ", " + detailedWeather + " à " + currentLocation;
    
    var weatherElement = document.getElementById('weather-info');
    if (weatherElement) {
        weatherElement.innerHTML = weather.icon + " <strong>" + weather.desc.charAt(0).toUpperCase() + weather.desc.slice(1) + "</strong><br>" +
                                  "<span style='font-size: 12px; line-height: 1.4;'>" +
                                  weather.temp + "°C<br>" +
                                  "Précipitations : " + weather.precipitation + "%<br>" +
                                  "Humidité : " + weather.humidity + "%<br>" +
                                  "Vent : " + windSpeed + " km/h<br>" +
                                  "<em>" + currentLocation + " (simulé)</em>" +
                                  "</span>";
    }
}

function refreshWeather() {
    loadWeather();
}

function changeLocation() {
    var newLocation = prompt("Entrez votre localisation :", currentLocation);
    if (newLocation && newLocation.trim()) {
        currentLocation = newLocation.trim();
        saveAllData();
        loadWeather();
    }
}

// Calcul de l'âge
function calculateAge(birthDate) {
    var today = new Date();
    var birth = new Date(birthDate);
    var age = today.getFullYear() - birth.getFullYear();
    var monthDiff = today.getMonth() - birth.getMonth();
    
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
        age--;
    }
    
    return age;
}

// Onglets
function showTab(tabName) {
    var contents = document.querySelectorAll('.tab-content');
    for (var i = 0; i < contents.length; i++) {
        contents[i].classList.remove('active');
    }
    
    var tabs = document.querySelectorAll('.tab');
    for (var i = 0; i < tabs.length; i++) {
        tabs[i].classList.remove('active');
    }
    
    