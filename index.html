<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>index_ok_synced_with_backups – Firebase Sync Debug</title>
</head>
<body>
  <h1>Gestionnaire de Rapaces — Firebase Sync avec Config Intégrée</h1>
  <div id="status">Chargement…</div>
  <pre id="log"></pre>

  <script type="module">
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { 
      getFirestore, addDoc, collection, serverTimestamp,
      getDocs, query, orderBy, limit
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const firebaseConfig = {'apiKey': 'AIzaSyBo8WFyLVoe9NtQiFCv7JfjCJg5pdzz7Hk', 'authDomain': 'rapace2-e7641.firebaseapp.com', 'projectId': 'rapace2-e7641', 'storageBucket': 'rapace2-e7641.firebasestorage.app', 'messagingSenderId': '477211338737', 'appId': '1:477211338737:web:ad71cfeea6e0d1ffa2c650', 'measurementId': 'G-76TRDY2KFM'};

    const $ = (id) => document.getElementById(id);
    function log(...args) { $.log.textContent += args.join(" ") + "\n"; console.log(...args); }
    function setStatus(msg) { $.status.textContent = msg; }

    let app, db, auth;
    function init() {
      app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);
    }

    async function testSync() {
      try {
        init();
        setStatus("Connexion...");
        const userReady = new Promise((resolve, reject) => {
          const off = onAuthStateChanged(auth, async (user) => {
            if (!user) await signInAnonymously(auth);
            off();
            resolve(auth.currentUser);
          }, reject);
        });
        const user = await userReady;
        log("Auth OK uid:", user.uid);

        await addDoc(collection(db, "__healthcheck__"), { when: serverTimestamp(), ua: navigator.userAgent });
        log("Écriture OK (__healthcheck__)");

        const q = query(collection(db, "__healthcheck__"), orderBy("when","desc"), limit(1));
        const snap = await getDocs(q);
        if (!snap.empty) {
          log("Lecture OK", JSON.stringify(snap.docs[0].data()));
          setStatus("✅ Sync Firestore OK");
        } else {
          setStatus("⚠️ Lecture vide (vérifiez règles Firestore)");
        }
      } catch(e) {
        console.error(e);
        log("Erreur:", e.message || e);
        setStatus("❌ Erreur: " + (e.code || e.message));
      }
    }

    setStatus("Config chargée, test en cours...");
    testSync();
  </script>
</body>
</html>