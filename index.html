
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Appli Rapaces - Synced</title>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; }
    header { background:#333; color:#fff; padding:10px; text-align:center; }
    nav { background:#444; color:#fff; display:flex; }
    nav button { flex:1; padding:10px; border:none; background:#444; color:#fff; cursor:pointer; }
    nav button.active { background:#666; }
    section { display:none; padding:20px; }
    section.active { display:block; }
    .btn { padding:6px 12px; margin:5px; }
  </style>
</head>
<body>
  <header>
    <h1>Appli Rapaces (Synced)</h1>
  </header>
  <nav>
    <button onclick="showTab('tab1')">Rapaces</button>
    <button onclick="showTab('tab2')">Chasse</button>
    <button onclick="showTab('tab3')">Reproduction</button>
    <button onclick="showTab('tabSync')">Sync</button>
  </nav>

  <section id="tab1" class="active">
    <h2>Gestion des Rapaces</h2>
    <p>(Ton contenu rapaces ici...)</p>
  </section>
  <section id="tab2">
    <h2>Chasse</h2>
    <p>(Ton contenu chasse ici...)</p>
  </section>
  <section id="tab3">
    <h2>Reproduction</h2>
    <p>(Ton contenu reproduction ici...)</p>
  </section>
  <section id="tabSync">
    <h2>Synchronisation</h2>
    <p>ID Utilisateur Firebase : <span id="userIdLabel"></span></p>
    <button class="btn" onclick="exportJSON()">Exporter JSON</button>
    <button class="btn" onclick="importJSON()">Importer JSON</button>
    <div id="syncLog" style="margin-top:15px; font-size:0.9em; color:#555; max-height:200px; overflow:auto; border:1px solid #ccc; padding:5px;"></div>
  </section>

  <script>
    function showTab(id) {
      document.querySelectorAll('section').forEach(sec => sec.classList.remove('active'));
      document.getElementById(id).classList.add('active');
      document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
    }

    // --- CONFIG FIREBASE (à personnaliser avec tes vraies clés) ---
    var firebaseConfig = {
      apiKey: "XXX",
      authDomain: "XXX.firebaseapp.com",
      projectId: "XXX",
      storageBucket: "XXX.appspot.com",
      messagingSenderId: "XXX",
      appId: "XXX"
    };

    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }
    var db = firebase.firestore();

    // --- Fonctions de sync ---
    function logSync(msg) {
      let div = document.getElementById('syncLog');
      let p = document.createElement('div');
      p.textContent = new Date().toLocaleTimeString() + " - " + msg;
      div.prepend(p);
    }

    async function downloadFromFirebase() {
      const id = localStorage.getItem('firebaseUserId') || '1214';
      document.getElementById('userIdLabel').textContent = id;
      try {
        const doc = await db.collection('users').doc(id).get();
        if (doc.exists) {
          const cloud = doc.data().localStorageDump || {};
          for (const [k,v] of Object.entries(cloud)) {
            localStorage.setItem(k,v);
          }
          logSync("Download réussi ("+Object.keys(cloud).length+" clés)");
        } else {
          logSync("Aucun doc trouvé, rien à télécharger.");
        }
      } catch(e) {
        console.error(e);
        logSync("Erreur download: "+e);
      }
    }

    async function safeUpload() {
      const id = localStorage.getItem('firebaseUserId') || '1214';
      document.getElementById('userIdLabel').textContent = id;
      const now = new Date().toISOString();
      const dump = {};
      for (let i=0;i<localStorage.length;i++) {
        const k = localStorage.key(i);
        dump[k] = localStorage.getItem(k);
      }
      try {
        // Backup
        await db.collection('users').doc(id).collection('backups').doc(String(Date.now()))
          .set({ at: now, localStorageDump: dump });
        // Merge
        const ref = db.collection('users').doc(id);
        const snap = await ref.get();
        const cloud = snap.exists ? (snap.data().localStorageDump || {}) : {};
        const merged = { ...cloud, ...dump };
        await ref.set({ lastSync: now, localStorageDump: merged }, { merge:true });
        logSync("Upload réussi ("+Object.keys(merged).length+" clés)");
      } catch(e) {
        console.error(e);
        logSync("Erreur upload: "+e);
      }
    }

    // --- Export / Import JSON ---
    function exportJSON() {
      const dump = {};
      for (let i=0;i<localStorage.length;i++) {
        const k=localStorage.key(i);
        dump[k]=localStorage.getItem(k);
      }
      const blob = new Blob([JSON.stringify(dump,null,2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'rapaces-backup-'+new Date().toISOString().slice(0,10)+'.json';
      a.click();
    }

    function importJSON() {
      const inp = document.createElement('input');
      inp.type='file'; inp.accept='.json,application/json';
      inp.onchange = e => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = evt => {
          try {
            const dump = JSON.parse(evt.target.result);
            for (const [k,v] of Object.entries(dump)) {
              localStorage.setItem(k,v);
            }
            alert('Import réussi');
            location.reload();
          } catch(err) { alert('Erreur import: '+err); }
        };
        reader.readAsText(file);
      };
      inp.click();
    }

    // --- Auto sync ---
    window.addEventListener('load', async () => {
      await downloadFromFirebase();
      setInterval(safeUpload, 30000);
    });
  </script>
</body>
</html>
