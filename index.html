<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>index_ok_synced_with_backups ‚Äì Firebase Sync Debug</title>
  <style>
    :root { --bg:#0b1020; --fg:#eaeefb; --muted:#94a3b8; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; }
    body { margin:0; font: 15px/1.5 system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#0b1020; color:#eaeefb; }
    header { padding:16px 20px; border-bottom:1px solid #1f2937; background: #0e1428; position: sticky; top:0; z-index:2; }
    h1 { margin:0; font-size:18px; }
    main { padding: 20px; max-width: 980px; margin: 0 auto; }
    section { background:#0e1428; border:1px solid #1f2937; border-radius:12px; padding:16px; margin-bottom:16px; }
    code, pre { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .btn { appearance:none; border:1px solid #334155; background:#111827; color:#e5e7eb; padding:8px 12px; border-radius:10px; cursor:pointer; }
    .btn:hover { background:#0b1220; }
    .pill { display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; }
    .ok { background: #052e1a; border: 1px solid #14532d; color:#86efac; }
    .warn { background: #2a1b00; border: 1px solid #92400e; color:#fcd34d; }
    .err { background: #2a0b0b; border: 1px solid #7f1d1d; color:#fecaca; }
    #status { position: fixed; right: 14px; bottom: 14px; background:#0b1220; border:1px solid #334155; border-radius:12px; padding:12px 14px; z-index:9999; min-width: 260px; }
    #status b { display:block; margin-bottom:4px; }
    .small { color: var(--muted); font-size: 12px; }
    .log { white-space: pre-wrap; background:#0b1220; border:1px dashed #334155; padding:10px; border-radius:8px; max-height:180px; overflow:auto; }
    .kbd { border:1px solid #334155; padding:1px 6px; border-radius:6px; background:#0b1220; }
    .muted { color:#94a3b8; }
  </style>
</head>
<body>
  <header>
    <h1>Gestionnaire de Rapaces ‚Äî Patch de synchronisation Firebase</h1>
    <div class="small muted">Ce fichier aide √† valider et r√©parer la sync (Auth + Firestore). Il peut remplacer temporairement votre index.</div>
  </header>

  <main>
    <section>
      <h2>1) Renseigner votre <code>firebaseConfig</code></h2>
      <p>Mettez les valeurs de votre projet Firebase (<code>apiKey</code>, <code>authDomain</code>, <code>projectId</code>, <code>storageBucket</code>, <code>messagingSenderId</code>, <code>appId</code>).</p>
      <details>
        <summary>O√π trouver ces valeurs ?</summary>
        <p>Dans <em>Console Firebase ‚Üí ‚öôÔ∏è Param√®tres du projet ‚Üí Vos applications Web</em>. Vous pouvez partager ces valeurs ici, elles sont publiques c√¥t√© client.</p>
      </details>
      <div class="row">
        <button id="btn-edit-config" class="btn">‚úèÔ∏è Coller mon firebaseConfig</button>
        <button id="btn-test" class="btn">üß™ Lancer les tests (Auth + Firestore)</button>
        <button id="btn-listen" class="btn">üëÇ √âcouter une collection</button>
      </div>
      <p class="small muted">Astuce: si vous aviez des restrictions d‚ÄôAPI key, autorisez <code>https://sulikan1214.github.io/*</code> et <code>http://localhost:*</code>.</p>
    </section>

    <section>
      <h2>2) Journal</h2>
      <div id="log" class="log" aria-live="polite"></div>
    </section>

    <section>
      <h2>3) Zone d‚Äôint√©gration de votre UI</h2>
      <p class="small muted">Vous pouvez coller ici votre HTML d‚Äôapplication pendant les tests.</p>
      <div id="app-slot" style="padding:8px;border:1px dashed #334155;border-radius:8px;"></div>
    </section>
  </main>

  <div id="status" role="status" aria-live="polite">
    <b>√âtat:</b>
    <div id="status-text" class="pill warn">En attente de configuration</div>
    <div id="status-sub" class="small"></div>
  </div>

  <script type="module">
    // ---------------------------
    // Imports Firebase (SDK v10+)
    // ---------------------------
    import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
    import { 
      getFirestore, addDoc, collection, serverTimestamp,
      getDocs, query, orderBy, limit, onSnapshot 
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    // -------------------------------------------
    // 1) Renseigner votre configuration Firebase
    // -------------------------------------------
    // ‚úèÔ∏è OPTION A: remplacez directement l'objet ci-dessous par vos valeurs
    let firebaseConfig = {
      // apiKey: "AI...",
      // authDomain: "xxx.firebaseapp.com",
      // projectId: "xxx",
      // storageBucket: "xxx.appspot.com",
      // messagingSenderId: "000000000000",
      // appId: "1:000000000000:web:xxxxxxxxxxxxxxxxxxxxxx"
    };

    // ‚úèÔ∏è OPTION B: si vous utilisez window.__FIREBASE_CONFIG, laissez l'objet vide ci-dessus
    if (!firebaseConfig.apiKey && window.__FIREBASE_CONFIG) {
      firebaseConfig = window.__FIREBASE_CONFIG;
    }

    // UI helpers
    const $ = (sel) => document.querySelector(sel);
    function log(...args) {
      const el = $("#log");
      const line = document.createElement("div");
      line.textContent = args.map(a => (typeof a === "object" ? JSON.stringify(a) : String(a))).join(" ");
      el.appendChild(line);
      el.scrollTop = el.scrollHeight;
      console.log(...args);
    }
    function setStatus(text, cls = "warn", sub = "") {
      $("#status-text").textContent = text;
      $("#status-text").className = "pill " + cls;
      $("#status-sub").textContent = sub;
    }

    // Bouton pour coller la config facilement
    $("#btn-edit-config").addEventListener("click", async () => {
      const current = JSON.stringify(firebaseConfig, null, 2);
      const input = prompt("Collez votre objet firebaseConfig (JSON):", current);
      try {
        if (input) {
          firebaseConfig = JSON.parse(input);
          log("Config mise √† jour ‚úÖ");
          setStatus("Config d√©finie", "ok", "Cliquez sur 'Lancer les tests'");
        }
      } catch(e) {
        log("‚ö†Ô∏è JSON invalide:", e.message);
        setStatus("Config invalide", "err", e.message);
      }
    });

    // Initialisation s√ªre (√©vite double init)
    let app, db, auth;
    function ensureInit() {
      if (!firebaseConfig.apiKey) {
        setStatus("Config manquante", "warn", "Cliquez sur 'Coller mon firebaseConfig'");
        throw new Error("firebaseConfig manquant");
      }
      app = getApps().length ? getApps()[0] : initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);
      return { app, db, auth };
    }

    // Test complet (Auth + Firestore)
    async function runTests() {
      try {
        ensureInit();
        setStatus("Connexion‚Ä¶", "warn");

        // Auth anonyme si pas connect√©
        const userReady = new Promise((resolve, reject) => {
          const off = onAuthStateChanged(auth, async (user) => {
            if (!user) {
              try {
                await signInAnonymously(auth);
              } catch (e) {
                off();
                reject(e);
                return;
              }
            } else {
              off();
              resolve(user);
            }
          }, reject);
        });
        const user = await userReady;
        log("Auth OK ‚úÖ uid:", user?.uid || auth.currentUser?.uid);

        // √âcriture d'un ping
        await addDoc(collection(db, "__healthcheck__"), { when: serverTimestamp(), ua: navigator.userAgent });
        log("√âcriture OK ‚úÖ (__healthcheck__)");

        // Lecture du dernier ping
        const q = query(collection(db, "__healthcheck__"), orderBy("when","desc"), limit(1));
        const snap = await getDocs(q);
        if (!snap.empty) {
          log("Lecture OK ‚úÖ", snap.docs[0].data());
          setStatus("‚úÖ Sync Firestore OK", "ok", "Auth + RW op√©rationnels");
        } else {
          setStatus("‚ö†Ô∏è Lecture vide", "warn", "V√©rifiez vos r√®gles Firestore");
        }
      } catch (e) {
        console.error(e);
        const code = e.code || e.message || String(e);
        log("‚ùå Erreur:", code);
        setStatus("‚ùå Erreur", "err", code);
      }
    }

    // √âcoute d'une collection (d√©mo)
    function startListen() {
      try {
        ensureInit();
        const col = prompt("Nom de la collection √† √©couter ?", "raptors");
        if (!col) return;
        const off = onSnapshot(collection(db, col), {
          next: (snap) => {
            log(`üëÇ ${col}: ${snap.size} documents`);
            setStatus("√âcoute active", "ok", `${col}: ${snap.size} docs`);
          },
          error: (err) => {
            log("onSnapshot error:", err.code || err.message);
            setStatus("‚ùå onSnapshot", "err", err.code || err.message);
          }
        });
        log("√âcoute d√©marr√©e. Fermez l‚Äôonglet pour arr√™ter.");
      } catch (e) {
        log("√âchec √©coute:", e.message);
        setStatus("‚ùå √âchec √©coute", "err", e.message);
      }
    }

    $("#btn-test").addEventListener("click", runTests);
    $("#btn-listen").addEventListener("click", startListen);

    // Message initial
    if (firebaseConfig.apiKey) {
      setStatus("Config d√©tect√©e", "ok", "Cliquez sur 'Lancer les tests'");
    } else {
      setStatus("En attente de configuration", "warn", "Cliquez sur 'Coller mon firebaseConfig'");
    }
  </script>
</body>
</html>
