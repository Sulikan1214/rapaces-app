<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionnaire de Rapaces</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'><circle cx='100' cy='100' r='95' fill='white' stroke='%23333' stroke-width='10'/><g transform='translate(100,100) scale(0.8)'><path d='M-60,-20 Q-40,-60 0,-40 Q40,-60 60,-20 Q50,-40 20,-30 Q10,-50 0,-35 Q-10,-50 -20,-30 Q-50,-40 -60,-20' fill='%23333'/><circle cx='-25' cy='-25' r='5' fill='%23333'/><path d='M-10,-10 Q0,0 10,-10 Q15,-5 5,-5 Q-5,-5 -10,-10' fill='%23333'/><path d='M-40,10 Q-20,20 0,10 Q20,20 40,10 Q30,30 0,25 Q-30,30 -40,10' fill='%23333'/><path d='M-30,-10 Q-20,0 -10,-10 M10,-10 Q20,0 30,-10' stroke='%23333' stroke-width='2' fill='none'/><path d='M-70,-30 Q-50,-10 -30,-20 M30,-20 Q50,-10 70,-30' stroke='%23333' stroke-width='3' fill='none'/><path d='M-60,20 Q-40,40 -20,30 M20,30 Q40,40 60,20' stroke='%23333' stroke-width='3' fill='none'/><circle cx='45' cy='45' r='2' fill='%23333'/><circle cx='-35' cy='55' r='1.5' fill='%23333'/><rect x='-15' y='35' width='4' height='2' fill='%23333'/></g></svg>" type="image/svg+xml">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            text-align: center;
            padding: 30px 20px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .weather-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            margin-top: 15px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            min-width: 120px;
            padding: 15px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            color: #2a5298;
            border-bottom-color: #2a5298;
            background: white;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            align-items: end;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2a5298;
        }

        button {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button.btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        button.btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #545b62 100%);
        }

        button.btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #212529;
        }

        .entry-item {
            background: #f0f4f8;
            margin: 15px 0;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #2a5298;
        }

        .entry-item .date {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .entry-item .content {
            color: #333;
        }

        .rapace-card {
            background: #f0f4f8;
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
            border: 2px solid #e3f2fd;
            position: relative;
        }

        .rapace-card h3 {
            color: #1e3c72;
            margin-bottom: 10px;
        }

        .rapace-actions {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
        }

        .rapace-actions button {
            padding: 8px 12px;
            font-size: 12px;
        }

        .weather-info {
            color: #e3f2fd;
            font-size: 14px;
        }

        .conditional-fields {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #f0f4f8;
            border-radius: 8px;
        }

        .conditional-fields.active {
            display: block;
        }

        .rating-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .rating-group input[type="radio"] {
            width: auto;
        }

        .hunt-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .hunt-item {
            background: #f0f4f8;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #e3f2fd;
        }

        .checkbox-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
        }

        .day-card {
            background: #f0f4f8;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #2a5298;
        }

        .day-card h4 {
            color: #1e3c72;
            margin-bottom: 10px;
        }

        .day-navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-card h3 {
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
            <svg width="80" height="80" viewBox="0 0 200 200" style="filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));">
                <circle cx="100" cy="100" r="95" fill="white" stroke="#1e3c72" stroke-width="8"/>
                <g transform="translate(100,100) scale(0.7)">
                    <path d="M-70,-30 Q-50,-70 0,-50 Q50,-70 70,-30 Q60,-50 30,-40 Q15,-65 0,-45 Q-15,-65 -30,-40 Q-60,-50 -70,-30" fill="#1e3c72"/>
                    <circle cx="-30" cy="-30" r="8" fill="white"/>
                    <circle cx="-28" cy="-32" r="5" fill="#1e3c72"/>
                    <circle cx="-26" cy="-34" r="2" fill="white"/>
                    <path d="M-15,-15 Q5,5 15,-15 Q20,-10 10,-8 Q-10,-8 -15,-15" fill="#2a5298"/>
                    <path d="M-50,15 Q-30,30 0,15 Q30,30 50,15 Q40,40 0,35 Q-40,40 -50,15" fill="#1e3c72"/>
                </g>
            </svg>
            <div>
                <h1>ü¶Ö Gestionnaire de Rapaces</h1>
                <p>Suivi quotidien de vos compagnons ail√©s</p>
            </div>
        </div>
        <div class="weather-controls">
            <p id="weather-info" class="weather-info">üå¶Ô∏è Chargement m√©t√©o...</p>
            <button onclick="refreshWeather()" style="padding: 8px 16px; font-size: 12px;">üîÑ</button>
            <button onclick="changeLocation()" style="padding: 8px 16px; font-size: 12px;">üìç</button>
        </div>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="showTab('gestion')">Gestion</button>
        <button class="tab" onclick="showTab('suivi')">Suivi</button>
        <button class="tab" onclick="showTab('chasse')">Chasse</button>
        <button class="tab" onclick="showTab('affaitage')">Affaitage</button>
        <button class="tab" onclick="showTab('stats')">Statistiques</button>
    </div>

    <div id="gestion" class="tab-content active">
        <h2>Ajouter un Rapace</h2>
        <div class="form-group">
            <label for="rapace-name">Nom du rapace :</label>
            <input type="text" id="rapace-name" placeholder="Ex: Aigle royal">
        </div>
        <div class="form-group">
            <label for="rapace-species">Esp√®ce :</label>
            <input type="text" id="rapace-species" placeholder="Ex: Aquila chrysaetos">
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="rapace-birthdate">Date de naissance :</label>
                <input type="date" id="rapace-birthdate">
            </div>
            <div class="form-group">
                <label for="rapace-sex">Sexe :</label>
                <select id="rapace-sex">
                    <option value="forme">Forme</option>
                    <option value="tiercelet">Tiercelet</option>
                </select>
            </div>
        </div>
        <button onclick="addRapace()">Ajouter le Rapace</button>

        <h2 style="margin-top: 40px;">Mes Rapaces</h2>
        <div id="rapace-list"></div>
    </div>

    <div id="suivi" class="tab-content">
        <h2>Suivi Quotidien</h2>
        <div class="form-group">
            <label for="rapace-select">S√©lectionner un rapace :</label>
            <select id="rapace-select" onchange="updateEntryList()">
                <option value="">Choisir un rapace</option>
            </select>
        </div>
        <div class="form-group">
            <label for="event-type">Type d'√©v√©nement :</label>
            <select id="event-type" onchange="showEventFields()">
                <option value="nourriture">Nourriture</option>
                <option value="vol">Vol</option>
                <option value="comportement">Comportement</option>
                <option value="sante">Sant√©</option>
                <option value="entrainement">Entra√Ænement</option>
            </select>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="event-date">Date :</label>
                <input type="date" id="event-date">
            </div>
            <div class="form-group">
                <label for="event-time">Heure :</label>
                <input type="time" id="event-time">
            </div>
        </div>
        
        <div class="form-group">
            <label for="event-notes">Notes :</label>
            <textarea id="event-notes" rows="3" placeholder="Observations..."></textarea>
        </div>

        <!-- Champs conditionnels pour Nourriture -->
        <div id="nourriture-fields" class="conditional-fields active">
            <div class="form-row">
                <div class="form-group">
                    <label for="poids-avant">Poids avant (g) :</label>
                    <input type="number" id="poids-avant" min="0">
                </div>
                <div class="form-group">
                    <label for="poids-apres">Poids apr√®s (g) :</label>
                    <input type="number" id="poids-apres" min="0">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="detail-nourriture">Menu :</label>
                    <select id="detail-nourriture">
                        <option value="poussin">Poussin</option>
                        <option value="caille">Caille</option>
                        <option value="pigeon">Pigeon</option>
                        <option value="lapin">Lapin</option>
                        <option value="lievre">Li√®vre</option>
                        <option value="canard">Canard</option>
                        <option value="faisan">Faisan</option>
                        <option value="perdrix">Perdrix</option>
                        <option value="boeuf">B≈ìuf</option>
                        <option value="autre">Autre</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="quantite-nourriture">Quantit√© :</label>
                    <input type="text" id="quantite-nourriture" placeholder="Ex: 200g">
                </div>
            </div>
        </div>

        <!-- Champs conditionnels pour Vol -->
        <div id="vol-fields" class="conditional-fields">
            <div class="form-group">
                <label for="type-vol">Type de vol :</label>
                <select id="type-vol">
                    <option value="suite">Suit√©</option>
                    <option value="chasse">Chasse</option>
                    <option value="entrainement">Entra√Ænement</option>
                </select>
            </div>
        </div>

        <!-- Champs conditionnels pour Comportement -->
        <div id="comportement-fields" class="conditional-fields">
            <div class="form-group">
                <label>R√©activit√© (1-5) :</label>
                <div class="rating-group">
                    <input type="radio" id="react1" name="reactivite" value="1">
                    <label for="react1">1</label>
                    <input type="radio" id="react2" name="reactivite" value="2">
                    <label for="react2">2</label>
                    <input type="radio" id="react3" name="reactivite" value="3">
                    <label for="react3">3</label>
                    <input type="radio" id="react4" name="reactivite" value="4">
                    <label for="react4">4</label>
                    <input type="radio" id="react5" name="reactivite" value="5">
                    <label for="react5">5</label>
                </div>
            </div>
        </div>

        <!-- Champs conditionnels pour Sant√© -->
        <div id="sante-fields" class="conditional-fields">
            <div class="form-group">
                <label for="etat-sante">√âtat :</label>
                <select id="etat-sante">
                    <option value="ras">RAS</option>
                    <option value="pb">PB</option>
                </select>
            </div>
        </div>

        <!-- Champs conditionnels pour Entra√Ænement -->
        <div id="entrainement-fields" class="conditional-fields">
            <div class="form-group">
                <label for="type-entrainement">Type d'entra√Ænement :</label>
                <select id="type-entrainement">
                    <option value="filiere">Fili√®re</option>
                    <option value="charriot">Charriot</option>
                    <option value="rc-voiture">RC Voiture</option>
                    <option value="drone">Drone</option>
                    <option value="vivant">Vivant</option>
                    <option value="corde">Corde</option>
                    <option value="ascendant">Ascendant</option>
                </select>
            </div>
        </div>

        <button onclick="addEntry()">Ajouter l'Entr√©e</button>

        <h2 style="margin-top: 40px;">Historique R√©cent</h2>
        <div id="entry-list"></div>
    </div>

    <div id="chasse" class="tab-content">
        <h2>Registre de Chasse</h2>
        <div class="form-group">
            <label for="chasse-rapace">Rapace :</label>
            <select id="chasse-rapace">
                <option value="">Choisir un rapace</option>
            </select>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="chasse-date">Date :</label>
                <input type="date" id="chasse-date">
            </div>
            <div class="form-group">
                <label for="chasse-time">Heure :</label>
                <input type="time" id="chasse-time">
            </div>
        </div>
        
        <div class="hunt-grid">
            <div class="hunt-item">
                <label for="chasse-faisan">Faisan :</label>
                <input type="number" id="chasse-faisan" min="0" max="10" value="0">
            </div>
            <div class="hunt-item">
                <label for="chasse-perdrix">Perdrix :</label>
                <input type="number" id="chasse-perdrix" min="0" max="10" value="0">
            </div>
            <div class="hunt-item">
                <label for="chasse-lapin">Lapin :</label>
                <input type="number" id="chasse-lapin" min="0" max="10" value="0">
            </div>
            <div class="hunt-item">
                <label for="chasse-lievre">Li√®vre :</label>
                <input type="number" id="chasse-lievre" min="0" max="10" value="0">
            </div>
            <div class="hunt-item">
                <label for="chasse-canard">Canard :</label>
                <input type="number" id="chasse-canard" min="0" max="10" value="0">
            </div>
            <div class="hunt-item">
                <label for="chasse-oie">Oie :</label>
                <input type="number" id="chasse-oie" min="0" max="10" value="0">
            </div>
            <div class="hunt-item">
                <label for="chasse-autre">Autre :</label>
                <input type="number" id="chasse-autre" min="0" max="10" value="0">
            </div>
        </div>
        
        <div class="form-group">
            <label for="chasse-notes">Notes :</label>
            <textarea id="chasse-notes" rows="3" placeholder="Observations sur la chasse..."></textarea>
        </div>
        
        <button onclick="addChasse()">Enregistrer la Chasse</button>
        
        <h2 style="margin-top: 40px;">Historique des Chasses</h2>
        <div id="chasse-list"></div>
    </div>

    <div id="affaitage" class="tab-content">
        <h2>Affaitage</h2>
        <div class="form-group">
            <label for="affaitage-rapace">Rapace :</label>
            <select id="affaitage-rapace">
                <option value="">Choisir un rapace</option>
            </select>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="affaitage-date">Date :</label>
                <input type="date" id="affaitage-date">
            </div>
            <div class="form-group">
                <label for="affaitage-time">Heure :</label>
                <input type="time" id="affaitage-time">
            </div>
        </div>
        
        <div class="form-group">
            <label>Activit√©s :</label>
            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="prise-nourriture">
                    <label for="prise-nourriture">Prise de nourriture</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="gant">
                    <label for="gant">Gant</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="filiere">
                    <label for="filiere">Fili√®re</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="libre">
                    <label for="libre">Libre</label>
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label for="affaitage-notes">Notes :</label>
            <textarea id="affaitage-notes" rows="3" placeholder="Observations sur l'affaitage..."></textarea>
        </div>
        
        <button onclick="addAffaitage()">Enregistrer l'Affaitage</button>
        
        <h2 style="margin-top: 40px;">Historique d'Affaitage</h2>
        <div id="affaitage-list"></div>
    </div>

    <div id="stats" class="tab-content">
        <h2>Statistiques</h2>
        <div style="margin-bottom: 20px;">
            <div class="day-navigation">
                <button onclick="changeStatsDate(-1)">‚Üê Jour pr√©c√©dent</button>
                <input type="date" id="stats-date" onchange="updateStats()">
                <button onclick="changeStatsDate(1)">Jour suivant ‚Üí</button>
                <button onclick="showMultipleDays()">Voir 4 jours</button>
            </div>
            <div style="margin-top: 10px;">
                <button onclick="exportAllData()">üíæ Exporter</button>
                <button onclick="importAllData()" style="margin-left: 10px;">üìÅ Importer</button>
                <button onclick="clearAllData()" class="btn-danger" style="margin-left: 10px;">üóëÔ∏è Vider</button>
            </div>
        </div>
        <div id="stats-content"></div>
    </div>

    <div id="sync" class="tab-content">
        <h2>Synchronisation Google Drive</h2>
        
        <div class="day-card">
            <h4>üìä √âtat de la synchronisation</h4>
            <p id="sync-status">üîÑ Non configur√©</p>
            <p id="last-sync">Derni√®re sync : Jamais</p>
            <p id="sync-devices">Appareils connect√©s : 0</p>
        </div>

        <div style="margin: 20px 0;">
            <h3>üîß Configuration</h3>
            <div style="display: flex; gap: 10px; margin: 15px 0; flex-wrap: wrap;">
                <button onclick="connectGoogleDrive()" id="connect-btn">üîó Connecter Google Drive</button>
                <button onclick="disconnectGoogleDrive()" id="disconnect-btn" style="display: none;" class="btn-secondary">‚ùå D√©connecter</button>
                <button onclick="syncNow()" id="sync-btn" style="display: none;">‚ö° Synchroniser maintenant</button>
            </div>
        </div>

        <div style="margin: 20px 0;">
            <h3>‚öôÔ∏è Param√®tres</h3>
            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="auto-sync" checked>
                    <label for="auto-sync">Synchronisation automatique (toutes les 5 minutes)</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="sync-on-change" checked>
                    <label for="sync-on-change">Synchroniser √† chaque modification</label>
                </div>
            </div>
        </div>

        <div style="margin: 20px 0;">
            <h3>üì± Autres appareils</h3>
            <p>1. Ouvrez cette application sur votre autre appareil</p>
            <p>2. Connectez-vous avec le m√™me compte Google</p>
            <p>3. Vos donn√©es se synchroniseront automatiquement</p>
        </div>

        <div style="margin: 20px 0;">
            <h3>üíæ Sauvegarde manuelle</h3>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="exportAllData()">üíæ Exporter sauvegarde</button>
                <button onclick="importAllData()">üìÅ Importer sauvegarde</button>
                <button onclick="clearAllData()" class="btn-danger">üóëÔ∏è Vider tout</button>
            </div>
        </div>

        <div class="day-card" style="background: #e3f2fd;">
            <h4>‚ÑπÔ∏è Comment √ßa marche</h4>
            <p>‚Ä¢ Vos donn√©es sont sauvegard√©es dans votre Google Drive personnel</p>
            <p>‚Ä¢ Seuls vous et vos appareils connect√©s peuvent y acc√©der</p>
            <p>‚Ä¢ La synchronisation est automatique et s√©curis√©e</p>
            <p>‚Ä¢ Vous pouvez vous d√©connecter √† tout moment</p>
        </div>
    </div>
</div>

<!-- Modal pour √©dition -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeEditModal()">&times;</span>
        <h2>Modifier le Rapace</h2>
        <div class="form-group">
            <label for="edit-name">Nom :</label>
            <input type="text" id="edit-name">
        </div>
        <div class="form-group">
            <label for="edit-species">Esp√®ce :</label>
            <input type="text" id="edit-species">
        </div>
        <div class="form-group">
            <label for="edit-birthdate">Date de naissance :</label>
            <input type="date" id="edit-birthdate">
        </div>
        <div class="form-group">
            <label for="edit-sex">Sexe :</label>
            <select id="edit-sex">
                <option value="forme">Forme</option>
                <option value="tiercelet">Tiercelet</option>
            </select>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button onclick="saveRapaceEdit()">üíæ Sauvegarder</button>
            <button onclick="closeEditModal()" class="btn-secondary">‚ùå Annuler</button>
        </div>
    </div>
</div>

<script>
// Variables globales
var rapaces = [];
var entries = [];
var chasseEntries = [];
var affaitageEntries = [];
var currentWeather = null;
var currentLocation = "Orthez (64300)";
var currentStatsDate = new Date();
var editingRapaceId = null;

// Variables pour Google Drive sync
var gapi = null;
var isGoogleDriveConnected = false;
var syncInterval = null;
var lastSyncTime = null;

// Sauvegarder normalement
function saveAllData() {
    try {
        var data = {
            rapaces: rapaces,
            entries: entries,
            chasseEntries: chasseEntries,
            affaitageEntries: affaitageEntries,
            currentLocation: currentLocation,
            lastSave: new Date().toISOString()
        };
        localStorage.setItem('rapaces_data', JSON.stringify(data));
    } catch (e) {
        console.error('Erreur sauvegarde:', e);
    }
}

// Fonctions de synchronisation simplifi√©es
function setupGoogleDriveSync() {
    alert('üåê Configuration Google Drive\n\n' +
          '1. Cette fonctionnalit√© connecte vos appareils via Google Drive\n' +
          '2. Vos donn√©es seront sauvegard√©es automatiquement\n' +
          '3. Tous vos appareils avec le m√™me compte Google seront synchronis√©s\n\n' +
          'Pour l\'instant, utilisez Export/Import pour synchroniser manuellement.\n\n' +
          'Exportez sur un appareil ‚Üí Importez sur l\'autre !');
}

function showSyncInstructions() {
    alert('üìñ Instructions de synchronisation\n\n' +
          'üì± M√âTHODE ACTUELLE (Export/Import) :\n' +
          '1. Sur appareil principal : Statistiques ‚Üí "üíæ Exporter"\n' +
          '2. Envoyez le fichier par email/cloud\n' +
          '3. Sur autre appareil : Statistiques ‚Üí "üìÅ Importer"\n' +
          '4. S√©lectionnez le fichier re√ßu\n' +
          '5. Vos donn√©es sont synchronis√©es !\n\n' +
          'üîÑ M√âTHODE FUTURE (Google Drive) :\n' +
          '- Synchronisation automatique en temps r√©el\n' +
          '- Disponible dans une prochaine version');
}

function loadAllData() {
    try {
        var savedData = localStorage.getItem('rapaces_data');
        if (savedData) {
            var data = JSON.parse(savedData);
            rapaces = data.rapaces || [];
            entries = data.entries || [];
            chasseEntries = data.chasseEntries || [];
            affaitageEntries = data.affaitageEntries || [];
            currentLocation = data.currentLocation || "Orthez (64300)";
            return true;
        }
    } catch (e) {
        console.error('Erreur chargement:', e);
    }
    return false;
}

// M√©t√©o avec OpenWeatherMap API
function loadWeather() {
    // Essayer d'abord de g√©olocaliser automatiquement
    if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                loadWeatherByCoords(position.coords.latitude, position.coords.longitude);
            },
            function(error) {
                // Si g√©olocalisation √©choue, utiliser la ville configur√©e
                loadWeatherByCity(currentLocation);
            },
            { timeout: 5000, maximumAge: 300000 } // 5 min cache
        );
    } else {
        // Pas de g√©olocalisation, utiliser la ville
        loadWeatherByCity(currentLocation);
    }
}

function loadWeatherByCoords(lat, lon) {
    // Votre cl√© API OpenWeatherMap
    var apiKey = "b4d68d2dedd2d6d43f81f804010b0673";
    var url = "https://api.openweathermap.org/data/2.5/weather?lat=" + lat + "&lon=" + lon + "&appid=" + apiKey + "&units=metric&lang=fr";
    
    fetch(url)
        .then(response => {
            if (!response.ok) throw new Error('API Error');
            return response.json();
        })
        .then(data => {
            processWeatherData(data);
            // Mettre √† jour la localisation d√©tect√©e
            currentLocation = data.name + " (" + data.sys.country + ")";
            saveAllData();
        })
        .catch(error => {
            console.log("Erreur API coords:", error);
            loadWeatherFallback();
        });
}

function loadWeatherByCity(cityName) {
    // Extraire juste le nom de ville (enlever le code postal)
    var city = cityName.split("(")[0].trim();
    
    // Votre cl√© API OpenWeatherMap
    var apiKey = "b4d68d2dedd2d6d43f81f804010b0673";
    var url = "https://api.openweathermap.org/data/2.5/weather?q=" + encodeURIComponent(city) + ",FR&appid=" + apiKey + "&units=metric&lang=fr";
    
    fetch(url)
        .then(response => {
            if (!response.ok) throw new Error('API Error');
            return response.json();
        })
        .then(data => {
            processWeatherData(data);
        })
        .catch(error => {
            console.log("Erreur API ville:", error);
            loadWeatherFallback();
        });
}

function processWeatherData(data) {
    // Extraire les donn√©es de l'API OpenWeatherMap
    var temp = Math.round(data.main.temp);
    var description = data.weather[0].description;
    var humidity = data.main.humidity;
    var windSpeed = Math.round(data.wind.speed * 3.6); // Convertir m/s en km/h
    var precipitation = 0;
    
    // Calculer les pr√©cipitations si disponibles
    if (data.rain && data.rain["1h"]) {
        precipitation = Math.round((data.rain["1h"] / 1) * 100); // Approximation
    } else if (data.snow && data.snow["1h"]) {
        precipitation = Math.round((data.snow["1h"] / 1) * 100);
    } else if (data.clouds && data.clouds.all > 80) {
        precipitation = Math.floor(data.clouds.all / 4); // Estimation bas√©e sur la couverture nuageuse
    }
    
    // Limiter les pr√©cipitations √† 100%
    precipitation = Math.min(precipitation, 100);
    
    // Choisir l'ic√¥ne selon les conditions
    var icon = getWeatherIcon(data.weather[0].main, data.weather[0].id);
    
    // Formatter la m√©t√©o compl√®te
    var detailedWeather = temp + "¬∞C\n" +
                         "Pr√©cipitations : " + precipitation + "%\n" +
                         "Humidit√© : " + humidity + "%\n" +
                         "Vent : " + windSpeed + " km/h";
    
    currentWeather = description + ", " + detailedWeather + " √† " + currentLocation;
    
    var weatherElement = document.getElementById('weather-info');
    if (weatherElement) {
        weatherElement.innerHTML = icon + " <strong>" + description.charAt(0).toUpperCase() + description.slice(1) + "</strong><br>" +
                                  "<span style='font-size: 12px; line-height: 1.4;'>" +
                                  temp + "¬∞C<br>" +
                                  "Pr√©cipitations : " + precipitation + "%<br>" +
                                  "Humidit√© : " + humidity + "%<br>" +
                                  "Vent : " + windSpeed + " km/h<br>" +
                                  "<em>" + currentLocation + "</em>" +
                                  "</span>";
    }
}

function getWeatherIcon(main, id) {
    // Mapper les conditions OpenWeatherMap vers des emojis
    switch (main) {
        case "Clear":
            return "‚òÄÔ∏è";
        case "Clouds":
            return id < 803 ? "‚õÖ" : "‚òÅÔ∏è";
        case "Rain":
            return "üåßÔ∏è";
        case "Drizzle":
            return "üå¶Ô∏è";
        case "Thunderstorm":
            return "‚õàÔ∏è";
        case "Snow":
            return "‚ùÑÔ∏è";
        case "Mist":
        case "Fog":
            return "üå´Ô∏è";
        case "Haze":
            return "üå§Ô∏è";
        default:
            return "üå§Ô∏è";
    }
}

function loadWeatherFallback() {
    // M√©t√©o simul√©e si l'API ne fonctionne pas
    var now = new Date();
    var month = now.getMonth();
    var hour = now.getHours();
    
    var conditions;
    
    if (month >= 2 && month <= 4) { // Printemps
        conditions = [
            {desc: "ensoleill√©", temp: 15 + Math.floor(Math.random() * 8), icon: "‚òÄÔ∏è", precipitation: 0 + Math.floor(Math.random() * 20), humidity: 45 + Math.floor(Math.random() * 20)},
            {desc: "partiellement nuageux", temp: 12 + Math.floor(Math.random() * 7), icon: "‚õÖ", precipitation: 10 + Math.floor(Math.random() * 30), humidity: 50 + Math.floor(Math.random() * 25)},
            {desc: "nuageux", temp: 10 + Math.floor(Math.random() * 6), icon: "‚òÅÔ∏è", precipitation: 20 + Math.floor(Math.random() * 40), humidity: 60 + Math.floor(Math.random() * 25)},
            {desc: "pluvieux", temp: 8 + Math.floor(Math.random() * 8), icon: "üåßÔ∏è", precipitation: 70 + Math.floor(Math.random() * 30), humidity: 75 + Math.floor(Math.random() * 20)}
        ];
    } else if (month >= 5 && month <= 7) { // √ât√©
        conditions = [
            {desc: "ensoleill√©", temp: 20 + Math.floor(Math.random() * 10), icon: "‚òÄÔ∏è", precipitation: 0 + Math.floor(Math.random() * 10), humidity: 35 + Math.floor(Math.random() * 20)},
            {desc: "tr√®s ensoleill√©", temp: 25 + Math.floor(Math.random() * 8), icon: "‚òÄÔ∏è", precipitation: 0 + Math.floor(Math.random() * 5), humidity: 30 + Math.floor(Math.random() * 15)},
            {desc: "chaud", temp: 28 + Math.floor(Math.random() * 7), icon: "üå°Ô∏è", precipitation: 0 + Math.floor(Math.random() * 15), humidity: 25 + Math.floor(Math.random() * 20)},
            {desc: "orageux", temp: 22 + Math.floor(Math.random() * 6), icon: "‚õàÔ∏è", precipitation: 60 + Math.floor(Math.random() * 40), humidity: 70 + Math.floor(Math.random() * 25)}
        ];
    } else if (month >= 8 && month <= 10) { // Automne
        conditions = [
            {desc: "doux", temp: 12 + Math.floor(Math.random() * 10), icon: "üçÇ", precipitation: 10 + Math.floor(Math.random() * 30), humidity: 50 + Math.floor(Math.random() * 25)},
            {desc: "nuageux", temp: 8 + Math.floor(Math.random() * 8), icon: "‚òÅÔ∏è", precipitation: 25 + Math.floor(Math.random() * 45), humidity: 65 + Math.floor(Math.random() * 25)},
            {desc: "pluvieux", temp: 6 + Math.floor(Math.random() * 10), icon: "üåßÔ∏è", precipitation: 70 + Math.floor(Math.random() * 30), humidity: 80 + Math.floor(Math.random() * 15)},
            {desc: "brumeux", temp: 5 + Math.floor(Math.random() * 8), icon: "üå´Ô∏è", precipitation: 30 + Math.floor(Math.random() * 40), humidity: 85 + Math.floor(Math.random() * 10)}
        ];
    } else { // Hiver
        conditions = [
            {desc: "frais", temp: 2 + Math.floor(Math.random() * 8), icon: "üå§Ô∏è", precipitation: 15 + Math.floor(Math.random() * 35), humidity: 65 + Math.floor(Math.random() * 25)},
            {desc: "nuageux", temp: 0 + Math.floor(Math.random() * 10), icon: "‚òÅÔ∏è", precipitation: 30 + Math.floor(Math.random() * 50), humidity: 70 + Math.floor(Math.random() * 25)},
            {desc: "pluvieux", temp: 3 + Math.floor(Math.random() * 8), icon: "üåßÔ∏è", precipitation: 75 + Math.floor(Math.random() * 25), humidity: 85 + Math.floor(Math.random() * 10)},
            {desc: "froid", temp: -2 + Math.floor(Math.random() * 8), icon: "‚ùÑÔ∏è", precipitation: 40 + Math.floor(Math.random() * 40), humidity: 80 + Math.floor(Math.random() * 15)}
        ];
    }
    
    var weather = conditions[Math.floor(Math.random() * conditions.length)];
    
    // Ajuster selon l'heure
    if (hour < 8 || hour > 20) {
        weather.temp = Math.max(weather.temp - 3, -5);
        weather.humidity = Math.min(weather.humidity + 10, 95);
    }
    
    // G√©n√©rer vitesse du vent
    var windSpeed = 3 + Math.floor(Math.random() * 15);
    
    var detailedWeather = weather.temp + "¬∞C\n" +
                         "Pr√©cipitations : " + weather.precipitation + "%\n" +
                         "Humidit√© : " + weather.humidity + "%\n" +
                         "Vent : " + windSpeed + " km/h";
    
    currentWeather = weather.desc + ", " + detailedWeather + " √† " + currentLocation;
    
    var weatherElement = document.getElementById('weather-info');
    if (weatherElement) {
        weatherElement.innerHTML = weather.icon + " <strong>" + weather.desc.charAt(0).toUpperCase() + weather.desc.slice(1) + "</strong><br>" +
                                  "<span style='font-size: 12px; line-height: 1.4;'>" +
                                  weather.temp + "¬∞C<br>" +
                                  "Pr√©cipitations : " + weather.precipitation + "%<br>" +
                                  "Humidit√© : " + weather.humidity + "%<br>" +
                                  "Vent : " + windSpeed + " km/h<br>" +
                                  "<em>" + currentLocation + " (simul√©)</em>" +
                                  "</span>";
    }
}

function refreshWeather() {
    loadWeather();
}

function changeLocation() {
    var newLocation = prompt("Entrez votre localisation :", currentLocation);
    if (newLocation && newLocation.trim()) {
        currentLocation = newLocation.trim();
        saveAllData();
        loadWeather();
    }
}

// Calcul de l'√¢ge
function calculateAge(birthDate) {
    var today = new Date();
    var birth = new Date(birthDate);
    var age = today.getFullYear() - birth.getFullYear();
    var monthDiff = today.getMonth() - birth.getMonth();
    
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
        age--;
    }
    
    return age;
}

// Onglets
function showTab(tabName) {
    var contents = document.querySelectorAll('.tab-content');
    for (var i = 0; i < contents.length; i++) {
        contents[i].classList.remove('active');
    }
    
    var tabs = document.querySelectorAll('.tab');
    for (var i = 0; i < tabs.length; i++) {
        tabs[i].classList.remove('active');
    }
    
    document.getElementById(tabName).classList.add('active');
    var activeTab = document.querySelector("[onclick=\"showTab('" + tabName + "')\"]");
    if (activeTab) {
        activeTab.classList.add('active');
    }
    
    if (tabName === 'stats') {
        updateStats();
    } else if (tabName === 'sync') {
        updateSyncStatus();
    }
}

// Champs conditionnels
function showEventFields() {
    var eventType = document.getElementById('event-type').value;
    var fields = document.querySelectorAll('.conditional-fields');
    
    for (var i = 0; i < fields.length; i++) {
        fields[i].classList.remove('active');
    }
    
    var targetField = document.getElementById(eventType + '-fields');
    if (targetField) {
        targetField.classList.add('active');
    }
}

// Ajouter rapace
function addRapace() {
    var name = document.getElementById('rapace-name').value;
    var species = document.getElementById('rapace-species').value;
    var birthdate = document.getElementById('rapace-birthdate').value;
    var sex = document.getElementById('rapace-sex').value;

    if (!name || !species || !birthdate) {
        alert('Merci de remplir tous les champs');
        return;
    }

    var age = calculateAge(birthdate);

    var rapace = {
        id: Date.now(),
        name: name,
        species: species,
        birthdate: birthdate,
        age: age,
        sex: sex,
        dateAdded: new Date().toISOString()
    };

    rapaces.push(rapace);
    saveAllData();
    updateRapaceList();
    updateRapaceSelects();
    
    document.getElementById('rapace-name').value = '';
    document.getElementById('rapace-species').value = '';
    document.getElementById('rapace-birthdate').value = '';
}

// Liste rapaces
function updateRapaceList() {
    var list = document.getElementById('rapace-list');
    list.innerHTML = '';
    
    if (rapaces.length === 0) {
        list.innerHTML = '<p style="text-align:center; color: #666;">Aucun rapace ajout√©</p>';
        return;
    }

    for (var i = 0; i < rapaces.length; i++) {
        var rapace = rapaces[i];
        var div = document.createElement('div');
        div.className = 'rapace-card';
        
        rapace.age = calculateAge(rapace.birthdate);
        
        div.innerHTML = '<div class="rapace-actions">' +
                        '<button onclick="editRapace(' + rapace.id + ')" class="btn-warning">‚úèÔ∏è</button>' +
                        '<button onclick="deleteRapace(' + rapace.id + ')" class="btn-danger">üóëÔ∏è</button>' +
                        '</div>' +
                        '<h3>' + rapace.name + '</h3>' +
                        '<p><strong>Esp√®ce :</strong> ' + rapace.species + '</p>' +
                        '<p><strong>√Çge :</strong> ' + rapace.age + ' ans</p>' +
                        '<p><strong>Sexe :</strong> ' + rapace.sex + '</p>' +
                        '<p><strong>N√© le :</strong> ' + new Date(rapace.birthdate).toLocaleDateString('fr-FR') + '</p>';
        list.appendChild(div);
    }
}

// √âdition rapace
function editRapace(rapaceId) {
    var rapace = rapaces.find(r => r.id === rapaceId);
    if (!rapace) return;
    
    editingRapaceId = rapaceId;
    document.getElementById('edit-name').value = rapace.name;
    document.getElementById('edit-species').value = rapace.species;
    document.getElementById('edit-birthdate').value = rapace.birthdate;
    document.getElementById('edit-sex').value = rapace.sex;
    
    document.getElementById('editModal').style.display = 'block';
}

function saveRapaceEdit() {
    if (!editingRapaceId) return;
    
    var rapace = rapaces.find(r => r.id === editingRapaceId);
    if (!rapace) return;
    
    var name = document.getElementById('edit-name').value;
    var species = document.getElementById('edit-species').value;
    var birthdate = document.getElementById('edit-birthdate').value;
    var sex = document.getElementById('edit-sex').value;
    
    if (!name || !species || !birthdate) {
        alert('Merci de remplir tous les champs');
        return;
    }
    
    rapace.name = name;
    rapace.species = species;
    rapace.birthdate = birthdate;
    rapace.age = calculateAge(birthdate);
    rapace.sex = sex;
    
    saveAllData();
    updateRapaceList();
    updateRapaceSelects();
    closeEditModal();
    
    alert('Rapace modifi√© !');
}

function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
    editingRapaceId = null;
}

function deleteRapace(rapaceId) {
    var rapace = rapaces.find(r => r.id === rapaceId);
    if (!rapace) return;
    
    if (confirm('Supprimer ' + rapace.name + ' et tout son historique ?')) {
        rapaces = rapaces.filter(r => r.id !== rapaceId);
        entries = entries.filter(e => e.rapaceId !== rapaceId);
        chasseEntries = chasseEntries.filter(c => c.rapaceId !== rapaceId);
        affaitageEntries = affaitageEntries.filter(a => a.rapaceId !== rapaceId);
        
        saveAllData();
        updateRapaceList();
        updateRapaceSelects();
        updateEntryList();
        updatechasseList();
        updateAffaitageList();
        
        alert('Rapace supprim√© !');
    }
}

// Mise √† jour selects
function updateRapaceSelects() {
    var selects = ['rapace-select', 'chasse-rapace', 'affaitage-rapace'];
    
    for (var s = 0; s < selects.length; s++) {
        var select = document.getElementById(selects[s]);
        if (select) {
            var currentValue = select.value;
            select.innerHTML = '<option value="">Choisir un rapace</option>';
            
            for (var i = 0; i < rapaces.length; i++) {
                var rapace = rapaces[i];
                var option = document.createElement('option');
                option.value = rapace.id;
                option.textContent = rapace.name;
                select.appendChild(option);
            }
            
            select.value = currentValue;
        }
    }
}

// Ajouter entr√©e
function addEntry() {
    var rapaceId = document.getElementById('rapace-select').value;
    var type = document.getElementById('event-type').value;
    var date = document.getElementById('event-date').value;
    var time = document.getElementById('event-time').value;
    var notes = document.getElementById('event-notes').value;

    if (!rapaceId || !date || !time) {
        alert('Merci de remplir tous les champs requis');
        return;
    }

    var entry = {
        id: Date.now(),
        rapaceId: parseInt(rapaceId),
        type: type,
        date: date,
        time: time,
        notes: notes,
        weather: currentWeather || 'M√©t√©o non dispo'
    };

    // Donn√©es sp√©cifiques selon le type
    if (type === 'nourriture') {
        entry.poidsAvant = document.getElementById('poids-avant').value;
        entry.poidsApres = document.getElementById('poids-apres').value;
        entry.menu = document.getElementById('detail-nourriture').value;
        entry.quantite = document.getElementById('quantite-nourriture').value;
    } else if (type === 'vol') {
        entry.typeVol = document.getElementById('type-vol').value;
    } else if (type === 'comportement') {
        var reactivite = document.querySelector('input[name="reactivite"]:checked');
        entry.reactivite = reactivite ? reactivite.value : '';
    } else if (type === 'sante') {
        entry.etatSante = document.getElementById('etat-sante').value;
    } else if (type === 'entrainement') {
        entry.typeEntrainement = document.getElementById('type-entrainement').value;
    }

    entries.push(entry);
    saveAllData();
    updateEntryList();
    
    // Vider les champs
    document.getElementById('event-notes').value = '';
    clearConditionalFields();
}

function clearConditionalFields() {
    var fields = ['poids-avant', 'poids-apres', 'quantite-nourriture'];
    for (var i = 0; i < fields.length; i++) {
        var field = document.getElementById(fields[i]);
        if (field) field.value = '';
    }
    
    var radios = document.querySelectorAll('input[name="reactivite"]');
    for (var i = 0; i < radios.length; i++) {
        radios[i].checked = false;
    }
}

// Liste entr√©es
function updateEntryList() {
    var selectedRapaceId = document.getElementById('rapace-select').value;
    var entryList = document.getElementById('entry-list');
    
    if (!selectedRapaceId) {
        entryList.innerHTML = '<p style="text-align:center; color: #666;">S√©lectionnez un rapace</p>';
        return;
    }

    var filteredEntries = [];
    for (var i = 0; i < entries.length; i++) {
        if (entries[i].rapaceId == selectedRapaceId) {
            filteredEntries.push(entries[i]);
        }
    }

    entryList.innerHTML = '';
    
    if (filteredEntries.length === 0) {
        entryList.innerHTML = '<p style="text-align:center; color: #666;">Aucune entr√©e</p>';
        return;
    }

    // Trier et prendre les 10 derni√®res
    filteredEntries.sort((a, b) => new Date(b.date + ' ' + b.time) - new Date(a.date + ' ' + a.time));
    filteredEntries = filteredEntries.slice(0, 10);

    for (var i = 0; i < filteredEntries.length; i++) {
        var entry = filteredEntries[i];
        var div = document.createElement('div');
        div.className = 'entry-item';
        var formattedDate = new Date(entry.date).toLocaleDateString('fr-FR') + ' √† ' + entry.time;
        
        var details = '';
        if (entry.type === 'nourriture') {
            details = '<br><strong>Poids:</strong> ' + (entry.poidsAvant || '?') + 'g ‚Üí ' + (entry.poidsApres || '?') + 'g';
            details += '<br><strong>Menu:</strong> ' + entry.menu + ' (' + entry.quantite + ')';
        } else if (entry.type === 'vol') {
            details = '<br><strong>Type:</strong> ' + entry.typeVol;
        } else if (entry.type === 'comportement') {
            details = '<br><strong>R√©activit√©:</strong> ' + entry.reactivite + '/5';
        } else if (entry.type === 'sante') {
            details = '<br><strong>√âtat:</strong> ' + entry.etatSante;
        } else if (entry.type === 'entrainement') {
            details = '<br><strong>Type:</strong> ' + entry.typeEntrainement;
        }
        
        div.innerHTML = '<div class="date">' + formattedDate + ' ‚Ä¢ ' + entry.weather + '</div>' +
                        '<div class="content">' +
                        '<strong>' + entry.type.charAt(0).toUpperCase() + entry.type.slice(1) + '</strong>' + details +
                        (entry.notes ? '<br><em>' + entry.notes + '</em>' : '') +
                        '</div>';
        entryList.appendChild(div);
    }
}

// Chasse
function addChasse() {
    var rapaceId = document.getElementById('chasse-rapace').value;
    var date = document.getElementById('chasse-date').value;
    var time = document.getElementById('chasse-time').value;
    var notes = document.getElementById('chasse-notes').value;
    
    if (!rapaceId || !date || !time) {
        alert('Merci de remplir tous les champs requis');
        return;
    }
    
    var chasse = {
        id: Date.now(),
        rapaceId: parseInt(rapaceId),
        date: date,
        time: time,
        notes: notes,
        faisan: parseInt(document.getElementById('chasse-faisan').value) || 0,
        perdrix: parseInt(document.getElementById('chasse-perdrix').value) || 0,
        lapin: parseInt(document.getElementById('chasse-lapin').value) || 0,
        lievre: parseInt(document.getElementById('chasse-lievre').value) || 0,
        canard: parseInt(document.getElementById('chasse-canard').value) || 0,
        oie: parseInt(document.getElementById('chasse-oie').value) || 0,
        autre: parseInt(document.getElementById('chasse-autre').value) || 0,
        weather: currentWeather || 'M√©t√©o non dispo'
    };
    
    chasseEntries.push(chasse);
    saveAllData();
    updatechasseList();
    
    // Vider
    var huntInputs = document.querySelectorAll('.hunt-item input');
    for (var i = 0; i < huntInputs.length; i++) {
        huntInputs[i].value = 0;
    }
    document.getElementById('chasse-notes').value = '';
}

function updatechasseList() {
    var chasseList = document.getElementById('chasse-list');
    chasseList.innerHTML = '';
    
    if (chasseEntries.length === 0) {
        chasseList.innerHTML = '<p style="text-align:center; color: #666;">Aucune chasse</p>';
        return;
    }
    
    for (var i = chasseEntries.length - 1; i >= 0; i--) {
        var chasse = chasseEntries[i];
        var rapace = rapaces.find(r => r.id === chasse.rapaceId);
        var div = document.createElement('div');
        div.className = 'day-card';
        
        var total = chasse.faisan + chasse.perdrix + chasse.lapin + chasse.lievre + chasse.canard + chasse.oie + chasse.autre;
        var details = '';
        
        if (chasse.faisan > 0) details += 'Faisan: ' + chasse.faisan + ' ';
        if (chasse.perdrix > 0) details += 'Perdrix: ' + chasse.perdrix + ' ';
        if (chasse.lapin > 0) details += 'Lapin: ' + chasse.lapin + ' ';
        if (chasse.lievre > 0) details += 'Li√®vre: ' + chasse.lievre + ' ';
        if (chasse.canard > 0) details += 'Canard: ' + chasse.canard + ' ';
        if (chasse.oie > 0) details += 'Oie: ' + chasse.oie + ' ';
        if (chasse.autre > 0) details += 'Autre: ' + chasse.autre + ' ';
        
        div.innerHTML = '<h4>' + (rapace ? rapace.name : 'Inconnu') + '</h4>' +
                        '<p style="color: #666; font-size: 14px;">' + new Date(chasse.date).toLocaleDateString('fr-FR') + ' √† ' + chasse.time + '</p>' +
                        '<p><strong>Total prises:</strong> ' + total + '</p>' +
                        '<p>' + (details || 'Aucune prise') + '</p>' +
                        (chasse.notes ? '<p><em>' + chasse.notes + '</em></p>' : '') +
                        '<p style="font-size: 12px; color: #666;">' + chasse.weather + '</p>';
        chasseList.appendChild(div);
    }
}

// Affaitage
function addAffaitage() {
    var rapaceId = document.getElementById('affaitage-rapace').value;
    var date = document.getElementById('affaitage-date').value;
    var time = document.getElementById('affaitage-time').value;
    var notes = document.getElementById('affaitage-notes').value;
    
    if (!rapaceId || !date || !time) {
        alert('Merci de remplir tous les champs requis');
        return;
    }
    
    var affaitage = {
        id: Date.now(),
        rapaceId: parseInt(rapaceId),
        date: date,
        time: time,
        notes: notes,
        priseNourriture: document.getElementById('prise-nourriture').checked,
        gant: document.getElementById('gant').checked,
        filiere: document.getElementById('filiere').checked,
        libre: document.getElementById('libre').checked,
        weather: currentWeather || 'M√©t√©o non dispo'
    };
    
    affaitageEntries.push(affaitage);
    saveAllData();
    updateAffaitageList();
    
    // Vider
    document.getElementById('affaitage-notes').value = '';
    var checkboxes = document.querySelectorAll('#affaitage .checkbox-item input');
    for (var i = 0; i < checkboxes.length; i++) {
        checkboxes[i].checked = false;
    }
}

function updateAffaitageList() {
    var affaitageList = document.getElementById('affaitage-list');
    affaitageList.innerHTML = '';
    
    if (affaitageEntries.length === 0) {
        affaitageList.innerHTML = '<p style="text-align:center; color: #666;">Aucun affaitage</p>';
        return;
    }
    
    for (var i = affaitageEntries.length - 1; i >= 0; i--) {
        var affaitage = affaitageEntries[i];
        var rapace = rapaces.find(r => r.id === affaitage.rapaceId);
        var div = document.createElement('div');
        div.className = 'day-card';
        
        var activites = [];
        if (affaitage.priseNourriture) activites.push('Prise de nourriture');
        if (affaitage.gant) activites.push('Gant');
        if (affaitage.filiere) activites.push('Fili√®re');
        if (affaitage.libre) activites.push('Libre');
        
        div.innerHTML = '<h4>' + (rapace ? rapace.name : 'Inconnu') + '</h4>' +
                        '<p style="color: #666; font-size: 14px;">' + new Date(affaitage.date).toLocaleDateString('fr-FR') + ' √† ' + affaitage.time + '</p>' +
                        '<p><strong>Activit√©s:</strong> ' + (activites.length > 0 ? activites.join(', ') : 'Aucune') + '</p>' +
                        (affaitage.notes ? '<p><em>' + affaitage.notes + '</em></p>' : '') +
                        '<p style="font-size: 12px; color: #666;">' + affaitage.weather + '</p>';
        affaitageList.appendChild(div);
    }
}

// Stats
function changeStatsDate(days) {
    currentStatsDate.setDate(currentStatsDate.getDate() + days);
    document.getElementById('stats-date').value = currentStatsDate.toISOString().split('T')[0];
    updateStats();
}

function showMultipleDays() {
    var statsContent = document.getElementById('stats-content');
    statsContent.innerHTML = '<div class="stats-grid">';
    
    for (var i = 0; i < 4; i++) {
        var dayDate = new Date(currentStatsDate);
        dayDate.setDate(dayDate.getDate() - 1 + i);
        var dateStr = dayDate.toISOString().split('T')[0];
        
        var dayEntries = entries.filter(e => e.date === dateStr);
        var dayChasse = chasseEntries.filter(c => c.date === dateStr);
        var dayAffaitage = affaitageEntries.filter(a => a.date === dateStr);
        
        statsContent.innerHTML += '<div class="stat-card">' +
                                  '<h3>' + dayDate.toLocaleDateString('fr-FR') + '</h3>' +
                                  '<div class="value">' + (dayEntries.length + dayChasse.length + dayAffaitage.length) + '</div>' +
                                  '<p>activit√©s</p>' +
                                  '</div>';
    }
    
    statsContent.innerHTML += '</div>';
}

function updateStats() {
    var selectedDate = document.getElementById('stats-date').value;
    if (!selectedDate) return;
    
    currentStatsDate = new Date(selectedDate);
    
    var dayEntries = entries.filter(e => e.date === selectedDate);
    var dayChasse = chasseEntries.filter(c => c.date === selectedDate);
    var dayAffaitage = affaitageEntries.filter(a => a.date === selectedDate);
    
    var weatherOfDay = '';
    if (dayEntries.length > 0) weatherOfDay = dayEntries[0].weather;
    else if (dayChasse.length > 0) weatherOfDay = dayChasse[0].weather;
    else if (dayAffaitage.length > 0) weatherOfDay = dayAffaitage[0].weather;
    
    var content = '<div class="day-card">';
    content += '<h4>üìÖ R√©capitulatif d√©taill√© du ' + new Date(selectedDate).toLocaleDateString('fr-FR') + '</h4>';
    
    if (weatherOfDay) {
        content += '<p style="color: #666; font-style: italic; margin-bottom: 15px;">üå§Ô∏è ' + weatherOfDay + '</p>';
    }
    
    // R√©sum√© rapide
    content += '<div class="stats-grid">';
    content += '<div class="stat-card"><h3>Activit√©s quotidiennes</h3><div class="value">' + dayEntries.length + '</div></div>';
    content += '<div class="stat-card"><h3>Chasses</h3><div class="value">' + dayChasse.length + '</div></div>';
    content += '<div class="stat-card"><h3>Affaitages</h3><div class="value">' + dayAffaitage.length + '</div></div>';
    var totalActivities = dayEntries.length + dayChasse.length + dayAffaitage.length;
    content += '<div class="stat-card"><h3>Total</h3><div class="value">' + totalActivities + '</div></div>';
    content += '</div>';
    
    // D√©tail complet des activit√©s par rapace
    if (totalActivities > 0) {
        content += '<h3 style="margin-top: 30px;">üìã D√©tail complet des activit√©s</h3>';
        
        // Grouper par rapace
        var activitiesByRapace = {};
        
        // Ajouter les activit√©s quotidiennes
        for (var i = 0; i < dayEntries.length; i++) {
            var entry = dayEntries[i];
            var rapace = rapaces.find(r => r.id === entry.rapaceId);
            var rapaceName = rapace ? rapace.name : 'Rapace inconnu';
            
            if (!activitiesByRapace[rapaceName]) {
                activitiesByRapace[rapaceName] = [];
            }
            
            activitiesByRapace[rapaceName].push({
                type: 'Suivi',
                icon: 'üìù',
                time: entry.time,
                detail: entry,
                category: 'entry'
            });
        }
        
        // Ajouter les chasses
        for (var i = 0; i < dayChasse.length; i++) {
            var chasse = dayChasse[i];
            var rapace = rapaces.find(r => r.id === chasse.rapaceId);
            var rapaceName = rapace ? rapace.name : 'Rapace inconnu';
            
            if (!activitiesByRapace[rapaceName]) {
                activitiesByRapace[rapaceName] = [];
            }
            
            activitiesByRapace[rapaceName].push({
                type: 'Chasse',
                icon: 'üèπ',
                time: chasse.time,
                detail: chasse,
                category: 'chasse'
            });
        }
        
        // Ajouter les affaitages
        for (var i = 0; i < dayAffaitage.length; i++) {
            var affaitage = dayAffaitage[i];
            var rapace = rapaces.find(r => r.id === affaitage.rapaceId);
            var rapaceName = rapace ? rapace.name : 'Rapace inconnu';
            
            if (!activitiesByRapace[rapaceName]) {
                activitiesByRapace[rapaceName] = [];
            }
            
            activitiesByRapace[rapaceName].push({
                type: 'Affaitage',
                icon: 'ü¶Ö',
                time: affaitage.time,
                detail: affaitage,
                category: 'affaitage'
            });
        }
        
        // Afficher par rapace
        var rapaceNames = Object.keys(activitiesByRapace).sort();
        for (var r = 0; r < rapaceNames.length; r++) {
            var rapaceName = rapaceNames[r];
            var activities = activitiesByRapace[rapaceName];
            
            // Trier les activit√©s par heure
            activities.sort(function(a, b) {
                return a.time.localeCompare(b.time);
            });
            
            content += '<div style="background: #f8f9fa; margin: 15px 0; padding: 20px; border-radius: 15px; border-left: 5px solid #2a5298;">';
            content += '<h4 style="color: #1e3c72; margin-bottom: 15px;">ü¶Ö ' + rapaceName + ' (' + activities.length + ' activit√©s)</h4>';
            
            for (var a = 0; a < activities.length; a++) {
                var activity = activities[a];
                var detail = activity.detail;
                
                content += '<div class="entry-item" style="margin: 10px 0;">';
                content += '<div class="date">' + activity.time + ' ‚Ä¢ ' + activity.icon + ' ' + activity.type + '</div>';
                content += '<div class="content">';
                
                if (activity.category === 'entry') {
                    content += '<strong>' + detail.type.charAt(0).toUpperCase() + detail.type.slice(1) + '</strong>';
                    
                    if (detail.type === 'nourriture') {
                        content += '<br>‚Ä¢ Poids: ' + (detail.poidsAvant || '?') + 'g ‚Üí ' + (detail.poidsApres || '?') + 'g';
                        content += '<br>‚Ä¢ Menu: ' + detail.menu + ' (' + detail.quantite + ')';
                    } else if (detail.type === 'vol') {
                        content += '<br>‚Ä¢ Type de vol: ' + detail.typeVol;
                    } else if (detail.type === 'comportement') {
                        content += '<br>‚Ä¢ R√©activit√©: ' + detail.reactivite + '/5';
                    } else if (detail.type === 'sante') {
                        content += '<br>‚Ä¢ √âtat de sant√©: ' + detail.etatSante;
                    } else if (detail.type === 'entrainement') {
                        content += '<br>‚Ä¢ Type d\'entra√Ænement: ' + detail.typeEntrainement;
                    }
                    
                } else if (activity.category === 'chasse') {
                    var totalPrises = detail.faisan + detail.perdrix + detail.lapin + detail.lievre + detail.canard + detail.oie + detail.autre;
                    content += '<strong>Session de chasse - ' + totalPrises + ' prise(s)</strong>';
                    
                    var prises = [];
                    if (detail.faisan > 0) prises.push('Faisan: ' + detail.faisan);
                    if (detail.perdrix > 0) prises.push('Perdrix: ' + detail.perdrix);
                    if (detail.lapin > 0) prises.push('Lapin: ' + detail.lapin);
                    if (detail.lievre > 0) prises.push('Li√®vre: ' + detail.lievre);
                    if (detail.canard > 0) prises.push('Canard: ' + detail.canard);
                    if (detail.oie > 0) prises.push('Oie: ' + detail.oie);
                    if (detail.autre > 0) prises.push('Autre: ' + detail.autre);
                    
                    if (prises.length > 0) {
                        content += '<br>‚Ä¢ D√©tail: ' + prises.join(', ');
                    } else {
                        content += '<br>‚Ä¢ Aucune prise';
                    }
                    
                } else if (activity.category === 'affaitage') {
                    content += '<strong>S√©ance d\'affaitage</strong>';
                    
                    var activitesAffaitage = [];
                    if (detail.priseNourriture) activitesAffaitage.push('Prise de nourriture');
                    if (detail.gant) activitesAffaitage.push('Travail au gant');
                    if (detail.filiere) activitesAffaitage.push('Fili√®re');
                    if (detail.libre) activitesAffaitage.push('Vol libre');
                    
                    if (activitesAffaitage.length > 0) {
                        content += '<br>‚Ä¢ Activit√©s: ' + activitesAffaitage.join(', ');
                    } else {
                        content += '<br>‚Ä¢ Aucune activit√© sp√©cifique';
                    }
                }
                
                // Notes
                if (detail.notes && detail.notes.trim()) {
                    content += '<br>‚Ä¢ <em>Notes: ' + detail.notes + '</em>';
                }
                
                content += '</div></div>';
            }
            
            content += '</div>';
        }
        
        // R√©sum√© de fin
        content += '<div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-top: 20px;">';
        content += '<h4 style="color: #1e3c72;">üìä R√©sum√© de la journ√©e</h4>';
        content += '<p><strong>‚Ä¢ ' + rapaceNames.length + '</strong> rapace(s) ont eu des activit√©s</p>';
        content += '<p><strong>‚Ä¢ ' + dayEntries.length + '</strong> activit√©(s) de suivi quotidien</p>';
        content += '<p><strong>‚Ä¢ ' + dayChasse.length + '</strong> session(s) de chasse</p>';
        content += '<p><strong>‚Ä¢ ' + dayAffaitage.length + '</strong> s√©ance(s) d\'affaitage</p>';
        
        // Calcul total des prises de chasse
        var totalPrisesJour = 0;
        for (var i = 0; i < dayChasse.length; i++) {
            var chasse = dayChasse[i];
            totalPrisesJour += chasse.faisan + chasse.perdrix + chasse.lapin + chasse.lievre + chasse.canard + chasse.oie + chasse.autre;
        }
        if (totalPrisesJour > 0) {
            content += '<p><strong>‚Ä¢ ' + totalPrisesJour + '</strong> prise(s) de chasse au total</p>';
        }
        
        if (weatherOfDay) {
            content += '<p><strong>‚Ä¢ Conditions m√©t√©o:</strong> ' + weatherOfDay + '</p>';
        }
        
        content += '</div>';
        
    } else {
        content += '<div style="text-align: center; color: #666; margin: 40px 0;">';
        content += '<h3>üò¥ Journ√©e de repos</h3>';
        content += '<p>Aucune activit√© enregistr√©e pour cette date.</p>';
        content += '</div>';
    }
    
    content += '</div>';
    
    document.getElementById('stats-content').innerHTML = content;
}

// Export/Import/Clear
function exportAllData() {
    var allData = {
        rapaces: rapaces,
        entries: entries,
        chasseEntries: chasseEntries,
        affaitageEntries: affaitageEntries,
        currentLocation: currentLocation,
        exportDate: new Date().toISOString()
    };
    
    var dataStr = JSON.stringify(allData, null, 2);
    var blob = new Blob([dataStr], { type: 'application/json' });
    var url = URL.createObjectURL(blob);
    var link = document.createElement('a');
    link.href = url;
    link.download = 'rapaces_backup.json';
    link.click();
    URL.revokeObjectURL(url);
    
    alert('Sauvegarde export√©e !');
}

function importAllData() {
    var input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = function(e) {
        var file = e.target.files[0];
        if (file) {
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    var data = JSON.parse(e.target.result);
                    
                    if (confirm('Importer ces donn√©es ? (remplace tout)')) {
                        rapaces = data.rapaces || [];
                        entries = data.entries || [];
                        chasseEntries = data.chasseEntries || [];
                        affaitageEntries = data.affaitageEntries || [];
                        currentLocation = data.currentLocation || "Orthez (64300)";
                        
                        saveAllData();
                        updateRapaceList();
                        updateRapaceSelects();
                        updateEntryList();
                        updatechasseList();
                        updateAffaitageList();
                        loadWeather();
                        
                        alert('Donn√©es import√©es !');
                    }
                } catch (error) {
                    alert('Erreur : fichier non valide');
                }
            };
            reader.readAsText(file);
        }
    };
    
    input.click();
}

function clearAllData() {
    if (confirm('Effacer TOUTES les donn√©es ?')) {
        if (confirm('Derni√®re confirmation - tout sera perdu !')) {
            rapaces = [];
            entries = [];
            chasseEntries = [];
            affaitageEntries = [];
            
            localStorage.removeItem('rapaces_data');
            
            updateRapaceList();
            updateRapaceSelects();
            updateEntryList();
            updatechasseList();
            updateAffaitageList();
            
            alert('Donn√©es effac√©es !');
        }
    }
}

// Initialisation
window.onload = function() {
    loadAllData();
    loadWeather();
    
    var now = new Date();
    var dateInputs = ['event-date', 'chasse-date', 'affaitage-date', 'stats-date'];
    var timeInputs = ['event-time', 'chasse-time', 'affaitage-time'];
    
    for (var i = 0; i < dateInputs.length; i++) {
        var input = document.getElementById(dateInputs[i]);
        if (input) {
            input.value = now.toISOString().split('T')[0];
        }
    }
    
    for (var i = 0; i < timeInputs.length; i++) {
        var input = document.getElementById(timeInputs[i]);
        if (input) {
            input.value = now.toTimeString().slice(0, 5);
        }
    }
    
    currentStatsDate = now;
    
    updateRapaceList();
    updateRapaceSelects();
    updateEntryList();
    updatechasseList();
    updateAffaitageList();
    showEventFields();
    
    // Sauvegarder toutes les 30 secondes
    setInterval(saveAllData, 30000);
};

// Fermer modal en cliquant √† c√¥t√©
window.onclick = function(event) {
    var modal = document.getElementById('editModal');
    if (event.target == modal) {
        closeEditModal();
    }
};
</script>
</body>
</html>