<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestionnaire de Rapaces</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'><circle cx='100' cy='100' r='95' fill='white' stroke='%23333' stroke-width='10'/><g transform='translate(100,100) scale(0.8)'><path d='M-60,-20 Q-40,-60 0,-40 Q40,-60 60,-20 Q50,-40 20,-30 Q10,-50 0,-35 Q-10,-50 -20,-30 Q-50,-40 -60,-20' fill='%23333'/><circle cx='-25' cy='-25' r='5' fill='%23333'/><path d='M-10,-10 Q0,0 10,-10 Q15,-5 5,-5 Q-5,-5 -10,-10' fill='%23333'/><path d='M-40,10 Q-20,20 0,10 Q20,20 40,10 Q30,30 0,25 Q-30,30 -40,10' fill='%23333'/><path d='M-30,-10 Q-20,0 -10,-10 M10,-10 Q20,0 30,-10' stroke='%23333' stroke-width='2' fill='none'/><path d='M-70,-30 Q-50,-10 -30,-20 M30,-20 Q50,-10 70,-30' stroke='%23333' stroke-width='3' fill='none'/><path d='M-60,20 Q-40,40 -20,30 M20,30 Q40,40 60,20' stroke='%23333' stroke-width='3' fill='none'/><circle cx='45' cy='45' r='2' fill='%23333'/><circle cx='-35' cy='55' r='1.5' fill='%23333'/><rect x='-15' y='35' width='4' height='2' fill='%23333'/></g></svg>" type="image/svg+xml">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
            z-index: 1;
        }

        .header {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            text-align: center;
            padding: 30px 20px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .weather-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            margin-top: 15px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            min-width: 100px;
            padding: 15px 10px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            color: #2a5298;
            border-bottom-color: #2a5298;
            background: white;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            gap: 15px;
            align-items: end;
        }

        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #2a5298;
        }

        button {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        button:hover {
            transform: translateY(-2px);
        }

        button.btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        button.btn-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #545b62 100%);
        }

        button.btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #212529;
        }

        button.btn-success {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
        }

        .entry-item {
            background: #f0f4f8;
            margin: 15px 0;
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid #2a5298;
            position: relative;
        }

        .entry-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
        }

        .entry-actions button {
            padding: 4px 8px;
            font-size: 12px;
            min-width: auto;
        }

        .entry-item .date {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
        }

        .entry-item .content {
            color: #333;
        }

        .rapace-card {
            background: #f0f4f8;
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
            border: 2px solid #e3f2fd;
            position: relative;
        }

        .rapace-card h3 {
            color: #1e3c72;
            margin-bottom: 10px;
        }

        .rapace-actions {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
        }

        .rapace-actions button {
            padding: 8px 12px;
            font-size: 12px;
        }

        .weather-info {
            color: #e3f2fd;
            font-size: 14px;
        }

        .conditional-fields {
            display: none;
            margin-top: 15px;
            padding: 15px;
            background: #f0f4f8;
            border-radius: 8px;
        }

        .conditional-fields.active {
            display: block;
        }

        .rating-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .rating-group input[type="radio"] {
            width: auto;
        }

        .hunt-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .hunt-item {
            background: #f0f4f8;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #e3f2fd;
        }

        .checkbox-group {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: auto;
        }

        .day-card {
            background: #f0f4f8;
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            border-left: 4px solid #2a5298;
        }

        .day-card h4 {
            color: #1e3c72;
            margin-bottom: 10px;
        }

        .day-navigation {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-card h3 {
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .stat-card .value {
            font-size: 2em;
            font-weight: bold;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .photo-preview {
            max-width: 200px;
            max-height: 200px;
            border-radius: 10px;
            margin: 10px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .rapace-photo {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 10px;
            border: 2px solid #e3f2fd;
            margin-right: 15px;
            float: left;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            display: inline-block;
            padding: 12px 24px;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .file-input-label:hover {
            transform: translateY(-2px);
        }

        .session-status {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 10px;
        }

        .session-fin {
            background: #dc3545;
            color: white;
        }

        .session-reprise {
            background: #28a745;
            color: white;
        }

        .session-jour {
            background: #6f42c1;
            color: white;
            font-size: 0.9em;
        }

        .session-history-card {
            background: #f8f9fa;
            border-left: 4px solid #6f42c1;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
        }

        .session-active {
            background: #e8f5e8;
            border-left-color: #28a745;
        }

        .session-terminated {
            background: #f8f9fa;
            border-left-color: #6c757d;
        }

        .affaitage-photo {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 10px;
            border: 2px solid #e3f2fd;
            margin: 10px 15px 10px 0;
            float: left;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            cursor: pointer;
            position: relative;
        }

        .photo-container {
            position: relative;
            display: inline-block;
            float: left;
        }

        .photo-delete-btn {
            position: absolute;
            top: -5px;
            right: 10px;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 25px;
            height: 25px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .photo-delete-btn:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        .chasse-photo {
            width: 120px;
            height: 120px;
            object-fit: cover;
            border-radius: 10px;
            border: 2px solid #e3f2fd;
            margin: 10px 15px 10px 0;
            float: left;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            cursor: pointer;
        }

        .chasse-content {
            margin-left: 0;
        }

        .chasse-content::after {
            content: "";
            display: table;
            clear: both;
        }

        .affaitage-content {
            margin-left: 0;
        }

        .affaitage-content::after {
            content: "";
            display: table;
            clear: both;
        }

        /* Styles pour l'onglet Documents */
        .document-card {
            background: #f0f4f8;
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
            border: 2px solid #e3f2fd;
            position: relative;
        }

        .document-actions {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
        }

        .document-preview {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 10px;
            border: 2px solid #e3f2fd;
            margin-right: 15px;
            float: left;
        }

        .document-icon {
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #e3f2fd;
            border-radius: 10px;
            margin-right: 15px;
            float: left;
            font-size: 30px;
        }

        .category-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .category-btn {
            padding: 8px 16px;
            border: 2px solid #2a5298;
            background: white;
            color: #2a5298;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .category-btn.active {
            background: #2a5298;
            color: white;
        }

        /* Styles pour l'onglet Leurre */
        .leurre-card {
            background: #f0f4f8;
            padding: 20px;
            border-radius: 15px;
            margin: 15px 0;
            border: 2px solid #e3f2fd;
            position: relative;
        }

        .leurre-actions {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            gap: 10px;
        }

        .leurre-photo {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 10px;
            border: 2px solid #e3f2fd;
            margin-right: 15px;
            float: left;
        }

        .efficacite-bar {
            background: #e9ecef;
            height: 20px;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }

        .efficacite-fill {
            height: 100%;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            transition: width 0.3s ease;
        }

        .session-leurre {
            background: #e8f5e8;
            border-left: 4px solid #28a745;
            padding: 15px;
            margin: 10px 0;
            border-radius: 10px;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
            <svg width="80" height="80" viewBox="0 0 200 200" style="filter: drop-shadow(2px 2px 4px rgba(0,0,0,0.3));">
                <circle cx="100" cy="100" r="95" fill="white" stroke="#1e3c72" stroke-width="8"/>
                <g transform="translate(100,100) scale(0.7)">
                    <path d="M-70,-30 Q-50,-70 0,-50 Q50,-70 70,-30 Q60,-50 30,-40 Q15,-65 0,-45 Q-15,-65 -30,-40 Q-60,-50 -70,-30" fill="#1e3c72"/>
                    <circle cx="-30" cy="-30" r="8" fill="white"/>
                    <circle cx="-28" cy="-32" r="5" fill="#1e3c72"/>
                    <circle cx="-26" cy="-34" r="2" fill="white"/>
                    <path d="M-15,-15 Q5,5 15,-15 Q20,-10 10,-8 Q-10,-8 -15,-15" fill="#2a5298"/>
                    <path d="M-50,15 Q-30,30 0,15 Q30,30 50,15 Q40,40 0,35 Q-40,40 -50,15" fill="#1e3c72"/>
                </g>
            </svg>
            <div>
                <h1>🦅 Gestionnaire de Rapaces</h1>
                <p>Suivi quotidien de vos compagnons ailés</p>
            </div>
        </div>
        <div class="weather-controls">
            <p id="weather-info" class="weather-info">🌦️ Chargement météo...</p>
            <button onclick="refreshWeather()" style="padding: 8px 16px; font-size: 12px;">🔄</button>
            <button onclick="changeLocation()" style="padding: 8px 16px; font-size: 12px;">📍</button>
        </div>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="showTab('gestion')">Gestion</button>
        <button class="tab" onclick="showTab('suivi')">Suivi</button>
        <button class="tab" onclick="showTab('chasse')">Chasse</button>
        <button class="tab" onclick="showTab('affaitage')">Affaitage</button>
        <button class="tab" onclick="showTab('leurre')">🎯 Leurre</button>
        <button class="tab" onclick="showTab('documents')">📁 Documents</button>
        <button class="tab" onclick="showTab('sync')">Sync</button>
        <button class="tab" onclick="showTab('stats')">Stats</button>
    </div>

    <!-- Onglet Gestion -->
    <div id="gestion" class="tab-content active">
        <h2>Ajouter un Rapace</h2>
        <div class="form-group">
            <label for="rapace-name">Nom du rapace :</label>
            <input type="text" id="rapace-name" placeholder="Ex: Aigle royal">
        </div>
        <div class="form-group">
            <label for="rapace-species">Espèce :</label>
            <input type="text" id="rapace-species" placeholder="Ex: Aquila chrysaetos">
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="rapace-bague">Numéro de bague :</label>
                <input type="text" id="rapace-bague" placeholder="Ex: AB123456">
            </div>
            <div class="form-group">
                <label for="rapace-birthdate">Date de naissance :</label>
                <input type="date" id="rapace-birthdate">
            </div>
            <div class="form-group">
                <label for="rapace-sex">Sexe :</label>
                <select id="rapace-sex">
                    <option value="forme">Forme</option>
                    <option value="tiercelet">Tiercelet</option>
                </select>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="rapace-poids-plein">Poids plein (g) :</label>
                <input type="number" id="rapace-poids-plein" min="0" placeholder="Ex: 1200">
            </div>
            <div class="form-group">
                <label for="rapace-poids-vol">Poids vol (g) :</label>
                <input type="number" id="rapace-poids-vol" min="0" placeholder="Ex: 1100">
            </div>
            <div class="form-group">
                <label for="rapace-poids-chasse">Poids chasse (g) :</label>
                <input type="number" id="rapace-poids-chasse" min="0" placeholder="Ex: 1000">
            </div>
        </div>
        <div class="form-group">
            <label for="rapace-photo">Photo du rapace :</label>
            <div class="file-input-wrapper">
                <input type="file" id="rapace-photo" accept="image/*" onchange="previewRapacePhoto(this)">
                <label for="rapace-photo" class="file-input-label">📷 Choisir une photo</label>
            </div>
            <div id="photo-preview-container"></div>
        </div>
        <button onclick="addRapace()">Ajouter le Rapace</button>

        <h2 style="margin-top: 40px;">Mes Rapaces</h2>
        <div id="rapace-list"></div>
    </div>

    <!-- Onglet Suivi -->
    <div id="suivi" class="tab-content">
        <h2>Suivi Quotidien</h2>
        <div class="form-group">
            <label for="rapace-select">Sélectionner un rapace :</label>
            <select id="rapace-select" onchange="updateEntryList()">
                <option value="">Choisir un rapace</option>
            </select>
        </div>
        <div class="form-group">
            <label for="event-type">Type d'événement :</label>
            <select id="event-type" onchange="showEventFields()">
                <option value="nourriture">Nourriture</option>
                <option value="vol">Vol</option>
                <option value="comportement">Comportement</option>
                <option value="sante">Santé</option>
                <option value="entrainement">Entraînement</option>
            </select>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="event-date">Date :</label>
                <input type="date" id="event-date">
            </div>
            <div class="form-group">
                <label for="event-time">Heure :</label>
                <input type="time" id="event-time">
            </div>
        </div>
        
        <div class="form-group">
            <label for="event-notes">Notes :</label>
            <textarea id="event-notes" rows="3" placeholder="Observations..."></textarea>
        </div>

        <div id="nourriture-fields" class="conditional-fields active">
            <div class="form-row">
                <div class="form-group">
                    <label for="poids-avant">Poids avant (g) :</label>
                    <input type="number" id="poids-avant" min="0" onchange="calculateWeightDifference()">
                </div>
                <div class="form-group">
                    <label for="poids-apres">Poids après (g) :</label>
                    <input type="number" id="poids-apres" min="0" onchange="calculateWeightDifference()">
                </div>
                <div class="form-group">
                    <label for="difference-poids">Différence (g) :</label>
                    <input type="text" id="difference-poids" readonly style="background: #f8f9fa; color: #666;">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label for="detail-nourriture">Menu :</label>
                    <select id="detail-nourriture">
                        <option value="poussin">Poussin</option>
                        <option value="caille">Caille</option>
                        <option value="pigeon">Pigeon</option>
                        <option value="lapin">Lapin</option>
                        <option value="lievre">Lièvre</option>
                        <option value="canard">Canard</option>
                        <option value="faisan">Faisan</option>
                        <option value="perdrix">Perdrix</option>
                        <option value="boeuf">Bœuf</option>
                        <option value="autre">Autre</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="quantite-nourriture">Quantité :</label>
                    <input type="text" id="quantite-nourriture" placeholder="Ex: 200g">
                </div>
            </div>
        </div>

        <div id="vol-fields" class="conditional-fields">
            <div class="form-group">
                <label for="type-vol">Type de vol :</label>
                <select id="type-vol">
                    <option value="suite">Suité</option>
                    <option value="chasse">Chasse</option>
                    <option value="entrainement">Entraînement</option>
                </select>
            </div>
        </div>

        <div id="comportement-fields" class="conditional-fields">
            <div class="form-group">
                <label>Réactivité (1-5) :</label>
                <div class="rating-group">
                    <input type="radio" id="react1" name="reactivite" value="1">
                    <label for="react1">1</label>
                    <input type="radio" id="react2" name="reactivite" value="2">
                    <label for="react2">2</label>
                    <input type="radio" id="react3" name="reactivite" value="3">
                    <label for="react3">3</label>
                    <input type="radio" id="react4" name="reactivite" value="4">
                    <label for="react4">4</label>
                    <input type="radio" id="react5" name="reactivite" value="5">
                    <label for="react5">5</label>
                </div>
            </div>
        </div>

        <div id="sante-fields" class="conditional-fields">
            <div class="form-group">
                <label for="etat-sante">État :</label>
                <select id="etat-sante">
                    <option value="ras">RAS</option>
                    <option value="pb">PB</option>
                </select>
            </div>
        </div>

        <div id="entrainement-fields" class="conditional-fields">
            <div class="form-group">
                <label for="type-entrainement">Type d'entraînement :</label>
                <select id="type-entrainement">
                    <option value="filiere">Filière</option>
                    <option value="charriot">Charriot + leurre</option>
                    <option value="rc-voiture">RC Voiture + leurre</option>
                    <option value="drone">Drone + leurre</option>
                    <option value="leurre">Leurre</option>
                    <option value="vivant">Vivant</option>
                    <option value="corde">Corde</option>
                    <option value="ascendant">Ascendant</option>
                </select>
            </div>
        </div>

        <button onclick="addEntry()">Ajouter l'Entrée</button>

        <h2 style="margin-top: 40px;">Historique Récent</h2>
        <div id="entry-list"></div>
    </div>

    <!-- Onglet Chasse -->
    <div id="chasse" class="tab-content">
        <h2>Registre de Chasse</h2>
        <div class="form-group">
            <label for="chasse-rapace">Rapace :</label>
            <select id="chasse-rapace" onchange="updatePoidsChaseReference()">
                <option value="">Choisir un rapace</option>
            </select>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="chasse-date">Date :</label>
                <input type="date" id="chasse-date">
            </div>
            <div class="form-group">
                <label for="chasse-time">Heure :</label>
                <input type="time" id="chasse-time">
            </div>
        </div>
        
        <div class="hunt-grid">
            <div class="hunt-item">
                <label for="chasse-faisan">Faisan :</label>
                <input type="number" id="chasse-faisan" min="0" max="10" value="0">
            </div>
            <div class="hunt-item">
                <label for="chasse-perdrix">Perdrix :</label>
                <input type="number" id="chasse-perdrix" min="0" max="10" value="0">
            </div>
            <div class="hunt-item">
                <label for="chasse-lapin">Lapin :</label>
                <input type="number" id="chasse-lapin" min="0" max="10" value="0">
            </div>
            <div class="hunt-item">
                <label for="chasse-lievre">Lièvre :</label>
                <input type="number" id="chasse-lievre" min="0" max="10" value="0">
            </div>
            <div class="hunt-item">
                <label for="chasse-canard">Canard :</label>
                <input type="number" id="chasse-canard" min="0" max="10" value="0">
            </div>
            <div class="hunt-item">
                <label for="chasse-oie">Oie :</label>
                <input type="number" id="chasse-oie" min="0" max="10" value="0">
            </div>
            <div class="hunt-item">
                <label for="chasse-autre">Autre :</label>
                <input type="number" id="chasse-autre" min="0" max="10" value="0">
            </div>
        </div>
        
        <div class="form-row" style="margin-top: 20px;">
            <div class="form-group">
                <label for="chasse-poids-jour">Poids du jour (g) :</label>
                <input type="number" id="chasse-poids-jour" min="0" placeholder="Poids avant la chasse">
            </div>
            <div class="form-group" id="poids-chasse-reference" style="padding: 12px; background: #f8f9fa; border-radius: 8px; display: flex; align-items: center;">
                <span style="color: #666;">Sélectionnez un rapace pour voir son poids de chasse</span>
            </div>
        </div>
        
        <div class="form-group">
            <label for="chasse-notes">Notes :</label>
            <textarea id="chasse-notes" rows="3" placeholder="Observations sur la chasse..."></textarea>
        </div>
        
        <div class="form-group">
            <label for="chasse-photo">📷 Photo de la chasse :</label>
            <div class="file-input-wrapper">
                <input type="file" id="chasse-photo" accept="image/*" onchange="previewChassePhoto(this)">
                <label for="chasse-photo" class="file-input-label">📷 Prendre/Choisir une photo</label>
            </div>
            <div id="chasse-photo-preview"></div>
        </div>
        
        <button onclick="addChasse()">Enregistrer la Chasse</button>
        
        <h2 style="margin-top: 40px;">Historique des Chasses</h2>
        <div id="chasse-list"></div>
    </div>

    <!-- Onglet Affaitage -->
    <div id="affaitage" class="tab-content">
        <h2>Affaitage</h2>
        <div class="form-group">
            <label for="affaitage-rapace">Rapace :</label>
            <select id="affaitage-rapace">
                <option value="">Choisir un rapace</option>
            </select>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="affaitage-date">Date :</label>
                <input type="date" id="affaitage-date">
            </div>
            <div class="form-group">
                <label for="affaitage-time">Heure :</label>
                <input type="time" id="affaitage-time">
            </div>
        </div>
        
        <div class="form-group">
            <label for="affaitage-poids">Poids (g) :</label>
            <input type="number" id="affaitage-poids" min="0" placeholder="Ex: 1050">
        </div>
        
        <div class="form-group">
            <label>Activités :</label>
            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="voliere">
                    <label for="voliere">🏠 Volière</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="prise-nourriture">
                    <label for="prise-nourriture">🍽️ Prise de nourriture</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="gant">
                    <label for="gant">🧤 Gant</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="filiere">
                    <label for="filiere">🎯 Filière</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="bloc">
                    <label for="bloc">🧱 Bloc</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="libre">
                    <label for="libre">🕊️ Libre</label>
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label>Gestion de session :</label>
            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="fin-affaitage">
                    <label for="fin-affaitage">🔚 Fin d'affaitage</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="reprise-affaitage">
                    <label for="reprise-affaitage">🔄 Reprise affaitage</label>
                </div>
            </div>
        </div>
        
        <div class="form-group">
            <label for="affaitage-notes">Notes :</label>
            <textarea id="affaitage-notes" rows="3" placeholder="Observations sur l'affaitage..."></textarea>
        </div>
        
        <div class="form-group">
            <label for="affaitage-evenement">🌟 Événement marquant (optionnel) :</label>
            <textarea id="affaitage-evenement" rows="2" placeholder="Ex: Premier vol libre réussi, Refus de prendre la nourriture, Agressivité inhabituelle..."></textarea>
        </div>
        
        <div class="form-group">
            <label for="affaitage-photo">📷 Photo de la session :</label>
            <div class="file-input-wrapper">
                <input type="file" id="affaitage-photo" accept="image/*" onchange="previewAffaitagePhoto(this)">
                <label for="affaitage-photo" class="file-input-label">📷 Prendre/Choisir une photo</label>
            </div>
            <div id="affaitage-photo-preview"></div>
        </div>
        
        <button onclick="addAffaitage()">Enregistrer l'Affaitage</button>
        
        <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 40px;">
            <h2>Historique d'Affaitage</h2>
            <button onclick="showEvenementsMarquants()" class="btn-warning">🌟 Événements marquants</button>
        </div>
        <div id="affaitage-list"></div>
    </div>

    <!-- NOUVEL ONGLET LEURRE -->
    <div id="leurre" class="tab-content">
        <h2>🎯 Gestion des Leurres</h2>
        
        <!-- Ajouter un nouveau leurre -->
        <div class="day-card">
            <h3>Ajouter un Leurre</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="leurre-nom">Nom du leurre :</label>
                    <input type="text" id="leurre-nom" placeholder="Ex: Leurre plume rouge">
                </div>
                <div class="form-group">
                    <label for="leurre-type">Type :</label>
                    <select id="leurre-type">
                        <option value="plume">Plume</option>
                        <option value="fourrure">Fourrure</option>
                        <option value="mixte">Mixte</option>
                        <option value="proie-artificielle">Proie artificielle</option>
                        <option value="drone">Drone + leurre</option>
                        <option value="autre">Autre</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="leurre-couleur">Couleur principale :</label>
                    <input type="text" id="leurre-couleur" placeholder="Ex: Rouge, Brun, Blanc...">
                </div>
                <div class="form-group">
                    <label for="leurre-taille">Taille (cm) :</label>
                    <input type="number" id="leurre-taille" min="1" placeholder="Ex: 25">
                </div>
                <div class="form-group">
                    <label for="leurre-poids-g">Poids (g) :</label>
                    <input type="number" id="leurre-poids-g" min="1" placeholder="Ex: 150">
                </div>
            </div>
            
            <div class="form-group">
                <label for="leurre-description">Description :</label>
                <textarea id="leurre-description" rows="2" placeholder="Description détaillée du leurre..."></textarea>
            </div>
            
            <div class="form-group">
                <label for="leurre-photo">📷 Photo du leurre :</label>
                <div class="file-input-wrapper">
                    <input type="file" id="leurre-photo" accept="image/*" onchange="previewLeurrePhoto(this)">
                    <label for="leurre-photo" class="file-input-label">📷 Prendre/Choisir une photo</label>
                </div>
                <div id="leurre-photo-preview"></div>
            </div>
            
            <button onclick="addLeurre()">Créer le Leurre</button>
        </div>

        <!-- Session d'utilisation -->
        <div class="day-card">
            <h3>📝 Enregistrer une Session de Leurre</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="session-leurre">Leurre utilisé :</label>
                    <select id="session-leurre">
                        <option value="">Choisir un leurre</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="session-rapace">Rapace :</label>
                    <select id="session-rapace">
                        <option value="">Choisir un rapace</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="session-date">Date :</label>
                    <input type="date" id="session-date">
                </div>
                <div class="form-group">
                    <label for="session-time">Heure :</label>
                    <input type="time" id="session-time">
                </div>
                <div class="form-group">
                    <label for="session-duree">Durée (min) :</label>
                    <input type="number" id="session-duree" min="1" placeholder="Ex: 30">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="session-reussite">Réussite :</label>
                    <select id="session-reussite">
                        <option value="excellente">Excellente - Rapace très réactif</option>
                        <option value="bonne">Bonne - Rapace réactif</option>
                        <option value="moyenne">Moyenne - Quelques hésitations</option>
                        <option value="difficile">Difficile - Peu d'intérêt</option>
                        <option value="echec">Échec - Aucun intérêt</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="session-nb-passes">Nombre de passes :</label>
                    <input type="number" id="session-nb-passes" min="0" placeholder="Ex: 15">
                </div>
            </div>
            
            <div class="form-group">
                <label>Conditions :</label>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="session-vent-fort">
                        <label for="session-vent-fort">💨 Vent fort</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="session-pluie">
                        <label for="session-pluie">🌧️ Pluie</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="session-premiere-fois">
                        <label for="session-premiere-fois">🆕 Première utilisation</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="session-rapace-affame">
                        <label for="session-rapace-affame">🍖 Rapace affamé</label>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="session-notes">Notes de session :</label>
                <textarea id="session-notes" rows="3" placeholder="Observations, comportement du rapace, amélioration à apporter..."></textarea>
            </div>
            
            <button onclick="addSessionLeurre()">Enregistrer la Session</button>
        </div>

        <!-- Liste des leurres -->
        <h2 style="margin-top: 40px;">🎯 Mes Leurres</h2>
        <div id="leurre-list"></div>
        
        <!-- Historique des sessions -->
        <h2 style="margin-top: 40px;">📊 Historique des Sessions</h2>
        <div id="sessions-leurre-list"></div>
    </div>

    <!-- NOUVEL ONGLET DOCUMENTS -->
    <div id="documents" class="tab-content">
        <h2>📁 Gestion des Documents</h2>
        
        <!-- Ajouter un document -->
        <div class="day-card">
            <h3>📎 Ajouter un Document</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="doc-nom">Nom du document :</label>
                    <input type="text" id="doc-nom" placeholder="Ex: Certificat vétérinaire">
                </div>
                <div class="form-group">
                    <label for="doc-categorie">Catégorie :</label>
                    <select id="doc-categorie">
                        <option value="sante">🏥 Santé</option>
                        <option value="legal">⚖️ Légal/Administratif</option>
                        <option value="formation">🎓 Formation</option>
                        <option value="equipement">🔧 Équipement</option>
                        <option value="chasse">🏹 Chasse</option>
                        <option value="elevage">🥚 Élevage</option>
                        <option value="autre">📋 Autre</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="doc-rapace">Rapace concerné (optionnel) :</label>
                    <select id="doc-rapace">
                        <option value="">Général/Tous les rapaces</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="doc-date">Date du document :</label>
                    <input type="date" id="doc-date">
                </div>
            </div>
            
            <div class="form-group">
                <label for="doc-description">Description :</label>
                <textarea id="doc-description" rows="2" placeholder="Description ou résumé du document..."></textarea>
            </div>
            
            <div class="form-group">
                <label for="doc-file">📁 Fichier :</label>
                <div class="file-input-wrapper">
                    <input type="file" id="doc-file" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif,.txt" onchange="previewDocument(this)">
                    <label for="doc-file" class="file-input-label">📁 Choisir un fichier</label>
                </div>
                <div id="doc-file-preview"></div>
                <small style="color: #666;">Formats supportés: PDF, Word, Images, Texte</small>
            </div>
            
            <button onclick="addDocument()">Ajouter le Document</button>
        </div>

        <!-- Filtres par catégorie -->
        <div style="margin: 30px 0;">
            <h3>🏷️ Filtrer par catégorie</h3>
            <div class="category-filter">
                <button class="category-btn active" onclick="filterDocuments('all')">Tous</button>
                <button class="category-btn" onclick="filterDocuments('sante')">🏥 Santé</button>
                <button class="category-btn" onclick="filterDocuments('legal')">⚖️ Légal</button>
                <button class="category-btn" onclick="filterDocuments('formation')">🎓 Formation</button>
                <button class="category-btn" onclick="filterDocuments('equipement')">🔧 Équipement</button>
                <button class="category-btn" onclick="filterDocuments('chasse')">🏹 Chasse</button>
                <button class="category-btn" onclick="filterDocuments('elevage')">🥚 Élevage</button>
                <button class="category-btn" onclick="filterDocuments('autre')">📋 Autre</button>
            </div>
        </div>

        <!-- Liste des documents -->
        <h2>📋 Mes Documents</h2>
        <div id="documents-list"></div>
    </div>

    <!-- Onglet Sync -->
    <div id="sync" class="tab-content">
        <h2>🔥 Synchronisation Firebase</h2>
        
        <div class="day-card">
            <h4 id="sync-status">📊 État de la synchronisation</h4>
            <p id="sync-details">🔄 Non configuré</p>
            <p id="last-sync-time">Dernière sync : Jamais</p>
        </div>

        <div style="margin: 20px 0;">
            <h3>🔧 Configuration</h3>
            <div style="display: flex; gap: 10px; margin: 15px 0; flex-wrap: wrap;">
                <button onclick="initFirebaseSync()" id="connect-drive-btn">🔗 Activer Firebase</button>
                <button onclick="manualFirebaseSync()" id="manual-sync-btn" style="display: none;">⚡ Synchroniser maintenant</button>
                <button onclick="forceUploadToFirebase()" id="force-upload-btn" style="display: none;" class="btn-warning">🚀 Forcer upload local → Firebase</button>
                <button onclick="forceDownloadFromFirebase()" id="force-download-btn" style="display: none;" class="btn-warning">📥 Forcer download Firebase → local</button>
                <button onclick="refreshAllData()" id="refresh-btn" style="display: none;">🔄 Actualiser tout</button>
                <button onclick="disconnectFirebase()" id="disconnect-drive-btn" style="display: none;" class="btn-secondary">❌ Déconnecter</button>
            </div>
            <p style="font-size: 14px; color: #666;">
                La synchronisation Firebase permet de garder vos données à jour sur tous vos appareils automatiquement.
            </p>
        </div>

        <div style="margin: 20px 0;">
            <h3>⚙️ Paramètres de synchronisation</h3>
            <div class="checkbox-group">
                <div class="checkbox-item">
                    <input type="checkbox" id="auto-sync-enabled" checked>
                    <label for="auto-sync-enabled">Synchronisation automatique (toutes les 30 secondes)</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="sync-on-change-enabled" checked>
                    <label for="sync-on-change-enabled">Synchroniser à chaque modification</label>
                </div>
                <div class="checkbox-item">
                    <input type="checkbox" id="sync-notifications" checked>
                    <label for="sync-notifications">Notifications de synchronisation</label>
                </div>
            </div>
        </div>

        <div style="margin: 20px 0;">
            <h3>📊 Historique de synchronisation</h3>
            <div id="sync-history" style="max-height: 200px; overflow-y: auto;">
                <p style="color: #666; font-style: italic;">Aucune synchronisation effectuée</p>
            </div>
        </div>
    </div>

    <!-- Onglet Stats -->
    <div id="stats" class="tab-content">
        <h2>Statistiques</h2>
        <div style="margin-bottom: 20px;">
            <div class="day-navigation">
                <button onclick="changeStatsDate(-1)">← Jour précédent</button>
                <input type="date" id="stats-date" onchange="updateStats()">
                <button onclick="changeStatsDate(1)">Jour suivant →</button>
                <button onclick="showMultipleDays()">Voir 4 jours</button>
                <button onclick="showBirdStats()">📊 Stats par oiseau</button>
                <button onclick="showWeightGraphs()">📈 Graphiques poids</button>
            </div>
            <div style="margin-top: 10px;">
                <button onclick="exportAllData()">💾 Exporter</button>
                <button onclick="importAllData()" style="margin-left: 10px;">📁 Importer</button>
                <button onclick="clearAllData()" class="btn-danger" style="margin-left: 10px;">🗑️ Vider</button>
            </div>
        </div>
        <div id="stats-content"></div>
    </div>
</div>

<!-- Modal pour affichage photo en grand -->
<div id="photoModal" class="modal">
    <div class="modal-content" style="max-width: 90%; max-height: 90%; padding: 10px; text-align: center;">
        <span class="close" onclick="closePhotoModal()">&times;</span>
        <img id="modal-photo" style="max-width: 100%; max-height: 80vh; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
        <p style="margin-top: 15px; color: #666; font-size: 14px;">📷 Photo</p>
    </div>
</div>

<!-- Modal pour les événements marquants -->
<div id="evenementsModal" class="modal">
    <div class="modal-content" style="max-width: 80%; max-height: 90%;">
        <span class="close" onclick="closeEvenementsModal()">&times;</span>
        <h2 style="color: #1e3c72; margin-bottom: 20px;">🌟 Événements Marquants d'Affaitage</h2>
        <div id="evenements-content" style="max-height: 70vh; overflow-y: auto;">
            <!-- Contenu généré dynamiquement -->
        </div>
    </div>
</div>

<!-- Modal pour édition affaitage -->
<div id="editAffaitageModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeEditAffaitageModal()">&times;</span>
        <h2>Modifier l'Affaitage</h2>
        
        <div id="edit-affaitage-info" style="background: #f0f4f8; padding: 15px; border-radius: 8px; margin-bottom: 20px; color: #666;">
            <!-- Infos sur l'affaitage à modifier -->
        </div>
        
        <div class="form-group">
            <label for="edit-affaitage-notes">Notes :</label>
            <textarea id="edit-affaitage-notes" rows="3" placeholder="Observations sur l'affaitage..."></textarea>
        </div>
        
        <div class="form-group">
            <label for="edit-affaitage-evenement">🌟 Événement marquant (optionnel) :</label>
            <textarea id="edit-affaitage-evenement" rows="2" placeholder="Ex: Premier vol libre réussi, Refus de prendre la nourriture, Agressivité inhabituelle..."></textarea>
            <div style="margin-top: 10px;">
                <button onclick="clearEvenementMarquant()" class="btn-secondary" style="font-size: 12px; padding: 6px 12px;">🗑️ Effacer l'événement marquant</button>
            </div>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button onclick="saveAffaitageEdit()">💾 Sauvegarder</button>
            <button onclick="closeEditAffaitageModal()" class="btn-secondary">❌ Annuler</button>
        </div>
    </div>
</div>

<!-- Modal pour édition rapaces -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeEditModal()">&times;</span>
        <h2>Modifier le Rapace</h2>
        <div class="form-group">
            <label for="edit-name">Nom :</label>
            <input type="text" id="edit-name">
        </div>
        <div class="form-group">
            <label for="edit-species">Espèce :</label>
            <input type="text" id="edit-species">
        </div>
        <div class="form-group">
            <label for="edit-bague">Numéro de bague :</label>
            <input type="text" id="edit-bague">
        </div>
        <div class="form-group">
            <label for="edit-birthdate">Date de naissance :</label>
            <input type="date" id="edit-birthdate">
        </div>
        <div class="form-group">
            <label for="edit-sex">Sexe :</label>
            <select id="edit-sex">
                <option value="forme">Forme</option>
                <option value="tiercelet">Tiercelet</option>
            </select>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="edit-poids-plein">Poids plein (g) :</label>
                <input type="number" id="edit-poids-plein" min="0">
            </div>
            <div class="form-group">
                <label for="edit-poids-vol">Poids vol (g) :</label>
                <input type="number" id="edit-poids-vol" min="0">
            </div>
            <div class="form-group">
                <label for="edit-poids-chasse">Poids chasse (g) :</label>
                <input type="number" id="edit-poids-chasse" min="0">
            </div>
        </div>
        <div class="form-group">
            <label for="edit-photo">Photo du rapace :</label>
            <div class="file-input-wrapper">
                <input type="file" id="edit-photo" accept="image/*" onchange="previewEditPhoto(this)">
                <label for="edit-photo" class="file-input-label">📷 Changer la photo</label>
            </div>
            <div id="edit-photo-preview-container"></div>
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button onclick="saveRapaceEdit()">💾 Sauvegarder</button>
            <button onclick="closeEditModal()" class="btn-secondary">❌ Annuler</button>
        </div>
    </div>
</div>

<script>
// Variables globales
var rapaces = [];
var entries = [];
var chasseEntries = [];
var affaitageEntries = [];
var leurres = [];
var sessionsLeurre = [];
var documents = [];
var currentWeather = null;
var currentLocation = "Orthez (64300)";
var currentStatsDate = new Date();
var editingRapaceId = null;
var editingAffaitageId = null;
var currentDocumentFilter = 'all';

// Variables pour la synchronisation
var syncIntervalId = null;
var lastSyncTime = null;
var syncHistory = [];

// === FIREBASE CONFIGURATION ===
const firebaseConfig = {
  apiKey: "AIzaSyB5nXyJU-FO5YClrS-NZYOJ5hPmW0toEPA",
  authDomain: "rapaces-d00a2.firebaseapp.com",
  projectId: "rapaces-d00a2",
  storageBucket: "rapaces-d00a2.firebasestorage.app",
  messagingSenderId: "404149284295",
  appId: "1:404149284295:web:d71ab1d727c8806b3a7de2",
  measurementId: "G-Y4C19XG2P7"
};

// Variables Firebase
var db = null;
var isFirebaseReady = false;
var firebaseUserId = null;

// === GESTION DES ONGLETS ===
function showTab(tabName) {
    var contents = document.querySelectorAll('.tab-content');
    for (var i = 0; i < contents.length; i++) {
        contents[i].classList.remove('active');
    }
    
    var tabs = document.querySelectorAll('.tab');
    for (var i = 0; i < tabs.length; i++) {
        tabs[i].classList.remove('active');
    }
    
    document.getElementById(tabName).classList.add('active');
    
    var tabButtons = document.querySelectorAll('.tab');
    for (var i = 0; i < tabButtons.length; i++) {
        if (tabButtons[i].onclick && tabButtons[i].onclick.toString().includes(tabName)) {
            tabButtons[i].classList.add('active');
            break;
        }
    }
    
    if (tabName === 'gestion') {
        updateRapaceList();
    } else if (tabName === 'suivi') {
        updateRapaceSelects();
        updateEntryList();
    } else if (tabName === 'chasse') {
        updateRapaceSelects();
        updatechasseList();
    } else if (tabName === 'affaitage') {
        updateRapaceSelects();
        updateAffaitageList();
    } else if (tabName === 'leurre') {
        updateRapaceSelects();
        updateLeurreList();
        updateSessionsLeurreList();
        updateLeurreSelects();
    } else if (tabName === 'documents') {
        updateRapaceSelects();
        updateDocumentsList();
    } else if (tabName === 'stats') {
        document.getElementById('stats-date').value = currentStatsDate.toISOString().split('T')[0];
        updateStats();
    } else if (tabName === 'sync') {
        updateSyncUI();
    }
}

// === GESTION DES RAPACES ===
function addRapace() {
    var name = document.getElementById('rapace-name').value.trim();
    var species = document.getElementById('rapace-species').value.trim();
    var bague = document.getElementById('rapace-bague').value.trim();
    var birthdate = document.getElementById('rapace-birthdate').value;
    var sex = document.getElementById('rapace-sex').value;
    var poidsPlein = document.getElementById('rapace-poids-plein').value;
    var poidsVol = document.getElementById('rapace-poids-vol').value;
    var poidsChasse = document.getElementById('rapace-poids-chasse').value;
    var photoInput = document.getElementById('rapace-photo');
    
    if (!name || !species) {
        alert('Veuillez remplir le nom et l\'espèce du rapace.');
        return;
    }
    
    var rapace = {
        id: Date.now(),
        name: name,
        species: species,
        bague: bague,
        birthdate: birthdate,
        sex: sex,
        poidsPlein: poidsPlein ? parseInt(poidsPlein) : null,
        poidsVol: poidsVol ? parseInt(poidsVol) : null,
        poidsChasse: poidsChasse ? parseInt(poidsChasse) : null,
        dateAdded: new Date().toISOString()
    };
    
    if (photoInput.files && photoInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            rapace.photo = e.target.result;
            finalizeAddRapace(rapace);
        };
        reader.readAsDataURL(photoInput.files[0]);
    } else {
        finalizeAddRapace(rapace);
    }
}

function finalizeAddRapace(rapace) {
    rapaces.push(rapace);
    saveAllData();
    updateRapaceList();
    updateRapaceSelects();
    
    // Nettoyer le formulaire
    document.getElementById('rapace-name').value = '';
    document.getElementById('rapace-species').value = '';
    document.getElementById('rapace-bague').value = '';
    document.getElementById('rapace-birthdate').value = '';
    document.getElementById('rapace-sex').value = 'forme';
    document.getElementById('rapace-poids-plein').value = '';
    document.getElementById('rapace-poids-vol').value = '';
    document.getElementById('rapace-poids-chasse').value = '';
    document.getElementById('rapace-photo').value = '';
    document.getElementById('photo-preview-container').innerHTML = '';
}

function updateRapaceList() {
    var list = document.getElementById('rapace-list');
    if (!list) return;
    
    if (rapaces.length === 0) {
        list.innerHTML = '<p style="color: #666; font-style: italic;">Aucun rapace enregistré.</p>';
        return;
    }
    
    var html = '';
    for (var i = 0; i < rapaces.length; i++) {
        var rapace = rapaces[i];
        var age = rapace.birthdate ? calculateAge(rapace.birthdate) + ' ans' : 'âge inconnu';
        
        html += '<div class="rapace-card">';
        html += '<div class="rapace-actions">';
        html += '<button onclick="editRapace(' + rapace.id + ')" class="btn-warning">✏️</button>';
        html += '<button onclick="deleteRapace(' + rapace.id + ')" class="btn-danger">🗑️</button>';
        html += '</div>';
        
        if (rapace.photo) {
            html += '<img src="' + rapace.photo + '" class="rapace-photo" alt="Photo de ' + rapace.name + '">';
        }
        
        html += '<h3>' + rapace.name + '</h3>';
        html += '<p><strong>Espèce:</strong> ' + rapace.species + '</p>';
        
        if (rapace.bague) {
            html += '<p><strong>Bague:</strong> ' + rapace.bague + '</p>';
        }
        
        html += '<p><strong>Sexe:</strong> ' + (rapace.sex === 'forme' ? 'Forme' : 'Tiercelet') + '</p>';
        html += '<p><strong>Âge:</strong> ' + age + '</p>';
        if (rapace.birthdate) {
            html += '<p><strong>Naissance:</strong> ' + new Date(rapace.birthdate).toLocaleDateString('fr-FR') + '</p>';
        }
        
        if (rapace.poidsPlein || rapace.poidsVol || rapace.poidsChasse) {
            html += '<div style="margin-top: 10px; padding: 10px; background: #e3f2fd; border-radius: 5px;">';
            html += '<strong>Poids de référence:</strong><br>';
            if (rapace.poidsPlein) html += '🍖 Plein: ' + rapace.poidsPlein + 'g ';
            if (rapace.poidsVol) html += '🕊️ Vol: ' + rapace.poidsVol + 'g ';
            if (rapace.poidsChasse) html += '🎯 Chasse: ' + rapace.poidsChasse + 'g';
            html += '</div>';
        }
        html += '</div>';
    }
    
    list.innerHTML = html;
}

function updateRapaceSelects() {
    var selects = ['rapace-select', 'chasse-rapace', 'affaitage-rapace', 'session-rapace', 'doc-rapace'];
    
    for (var s = 0; s < selects.length; s++) {
        var select = document.getElementById(selects[s]);
        if (!select) continue;
        
        var currentValue = select.value;
        
        var html = '<option value="">Choisir un rapace</option>';
        for (var i = 0; i < rapaces.length; i++) {
            var rapace = rapaces[i];
            html += '<option value="' + rapace.id + '">' + rapace.name + ' (' + rapace.species + ')</option>';
        }
        
        select.innerHTML = html;
        select.value = currentValue;
        
        if (select.id === 'chasse-rapace') {
            updatePoidsChaseReference();
        }
    }
}

function calculateAge(birthDate) {
    var today = new Date();
    var birth = new Date(birthDate);
    var age = today.getFullYear() - birth.getFullYear();
    var monthDiff = today.getMonth() - birth.getMonth();
    
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {
        age--;
    }
    
    return age;
}

function editRapace(id) {
    var rapace = rapaces.find(r => r.id === id);
    if (!rapace) return;
    
    editingRapaceId = id;
    
    document.getElementById('edit-name').value = rapace.name;
    document.getElementById('edit-species').value = rapace.species;
    document.getElementById('edit-bague').value = rapace.bague || '';
    document.getElementById('edit-birthdate').value = rapace.birthdate || '';
    document.getElementById('edit-sex').value = rapace.sex;
    document.getElementById('edit-poids-plein').value = rapace.poidsPlein || '';
    document.getElementById('edit-poids-vol').value = rapace.poidsVol || '';
    document.getElementById('edit-poids-chasse').value = rapace.poidsChasse || '';
    
    var photoContainer = document.getElementById('edit-photo-preview-container');
    photoContainer.innerHTML = '';
    if (rapace.photo) {
        var img = document.createElement('img');
        img.src = rapace.photo;
        img.className = 'photo-preview';
        photoContainer.appendChild(img);
    }
    
    document.getElementById('editModal').style.display = 'block';
}

function closeEditModal() {
    document.getElementById('editModal').style.display = 'none';
    editingRapaceId = null;
}

function saveRapaceEdit() {
    if (!editingRapaceId) return;
    
    var rapace = rapaces.find(r => r.id === editingRapaceId);
    if (!rapace) return;
    
    var name = document.getElementById('edit-name').value.trim();
    var species = document.getElementById('edit-species').value.trim();
    
    if (!name || !species) {
        alert('Veuillez remplir le nom et l\'espèce du rapace.');
        return;
    }
    
    rapace.name = name;
    rapace.species = species;
    rapace.bague = document.getElementById('edit-bague').value.trim();
    rapace.birthdate = document.getElementById('edit-birthdate').value;
    rapace.sex = document.getElementById('edit-sex').value;
    
    var poidsPlein = document.getElementById('edit-poids-plein').value;
    var poidsVol = document.getElementById('edit-poids-vol').value;
    var poidsChasse = document.getElementById('edit-poids-chasse').value;
    
    rapace.poidsPlein = poidsPlein ? parseInt(poidsPlein) : null;
    rapace.poidsVol = poidsVol ? parseInt(poidsVol) : null;
    rapace.poidsChasse = poidsChasse ? parseInt(poidsChasse) : null;
    
    var photoInput = document.getElementById('edit-photo');
    if (photoInput.files && photoInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            rapace.photo = e.target.result;
            finalizeSaveRapaceEdit();
        };
        reader.readAsDataURL(photoInput.files[0]);
    } else {
        finalizeSaveRapaceEdit();
    }
}

function finalizeSaveRapaceEdit() {
    saveAllData();
    updateRapaceList();
    updateRapaceSelects();
    closeEditModal();
}

function deleteRapace(id) {
    var rapace = rapaces.find(r => r.id === id);
    if (!rapace) return;
    
    if (confirm('Êtes-vous sûr de vouloir supprimer ' + rapace.name + ' ?')) {
        rapaces = rapaces.filter(r => r.id !== id);
        entries = entries.filter(e => e.rapaceId !== id);
        chasseEntries = chasseEntries.filter(c => c.rapaceId !== id);
        affaitageEntries = affaitageEntries.filter(a => a.rapaceId !== id);
        sessionsLeurre = sessionsLeurre.filter(s => s.rapaceId !== id);
        documents = documents.filter(d => d.rapaceId !== id);
        
        saveAllData();
        updateRapaceList();
        updateRapaceSelects();
        updateEntryList();
        updatechasseList();
        updateAffaitageList();
        updateLeurreList();
        updateSessionsLeurreList();
        updateDocumentsList();
    }
}

// === GESTION DES PHOTOS ===
function previewRapacePhoto(input) {
    var container = document.getElementById('photo-preview-container');
    container.innerHTML = '';
    
    if (input.files && input.files[0]) {
        var file = input.files[0];
        
        if (file.size > 5 * 1024 * 1024) {
            alert('La photo est trop volumineuse. Taille maximale : 5MB');
            input.value = '';
            return;
        }
        
        var reader = new FileReader();
        reader.onload = function(e) {
            var img = document.createElement('img');
            img.src = e.target.result;
            img.className = 'photo-preview';
            container.appendChild(img);
        };
        reader.readAsDataURL(file);
    }
}

function previewEditPhoto(input) {
    var container = document.getElementById('edit-photo-preview-container');
    container.innerHTML = '';
    
    if (input.files && input.files[0]) {
        var file = input.files[0];
        
        if (file.size > 5 * 1024 * 1024) {
            alert('La photo est trop volumineuse. Taille maximale : 5MB');
            input.value = '';
            return;
        }
        
        var reader = new FileReader();
        reader.onload = function(e) {
            var img = document.createElement('img');
            img.src = e.target.result;
            img.className = 'photo-preview';
            container.appendChild(img);
        };
        reader.readAsDataURL(file);
    }
}

function previewAffaitagePhoto(input) {
    var container = document.getElementById('affaitage-photo-preview');
    container.innerHTML = '';
    
    if (input.files && input.files[0]) {
        var file = input.files[0];
        
        if (file.size > 5 * 1024 * 1024) {
            alert('La photo est trop volumineuse. Taille maximale : 5MB');
            input.value = '';
            return;
        }
        
        var reader = new FileReader();
        reader.onload = function(e) {
            var img = document.createElement('img');
            img.src = e.target.result;
            img.className = 'photo-preview';
            container.appendChild(img);
        };
        reader.readAsDataURL(file);
    }
}

function previewChassePhoto(input) {
    var container = document.getElementById('chasse-photo-preview');
    container.innerHTML = '';
    
    if (input.files && input.files[0]) {
        var file = input.files[0];
        
        if (file.size > 5 * 1024 * 1024) {
            alert('La photo est trop volumineuse. Taille maximale : 5MB');
            input.value = '';
            return;
        }
        
        var reader = new FileReader();
        reader.onload = function(e) {
            var img = document.createElement('img');
            img.src = e.target.result;
            img.className = 'photo-preview';
            container.appendChild(img);
        };
        reader.readAsDataURL(file);
    }
}

function previewLeurrePhoto(input) {
    var container = document.getElementById('leurre-photo-preview');
    container.innerHTML = '';
    
    if (input.files && input.files[0]) {
        var file = input.files[0];
        
        if (file.size > 5 * 1024 * 1024) {
            alert('La photo est trop volumineuse. Taille maximale : 5MB');
            input.value = '';
            return;
        }
        
        var reader = new FileReader();
        reader.onload = function(e) {
            var img = document.createElement('img');
            img.src = e.target.result;
            img.className = 'photo-preview';
            container.appendChild(img);
        };
        reader.readAsDataURL(file);
    }
}

function previewDocument(input) {
    var container = document.getElementById('doc-file-preview');
    container.innerHTML = '';
    
    if (input.files && input.files[0]) {
        var file = input.files[0];
        
        if (file.size > 10 * 1024 * 1024) {
            alert('Le fichier est trop volumineux. Taille maximale : 10MB');
            input.value = '';
            return;
        }
        
        var reader = new FileReader();
        reader.onload = function(e) {
            if (file.type.includes('image/')) {
                var img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'photo-preview';
                container.appendChild(img);
            } else {
                var info = document.createElement('div');
                info.style.cssText = 'padding: 10px; background: #f0f4f8; border-radius: 8px; margin-top: 10px;';
                info.innerHTML = '<strong>📁 ' + file.name + '</strong><br><small>Taille: ' + (file.size / 1024).toFixed(1) + ' KB</small>';
                container.appendChild(info);
            }
        };
        
        if (file.type.includes('image/')) {
            reader.readAsDataURL(file);
        } else {
            reader.readAsText(file);
        }
    }
}

// === GESTION DU SUIVI QUOTIDIEN ===
function showEventFields() {
    var eventType = document.getElementById('event-type').value;
    var fields = ['nourriture-fields', 'vol-fields', 'comportement-fields', 'sante-fields', 'entrainement-fields'];
    
    for (var i = 0; i < fields.length; i++) {
        document.getElementById(fields[i]).classList.remove('active');
    }
    
    var targetField = eventType + '-fields';
    var targetElement = document.getElementById(targetField);
    if (targetElement) {
        targetElement.classList.add('active');
    }
}

function calculateWeightDifference() {
    var poidsAvant = parseFloat(document.getElementById('poids-avant').value) || 0;
    var poidsApres = parseFloat(document.getElementById('poids-apres').value) || 0;
    var difference = poidsAvant - poidsApres;
    
    var diffField = document.getElementById('difference-poids');
    if (poidsAvant && poidsApres) {
        if (difference > 0) {
            diffField.value = '-' + difference + 'g (perte)';
            diffField.style.color = '#d73527';
        } else if (difference < 0) {
            diffField.value = '+' + Math.abs(difference) + 'g (gain)';
            diffField.style.color = '#28a745';
        } else {
            diffField.value = '0g (stable)';
            diffField.style.color = '#6c757d';
        }
    } else {
        diffField.value = '';
    }
}

function addEntry() {
    var rapaceId = document.getElementById('rapace-select').value;
    var eventType = document.getElementById('event-type').value;
    var eventDate = document.getElementById('event-date').value;
    var eventTime = document.getElementById('event-time').value;
    var notes = document.getElementById('event-notes').value.trim();
    
    if (!rapaceId) {
        alert('Veuillez sélectionner un rapace.');
        return;
    }
    
    if (!eventDate) {
        eventDate = new Date().toISOString().split('T')[0];
    }
    
    if (!eventTime) {
        eventTime = new Date().toTimeString().split(' ')[0].substring(0, 5);
    }
    
    var entry = {
        id: Date.now(),
        rapaceId: parseInt(rapaceId),
        type: eventType,
        date: eventDate,
        time: eventTime,
        notes: notes,
        weather: currentWeather,
        timestamp: new Date().toISOString()
    };
    
    if (eventType === 'nourriture') {
        entry.poidsAvant = document.getElementById('poids-avant').value;
        entry.poidsApres = document.getElementById('poids-apres').value;
        entry.menu = document.getElementById('detail-nourriture').value;
        entry.quantite = document.getElementById('quantite-nourriture').value;
    } else if (eventType === 'vol') {
        entry.typeVol = document.getElementById('type-vol').value;
    } else if (eventType === 'comportement') {
        var reactivite = document.querySelector('input[name="reactivite"]:checked');
        entry.reactivite = reactivite ? reactivite.value : '';
    } else if (eventType === 'sante') {
        entry.etatSante = document.getElementById('etat-sante').value;
    } else if (eventType === 'entrainement') {
        entry.typeEntrainement = document.getElementById('type-entrainement').value;
    }
    
    entries.push(entry);
    saveAllData();
    updateEntryList();
    
    clearEntryForm();
}

function clearEntryForm() {
    document.getElementById('event-notes').value = '';
    document.getElementById('poids-avant').value = '';
    document.getElementById('poids-apres').value = '';
    document.getElementById('difference-poids').value = '';
    document.getElementById('quantite-nourriture').value = '';
    
    var radios = document.querySelectorAll('input[name="reactivite"]');
    for (var i = 0; i < radios.length; i++) {
        radios[i].checked = false;
    }
}

function updateEntryList() {
    var list = document.getElementById('entry-list');
    if (!list) return;
    
    var selectedRapaceId = document.getElementById('rapace-select').value;
    var filteredEntries;
    
    if (selectedRapaceId) {
        filteredEntries = entries.filter(e => e.rapaceId === parseInt(selectedRapaceId));
    } else {
        filteredEntries = entries;
    }
    
    filteredEntries.sort((a, b) => {
        var dateTimeA = new Date(a.date + 'T' + a.time);
        var dateTimeB = new Date(b.date + 'T' + b.time);
        return dateTimeB - dateTimeA;
    });
    
    if (filteredEntries.length === 0) {
        list.innerHTML = '<p style="color: #666; font-style: italic;">Aucune entrée trouvée.</p>';
        return;
    }
    
    var html = '';
    for (var i = 0; i < Math.min(filteredEntries.length, 10); i++) {
        var entry = filteredEntries[i];
        var rapace = rapaces.find(r => r.id === entry.rapaceId);
        var rapaceName = rapace ? rapace.name : 'Rapace supprimé';
        
        html += '<div class="entry-item">';
        html += '<div class="date">' + new Date(entry.date + 'T' + entry.time).toLocaleDateString('fr-FR') + ' à ' + entry.time;
        html += ' - ' + rapaceName + ' (' + getEventTypeLabel(entry.type) + ')</div>';
        html += '<div class="content">';
        
        if (entry.type === 'nourriture') {
            html += '<strong>Menu:</strong> ' + entry.menu;
            if (entry.quantite) html += ' (' + entry.quantite + ')';
            if (entry.poidsAvant && entry.poidsApres) {
                var difference = parseFloat(entry.poidsAvant) - parseFloat(entry.poidsApres);
                var diffText = '';
                if (difference > 0) {
                    diffText = ' (-' + difference + 'g)';
                } else if (difference < 0) {
                    diffText = ' (+' + Math.abs(difference) + 'g)';
                } else {
                    diffText = ' (0g)';
                }
                html += '<br><strong>Poids:</strong> ' + entry.poidsAvant + 'g → ' + entry.poidsApres + 'g' + diffText;
            }
        } else if (entry.type === 'vol') {
            html += '<strong>Type de vol:</strong> ' + entry.typeVol;
        } else if (entry.type === 'comportement') {
            html += '<strong>Réactivité:</strong> ' + entry.reactivite + '/5';
        } else if (entry.type === 'sante') {
            html += '<strong>État:</strong> ' + entry.etatSante;
        } else if (entry.type === 'entrainement') {
            html += '<strong>Type:</strong> ' + entry.typeEntrainement;
        }
        
        if (entry.notes) {
            html += '<br><strong>Notes:</strong> ' + entry.notes;
        }
        html += '</div></div>';
    }
    
    list.innerHTML = html;
}

function getEventTypeLabel(type) {
    switch (type) {
        case 'nourriture': return 'Nourriture';
        case 'vol': return 'Vol';
        case 'comportement': return 'Comportement';
        case 'sante': return 'Santé';
        case 'entrainement': return 'Entraînement';
        default: return type;
    }
}

// === GESTION DE LA CHASSE ===
function updatePoidsChaseReference() {
    var rapaceId = document.getElementById('chasse-rapace').value;
    var referenceDiv = document.getElementById('poids-chasse-reference');
    
    if (!referenceDiv) return;
    
    if (rapaceId) {
        var rapace = rapaces.find(r => r.id == rapaceId);
        if (rapace && rapace.poidsChasse) {
            referenceDiv.innerHTML = '<strong>🎯 Poids de chasse de ' + rapace.name + ':</strong> ' + rapace.poidsChasse + 'g';
            referenceDiv.style.background = '#e3f2fd';
            referenceDiv.style.color = '#1e3c72';
        } else if (rapace) {
            referenceDiv.innerHTML = '<strong>⚠️ ' + rapace.name + ':</strong> Poids de chasse non défini';
            referenceDiv.style.background = '#fff3cd';
            referenceDiv.style.color = '#856404';
        }
    } else {
        referenceDiv.innerHTML = '<span style="color: #666;">Sélectionnez un rapace pour voir son poids de chasse</span>';
        referenceDiv.style.background = '#f8f9fa';
        referenceDiv.style.color = '#666';
    }
}

function addChasse() {
    var rapaceId = document.getElementById('chasse-rapace').value;
    var date = document.getElementById('chasse-date').value;
    var time = document.getElementById('chasse-time').value;
    var notes = document.getElementById('chasse-notes').value.trim();
    var poidsJour = document.getElementById('chasse-poids-jour').value;
    var photoInput = document.getElementById('chasse-photo');
    
    if (!rapaceId) {
        alert('Veuillez sélectionner un rapace.');
        return;
    }
    
    if (!date) {
        date = new Date().toISOString().split('T')[0];
    }
    
    if (!time) {
        time = new Date().toTimeString().split(' ')[0].substring(0, 5);
    }
    
    var chasse = {
        id: Date.now(),
        rapaceId: parseInt(rapaceId),
        date: date,
        time: time,
        notes: notes,
        weather: currentWeather,
        timestamp: new Date().toISOString(),
        poidsJour: poidsJour ? parseInt(poidsJour) : null,
        faisan: parseInt(document.getElementById('chasse-faisan').value) || 0,
        perdrix: parseInt(document.getElementById('chasse-perdrix').value) || 0,
        lapin: parseInt(document.getElementById('chasse-lapin').value) || 0,
        lievre: parseInt(document.getElementById('chasse-lievre').value) || 0,
        canard: parseInt(document.getElementById('chasse-canard').value) || 0,
        oie: parseInt(document.getElementById('chasse-oie').value) || 0,
        autre: parseInt(document.getElementById('chasse-autre').value) || 0
    };
    
    if (photoInput.files && photoInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            chasse.photo = e.target.result;
            finalizeAddChasse(chasse);
        };
        reader.readAsDataURL(photoInput.files[0]);
    } else {
        finalizeAddChasse(chasse);
    }
}

function finalizeAddChasse(chasse) {
    chasseEntries.push(chasse);
    saveAllData();
    updatechasseList();
    
    // Nettoyer le formulaire
    document.getElementById('chasse-notes').value = '';
    document.getElementById('chasse-poids-jour').value = '';
    document.getElementById('chasse-photo').value = '';
    document.getElementById('chasse-photo-preview').innerHTML = '';
    var huntInputs = document.querySelectorAll('.hunt-item input[type="number"]');
    for (var i = 0; i < huntInputs.length; i++) {
        huntInputs[i].value = '0';
    }
}

function updatechasseList() {
    var list = document.getElementById('chasse-list');
    if (!list) return;
    
    var sortedChasses = [...chasseEntries].sort((a, b) => {
        var dateTimeA = new Date(a.date + 'T' + a.time);
        var dateTimeB = new Date(b.date + 'T' + b.time);
        return dateTimeB - dateTimeA;
    });
    
    if (sortedChasses.length === 0) {
        list.innerHTML = '<p style="color: #666; font-style: italic;">Aucune chasse enregistrée.</p>';
        return;
    }
    
    var html = '';
    for (var i = 0; i < sortedChasses.length; i++) {
        var chasse = sortedChasses[i];
        var rapace = rapaces.find(r => r.id === chasse.rapaceId);
        var rapaceName = rapace ? rapace.name : 'Rapace supprimé';
        
        var total = chasse.faisan + chasse.perdrix + chasse.lapin + chasse.lievre + chasse.canard + chasse.oie + chasse.autre;
        
        html += '<div class="entry-item">';
        html += '<div class="entry-actions">';
        html += '<button onclick="deleteChasseEntry(' + chasse.id + ')" class="btn-danger" title="Supprimer">🗑️</button>';
        html += '</div>';
        
        html += '<div class="chasse-content">';
        
        if (chasse.photo) {
            html += '<div class="photo-container">';
            html += '<img src="' + chasse.photo + '" class="chasse-photo" alt="Photo de la chasse" title="Cliquez pour agrandir" onclick="showPhotoModal(\'' + chasse.photo + '\')">';
            html += '<button class="photo-delete-btn" onclick="deleteChassePhoto(' + chasse.id + ')" title="Supprimer la photo">×</button>';
            html += '</div>';
        }
        
        html += '<div class="date">' + new Date(chasse.date + 'T' + chasse.time).toLocaleDateString('fr-FR') + ' à ' + chasse.time;
        html += ' - ' + rapaceName + ' (Total: ' + total + ' prises)';
        
        if (chasse.photo) {
            html += ' <span style="color: #28a745; font-size: 16px;" title="Photo disponible">📷</span>';
        }
        
        html += '</div>';
        html += '<div class="content">';
        
        if (chasse.poidsJour) {
            html += '<strong>Poids du jour:</strong> ' + chasse.poidsJour + 'g';
            
            if (rapace && rapace.poidsChasse) {
                var diffPoids = chasse.poidsJour - rapace.poidsChasse;
                var diffColor = diffPoids >= 0 ? '#28a745' : '#dc3545';
                var diffSign = diffPoids >= 0 ? '+' : '';
                html += ' <span style="color: ' + diffColor + '; font-weight: bold;">(' + diffSign + diffPoids + 'g vs poids chasse)</span>';
            }
            html += '<br>';
        }
        
        var details = [];
        if (chasse.faisan > 0) details.push(chasse.faisan + ' faisan(s)');
        if (chasse.perdrix > 0) details.push(chasse.perdrix + ' perdrix');
        if (chasse.lapin > 0) details.push(chasse.lapin + ' lapin(s)');
        if (chasse.lievre > 0) details.push(chasse.lievre + ' lièvre(s)');
        if (chasse.canard > 0) details.push(chasse.canard + ' canard(s)');
        if (chasse.oie > 0) details.push(chasse.oie + ' oie(s)');
        if (chasse.autre > 0) details.push(chasse.autre + ' autre(s)');
        
        if (details.length > 0) {
            html += '<strong>Prises:</strong> ' + details.join(', ');
        } else {
            html += '<strong>Prises:</strong> Aucune';
        }
        
        if (chasse.notes) {
            html += '<br><strong>Notes:</strong> ' + chasse.notes;
        }
        html += '</div></div></div>';
    }
    
    list.innerHTML = html;
}

function deleteChassePhoto(id) {
    if (confirm('Êtes-vous sûr de vouloir supprimer cette photo ?')) {
        var entry = chasseEntries.find(e => e.id === id);
        if (entry) {
            delete entry.photo;
            saveAllData();
            updatechasseList();
        }
    }
}

function deleteChasseEntry(id) {
    var entry = chasseEntries.find(e => e.id === id);
    if (!entry) return;
    
    var rapace = rapaces.find(r => r.id === entry.rapaceId);
    var rapaceName = rapace ? rapace.name : 'Rapace supprimé';
    
    if (confirm('Êtes-vous sûr de vouloir supprimer cette chasse de ' + rapaceName + ' du ' + new Date(entry.date).toLocaleDateString('fr-FR') + ' ?')) {
        chasseEntries = chasseEntries.filter(e => e.id !== id);
        saveAllData();
        updatechasseList();
    }
}

// === GESTION DE L'AFFAITAGE ===
function addAffaitage() {
    var rapaceId = document.getElementById('affaitage-rapace').value;
    var date = document.getElementById('affaitage-date').value;
    var time = document.getElementById('affaitage-time').value;
    var notes = document.getElementById('affaitage-notes').value.trim();
    var evenementMarquant = document.getElementById('affaitage-evenement').value.trim();
    var poids = document.getElementById('affaitage-poids').value;
    var photoInput = document.getElementById('affaitage-photo');
    
    if (!rapaceId) {
        alert('Veuillez sélectionner un rapace.');
        return;
    }
    
    if (!date) {
        date = new Date().toISOString().split('T')[0];
    }
    
    if (!time) {
        time = new Date().toTimeString().split(' ')[0].substring(0, 5);
    }
    
    var affaitage = {
        id: Date.now(),
        rapaceId: parseInt(rapaceId),
        date: date,
        time: time,
        notes: notes,
        evenementMarquant: evenementMarquant,
        poids: poids ? parseInt(poids) : null,
        weather: currentWeather,
        timestamp: new Date().toISOString(),
        priseNourriture: document.getElementById('prise-nourriture').checked,
        voliere: document.getElementById('voliere').checked,
        gant: document.getElementById('gant').checked,
        filiere: document.getElementById('filiere').checked,
        bloc: document.getElementById('bloc').checked,
        libre: document.getElementById('libre').checked,
        finAffaitage: document.getElementById('fin-affaitage').checked,
        repriseAffaitage: document.getElementById('reprise-affaitage').checked
    };
    
    if (photoInput.files && photoInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            affaitage.photo = e.target.result;
            finalizeAddAffaitage(affaitage);
        };
        reader.readAsDataURL(photoInput.files[0]);
    } else {
        finalizeAddAffaitage(affaitage);
    }
}

function finalizeAddAffaitage(affaitage) {
    affaitageEntries.push(affaitage);
    saveAllData();
    updateAffaitageList();
    
    // Nettoyer le formulaire
    document.getElementById('affaitage-notes').value = '';
    document.getElementById('affaitage-evenement').value = '';
    document.getElementById('affaitage-poids').value = '';
    document.getElementById('affaitage-photo').value = '';
    document.getElementById('affaitage-photo-preview').innerHTML = '';
    document.getElementById('prise-nourriture').checked = false;
    document.getElementById('voliere').checked = false;
    document.getElementById('gant').checked = false;
    document.getElementById('filiere').checked = false;
    document.getElementById('bloc').checked = false;
    document.getElementById('libre').checked = false;
    document.getElementById('fin-affaitage').checked = false;
    document.getElementById('reprise-affaitage').checked = false;
}

// === NOUVELLES FONCTIONS DE MODIFICATION D'AFFAITAGE ===
function editAffaitageEntry(id) {
    var affaitage = affaitageEntries.find(a => a.id === id);
    if (!affaitage) return;
    
    var rapace = rapaces.find(r => r.id === affaitage.rapaceId);
    var rapaceName = rapace ? rapace.name : 'Rapace supprimé';
    
    editingAffaitageId = id;
    
    // Remplir les informations de l'affaitage
    var infoDiv = document.getElementById('edit-affaitage-info');
    infoDiv.innerHTML = '<strong>📅 ' + new Date(affaitage.date + 'T' + affaitage.time).toLocaleDateString('fr-FR') + ' à ' + affaitage.time + '</strong><br>' +
                        '<strong>🦅 Rapace:</strong> ' + rapaceName + '<br>' +
                        (affaitage.poids ? '<strong>⚖️ Poids:</strong> ' + affaitage.poids + 'g<br>' : '') +
                        '<strong>🎯 Activités:</strong> ' + getActivitiesText(affaitage);
    
    // Remplir les champs modifiables
    document.getElementById('edit-affaitage-notes').value = affaitage.notes || '';
    document.getElementById('edit-affaitage-evenement').value = affaitage.evenementMarquant || '';
    
    document.getElementById('editAffaitageModal').style.display = 'block';
}

function getActivitiesText(affaitage) {
    var activites = [];
    if (affaitage.priseNourriture) activites.push('🍽️ Prise de nourriture');
    if (affaitage.voliere) activites.push('🏠 Volière');
    if (affaitage.gant) activites.push('🧤 Gant');
    if (affaitage.filiere) activites.push('🎯 Filière');
    if (affaitage.bloc) activites.push('🧱 Bloc');
    if (affaitage.libre) activites.push('🕊️ Libre');
    
    return activites.length > 0 ? activites.join(', ') : 'Aucune';
}

function closeEditAffaitageModal() {
    document.getElementById('editAffaitageModal').style.display = 'none';
    editingAffaitageId = null;
}

function clearEvenementMarquant() {
    if (confirm('Êtes-vous sûr de vouloir effacer l\'événement marquant ?')) {
        document.getElementById('edit-affaitage-evenement').value = '';
    }
}

function saveAffaitageEdit() {
    if (!editingAffaitageId) return;
    
    var affaitage = affaitageEntries.find(a => a.id === editingAffaitageId);
    if (!affaitage) return;
    
    // Sauvegarder les modifications
    affaitage.notes = document.getElementById('edit-affaitage-notes').value.trim();
    affaitage.evenementMarquant = document.getElementById('edit-affaitage-evenement').value.trim();
    
    // Ajouter une note de modification
    affaitage.lastModified = new Date().toISOString();
    
    saveAllData();
    updateAffaitageList();
    closeEditAffaitageModal();
    
    // Afficher une confirmation
    showMiniNotification('✅ Affaitage modifié avec succès');
}

function updateAffaitageList() {
    var list = document.getElementById('affaitage-list');
    if (!list) return;
    
    var sortedAffaitages = [...affaitageEntries].sort((a, b) => {
        var dateTimeA = new Date(a.date + 'T' + a.time);
        var dateTimeB = new Date(b.date + 'T' + b.time);
        return dateTimeB - dateTimeA;
    });
    
    if (sortedAffaitages.length === 0) {
        list.innerHTML = '<p style="color: #666; font-style: italic;">Aucun affaitage enregistré.</p>';
        return;
    }
    
    var html = '';
    for (var i = 0; i < sortedAffaitages.length; i++) {
        var affaitage = sortedAffaitages[i];
        var rapace = rapaces.find(r => r.id === affaitage.rapaceId);
        var rapaceName = rapace ? rapace.name : 'Rapace supprimé';
        
        html += '<div class="entry-item">';
        html += '<div class="entry-actions">';
        html += '<button onclick="editAffaitageEntry(' + affaitage.id + ')" class="btn-warning" title="Modifier">✏️</button>';
        html += '<button onclick="deleteAffaitageEntry(' + affaitage.id + ')" class="btn-danger" title="Supprimer">🗑️</button>';
        html += '</div>';
        
        html += '<div class="affaitage-content">';
        
        if (affaitage.photo) {
            html += '<div class="photo-container">';
            html += '<img src="' + affaitage.photo + '" class="affaitage-photo" alt="Photo de la session d\'affaitage" title="Cliquez pour agrandir" onclick="showPhotoModal(\'' + affaitage.photo + '\')">';
            html += '<button class="photo-delete-btn" onclick="deleteAffaitagePhoto(' + affaitage.id + ')" title="Supprimer la photo">×</button>';
            html += '</div>';
        }
        
        html += '<div class="date">' + new Date(affaitage.date + 'T' + affaitage.time).toLocaleDateString('fr-FR') + ' à ' + affaitage.time;
        html += ' - ' + rapaceName;
        
        // Afficher la météo si disponible
        if (affaitage.weather) {
            var weatherInfo = affaitage.weather.split(',')[0]; // Prendre la première partie (description + température)
            html += ' (' + weatherInfo + ')';
        }
        
        if (affaitage.photo) {
            html += ' <span style="color: #28a745; font-size: 16px;" title="Photo disponible">📷</span>';
        }
        
        // Marquer les événements marquants
        if (affaitage.evenementMarquant && affaitage.evenementMarquant.trim()) {
            html += ' <span style="color: #ffc107; font-size: 16px;" title="Événement marquant">🌟</span>';
        }
        
        // Indicateur de modification
        if (affaitage.lastModified) {
            html += ' <span style="color: #17a2b8; font-size: 12px;" title="Modifié le ' + new Date(affaitage.lastModified).toLocaleDateString('fr-FR') + '">✏️</span>';
        }
        
        if (affaitage.finAffaitage) {
            html += '<span class="session-status session-fin">🔚 FIN</span>';
        }
        if (affaitage.repriseAffaitage) {
            html += '<span class="session-status session-reprise">🔄 REPRISE</span>';
        }
        
        html += '</div>';
        html += '<div class="content">';
        
        if (affaitage.poids) {
            html += '<strong>Poids:</strong> ' + affaitage.poids + 'g';
            
            if (rapace && (rapace.poidsChasse || rapace.poidsVol || rapace.poidsPlein)) {
                var comparisons = [];
                if (rapace.poidsChasse) {
                    var diffChasse = affaitage.poids - rapace.poidsChasse;
                    var colorChasse = diffChasse >= 0 ? '#28a745' : '#dc3545';
                    var signChasse = diffChasse >= 0 ? '+' : '';
                    comparisons.push('<span style="color: ' + colorChasse + ';">🎯(' + signChasse + diffChasse + 'g)</span>');
                }
                if (rapace.poidsVol) {
                    var diffVol = affaitage.poids - rapace.poidsVol;
                    var colorVol = diffVol >= 0 ? '#28a745' : '#dc3545';
                    var signVol = diffVol >= 0 ? '+' : '';
                    comparisons.push('<span style="color: ' + colorVol + ';">🕊️(' + signVol + diffVol + 'g)</span>');
                }
                if (comparisons.length > 0) {
                    html += ' ' + comparisons.join(' ');
                }
            }
            html += '<br>';
        }
        
        var activites = [];
        if (affaitage.priseNourriture) activites.push('🍽️ Prise de nourriture');
        if (affaitage.voliere) activites.push('🏠 Volière');
        if (affaitage.gant) activites.push('🧤 Gant');
        if (affaitage.filiere) activites.push('🎯 Filière');
        if (affaitage.bloc) activites.push('🧱 Bloc');
        if (affaitage.libre) activites.push('🕊️ Libre');
        
        if (activites.length > 0) {
            html += '<strong>Activités:</strong> ' + activites.join(', ');
        } else {
            html += '<strong>Activités:</strong> Aucune';
        }
        
        // Afficher l'événement marquant s'il existe
        if (affaitage.evenementMarquant && affaitage.evenementMarquant.trim()) {
            html += '<br><div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 8px; margin: 8px 0; border-radius: 4px;">';
            html += '<strong>🌟 ÉVÉNEMENT MARQUANT:</strong> ' + affaitage.evenementMarquant;
            html += '</div>';
        }
        
        if (affaitage.notes) {
            html += '<br><strong>Notes:</strong> ' + affaitage.notes;
        }
        html += '</div></div></div>';
    }
    
    list.innerHTML = html;
}

function deleteAffaitagePhoto(id) {
    if (confirm('Êtes-vous sûr de vouloir supprimer cette photo ?')) {
        var entry = affaitageEntries.find(e => e.id === id);
        if (entry) {
            delete entry.photo;
            saveAllData();
            updateAffaitageList();
        }
    }
}

function deleteAffaitageEntry(id) {
    var entry = affaitageEntries.find(e => e.id === id);
    if (!entry) return;
    
    var rapace = rapaces.find(r => r.id === entry.rapaceId);
    var rapaceName = rapace ? rapace.name : 'Rapace supprimé';
    
    if (confirm('Êtes-vous sûr de vouloir supprimer cette entrée d\'affaitage pour ' + rapaceName + ' du ' + new Date(entry.date).toLocaleDateString('fr-FR') + ' ?')) {
        affaitageEntries = affaitageEntries.filter(e => e.id !== id);
        saveAllData();
        updateAffaitageList();
    }
}

// === GESTION DES ÉVÉNEMENTS MARQUANTS ===
function showEvenementsMarquants() {
    var modal = document.getElementById('evenementsModal');
    var content = document.getElementById('evenements-content');
    
    // Filtrer les affaitages avec événements marquants
    var evenements = affaitageEntries.filter(a => a.evenementMarquant && a.evenementMarquant.trim());
    
    if (evenements.length === 0) {
        content.innerHTML = '<p style="color: #666; font-style: italic; text-align: center; padding: 40px;">Aucun événement marquant enregistré pour le moment.</p>';
    } else {
        // Grouper par rapace
        var evenementsParRapace = {};
        for (var i = 0; i < evenements.length; i++) {
            var evt = evenements[i];
            var rapace = rapaces.find(r => r.id === evt.rapaceId);
            var rapaceName = rapace ? rapace.name : 'Rapace supprimé';
            
            if (!evenementsParRapace[rapaceName]) {
                evenementsParRapace[rapaceName] = [];
            }
            evenementsParRapace[rapaceName].push(evt);
        }
        
        var html = '';
        
        // Afficher par rapace
        for (var rapaceName in evenementsParRapace) {
            var rapaceEvenements = evenementsParRapace[rapaceName];
            
            // Trier par date (plus récent d'abord)
            rapaceEvenements.sort((a, b) => {
                var dateTimeA = new Date(a.date + 'T' + a.time);
                var dateTimeB = new Date(b.date + 'T' + b.time);
                return dateTimeB - dateTimeA;
            });
            
            html += '<div style="margin-bottom: 30px; padding: 20px; background: #f8f9fa; border-radius: 10px; border: 2px solid #e3f2fd;">';
            html += '<h3 style="color: #1e3c72; margin-bottom: 15px; font-size: 1.4em;">🦅 ' + rapaceName + '</h3>';
            
            for (var j = 0; j < rapaceEvenements.length; j++) {
                var evt = rapaceEvenements[j];
                
                html += '<div style="margin: 15px 0; padding: 15px; background: white; border-radius: 8px; border-left: 4px solid #ffc107;">';
                html += '<div style="display: flex; align-items: center; margin-bottom: 8px;">';
                html += '<span style="color: #ffc107; font-size: 18px; margin-right: 8px;">🌟</span>';
                html += '<strong style="color: #1e3c72;">' + new Date(evt.date + 'T' + evt.time).toLocaleDateString('fr-FR') + ' à ' + evt.time + '</strong>';
                
                // Indicateur de modification
                if (evt.lastModified) {
                    html += '<span style="margin-left: 10px; color: #17a2b8; font-size: 11px;" title="Modifié le ' + new Date(evt.lastModified).toLocaleDateString('fr-FR') + ' à ' + new Date(evt.lastModified).toLocaleTimeString('fr-FR') + '">✏️ modifié</span>';
                }
                
                // Afficher la météo si disponible
                if (evt.weather) {
                    var weatherInfo = evt.weather.split(',')[0]; // Prendre la première partie
                    html += '<span style="margin-left: 15px; color: #666; font-size: 0.9em;">(' + weatherInfo + ')</span>';
                }
                
                html += '</div>';
                html += '<div style="color: #333; line-height: 1.4;">' + evt.evenementMarquant + '</div>';
                html += '</div>';
            }
            
            html += '</div>';
        }
        
        content.innerHTML = html;
    }
    
    modal.style.display = 'block';
}

function closeEvenementsModal() {
    document.getElementById('evenementsModal').style.display = 'none';
}

// === GESTION DES LEURRES ===
function addLeurre() {
    var nom = document.getElementById('leurre-nom').value.trim();
    var type = document.getElementById('leurre-type').value;
    var couleur = document.getElementById('leurre-couleur').value.trim();
    var taille = document.getElementById('leurre-taille').value;
    var poids = document.getElementById('leurre-poids-g').value;
    var description = document.getElementById('leurre-description').value.trim();
    var photoInput = document.getElementById('leurre-photo');
    
    if (!nom || !type) {
        alert('Veuillez remplir le nom et le type du leurre.');
        return;
    }
    
    var leurre = {
        id: Date.now(),
        nom: nom,
        type: type,
        couleur: couleur,
        taille: taille ? parseInt(taille) : null,
        poids: poids ? parseInt(poids) : null,
        description: description,
        dateAdded: new Date().toISOString(),
        utilisations: 0,
        efficacite: 0
    };
    
    if (photoInput.files && photoInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            leurre.photo = e.target.result;
            finalizeAddLeurre(leurre);
        };
        reader.readAsDataURL(photoInput.files[0]);
    } else {
        finalizeAddLeurre(leurre);
    }
}

function finalizeAddLeurre(leurre) {
    leurres.push(leurre);
    saveAllData();
    updateLeurreList();
    updateLeurreSelects();
    
    // Nettoyer le formulaire
    document.getElementById('leurre-nom').value = '';
    document.getElementById('leurre-type').value = 'plume';
    document.getElementById('leurre-couleur').value = '';
    document.getElementById('leurre-taille').value = '';
    document.getElementById('leurre-poids-g').value = '';
    document.getElementById('leurre-description').value = '';
    document.getElementById('leurre-photo').value = '';
    document.getElementById('leurre-photo-preview').innerHTML = '';
}

function updateLeurreSelects() {
    var select = document.getElementById('session-leurre');
    if (!select) return;
    
    var currentValue = select.value;
    
    var html = '<option value="">Choisir un leurre</option>';
    for (var i = 0; i < leurres.length; i++) {
        var leurre = leurres[i];
        html += '<option value="' + leurre.id + '">' + leurre.nom + ' (' + leurre.type + ')</option>';
    }
    
    select.innerHTML = html;
    select.value = currentValue;
}

function updateLeurreList() {
    var list = document.getElementById('leurre-list');
    if (!list) return;
    
    if (leurres.length === 0) {
        list.innerHTML = '<p style="color: #666; font-style: italic;">Aucun leurre enregistré.</p>';
        return;
    }
    
    var html = '';
    for (var i = 0; i < leurres.length; i++) {
        var leurre = leurres[i];
        
        html += '<div class="leurre-card">';
        html += '<div class="leurre-actions">';
        html += '<button onclick="deleteLeurre(' + leurre.id + ')" class="btn-danger">🗑️</button>';
        html += '</div>';
        
        if (leurre.photo) {
            html += '<img src="' + leurre.photo + '" class="leurre-photo" alt="Photo de ' + leurre.nom + '">';
        }
        
        html += '<h3>🎯 ' + leurre.nom + '</h3>';
        html += '<p><strong>Type:</strong> ' + leurre.type.charAt(0).toUpperCase() + leurre.type.slice(1) + '</p>';
        
        if (leurre.couleur) {
            html += '<p><strong>Couleur:</strong> ' + leurre.couleur + '</p>';
        }
        
        if (leurre.taille || leurre.poids) {
            html += '<p><strong>Dimensions:</strong> ';
            if (leurre.taille) html += leurre.taille + 'cm ';
            if (leurre.poids) html += '• ' + leurre.poids + 'g';
            html += '</p>';
        }
        
        if (leurre.description) {
            html += '<p><strong>Description:</strong> ' + leurre.description + '</p>';
        }
        
        // Statistiques d'utilisation
        html += '<div style="margin-top: 15px; padding: 10px; background: #e3f2fd; border-radius: 8px;">';
        html += '<strong>📊 Statistiques:</strong><br>';
        html += '• Utilisations: ' + leurre.utilisations + '<br>';
        html += '• Efficacité moyenne: ' + leurre.efficacite.toFixed(1) + '%';
        
        if (leurre.efficacite > 0) {
            html += '<div class="efficacite-bar">';
            html += '<div class="efficacite-fill" style="width: ' + leurre.efficacite + '%"></div>';
            html += '</div>';
        }
        html += '</div>';
        
        html += '</div>';
    }
    
    list.innerHTML = html;
}

function deleteLeurre(id) {
    var leurre = leurres.find(l => l.id === id);
    if (!leurre) return;
    
    if (confirm('Êtes-vous sûr de vouloir supprimer le leurre "' + leurre.nom + '" ?')) {
        leurres = leurres.filter(l => l.id !== id);
        sessionsLeurre = sessionsLeurre.filter(s => s.leurreId !== id);
        
        saveAllData();
        updateLeurreList();
        updateLeurreSelects();
        updateSessionsLeurreList();
    }
}

function addSessionLeurre() {
    var leurreId = document.getElementById('session-leurre').value;
    var rapaceId = document.getElementById('session-rapace').value;
    var date = document.getElementById('session-date').value;
    var time = document.getElementById('session-time').value;
    var duree = document.getElementById('session-duree').value;
    var reussite = document.getElementById('session-reussite').value;
    var nbPasses = document.getElementById('session-nb-passes').value;
    var notes = document.getElementById('session-notes').value.trim();
    
    if (!leurreId || !rapaceId) {
        alert('Veuillez sélectionner un leurre et un rapace.');
        return;
    }
    
    if (!date) {
        date = new Date().toISOString().split('T')[0];
    }
    
    if (!time) {
        time = new Date().toTimeString().split(' ')[0].substring(0, 5);
    }
    
    var session = {
        id: Date.now(),
        leurreId: parseInt(leurreId),
        rapaceId: parseInt(rapaceId),
        date: date,
        time: time,
        duree: duree ? parseInt(duree) : null,
        reussite: reussite,
        nbPasses: nbPasses ? parseInt(nbPasses) : null,
        notes: notes,
        weather: currentWeather,
        timestamp: new Date().toISOString(),
        ventFort: document.getElementById('session-vent-fort').checked,
        pluie: document.getElementById('session-pluie').checked,
        premiereFois: document.getElementById('session-premiere-fois').checked,
        rapaceAffame: document.getElementById('session-rapace-affame').checked
    };
    
    sessionsLeurre.push(session);
    
    // Mettre à jour les statistiques du leurre
    updateLeurreStats(parseInt(leurreId));
    
    saveAllData();
    updateSessionsLeurreList();
    updateLeurreList();
    
    // Nettoyer le formulaire
    document.getElementById('session-duree').value = '';
    document.getElementById('session-reussite').value = 'excellente';
    document.getElementById('session-nb-passes').value = '';
    document.getElementById('session-notes').value = '';
    document.getElementById('session-vent-fort').checked = false;
    document.getElementById('session-pluie').checked = false;
    document.getElementById('session-premiere-fois').checked = false;
    document.getElementById('session-rapace-affame').checked = false;
}

function updateLeurreStats(leurreId) {
    var leurre = leurres.find(l => l.id === leurreId);
    if (!leurre) return;
    
    var sessions = sessionsLeurre.filter(s => s.leurreId === leurreId);
    leurre.utilisations = sessions.length;
    
    if (sessions.length > 0) {
        var totalEfficacite = 0;
        for (var i = 0; i < sessions.length; i++) {
            var session = sessions[i];
            switch (session.reussite) {
                case 'excellente': totalEfficacite += 100; break;
                case 'bonne': totalEfficacite += 80; break;
                case 'moyenne': totalEfficacite += 60; break;
                case 'difficile': totalEfficacite += 30; break;
                case 'echec': totalEfficacite += 0; break;
            }
        }
        leurre.efficacite = totalEfficacite / sessions.length;
    } else {
        leurre.efficacite = 0;
    }
}

function updateSessionsLeurreList() {
    var list = document.getElementById('sessions-leurre-list');
    if (!list) return;
    
    var sortedSessions = [...sessionsLeurre].sort((a, b) => {
        var dateTimeA = new Date(a.date + 'T' + a.time);
        var dateTimeB = new Date(b.date + 'T' + b.time);
        return dateTimeB - dateTimeA;
    });
    
    if (sortedSessions.length === 0) {
        list.innerHTML = '<p style="color: #666; font-style: italic;">Aucune session enregistrée.</p>';
        return;
    }
    
    var html = '';
    for (var i = 0; i < sortedSessions.length; i++) {
        var session = sortedSessions[i];
        var leurre = leurres.find(l => l.id === session.leurreId);
        var rapace = rapaces.find(r => r.id === session.rapaceId);
        
        var leurreNom = leurre ? leurre.nom : 'Leurre supprimé';
        var rapaceNom = rapace ? rapace.name : 'Rapace supprimé';
        
        html += '<div class="session-leurre">';
        html += '<div class="entry-actions">';
        html += '<button onclick="deleteSessionLeurre(' + session.id + ')" class="btn-danger" title="Supprimer">🗑️</button>';
        html += '</div>';
        
        html += '<div class="date">' + new Date(session.date + 'T' + session.time).toLocaleDateString('fr-FR') + ' à ' + session.time;
        html += ' - ' + rapaceNom + ' avec ' + leurreNom + '</div>';
        html += '<div class="content">';
        
        if (session.duree) {
            html += '<strong>Durée:</strong> ' + session.duree + ' minutes<br>';
        }
        
        var reussiteLabel = '';
        var reussiteColor = '';
        switch (session.reussite) {
            case 'excellente': reussiteLabel = 'Excellente'; reussiteColor = '#28a745'; break;
            case 'bonne': reussiteLabel = 'Bonne'; reussiteColor = '#20c997'; break;
            case 'moyenne': reussiteLabel = 'Moyenne'; reussiteColor = '#ffc107'; break;
            case 'difficile': reussiteLabel = 'Difficile'; reussiteColor = '#fd7e14'; break;
            case 'echec': reussiteLabel = 'Échec'; reussiteColor = '#dc3545'; break;
        }
        
        html += '<strong>Réussite:</strong> <span style="color: ' + reussiteColor + '; font-weight: bold;">' + reussiteLabel + '</span>';
        
        if (session.nbPasses) {
            html += ' (' + session.nbPasses + ' passes)';
        }
        html += '<br>';
        
        var conditions = [];
        if (session.ventFort) conditions.push('💨 Vent fort');
        if (session.pluie) conditions.push('🌧️ Pluie');
        if (session.premiereFois) conditions.push('🆕 Première fois');
        if (session.rapaceAffame) conditions.push('🍖 Rapace affamé');
        
        if (conditions.length > 0) {
            html += '<strong>Conditions:</strong> ' + conditions.join(', ') + '<br>';
        }
        
        if (session.notes) {
            html += '<strong>Notes:</strong> ' + session.notes;
        }
        html += '</div></div>';
    }
    
    list.innerHTML = html;
}

function deleteSessionLeurre(id) {
    var session = sessionsLeurre.find(s => s.id === id);
    if (!session) return;
    
    if (confirm('Êtes-vous sûr de vouloir supprimer cette session ?')) {
        sessionsLeurre = sessionsLeurre.filter(s => s.id !== id);
        
        // Mettre à jour les stats du leurre
        updateLeurreStats(session.leurreId);
        
        saveAllData();
        updateSessionsLeurreList();
        updateLeurreList();
    }
}

// === GESTION DES DOCUMENTS ===
function addDocument() {
    var nom = document.getElementById('doc-nom').value.trim();
    var categorie = document.getElementById('doc-categorie').value;
    var rapaceId = document.getElementById('doc-rapace').value;
    var date = document.getElementById('doc-date').value;
    var description = document.getElementById('doc-description').value.trim();
    var fileInput = document.getElementById('doc-file');
    
    if (!nom || !categorie) {
        alert('Veuillez remplir le nom et la catégorie du document.');
        return;
    }
    
    var document_obj = {
        id: Date.now(),
        nom: nom,
        categorie: categorie,
        rapaceId: rapaceId ? parseInt(rapaceId) : null,
        date: date,
        description: description,
        dateAdded: new Date().toISOString()
    };
    
    if (fileInput.files && fileInput.files[0]) {
        const reader = new FileReader();
        reader.onload = function(e) {
            document_obj.file = e.target.result;
            document_obj.fileName = fileInput.files[0].name;
            document_obj.fileType = fileInput.files[0].type;
            document_obj.fileSize = fileInput.files[0].size;
            finalizeAddDocument(document_obj);
        };
        reader.readAsDataURL(fileInput.files[0]);
    } else {
        finalizeAddDocument(document_obj);
    }
}

function finalizeAddDocument(document_obj) {
    documents.push(document_obj);
    saveAllData();
    updateDocumentsList();
    
    // Nettoyer le formulaire
    document.getElementById('doc-nom').value = '';
    document.getElementById('doc-categorie').value = 'sante';
    document.getElementById('doc-rapace').value = '';
    document.getElementById('doc-date').value = '';
    document.getElementById('doc-description').value = '';
    document.getElementById('doc-file').value = '';
    document.getElementById('doc-file-preview').innerHTML = '';
}

function filterDocuments(category) {
    currentDocumentFilter = category;
    
    // Mettre à jour l'apparence des boutons
    var buttons = document.querySelectorAll('.category-btn');
    for (var i = 0; i < buttons.length; i++) {
        buttons[i].classList.remove('active');
    }
    event.target.classList.add('active');
    
    updateDocumentsList();
}

function updateDocumentsList() {
    var list = document.getElementById('documents-list');
    if (!list) return;
    
    var filteredDocuments = documents;
    if (currentDocumentFilter !== 'all') {
        filteredDocuments = documents.filter(d => d.categorie === currentDocumentFilter);
    }
    
    var sortedDocuments = [...filteredDocuments].sort((a, b) => {
        return new Date(b.dateAdded) - new Date(a.dateAdded);
    });
    
    if (sortedDocuments.length === 0) {
        list.innerHTML = '<p style="color: #666; font-style: italic;">Aucun document trouvé.</p>';
        return;
    }
    
    var html = '';
    for (var i = 0; i < sortedDocuments.length; i++) {
        var doc = sortedDocuments[i];
        var rapace = doc.rapaceId ? rapaces.find(r => r.id === doc.rapaceId) : null;
        var rapaceNom = rapace ? rapace.name : null;
        
        html += '<div class="document-card">';
        html += '<div class="document-actions">';
        if (doc.file) {
            html += '<button onclick="downloadDocument(' + doc.id + ')" class="btn-success" title="Télécharger">📥</button>';
        }
        html += '<button onclick="deleteDocument(' + doc.id + ')" class="btn-danger" title="Supprimer">🗑️</button>';
        html += '</div>';
        
        // Icône ou aperçu
        if (doc.file && doc.fileType && doc.fileType.includes('image/')) {
            html += '<img src="' + doc.file + '" class="document-preview" alt="Aperçu">';
        } else {
            var icon = getDocumentIcon(doc.categorie, doc.fileType);
            html += '<div class="document-icon">' + icon + '</div>';
        }
        
        html += '<h3>📄 ' + doc.nom + '</h3>';
        html += '<p><strong>Catégorie:</strong> ' + getCategorieLabel(doc.categorie) + '</p>';
        
        if (rapaceNom) {
            html += '<p><strong>Rapace:</strong> ' + rapaceNom + '</p>';
        }
        
        if (doc.date) {
            html += '<p><strong>Date:</strong> ' + new Date(doc.date).toLocaleDateString('fr-FR') + '</p>';
        }
        
        if (doc.description) {
            html += '<p><strong>Description:</strong> ' + doc.description + '</p>';
        }
        
        if (doc.fileName) {
            html += '<div style="margin-top: 10px; padding: 8px; background: #e3f2fd; border-radius: 5px; font-size: 14px;">';
            html += '<strong>Fichier:</strong> ' + doc.fileName;
            if (doc.fileSize) {
                html += ' (' + (doc.fileSize / 1024).toFixed(1) + ' KB)';
            }
            html += '</div>';
        }
        
        html += '<p style="color: #666; font-size: 12px; margin-top: 10px;">Ajouté le ' + new Date(doc.dateAdded).toLocaleDateString('fr-FR') + '</p>';
        html += '</div>';
    }
    
    list.innerHTML = html;
}

function getCategorieLabel(categorie) {
    switch (categorie) {
        case 'sante': return '🏥 Santé';
        case 'legal': return '⚖️ Légal/Administratif';
        case 'formation': return '🎓 Formation';
        case 'equipement': return '🔧 Équipement';
        case 'chasse': return '🏹 Chasse';
        case 'elevage': return '🥚 Élevage';
        case 'autre': return '📋 Autre';
        default: return categorie;
    }
}

function getDocumentIcon(categorie, fileType) {
    if (fileType) {
        if (fileType.includes('pdf')) return '📄';
        if (fileType.includes('word')) return '📝';
        if (fileType.includes('image/')) return '🖼️';
        if (fileType.includes('text')) return '📃';
    }
    
    switch (categorie) {
        case 'sante': return '🏥';
        case 'legal': return '⚖️';
        case 'formation': return '🎓';
        case 'equipement': return '🔧';
        case 'chasse': return '🏹';
        case 'elevage': return '🥚';
        default: return '📋';
    }
}

function downloadDocument(id) {
    var doc = documents.find(d => d.id === id);
    if (!doc || !doc.file) return;
    
    var link = document.createElement('a');
    link.href = doc.file;
    link.download = doc.fileName || 'document';
    link.click();
}

function deleteDocument(id) {
    var doc = documents.find(d => d.id === id);
    if (!doc) return;
    
    if (confirm('Êtes-vous sûr de vouloir supprimer le document "' + doc.nom + '" ?')) {
        documents = documents.filter(d => d.id !== id);
        saveAllData();
        updateDocumentsList();
    }
}

// === GESTION DE LA MÉTÉO ===
function loadWeather() {
    var weatherElement = document.getElementById('weather-info');
    if (weatherElement) {
        weatherElement.innerHTML = '🌦️ <small>Chargement météo...</small>';
    }
    
    if ("geolocation" in navigator) {
        navigator.geolocation.getCurrentPosition(
            function(position) {
                loadWeatherByCoords(position.coords.latitude, position.coords.longitude);
            },
            function(error) {
                console.log("Géolocalisation échouée:", error.message);
                loadWeatherByCity(currentLocation);
            },
            { timeout: 10000, maximumAge: 300000 }
        );
    } else {
        loadWeatherByCity(currentLocation);
    }
}

function loadWeatherByCoords(lat, lon) {
    var apiKey = "b4d68d2dedd2d6d43f81f804010b0673";
    var url = "https://api.openweathermap.org/data/2.5/weather?lat=" + lat + "&lon=" + lon + "&appid=" + apiKey + "&units=metric&lang=fr";
    
    fetch(url)
        .then(response => {
            if (!response.ok) throw new Error('API Error: ' + response.status);
            return response.json();
        })
        .then(data => {
            processWeatherData(data);
            currentLocation = data.name + " (" + data.sys.country + ")";
            saveAllData();
        })
        .catch(error => {
            console.log("Erreur API coords:", error);
            loadWeatherByCity(currentLocation);
        });
}

function loadWeatherByCity(cityName) {
    var city = cityName.split("(")[0].trim();
    var apiKey = "b4d68d2dedd2d6d43f81f804010b0673";
    var url = "https://api.openweathermap.org/data/2.5/weather?q=" + encodeURIComponent(city) + ",FR&appid=" + apiKey + "&units=metric&lang=fr";
    
    fetch(url)
        .then(response => {
            if (!response.ok) throw new Error('API Error: ' + response.status);
            return response.json();
        })
        .then(data => {
            processWeatherData(data);
        })
        .catch(error => {
            console.log("Erreur API ville:", error);
            loadWeatherFallback();
        });
}

function processWeatherData(data) {
    var temp = Math.round(data.main.temp);
    var description = data.weather[0].description;
    var humidity = data.main.humidity;
    var windSpeed = Math.round(data.wind.speed * 3.6);
    var precipitation = 0;
    
    if (data.rain && data.rain["1h"]) {
        precipitation = Math.round((data.rain["1h"] / 1) * 100);
    } else if (data.snow && data.snow["1h"]) {
        precipitation = Math.round((data.snow["1h"] / 1) * 100);
    } else if (data.clouds && data.clouds.all > 80) {
        precipitation = Math.floor(data.clouds.all / 4);
    }
    
    precipitation = Math.min(precipitation, 100);
    var icon = getWeatherIcon(data.weather[0].main, data.weather[0].id);
    
    var detailedWeather = temp + "°C\n" +
                         "Précipitations : " + precipitation + "%\n" +
                         "Humidité : " + humidity + "%\n" +
                         "Vent : " + windSpeed + " km/h";
    
    currentWeather = description + ", " + detailedWeather + " à " + currentLocation;
    
    var weatherElement = document.getElementById('weather-info');
    if (weatherElement) {
        weatherElement.innerHTML = icon + " <strong>" + description.charAt(0).toUpperCase() + description.slice(1) + "</strong><br>" +
                                  "<span style='font-size: 12px; line-height: 1.4;'>" +
                                  temp + "°C<br>" +
                                  "Précipitations : " + precipitation + "%<br>" +
                                  "Humidité : " + humidity + "%<br>" +
                                  "Vent : " + windSpeed + " km/h<br>" +
                                  "<em>" + currentLocation + "</em>" +
                                  "</span>";
    }
}

function getWeatherIcon(main, id) {
    switch (main) {
        case "Clear":
            return "☀️";
        case "Clouds":
            return id < 803 ? "⛅" : "☁️";
        case "Rain":
            return "🌧️";
        case "Drizzle":
            return "🌦️";
        case "Thunderstorm":
            return "⛈️";
        case "Snow":
            return "❄️";
        case "Mist":
        case "Fog":
            return "🌫️";
        case "Haze":
            return "🌤️";
        default:
            return "🌤️";
    }
}

function loadWeatherFallback() {
    var weatherElement = document.getElementById('weather-info');
    if (weatherElement) {
        weatherElement.innerHTML = '🌤️ <strong>Mode hors ligne</strong><br>' +
                                  '<span style="font-size: 12px; line-height: 1.4;">' +
                                  '15°C<br>' +
                                  'Précipitations : 20%<br>' +
                                  'Humidité : 60%<br>' +
                                  'Vent : 10 km/h<br>' +
                                  '<em style="color: #ffeb3b;">' + currentLocation + ' (Mode hors ligne)</em>' +
                                  '</span>';
    }
    currentWeather = "Mode hors ligne, 15°C, 20% précipitations, 60% humidité, vent 10 km/h à " + currentLocation;
}

function refreshWeather() {
    console.log("🔄 Tentative de rechargement de la météo...");
    loadWeather();
    
    setTimeout(function() {
        var weatherElement = document.getElementById('weather-info');
        if (weatherElement && weatherElement.innerHTML.includes('Chargement')) {
            console.log("⚠️ Timeout météo, passage en mode hors ligne");
            loadWeatherFallback();
        }
    }, 10000);
}

function changeLocation() {
    var newLocation = prompt("Entrez votre localisation (ex: Paris, Toulouse, Lyon...) :", currentLocation);
    if (newLocation && newLocation.trim()) {
        currentLocation = newLocation.trim();
        saveAllData();
        console.log("📍 Nouvelle localisation:", currentLocation);
        
        var weatherElement = document.getElementById('weather-info');
        if (weatherElement) {
            weatherElement.innerHTML = '🌦️ <small>Chargement météo pour ' + currentLocation + '...</small>';
        }
        
        loadWeatherByCity(currentLocation);
    }
}

// === GESTION DES STATISTIQUES ===
function updateStats() {
    var selectedDate = new Date(document.getElementById('stats-date').value);
    currentStatsDate = selectedDate;
    generateStatsForDate(selectedDate);
}

function changeStatsDate(days) {
    currentStatsDate.setDate(currentStatsDate.getDate() + days);
    document.getElementById('stats-date').value = currentStatsDate.toISOString().split('T')[0];
    updateStats();
}

function showMultipleDays() {
    var html = '';
    for (var i = 0; i < 4; i++) {
        var date = new Date(currentStatsDate);
        date.setDate(date.getDate() - i);
        html += generateStatsForDateHTML(date);
    }
    document.getElementById('stats-content').innerHTML = html;
}

function generateStatsForDate(date) {
    var html = generateStatsForDateHTML(date);
    document.getElementById('stats-content').innerHTML = html;
}

function generateStatsForDateHTML(date) {
    var dateStr = date.toISOString().split('T')[0];
    var dayEntries = entries.filter(e => e.date === dateStr);
    var dayChasses = chasseEntries.filter(c => c.date === dateStr);
    var dayAffaitages = affaitageEntries.filter(a => a.date === dateStr);
    var daySessions = sessionsLeurre.filter(s => s.date === dateStr);
    
    var html = '<div class="day-card">';
    html += '<h4>' + date.toLocaleDateString('fr-FR', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) + '</h4>';
    
    if (dayEntries.length === 0 && dayChasses.length === 0 && dayAffaitages.length === 0 && daySessions.length === 0) {
        html += '<p style="color: #666; font-style: italic;">Aucune activité enregistrée ce jour.</p>';
    } else {
        html += '<div class="stats-grid">';
        
        html += '<div class="stat-card">';
        html += '<h3>📝 Entrées de suivi</h3>';
        html += '<div class="value">' + dayEntries.length + '</div>';
        html += '</div>';
        
        html += '<div class="stat-card">';
        html += '<h3>🏹 Sorties de chasse</h3>';
        html += '<div class="value">' + dayChasses.length + '</div>';
        html += '</div>';
        
        html += '<div class="stat-card">';
        html += '<h3>🦅 Sessions d\'affaitage</h3>';
        html += '<div class="value">' + dayAffaitages.length + '</div>';
        html += '</div>';
        
        html += '<div class="stat-card">';
        html += '<h3>🎯 Sessions de leurre</h3>';
        html += '<div class="value">' + daySessions.length + '</div>';
        html += '</div>';
        
        html += '</div>';
    }
    
    html += '</div>';
    return html;
}

function showBirdStats() {
    var html = '<h3>📊 Statistiques complètes par oiseau</h3>';
    
    if (rapaces.length === 0) {
        html += '<p style="color: #666; font-style: italic;">Aucun rapace enregistré.</p>';
        document.getElementById('stats-content').innerHTML = html;
        return;
    }
    
    for (var i = 0; i < rapaces.length; i++) {
        var rapace = rapaces[i];
        var birdEntries = entries.filter(e => e.rapaceId === rapace.id);
        var birdChasses = chasseEntries.filter(c => c.rapaceId === rapace.id);
        var birdAffaitages = affaitageEntries.filter(a => a.rapaceId === rapace.id);
        var birdSessions = sessionsLeurre.filter(s => s.rapaceId === rapace.id);
        
        html += '<div class="day-card" style="margin: 20px 0; background: linear-gradient(135deg, #f8f9fa 0%, #e3f2fd 100%);">';
        html += '<h4 style="color: #1e3c72; margin-bottom: 20px; font-size: 1.8em; text-align: center; border-bottom: 2px solid #2a5298; padding-bottom: 10px;">';
        
        if (rapace.photo) {
            html += '<img src="' + rapace.photo + '" style="width: 60px; height: 60px; object-fit: cover; border-radius: 50%; margin-right: 15px; vertical-align: middle;">';
        }
        
        html += '🦅 ' + rapace.name + ' (' + rapace.species + ')';
        
        if (rapace.bague) {
            html += '<br><small style="font-size: 0.7em; color: #666;">Bague: ' + rapace.bague + '</small>';
        }
        
        html += '</h4>';
        
        var totalEntries = birdEntries.length;
        var totalChasses = birdChasses.length;
        var totalAffaitages = birdAffaitages.length;
        var totalSessions = birdSessions.length;
        
        html += '<div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">';
        html += '<h5 style="color: #1e3c72; margin-bottom: 15px; font-size: 1.3em;">📈 Résumé</h5>';
        html += '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">';
        
        html += '<div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #28a745, #20c997); color: white; border-radius: 10px;">';
        html += '<div style="font-size: 2em; font-weight: bold;">' + totalEntries + '</div>';
        html += '<div style="font-size: 0.9em;">Entrées totales</div>';
        html += '</div>';
        
        html += '<div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #dc3545, #c82333); color: white; border-radius: 10px;">';
        html += '<div style="font-size: 2em; font-weight: bold;">' + totalChasses + '</div>';
        html += '<div style="font-size: 0.9em;">Chasses</div>';
        html += '</div>';
        
        html += '<div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #6f42c1, #563d7c); color: white; border-radius: 10px;">';
        html += '<div style="font-size: 2em; font-weight: bold;">' + totalAffaitages + '</div>';
        html += '<div style="font-size: 0.9em;">Affaitages</div>';
        html += '</div>';
        
        html += '<div style="text-align: center; padding: 15px; background: linear-gradient(135deg, #ffc107, #e0a800); color: #212529; border-radius: 10px;">';
        html += '<div style="font-size: 2em; font-weight: bold;">' + totalSessions + '</div>';
        html += '<div style="font-size: 0.9em;">Sessions leurre</div>';
        html += '</div>';
        
        html += '</div>';
        html += '</div>';
        html += '</div>';
    }
    
    document.getElementById('stats-content').innerHTML = html;
}

function showWeightGraphs() {
    var html = '<h3>📈 Courbes de poids (7 derniers jours)</h3>';
    
    if (rapaces.length === 0) {
        html += '<p style="color: #666; font-style: italic;">Aucun rapace enregistré.</p>';
        document.getElementById('stats-content').innerHTML = html;
        return;
    }
    
    for (var i = 0; i < rapaces.length; i++) {
        var rapace = rapaces[i];
        html += generateWeightGraph(rapace);
    }
    
    document.getElementById('stats-content').innerHTML = html;
}

function generateWeightGraph(rapace) {
    var html = '<div class="day-card" style="margin: 15px 0;">';
    html += '<h4 style="color: #1e3c72; margin-bottom: 15px;">📈 ' + rapace.name + '</h4>';
    
    var weightData = [];
    var today = new Date();
    
    for (var d = 6; d >= 0; d--) {
        var checkDate = new Date(today);
        checkDate.setDate(checkDate.getDate() - d);
        var dateStr = checkDate.toISOString().split('T')[0];
        
        var dayEntries = entries.filter(e => 
            e.rapaceId === rapace.id && 
            e.date === dateStr && 
            e.type === 'nourriture' && 
            e.poidsApres
        );
        
        var weight = null;
        if (dayEntries.length > 0) {
            var lastEntry = dayEntries[dayEntries.length - 1];
            weight = parseFloat(lastEntry.poidsApres);
        }
        
        weightData.push({
            date: checkDate.toLocaleDateString('fr-FR', { month: 'short', day: 'numeric' }),
            weight: weight
        });
    }
    
    html += '<div style="background: #f8f9fa; padding: 20px; border-radius: 8px; font-family: monospace; font-size: 12px; overflow-x: auto;">';
    
    var hasData = weightData.some(d => d.weight !== null);
    
    if (!hasData) {
        html += '<p style="color: #666; font-style: italic; font-family: Arial;">Aucune donnée de poids disponible sur les 7 derniers jours.</p>';
    } else {
        html += '<p style="color: #666; font-family: Arial;">Graphique simplifié des poids récents</p>';
        
        for (var x = 0; x < weightData.length; x++) {
            var dataPoint = weightData[x];
            if (dataPoint.weight !== null) {
                html += dataPoint.date + ': ' + dataPoint.weight + 'g<br>';
            } else {
                html += dataPoint.date + ': -<br>';
            }
        }
        
        if (rapace.poidsChasse || rapace.poidsVol || rapace.poidsPlein) {
            html += '<div style="font-family: Arial; font-size: 12px; margin-top: 10px;">';
            html += '<strong>Poids de référence:</strong> ';
            if (rapace.poidsChasse) html += '🎯 Chasse: ' + rapace.poidsChasse + 'g ';
            if (rapace.poidsVol) html += '🕊️ Vol: ' + rapace.poidsVol + 'g ';
            if (rapace.poidsPlein) html += '🍖 Plein: ' + rapace.poidsPlein + 'g';
            html += '</div>';
        }
    }
    
    html += '</div>';
    html += '</div>';
    
    return html;
}

function exportAllData() {
    var data = {
        rapaces: rapaces,
        entries: entries,
        chasseEntries: chasseEntries,
        affaitageEntries: affaitageEntries,
        leurres: leurres,
        sessionsLeurre: sessionsLeurre,
        documents: documents,
        currentLocation: currentLocation,
        exportDate: new Date().toISOString(),
        version: "2.0"
    };
    
    var dataStr = JSON.stringify(data, null, 2);
    var dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    var link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = 'rapaces_data_' + new Date().toISOString().split('T')[0] + '.json';
    link.click();
}

function importAllData() {
    var input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    input.onchange = function(e) {
        var file = e.target.files[0];
        if (!file) return;
        
        var reader = new FileReader();
        reader.onload = function(e) {
            try {
                var data = JSON.parse(e.target.result);
                
                if (data.rapaces && Array.isArray(data.rapaces)) {
                    if (confirm('Cette action va remplacer toutes vos données actuelles. Continuer ?')) {
                        rapaces = data.rapaces || [];
                        entries = data.entries || [];
                        chasseEntries = data.chasseEntries || [];
                        affaitageEntries = data.affaitageEntries || [];
                        leurres = data.leurres || [];
                        sessionsLeurre = data.sessionsLeurre || [];
                        documents = data.documents || [];
                        currentLocation = data.currentLocation || currentLocation;
                        
                        saveAllData();
                        updateRapaceList();
                        updateRapaceSelects();
                        updateEntryList();
                        updatechasseList();
                        updateAffaitageList();
                        updateLeurreList();
                        updateSessionsLeurreList();
                        updateDocumentsList();
                        updateLeurreSelects();
                        
                        alert('Données importées avec succès !');
                    }
                } else {
                    alert('Format de fichier invalide.');
                }
            } catch (error) {
                alert('Erreur lors de l\'importation : ' + error.message);
            }
        };
        reader.readAsText(file);
    };
    input.click();
}

function clearAllData() {
    if (confirm('Êtes-vous sûr de vouloir supprimer TOUTES les données ? Cette action est irréversible.')) {
        if (confirm('Dernière confirmation : toutes vos données seront perdues !')) {
            rapaces = [];
            entries = [];
            chasseEntries = [];
            affaitageEntries = [];
            leurres = [];
            sessionsLeurre = [];
            documents = [];
            
            localStorage.removeItem('rapaces_data');
            
            updateRapaceList();
            updateRapaceSelects();
            updateEntryList();
            updatechasseList();
            updateAffaitageList();
            updateLeurreList();
            updateSessionsLeurreList();
            updateDocumentsList();
            updateLeurreSelects();
            
            alert('Toutes les données ont été supprimées.');
        }
    }
}

// === FONCTIONS FIREBASE SIMPLIFIÉES ===
var db = null;
var isFirebaseReady = false;
var firebaseUserId = null;

function initFirebaseSync() {
    alert('Fonctionnalité Firebase en cours de développement');
}

function manualFirebaseSync() {
    alert('Synchronisation Firebase non disponible');
}

function forceUploadToFirebase() {
    alert('Upload Firebase non disponible');
}

function forceDownloadFromFirebase() {
    alert('Download Firebase non disponible');
}

function refreshAllData() {
    loadAllData();
    updateRapaceList();
    updateRapaceSelects();
    updateEntryList();
    updatechasseList();
    updateAffaitageList();
    updateLeurreList();
    updateSessionsLeurreList();
    updateDocumentsList();
    updateLeurreSelects();
    addSyncHistoryEntry('🔄 Données rechargées depuis le stockage local');
}

function disconnectFirebase() {
    alert('Firebase non connecté');
}

function updateSyncUI() {
    var statusEl = document.getElementById('sync-status');
    var detailsEl = document.getElementById('sync-details');
    var lastSyncEl = document.getElementById('last-sync-time');
    
    if (statusEl) {
        statusEl.textContent = '❌ Firebase non connecté';
        statusEl.style.color = 'red';
        detailsEl.textContent = 'Fonctionnalité en développement';
        detailsEl.style.color = '#666';
        lastSyncEl.textContent = 'Dernière sync : Jamais';
    }
}

function addSyncHistoryEntry(message) {
    var now = new Date();
    var timeStr = now.toLocaleTimeString('fr-FR');
    syncHistory.unshift(timeStr + ' - ' + message);
    
    if (syncHistory.length > 10) {
        syncHistory = syncHistory.slice(0, 10);
    }
    
    var historyEl = document.getElementById('sync-history');
    if (historyEl) {
        historyEl.innerHTML = syncHistory.map(entry => 
            '<p style="margin: 5px 0; font-size: 14px;">' + entry + '</p>'
        ).join('');
    }
}

function showMiniNotification(message) {
    var notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #4285f4;
        color: white;
        padding: 10px 15px;
        border-radius: 5px;
        z-index: 10000;
        font-size: 14px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    `;
    notification.textContent = message;
    
    document.body.appendChild(notification);
    
    setTimeout(function() {
        notification.remove();
    }, 3000);
}

// === GESTION DES MODALES ===
window.onclick = function(event) {
    var editModal = document.getElementById('editModal');
    var editAffaitageModal = document.getElementById('editAffaitageModal');
    var photoModal = document.getElementById('photoModal');
    var evenementsModal = document.getElementById('evenementsModal');
    
    if (event.target === editModal) {
        closeEditModal();
    }
    if (event.target === editAffaitageModal) {
        closeEditAffaitageModal();
    }
    if (event.target === photoModal) {
        closePhotoModal();
    }
    if (event.target === evenementsModal) {
        closeEvenementsModal();
    }
}

// === MODALES ===
function showPhotoModal(photoSrc) {
    var modal = document.getElementById('photoModal');
    var modalPhoto = document.getElementById('modal-photo');
    
    modalPhoto.src = photoSrc;
    modal.style.display = 'block';
}

function closePhotoModal() {
    document.getElementById('photoModal').style.display = 'none';
}

// === GESTION DES DONNÉES ===
function saveAllData() {
    try {
        var data = {
            rapaces: rapaces,
            entries: entries,
            chasseEntries: chasseEntries,
            affaitageEntries: affaitageEntries,
            leurres: leurres,
            sessionsLeurre: sessionsLeurre,
            documents: documents,
            currentLocation: currentLocation,
            lastSave: new Date().toISOString()
        };
        localStorage.setItem('rapaces_data', JSON.stringify(data));
        
        if (isFirebaseReady && document.getElementById('sync-on-change-enabled') && document.getElementById('sync-on-change-enabled').checked) {
            syncToFirebase();
        }
    } catch (e) {
        console.error('Erreur sauvegarde:', e);
    }
}

function loadAllData() {
    try {
        var savedData = localStorage.getItem('rapaces_data');
        if (savedData) {
            var data = JSON.parse(savedData);
            rapaces = data.rapaces || [];
            entries = data.entries || [];
            chasseEntries = data.chasseEntries || [];
            affaitageEntries = data.affaitageEntries || [];
            leurres = data.leurres || [];
            sessionsLeurre = data.sessionsLeurre || [];
            documents = data.documents || [];
            currentLocation = data.currentLocation || "Orthez (64300)";
            return true;
        }
    } catch (e) {
        console.error('Erreur chargement:', e);
    }
    return false;
}

// === INITIALISATION DE L'APPLICATION ===
function initApp() {
    loadAllData();
    
    updateRapaceList();
    updateRapaceSelects();
    updateEntryList();
    updatechasseList();
    updateAffaitageList();
    updateLeurreList();
    updateSessionsLeurreList();
    updateDocumentsList();
    updateLeurreSelects();
    
    var today = new Date().toISOString().split('T')[0];
    var now = new Date().toTimeString().split(' ')[0].substring(0, 5);
    
    var eventDateEl = document.getElementById('event-date');
    var eventTimeEl = document.getElementById('event-time');
    var chasseDateEl = document.getElementById('chasse-date');
    var chasseTimeEl = document.getElementById('chasse-time');
    var affaitageeDateEl = document.getElementById('affaitage-date');
    var affaitageTimeEl = document.getElementById('affaitage-time');
    var sessionDateEl = document.getElementById('session-date');
    var sessionTimeEl = document.getElementById('session-time');
    var docDateEl = document.getElementById('doc-date');
    var statsDateEl = document.getElementById('stats-date');
    
    if (eventDateEl) eventDateEl.value = today;
    if (eventTimeEl) eventTimeEl.value = now;
    if (chasseDateEl) chasseDateEl.value = today;
    if (chasseTimeEl) chasseTimeEl.value = now;
    if (affaitageeDateEl) affaitageeDateEl.value = today;
    if (affaitageTimeEl) affaitageTimeEl.value = now;
    if (sessionDateEl) sessionDateEl.value = today;
    if (sessionTimeEl) sessionTimeEl.value = now;
    if (docDateEl) docDateEl.value = today;
    if (statsDateEl) statsDateEl.value = today;
    
    loadWeather();
    showEventFields();
    updateStats();
    updatePoidsChaseReference();
    updateSyncUI();
}

document.addEventListener('DOMContentLoaded', function() {
    initApp();
});
</script>

<!-- === SAFE PATCH: Fauconniers minimal + selecteurs (août 2025) === -->
<script>
(function(){
  // --- Utils ---
  function onReady(fn){
    if (document.readyState === 'interactive' || document.readyState === 'complete') fn();
    else document.addEventListener('DOMContentLoaded', fn);
  }

  // --- Data (ne touche pas à saveAllData/loadAllData si ça n'existe pas) ---
  window.fauconniers = window.fauconniers || [];
  function persist(){
    try { if (typeof window.saveAllData === 'function') window.saveAllData(); } catch(e){ console.warn(e); }
  }

  // --- UI: bouton flottant + modale très simple ---
  function ensureFloatingUI(){
    if (document.getElementById('btn-fc-float')) return;
    var b = document.createElement('button');
    b.id = 'btn-fc-float';
    b.type = 'button';
    b.textContent = '👤 Fauconniers';
    Object.assign(b.style, { position:'fixed', right:'12px', bottom:'12px', zIndex:99999, padding:'10px 14px', borderRadius:'999px' });
    document.body.appendChild(b);
    b.addEventListener('click', openModal);

    var m = document.createElement('div');
    m.id = 'fc-modal';
    Object.assign(m.style, { position:'fixed', inset:'0', background:'rgba(0,0,0,0.35)', display:'none', zIndex:100000 });
    m.innerHTML = '<div style="max-width:520px;margin:8vh auto;background:#fff;border-radius:12px;padding:16px;">'
                + '<div style="display:flex;justify-content:space-between;align-items:center;">'
                + '<h3 style="margin:0">👤 Fauconniers</h3><button id="fc-close" type="button">✖</button></div>'
                + '<div class="form-row" style="margin-top:10px;gap:8px;"><input type="text" id="fc-name" placeholder="Nom (ex: Philippe)" style="flex:1">'
                + '<button id="fc-add" type="button">Ajouter</button></div>'
                + '<div id="fc-list" style="margin-top:12px;max-height:40vh;overflow:auto;"></div>'
                + '</div>';
    document.body.appendChild(m);
    m.addEventListener('click', e=>{ if(e.target===m) closeModal(); });
    m.querySelector('#fc-close').addEventListener('click', closeModal);
    m.querySelector('#fc-add').addEventListener('click', function(){
      var nom = (document.getElementById('fc-name').value||'').trim();
      if(!nom){ alert('Saisis un nom'); return; }
      window.fauconniers.push({ id: Date.now(), nom });
      document.getElementById('fc-name').value='';
      renderList();
      refreshSelectors();
      persist();
    });
  }

  function openModal(){ renderList(); document.getElementById('fc-modal').style.display='block'; }
  function closeModal(){ var m=document.getElementById('fc-modal'); if(m) m.style.display='none'; }
  function renderList(){
    var box = document.getElementById('fc-list'); if (!box) return;
    var arr = window.fauconniers||[];
    if (!arr.length){ box.innerHTML = '<p style="color:#666">Aucun fauconnier.</p>'; return; }
    var html = '<ul style="list-style:none;margin:0;padding:0">';
    arr.forEach(f=>{
      html += '<li style="display:flex;justify-content:space-between;align-items:center;padding:6px 4px;border-bottom:1px dashed #eee;">'
           +  '<span>'+f.nom+'</span>'
           +  '<button type="button" onclick="(function(id){ window.fauconniers = (window.fauconniers||[]).filter(x=>x.id!==id); ('
           +  'document.getElementById(\\'fc-list\\')&&('
           +  'document.getElementById(\\'fc-list\\').innerHTML=\'\'); );'
           +  '})( '+f.id+' )">Supprimer</button>'
           +  '</li>';
    });
    html += '</ul>';
    box.innerHTML = html;
  }

  // --- Sélecteurs (Suivi + Affaitage) : créés si absents ---
  function ensureSelector(sectionId, selectId, label){
    var sec = document.getElementById(sectionId);
    if (!sec || document.getElementById(selectId)) return;
    var grp = document.createElement('div');
    grp.className = 'form-group';
    grp.innerHTML = '<label for="'+selectId+'">'+label+' :</label>'
                  + '<select id="'+selectId+'"><option value="">Choisir</option></select>';
    sec.insertBefore(grp, sec.firstChild);
  }

  function refreshSelectors(){
    ['suivi-fauconnier','affaitage-fauconnier'].forEach(function(id){
      var sel = document.getElementById(id);
      if (!sel) return;
      var keep = sel.value;
      sel.innerHTML = '<option value="">Choisir</option>' + (window.fauconniers||[]).map(f=>'<option value="'+f.id+'">'+f.nom+'</option>').join('');
      if (keep) sel.value = keep;
    });
  }

  // --- Hooks très prudents (seulement si fonctions existent) ---
  function hookAddEntry(){
    if (typeof window.addEntry !== 'function') return; // Suivi
    if (window.__safe_hooked_addEntry) return;
    window.__safe_hooked_addEntry = true;
    var _orig = window.addEntry;
    window.addEntry = function(){
      var before = (window.entries||[]).length;
      var res; try { res = _orig.apply(this, arguments); } catch(e){ console.warn(e); }
      try {
        if ((window.entries||[]).length > before){
          var last = window.entries[window.entries.length-1];
          var fsel = document.getElementById('suivi-fauconnier');
          var fid = fsel && fsel.value ? parseInt(fsel.value) : null;
          last.fauconnierId = fid || null;
          persist();
          if (typeof window.updateEntryList==='function') window.updateEntryList();
        }
      } catch(e){}
      return res;
    };
  }

  function hookAddAffaitage(){
    if (typeof window.addAffaitage !== 'function') return;
    if (window.__safe_hooked_addAff) return;
    window.__safe_hooked_addAff = true;
    var _orig = window.addAffaitage;
    window.addAffaitage = function(){
      var before = (window.affaitageEntries||[]).length;
      var res; try { res = _orig.apply(this, arguments); } catch(e){ console.warn(e); }
      try {
        if ((window.affaitageEntries||[]).length > before){
          var last = window.affaitageEntries[window.affaitageEntries.length-1];
          var fsel = document.getElementById('affaitage-fauconnier');
          var fid = fsel && fsel.value ? parseInt(fsel.value) : null;
          last.fauconnierId = fid || null;
          persist();
          if (typeof window.updateAffaitageList==='function') window.updateAffaitageList();
        }
      } catch(e){}
      return res;
    };
  }

  // --- Minimal init ---
  onReady(function(){
    ensureFloatingUI();
    ensureSelector('suivi', 'suivi-fauconnier', 'Fauconnier');
    ensureSelector('affaitage', 'affaitage-fauconnier', 'Fauconnier');
    refreshSelectors();
    hookAddEntry();
    hookAddAffaitage();
  });

  // En cas de SPA/DOM tardif : retenter quelques fois
  var tries = 0;
  var id = setInterval(function(){
    tries++;
    try {
      ensureFloatingUI();
      ensureSelector('suivi', 'suivi-fauconnier', 'Fauconnier');
      ensureSelector('affaitage', 'affaitage-fauconnier', 'Fauconnier');
      refreshSelectors();
      hookAddEntry();
      hookAddAffaitage();
      if (tries >= 10) clearInterval(id);
    } catch(e){ if (tries >= 10) clearInterval(id); }
  }, 800);
})();
</script>


<!-- === SAFE++ INTEGRATION (août 2025) — intégration directe dans les listes === -->
<script>
(function(){
  function onReady(fn){
    if (document.readyState === 'interactive' || document.readyState === 'complete') fn();
    else document.addEventListener('DOMContentLoaded', fn);
  }

  // Helpers
  function getFauconnierName(id){
    var f = (window.fauconniers||[]).find(x=>x.id===id);
    return f ? f.nom : null;
  }
  function parseTempFromWeather(w){
    if (!w) return null;
    var m = /([+-]?[0-9]+(?:\.[0-9]+)?)\s*°C/.exec(w);
    return m ? (m[1] + '°C') : null;
  }
  function sessionStartDateFor(rapaceId, untilDateTime){
    var arr = (window.affaitageEntries||[]).filter(a=>a.rapaceId===rapaceId);
    if (!arr.length) return null;
    arr.sort((a,b)=> new Date(a.date+'T'+a.time) - new Date(b.date+'T'+b.time));
    var start = null;
    for (var i=0;i<arr.length;i++){
      var dt = new Date(arr[i].date+'T'+arr[i].time);
      if (untilDateTime && dt > untilDateTime) break;
      if (!start) start = dt;
      if (arr[i].repriseAffaitage) start = dt;
      if (arr[i].finAffaitage) start = null;
    }
    return start;
  }
  function ensureSearch(sectionId, listId){
    var sec = document.getElementById(sectionId);
    var list = document.getElementById(listId);
    if (!sec || !list || document.getElementById('search-'+sectionId)) return;
    var box = document.createElement('div');
    box.className = 'form-group';
    box.innerHTML = '<label>🔎 Rechercher :</label><input type="text" id="search-'+sectionId+'" placeholder="Filtrer le texte visible...">';
    sec.insertBefore(box, sec.firstChild);
    box.querySelector('input').addEventListener('input', function(){
      var q = (this.value||'').toLowerCase();
      Array.from(list.querySelectorAll('.entry-item')).forEach(function(it){
        it.style.display = (it.textContent||'').toLowerCase().indexOf(q)>=0 ? '' : 'none';
      });
    });
  }
  function exportCSV(filename, rows){
    var csv = rows.map(r=>r.map(v=>{
      v = v==null ? '' : (''+v).replace(/"/g,'""');
      return /[",\n;]/.test(v)?('"'+v+'"'):v;
    }).join(';')).join('\n');
    var blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    var a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 3000);
  }
  function ensureExport(sectionId, btnId, buildRows, filename){
    var sec = document.getElementById(sectionId);
    if (!sec || document.getElementById(btnId)) return;
    var btn = document.createElement('button');
    btn.id = btnId;
    btn.type = 'button';
    btn.textContent = 'Exporter CSV';
    btn.style.margin = '6px 0';
    sec.insertBefore(btn, sec.firstChild);
    btn.addEventListener('click', function(){ exportCSV(filename, buildRows()); });
  }

  // Build rows for exports
  function buildAffRows(){
    var rid = document.getElementById('affaitage-rapace') && document.getElementById('affaitage-rapace').value ? parseInt(document.getElementById('affaitage-rapace').value) : null;
    var arr = (window.affaitageEntries||[]).slice();
    if (rid) arr = arr.filter(a=>a.rapaceId===rid);
    arr.sort((a,b)=> new Date(a.date+'T'+a.time) - new Date(b.date+'T'+b.time));
    var rows = [['Date','Heure','Rapace','Jour','Température','Poids(g)','Activités','Événement','Fauconnier','Notes']];
    arr.forEach(a=>{
      var dt = new Date(a.date+'T'+a.time);
      var start = sessionStartDateFor(a.rapaceId, dt);
      var jour = start ? (Math.floor((dt-start)/(1000*60*60*24))+1) : '';
      var temp = a.temperature || parseTempFromWeather(a.weather) || '';
      var acts = ['priseNourriture','voliere','gant','filiere','bloc','libre'].filter(k=>a[k]).join(',');
      var f = a.fauconnierId ? (getFauconnierName(a.fauconnierId)||'') : '';
      var rapName = (window.rapaces||[]).find(r=>r.id===a.rapaceId); rapName = rapName ? (rapName.name||rapName.nom||'#'+a.rapaceId) : ('#'+a.rapaceId);
      rows.push([a.date,a.time,rapName,jour,temp,(a.poids||''),acts,(a.evenementMarquant||''),f,(a.notes||'')]);
    });
    return rows;
  }
  function buildSuiviRows(){
    var rid = document.getElementById('rapace-select') && document.getElementById('rapace-select').value ? parseInt(document.getElementById('rapace-select').value) : null;
    var arr = (window.entries||[]).slice();
    if (rid) arr = arr.filter(e=>e.rapaceId===rid);
    arr.sort((a,b)=> new Date(a.date+'T'+a.time) - new Date(b.date+'T'+b.time));
    var rows = [['Date','Heure','Rapace','Poids(g)','Alimentation','Santé','Fauconnier','Notes']];
    arr.forEach(e=>{
      var f = e.fauconnierId ? (getFauconnierName(e.fauconnierId)||'') : '';
      var rapName = (window.rapaces||[]).find(r=>r.id===e.rapaceId); rapName = rapName ? (rapName.name||rapName.nom||'#'+e.rapaceId) : ('#'+e.rapaceId);
      rows.push([e.date,e.time,rapName,e.poids||'',e.alimentation||'',e.sante||'',f,e.notes||'']);
    });
    return rows;
  }
  function buildChasseRows(){
    var rid = document.getElementById('chasse-rapace') && document.getElementById('chasse-rapace').value ? parseInt(document.getElementById('chasse-rapace').value) : null;
    var arr = (window.chasseEntries||[]).slice();
    if (rid) arr = arr.filter(c=>c.rapaceId===rid);
    arr.sort((a,b)=> new Date(a.date+'T'+a.time) - new Date(b.date+'T'+b.time));
    var rows = [['Date','Heure','Rapace','Poids jour(g)','Prises','Total','Fauconnier','Notes']];
    arr.forEach(c=>{
      var prises = ['faisan','perdrix','lapin','lievre','canard','oie','autre'].map(k=> (c[k]||0)?(k+':'+c[k]):null).filter(Boolean).join(', ');
      var total = (c.faisan||0)+(c.perdrix||0)+(c.lapin||0)+(c.lievre||0)+(c.canard||0)+(c.oie||0)+(c.autre||0);
      var f = c.fauconnierId ? (getFauconnierName(c.fauconnierId)||'') : '';
      var rapName = (window.rapaces||[]).find(r=>r.id===c.rapaceId); rapName = rapName ? (rapName.name||rapName.nom||'#'+c.rapaceId) : ('#'+c.rapaceId);
      rows.push([c.date,c.time,rapName,c.poidsJour||'',prises,total,f,c.notes||'']);
    });
    return rows;
  }

  // Decorators for lists (non-intrusive)
  function decorateAffaitageList(){
    var list = document.getElementById('affaitage-list');
    if (!list) return;
    var items = Array.from(list.querySelectorAll('.entry-item'));
    if (!items.length) return;

    // Build the dataset in the same (likely) order: newest first
    var rid = document.getElementById('affaitage-rapace') && document.getElementById('affaitage-rapace').value ? parseInt(document.getElementById('affaitage-rapace').value) : null;
    var arr = (window.affaitageEntries||[]).slice();
    if (rid) arr = arr.filter(a=>a.rapaceId===rid);
    arr.sort((a,b)=> new Date(b.date+'T'+b.time) - new Date(a.date+'T'+a.time));

    items.forEach(function(node, idx){
      var a = arr[idx]; if (!a) return;

      // Add temperature + fauconnier + jour badge inside the content block
      var content = node.querySelector('.content') || node;
      if (a && content && !content.__affaitageDecorated){
        // Jour N
        var dt = new Date(a.date+'T'+a.time);
        var start = sessionStartDateFor(a.rapaceId, dt);
        if (start){
          var d = Math.floor((dt-start)/(1000*60*60*24)) + 1;
          // Insert near date header if found, else at top of content
          var dateEl = node.querySelector('.date');
          var badge = document.createElement('span');
          badge.className = 'session-status';
          badge.style.cssText = 'background:#e3f2fd;color:#1e3c72;border:1px solid #2a5298;margin-left:6px;padding:2px 6px;border-radius:10px;font-size:12px;';
          badge.textContent = 'Jour '+d;
          if (dateEl && !dateEl.textContent.includes('Jour ')) dateEl.appendChild(badge);
        }

        // Température
        var temp = a.temperature || parseTempFromWeather(a.weather);
        if (temp && content.innerHTML.indexOf('🌡️ Température:') === -1){
          var p = document.createElement('div');
          p.innerHTML = '<strong>🌡️ Température:</strong> '+temp;
          content.insertBefore(p, content.firstChild);
        }
        // Fauconnier
        if (a.fauconnierId && content.innerHTML.indexOf('👤 Fauconnier:') === -1){
          var fName = getFauconnierName(a.fauconnierId) || 'Fauconnier supprimé';
          var fdiv = document.createElement('div');
          fdiv.innerHTML = '<strong>👤 Fauconnier:</strong> '+fName;
          content.appendChild(fdiv);
        }
        // Bouton Photo +
        var actions = node.querySelector('.entry-actions') || node;
        if (actions && !actions.querySelector('.btn-photo-plus')){
          var b = document.createElement('button');
          b.className = 'btn-warning btn-photo-plus';
          b.type = 'button';
          b.textContent = '📷 Photo +';
          b.style.marginLeft = '6px';
          b.addEventListener('click', function(){
            var input = document.createElement('input');
            input.type = 'file'; input.accept='image/*';
            input.onchange = function(ev){
              var f = ev.target.files && ev.target.files[0]; if (!f) return;
              var r = new FileReader();
              r.onload = function(e){
                a.photo = e.target.result;
                if (typeof window.saveAllData === 'function') window.saveAllData();
                // show preview if there's a photo container
                var existingImg = node.querySelector('img');
                if (!existingImg){
                  var pc = document.createElement('div');
                  pc.className = 'photo-container';
                  var img = document.createElement('img');
                  img.className = 'affaitage-photo';
                  img.src = a.photo;
                  pc.appendChild(img);
                  node.insertBefore(pc, node.firstChild);
                } else {
                  existingImg.src = a.photo;
                }
              };
              r.readAsDataURL(f);
            };
            input.click();
          });
          actions.appendChild(b);
        }

        content.__affaitageDecorated = true;
      }
    });
  }

  function decorateSuiviList(){
    var list = document.getElementById('entry-list');
    if (!list) return;
    var items = Array.from(list.querySelectorAll('.entry-item .content'));
    if (!items.length) return;
    // Sort data newest first and if rapace selected, filter to match
    var rid = document.getElementById('rapace-select') && document.getElementById('rapace-select').value ? parseInt(document.getElementById('rapace-select').value) : null;
    var arr = (window.entries||[]).slice();
    if (rid) arr = arr.filter(e=>e.rapaceId===rid);
    arr.sort((a,b)=> new Date(b.date+'T'+b.time) - new Date(a.date+'T'+a.time));
    items.forEach(function(content, idx){
      var e = arr[idx]; if (!e) return;
      if (e.fauconnierId && content.innerHTML.indexOf('👤 Fauconnier:') === -1){
        var fName = getFauconnierName(e.fauconnierId) || 'Fauconnier supprimé';
        var div = document.createElement('div');
        div.innerHTML = '<strong>👤 Fauconnier:</strong> '+fName;
        content.appendChild(div);
      }
    });
  }

  function decorateChasseList(){
    var list = document.getElementById('chasse-list');
    if (!list) return;
    var items = Array.from(list.querySelectorAll('.entry-item .content'));
    if (!items.length) return;
    var rid = document.getElementById('chasse-rapace') && document.getElementById('chasse-rapace').value ? parseInt(document.getElementById('chasse-rapace').value) : null;
    var arr = (window.chasseEntries||[]).slice();
    if (rid) arr = arr.filter(c=>c.rapaceId===rid);
    arr.sort((a,b)=> new Date(b.date+'T'+b.time) - new Date(a.date+'T'+a.time));
    items.forEach(function(content, idx){
      var c = arr[idx]; if (!c) return;
      if (c.fauconnierId && content.innerHTML.indexOf('👤 Fauconnier:') === -1){
        var fName = getFauconnierName(c.fauconnierId) || 'Fauconnier supprimé';
        var div = document.createElement('div');
        div.innerHTML = '<strong>👤 Fauconnier:</strong> '+fName;
        content.appendChild(div);
      }
    });
  }

  // Patch update functions (call original then decorate)
  function hookUpdate(fnName, decorator){
    if (typeof window[fnName] !== 'function') return;
    if (window['__hooked_'+fnName]) return;
    window['__hooked_'+fnName] = true;
    var orig = window[fnName];
    window[fnName] = function(){
      var res; try { res = orig.apply(this, arguments); } catch(e){ console.warn(e); }
      try { decorator(); } catch(e){ console.warn('decorate error '+fnName, e); }
      return res;
    };
  }

  function ensureWeightPrefill(){
    var affSel = document.getElementById('affaitage-rapace');
    var poidsInput = document.getElementById('affaitage-poids');
    function prefill(){
      if (!affSel || !poidsInput) return;
      if (poidsInput.value) return;
      var rid = parseInt(affSel.value||'0'); if (!rid) return;
      var list = (window.affaitageEntries||[]).filter(a=>a.rapaceId===rid && a.poids!=null);
      list.sort((a,b)=> new Date(b.date+'T'+b.time) - new Date(a.date+'T'+a.time));
      var val = null;
      if (list.length) val = list[0].poids;
      else {
        var R = (window.rapaces||[]).find(r=>r.id===rid);
        val = (R && (R.poidsVol || R.poidsChasse || R.poidsPlein)) || null;
      }
      if (val!=null) poidsInput.value = val;
    }
    if (affSel) affSel.addEventListener('change', prefill);
    prefill();
  }

  onReady(function(){
    // Search + Export
    ensureSearch('affaitage','affaitage-list');
    ensureSearch('suivi','entry-list');
    ensureSearch('historique','entry-list'); // fallback si ton id de section est "historique"
    ensureSearch('chasse','chasse-list');
    ensureExport('affaitage','btn-export-aff','buildAffRows','affaitage.csv');
    ensureExport('suivi','btn-export-suivi','buildSuiviRows','suivi.csv');
    ensureExport('historique','btn-export-suivi2','buildSuiviRows','suivi.csv');
    ensureExport('chasse','btn-export-chasse','buildChasseRows','chasse.csv');

    // Hook update renderers
    hookUpdate('updateAffaitageList', decorateAffaitageList);
    hookUpdate('updateEntryList', decorateSuiviList);
    hookUpdate('updatechasseList', decorateChasseList);

    // Run once on load in case lists are already rendered
    setTimeout(function(){
      try { decorateAffaitageList(); } catch(e){}
      try { decorateSuiviList(); } catch(e){}
      try { decorateChasseList(); } catch(e){}
    }, 600);

    // Weight prefill
    ensureWeightPrefill();
  });
})();
</script>


<!-- === FALCONNIER FIX PACK (garantie création + sélection) === -->
<script>
(function(){
  // --- Persistance robuste (fallback localStorage dédié) ---
  function loadFauconniers(){
    try {
      if (Array.isArray(window.fauconniers) && window.fauconniers.length) return window.fauconniers;
      var raw = localStorage.getItem('rapaces_fauconniers');
      var arr = raw ? JSON.parse(raw) : [];
      window.fauconniers = Array.isArray(window.fauconniers) ? window.fauconniers : [];
      if (arr && arr.length && window.fauconniers.length===0) window.fauconniers = arr;
      return window.fauconniers;
    } catch(e){ return (window.fauconniers = window.fauconniers||[]); }
  }
  function saveFauconniers(){
    try { localStorage.setItem('rapaces_fauconniers', JSON.stringify(window.fauconniers||[])); } catch(e){}
    try { if (typeof window.saveAllData==='function') window.saveAllData(); } catch(e){}
  }

  // --- UI: bouton flottant + modale ---
  function ensureFloatingUI(){
    if (document.getElementById('btn-fc-float')) return;
    var b = document.createElement('button');
    b.id = 'btn-fc-float'; b.type = 'button'; b.textContent = '👤 Fauconniers';
    Object.assign(b.style, { position:'fixed', right:'12px', bottom:'12px', zIndex:99999, padding:'10px 14px', borderRadius:'999px', boxShadow:'0 4px 12px rgba(0,0,0,0.15)' });
    document.body.appendChild(b);
    b.addEventListener('click', openModal);

    if (!document.getElementById('fc-modal')){
      var m = document.createElement('div'); m.id='fc-modal';
      Object.assign(m.style, { position:'fixed', inset:'0', background:'rgba(0,0,0,0.35)', display:'none', zIndex:100000 });
      m.innerHTML = '<div style="max-width:520px;margin:8vh auto;background:#fff;border-radius:12px;padding:16px;">'
                  +   '<div style="display:flex;justify-content:space-between;align-items:center;">'
                  +     '<h3 style="margin:0">👤 Fauconniers</h3><button id="fc-close" type="button">✖</button>'
                  +   '</div>'
                  +   '<div class="form-row" style="margin-top:10px;gap:8px;">'
                  +     '<input type="text" id="fc-name" placeholder="Nom (ex: Philippe)" style="flex:1">'
                  +     '<button id="fc-add" type="button">Ajouter</button>'
                  +   '</div>'
                  +   '<div id="fc-list" style="margin-top:12px;max-height:40vh;overflow:auto;border:1px solid #eee;border-radius:8px;padding:8px;"></div>'
                  + '</div>';
      document.body.appendChild(m);
      m.addEventListener('click', e=>{ if (e.target===m) closeModal(); });
      m.querySelector('#fc-close').addEventListener('click', closeModal);
      m.querySelector('#fc-add').addEventListener('click', function(){
        var nom = (document.getElementById('fc-name').value||'').trim();
        if (!nom){ alert('Saisis un nom'); return; }
        loadFauconniers();
        window.fauconniers.push({ id: Date.now(), nom });
        document.getElementById('fc-name').value='';
        saveFauconniers();
        refreshSelectors();
        renderList();
      });
    }
  }
  function openModal(){ renderList(); document.getElementById('fc-modal').style.display='block'; }
  function closeModal(){ var m=document.getElementById('fc-modal'); if (m) m.style.display='none'; }
  function renderList(){
    var box = document.getElementById('fc-list'); if (!box) return;
    var arr = loadFauconniers();
    if (!arr.length){ box.innerHTML = '<p style="color:#666">Aucun fauconnier.</p>'; return; }
    var html = '<ul style="list-style:none;margin:0;padding:0">';
    arr.forEach(f=>{
      html += '<li style="display:flex;justify-content:space-between;align-items:center;padding:6px 4px;border-bottom:1px dashed #eee;">'
           +  '<span>'+f.nom+'</span>'
           +  '<button type="button" onclick="(function(id){ window.fauconniers = (window.fauconniers||[]).filter(x=>x.id!==id); ('
           +  'function(){ try{ localStorage.setItem(\\'rapaces_fauconniers\\', JSON.stringify(window.fauconniers)); }catch(e){} } )();'
           +  '(function(){ try{ if (typeof window.saveAllData===\\'function\\') window.saveAllData(); }catch(e){} })();'
           +  'var selIds=[\\'suivi-fauconnier\\',\\'affaitage-fauconnier\\',\\'chasse-fauconnier\\',\\'session-fauconnier\\'];'
           +  'selIds.forEach(function(sid){ var s=document.getElementById(sid); if(s){ var v=s.value; var opts=(window.fauconniers||[]).map(function(f){return \'<option value=\"\'+f.id+\'\">\'+f.nom+\'</option>\';}).join(\\\'\\\'); s.innerHTML=\'<option value=\"\">Choisir</option>\'+opts; if (v && s.querySelector(\\\'option[value=\"\\\'+v+\\\'\"]\\\')) s.value=v; }});'
           +  'renderList(); })( '+f.id+' )">Supprimer</button>'
           +  '</li>';
    });
    html += '</ul>';
    box.innerHTML = html;
  }

  // --- Sélecteurs garantis + synchronisation ---
  function ensureSelector(sectionIds, selectId, label){
    var sec = null;
    sectionIds.forEach(function(sid){ if (!sec) sec = document.getElementById(sid); });
    if (!sec || document.getElementById(selectId)) return;
    var grp = document.createElement('div');
    grp.className = 'form-group';
    grp.innerHTML = '<label for="'+selectId+'">'+label+' :</label>'
                  + '<select id="'+selectId+'"><option value="">Choisir</option></select>';
    sec.insertBefore(grp, sec.firstChild);
  }
  function refreshSelectors(){
    loadFauconniers();
    var opts = (window.fauconniers||[]).map(f=>'<option value="'+f.id+'">'+f.nom+'</option>').join('');
    ['suivi-fauconnier','affaitage-fauconnier','chasse-fauconnier','session-fauconnier'].forEach(function(id){
      var sel = document.getElementById(id);
      if (!sel) return;
      var keep = sel.value;
      sel.innerHTML = '<option value="">Choisir</option>'+opts;
      if (keep && sel.querySelector('option[value="'+keep+'"]')) sel.value = keep;
      sel.disabled = false;
    });
  }

  // --- Association à l'enregistrement (hooks + fallback boutons) ---
  function hookAdd(fnName, selectId, entriesArrayName){
    if (typeof window[fnName] !== 'function') return;
    if (window['__hooked_'+fnName+'_fc']) return;
    window['__hooked_'+fnName+'_fc'] = true;
    var orig = window[fnName];
    window[fnName] = function(){
      var before = (window[entriesArrayName]||[]).length;
      var res; try { res = orig.apply(this, arguments); } catch(e){ console.warn(e); }
      try {
        var arr = window[entriesArrayName] || [];
        if (arr.length > before){
          var last = arr[arr.length-1];
          var sel = document.getElementById(selectId);
          var fid = sel && sel.value ? parseInt(sel.value) : null;
          last.fauconnierId = fid || null;
          try { if (typeof window.saveAllData==='function') window.saveAllData(); } catch(e){}
          var upd = (fnName==='addAffaitage'?'updateAffaitageList':(fnName==='addEntry'?'updateEntryList':(fnName==='addChasse'?'updatechasseList':null)));
          if (upd && typeof window[upd]==='function') window[upd]();
        }
      } catch(e){}
      return res;
    };
  }
  function fallbackButton(sectionId, selectId, entriesArrayName){
    var sec = document.getElementById(sectionId);
    if (!sec) return;
    var btn = Array.from(sec.querySelectorAll('button')).find(b=>/ajouter|enregistrer|add/i.test(b.textContent||''));
    if (!btn || btn.__fc_bound) return;
    btn.__fc_bound = true;
    btn.addEventListener('click', function(){
      setTimeout(function(){
        try {
          var arr = window[entriesArrayName]||[]; if (!arr.length) return;
          var last = arr[arr.length-1];
          var sel = document.getElementById(selectId);
          var fid = sel && sel.value ? parseInt(sel.value) : null;
          if (last && last.fauconnierId == null && fid != null){
            last.fauconnierId = fid;
            try { if (typeof window.saveAllData==='function') window.saveAllData(); } catch(e){}
          }
        } catch(e){}
      }, 300);
    });
  }

  // --- Init ---
  function init(){
    loadFauconniers();
    ensureFloatingUI();
    ensureSelector(['suivi','historique'], 'suivi-fauconnier', 'Fauconnier');
    ensureSelector(['affaitage'], 'affaitage-fauconnier', 'Fauconnier');
    refreshSelectors();
    hookAdd('addEntry','suivi-fauconnier','entries');
    hookAdd('addAffaitage','affaitage-fauconnier','affaitageEntries');
    hookAdd('addChasse','chasse-fauconnier','chasseEntries');
    // fallback si pas de hooks possibles
    fallbackButton('suivi','suivi-fauconnier','entries');
    fallbackButton('historique','suivi-fauconnier','entries');
    fallbackButton('affaitage','affaitage-fauconnier','affaitageEntries');
  }

  if (document.readyState==='complete' || document.readyState==='interactive') init();
  else document.addEventListener('DOMContentLoaded', init);

  // Re-essayer si le DOM bouge
  var tries = 0;
  var id = setInterval(function(){
    tries++;
    try { init(); } catch(e){}
    if (tries > 8) clearInterval(id);
  }, 700);
})();
</script>


<!-- === FALCONNIER CAPTURE BOOST (Affaitage) === -->
<script>
(function(){
  function getSelVal(id){
    var el = document.getElementById(id);
    return el && el.value ? parseInt(el.value) : null;
  }
  function saveLast(fid){
    if (!fid) return;
    try { localStorage.setItem('rapaces_last_fauconnier', String(fid)); } catch(e){}
  }
  function getLast(){
    try { var v = localStorage.getItem('rapaces_last_fauconnier'); return v?parseInt(v):null; } catch(e){ return null; }
  }
  // Ensure selector exists in Affaitage & Suivi (idempotent)
  function ensureSelector(sectionIds, selectId, label){
    var sec = null; sectionIds.forEach(function(id){ if (!sec) sec = document.getElementById(id); });
    if (!sec || document.getElementById(selectId)) return;
    var g = document.createElement('div');
    g.className='form-group';
    g.innerHTML = '<label for="'+selectId+'">'+label+' :</label><select id="'+selectId+'"><option value="">Choisir</option></select>';
    sec.insertBefore(g, sec.firstChild);
  }
  function refreshSelectors(){
    var opts = (window.fauconniers||[]).map(function(f){ return '<option value="'+f.id+'">'+f.nom+'</option>'; }).join('');
    ['affaitage-fauconnier','suivi-fauconnier'].forEach(function(id){
      var sel = document.getElementById(id);
      if (!sel) return;
      var keep = sel.value;
      sel.innerHTML = '<option value="">Choisir</option>'+opts;
      if (keep) sel.value = keep;
      if (!sel.value){ // préselectionner dernier utilisé
        var last = getLast();
        if (last && sel.querySelector('option[value="'+last+'"]')) sel.value = String(last);
      }
    });
  }

  function captureOnAdd(){
    // hook principal
    if (typeof window.addAffaitage === 'function' && !window.__fc_capture_boost){
      window.__fc_capture_boost = true;
      var orig = window.addAffaitage;
      window.addAffaitage = function(){
        var before = (window.affaitageEntries||[]).length;
        var res; try { res = orig.apply(this, arguments); } catch(e){}
        try {
          var arr = window.affaitageEntries||[];
          if (arr.length > before){
            var last = arr[arr.length-1];
            var fid = getSelVal('affaitage-fauconnier') || getSelVal('suivi-fauconnier') || getLast();
            if (fid != null){
              last.fauconnierId = fid;
              saveLast(fid);
              try { if (typeof window.saveAllData==='function') window.saveAllData(); } catch(e){}
              if (typeof window.updateAffaitageList==='function') window.updateAffaitageList();
            }
          }
        } catch(e){}
        return res;
      };
    }

    // fallback si on ne passe pas par addAffaitage()
    ['affaitage','historique','suivi'].forEach(function(sectionId){
      var sec = document.getElementById(sectionId);
      if (!sec) return;
      var btns = sec.querySelectorAll('button');
      btns.forEach(function(b){
        if (b.__fc_capture_boost) return;
        if (!/ajouter|enregistrer|add/i.test(b.textContent||'')) return;
        b.__fc_capture_boost = true;
        b.addEventListener('click', function(){
          setTimeout(function(){
            try {
              var arr = window.affaitageEntries||[]; if (!arr.length) return;
              var last = arr[arr.length-1];
              if (last && last.fauconnierId == null){
                var fid = getSelVal('affaitage-fauconnier') || getSelVal('suivi-fauconnier') || getLast();
                if (fid != null){
                  last.fauconnierId = fid;
                  saveLast(fid);
                  try { if (typeof window.saveAllData==='function') window.saveAllData(); } catch(e){}
                  if (typeof window.updateAffaitageList==='function') window.updateAffaitageList();
                }
              }
            } catch(e){}
          }, 300);
        });
      });
    });
  }

  function decorateAffListOnce(){
    var list = document.getElementById('affaitage-list');
    if (!list) return;
    var items = Array.from(list.querySelectorAll('.entry-item'));
    if (!items.length) return;
    var arr = (window.affaitageEntries||[]).slice().sort(function(a,b){ return new Date(b.date+'T'+b.time) - new Date(a.date+'T'+a.time); });
    items.forEach(function(node, idx){
      var a = arr[idx]; if (!a) return;
      var fName = a.fauconnierId ? ((window.fauconniers||[]).find(function(f){ return f.id===a.fauconnierId; })||{}).nom : null;
      if (fName){
        var content = node.querySelector('.content') || node;
        if (content && content.innerHTML.indexOf('👤 Fauconnier:') === -1){
          var div = document.createElement('div');
          div.innerHTML = '<strong>👤 Fauconnier:</strong> '+fName;
          content.appendChild(div);
        }
      }
    });
  }

  function init(){
    ensureSelector(['affaitage'], 'affaitage-fauconnier', 'Fauconnier');
    ensureSelector(['suivi','historique'], 'suivi-fauconnier', 'Fauconnier');
    refreshSelectors();
    captureOnAdd();
    setTimeout(decorateAffListOnce, 600);
  }

  if (document.readyState==='complete' || document.readyState==='interactive') init();
  else document.addEventListener('DOMContentLoaded', init);

  // re-essayer un peu si DOM late
  var ticks = 0; var timer = setInterval(function(){ ticks++; try{ init(); }catch(e){} if (ticks>6) clearInterval(timer); }, 800);
})();
</script>


<!-- === Fauconnier "+" button beside selectors === -->
<script>
(function(){
  function openFauconniersModal(){
    var btnFloat = document.getElementById('btn-fc-float');
    if (btnFloat) btnFloat.click();
  }
  function injectPlus(selectId){
    var sel = document.getElementById(selectId);
    if (!sel || document.getElementById(selectId+'-plus')) return;
    var btn = document.createElement('button');
    btn.id = selectId+'-plus';
    btn.type = 'button';
    btn.textContent = '+';
    btn.style.marginLeft = '6px';
    btn.style.padding = '2px 6px';
    btn.style.fontSize = '16px';
    btn.addEventListener('click', function(e){
      e.preventDefault();
      openFauconniersModal();
    });
    sel.parentNode.insertBefore(btn, sel.nextSibling);
  }
  function initPlus(){
    injectPlus('affaitage-fauconnier');
    injectPlus('suivi-fauconnier');
  }
  // Retire le bouton flottant
  var floatBtn = document.getElementById('btn-fc-float');
  if (floatBtn) floatBtn.remove();
  if (document.readyState==='complete' || document.readyState==='interactive') initPlus();
  else document.addEventListener('DOMContentLoaded', initPlus);
})();
</script>


<!-- === PLUS BUTTON FIX: self-contained modal + auto-select new fauconnier === -->
<script>
(function(){
  function onReady(fn){
    if (document.readyState === 'interactive' || document.readyState === 'complete') fn();
    else document.addEventListener('DOMContentLoaded', fn);
  }
  function loadF(){
    try {
      if (Array.isArray(window.fauconniers) && window.fauconniers.length) return window.fauconniers;
      var raw = localStorage.getItem('rapaces_fauconniers');
      var arr = raw ? JSON.parse(raw) : [];
      window.fauconniers = Array.isArray(window.fauconniers) ? window.fauconniers : [];
      if (arr && arr.length && window.fauconniers.length===0) window.fauconniers = arr;
      return window.fauconniers;
    } catch(e){ return (window.fauconniers = window.fauconniers||[]); }
  }
  function saveF(){
    try { localStorage.setItem('rapaces_fauconniers', JSON.stringify(window.fauconniers||[])); } catch(e){}
    try { if (typeof window.saveAllData==='function') window.saveAllData(); } catch(e){}
  }
  function refreshSelectors(){
    loadF();
    var opts = (window.fauconniers||[]).map(function(f){ return '<option value="'+f.id+'">'+f.nom+'</option>'; }).join('');
    ['suivi-fauconnier','affaitage-fauconnier','chasse-fauconnier','session-fauconnier'].forEach(function(id){
      var sel = document.getElementById(id);
      if (!sel) return;
      var keep = sel.value;
      sel.innerHTML = '<option value="">Choisir</option>'+opts;
      if (keep && sel.querySelector('option[value="'+keep+'"]')) sel.value = keep;
    });
  }

  function ensureModal(){
    if (document.getElementById('fc-modal-lite')) return;
    var m = document.createElement('div');
    m.id = 'fc-modal-lite';
    Object.assign(m.style, { position:'fixed', inset:'0', background:'rgba(0,0,0,0.35)', display:'none', zIndex:100000 });
    m.innerHTML = '<div style="max-width:520px;margin:8vh auto;background:#fff;border-radius:12px;padding:16px;">'
                +   '<div style="display:flex;justify-content:space-between;align-items:center;">'
                +     '<h3 style="margin:0">👤 Fauconniers</h3><button id="fc-close-lite" type="button">✖</button>'
                +   '</div>'
                +   '<div class="form-row" style="margin-top:10px;gap:8px;">'
                +     '<input type="text" id="fc-name-lite" placeholder="Nom (ex: Philippe)" style="flex:1">'
                +     '<button id="fc-add-lite" type="button">Ajouter</button>'
                +   '</div>'
                +   '<div id="fc-list-lite" style="margin-top:12px;max-height:40vh;overflow:auto;border:1px solid #eee;border-radius:8px;padding:8px;"></div>'
                + '</div>';
    document.body.appendChild(m);
    m.addEventListener('click', function(e){ if (e.target===m) closeModal(); });
    document.getElementById('fc-close-lite').addEventListener('click', closeModal);
    document.getElementById('fc-add-lite').addEventListener('click', function(){
      var nom = (document.getElementById('fc-name-lite').value||'').trim();
      if (!nom){ alert('Saisis un nom'); return; }
      loadF();
      var id = Date.now();
      window.fauconniers.push({ id: id, nom: nom });
      document.getElementById('fc-name-lite').value='';
      saveF();
      refreshSelectors();
      // auto-sélectionner le nouveau dans les selects visibles
      ['affaitage-fauconnier','suivi-fauconnier'].forEach(function(sid){
        var sel = document.getElementById(sid);
        if (sel && sel.querySelector('option[value="'+id+'"]')) sel.value = String(id);
      });
      renderList();
    });
  }
  function openModal(){
    ensureModal();
    renderList();
    document.getElementById('fc-modal-lite').style.display='block';
  }
  function closeModal(){
    var m = document.getElementById('fc-modal-lite');
    if (m) m.style.display='none';
  }
  function renderList(){
    var box = document.getElementById('fc-list-lite'); if (!box) return;
    var arr = loadF();
    if (!arr.length){ box.innerHTML = '<p style="color:#666">Aucun fauconnier.</p>'; return; }
    var html = '<ul style="list-style:none;margin:0;padding:0">';
    arr.forEach(function(f){
      html += '<li style="display:flex;justify-content:space-between;align-items:center;padding:6px 4px;border-bottom:1px dashed #eee;">'
           +  '<span>'+f.nom+'</span>'
           +  '<button type="button" onclick="(function(id){ window.fauconniers=(window.fauconniers||[]).filter(function(x){return x.id!==id;}); '
           +  'try{ localStorage.setItem(\\'rapaces_fauconniers\\', JSON.stringify(window.fauconniers)); }catch(e){} '
           +  'try{ if (typeof window.saveAllData===\\'function\\') window.saveAllData(); }catch(e){} '
           +  '(function(){ var opts=(window.fauconniers||[]).map(function(f){return \'<option value=\"\'+f.id+\'\">\'+f.nom+\'</option>\';}).join(\\\'\\\');'
           +  '[\\'suivi-fauconnier\\',\\'affaitage-fauconnier\\',\\'chasse-fauconnier\\',\\'session-fauconnier\\'].forEach(function(sid){ var s=document.getElementById(sid); if(!s) return; var keep=s.value; s.innerHTML = \'<option value=\"\">Choisir</option>\' + opts; if (keep && s.querySelector(\\\'option[value=\"\\\'+keep+\\\'\"]\\\')) s.value=keep; }); })(); '
           +  'renderList(); })( '+f.id+' )">Supprimer</button>'
           +  '</li>';
    });
    html += '</ul>';
    box.innerHTML = html;
  }

  function injectPlus(selectId){
    var sel = document.getElementById(selectId);
    if (!sel || document.getElementById(selectId+'-plus')) return;
    var btn = document.createElement('button');
    btn.id = selectId+'-plus';
    btn.type = 'button';
    btn.textContent = '+';
    btn.title = 'Ajouter un fauconnier';
    btn.style.marginLeft = '6px';
    btn.style.padding = '2px 6px';
    btn.style.fontSize = '16px';
    btn.addEventListener('click', function(e){
      e.preventDefault();
      openModal();
    });
    sel.parentNode.insertBefore(btn, sel.nextSibling);
  }

  function init(){
    ensureModal();
    injectPlus('affaitage-fauconnier');
    injectPlus('suivi-fauconnier');
    refreshSelectors();
  }

  onReady(init);
  // Retry a few times in case selects appear later
  var n=0, t=setInterval(function(){ n++; try{ init(); }catch(e){} if(n>8) clearInterval(t); }, 700);
})();
</script>


<!-- === PLUS LAZY MODAL CREATION === -->
<script>
(function(){
  function ensureModalLite(){
    if (document.getElementById('fc-modal-lite')) return true;
    var m = document.createElement('div');
    m.id = 'fc-modal-lite';
    Object.assign(m.style, { position:'fixed', inset:'0', background:'rgba(0,0,0,0.35)', display:'none', zIndex:100000 });
    m.innerHTML = '<div style="max-width:520px;margin:8vh auto;background:#fff;border-radius:12px;padding:16px;">'
                +   '<div style="display:flex;justify-content:space-between;align-items:center;">'
                +     '<h3 style="margin:0">👤 Fauconniers</h3><button id="fc-close-lite" type="button">✖</button>'
                +   '</div>'
                +   '<div class="form-row" style="margin-top:10px;gap:8px;">'
                +     '<input type="text" id="fc-name-lite" placeholder="Nom (ex: Philippe)" style="flex:1">'
                +     '<button id="fc-add-lite" type="button">Ajouter</button>'
                +   '</div>'
                +   '<div id="fc-list-lite" style="margin-top:12px;max-height:40vh;overflow:auto;border:1px solid #eee;border-radius:8px;padding:8px;"></div>'
                + '</div>';
    document.body.appendChild(m);
    m.addEventListener('click', function(e){ if (e.target===m) closeModalLite(); });
    document.getElementById('fc-close-lite').addEventListener('click', closeModalLite);
    document.getElementById('fc-add-lite').addEventListener('click', addLite);
    return true;
  }
  function loadF(){
    try { return JSON.parse(localStorage.getItem('rapaces_fauconniers')||'[]'); } catch(e){ return []; }
  }
  function saveF(arr){
    try { localStorage.setItem('rapaces_fauconniers', JSON.stringify(arr)); } catch(e){}
    try { if (typeof window.saveAllData==='function') window.saveAllData(); } catch(e){}
  }
  function openModalLite(){
    ensureModalLite();
    renderListLite();
    document.getElementById('fc-modal-lite').style.display='block';
  }
  function closeModalLite(){
    var m = document.getElementById('fc-modal-lite'); if (m) m.style.display='none';
  }
  function addLite(){
    var nom = (document.getElementById('fc-name-lite').value||'').trim();
    if(!nom){ alert('Saisis un nom'); return; }
    var arr = loadF();
    var id = Date.now();
    arr.push({ id:id, nom:nom });
    saveF(arr);
    // Refresh selectors and auto-select new
    ['affaitage-fauconnier','suivi-fauconnier'].forEach(function(sid){
      var sel = document.getElementById(sid);
      if (!sel) return;
      var opts = arr.map(function(f){ return '<option value="'+f.id+'">'+f.nom+'</option>'; }).join('');
      sel.innerHTML = '<option value="">Choisir</option>'+opts;
      sel.value = String(id);
    });
    document.getElementById('fc-name-lite').value='';
    renderListLite();
  }
  function renderListLite(){
    var box = document.getElementById('fc-list-lite'); if (!box) return;
    var arr = loadF();
    if (!arr.length){ box.innerHTML = '<p style="color:#666">Aucun fauconnier.</p>'; return; }
    var html = '<ul style="list-style:none;margin:0;padding:0">';
    arr.forEach(function(f){
      html += '<li style="display:flex;justify-content:space-between;align-items:center;padding:6px 4px;border-bottom:1px dashed #eee;">'
           +  '<span>'+f.nom+'</span>'
           +  '<button type="button" onclick="(function(id){ var arr='+JSON.stringify(arr)+'.filter(function(x){return x.id!==id;}); '
           +  'localStorage.setItem(\\'rapaces_fauconniers\\', JSON.stringify(arr)); '
           +  '(function(){ var opts=arr.map(function(f){return \'<option value=\"\'+f.id+\'\">\'+f.nom+\'</option>\';}).join(\\\'\\\');'
           +  '[\\'affaitage-fauconnier\\',\\'suivi-fauconnier\\'].forEach(function(sid){ var s=document.getElementById(sid); if(!s) return; var keep=s.value; s.innerHTML = \'<option value=\"\">Choisir</option>\' + opts; if (keep && s.querySelector(\\\'option[value=\"\\\'+keep+\\\'\"]\\\')) s.value=keep; }); })(); '
           +  'document.getElementById(\\'fc-modal-lite\\') && (document.getElementById(\\'fc-list-lite\\').innerHTML = \'\'); })( '+f.id+' )">Supprimer</button>'
           +  '</li>';
    });
    html += '</ul>';
    box.innerHTML = html;
  }

  function bindPlusNow(id){
    var btn = document.getElementById(id);
    if (!btn || btn.__lazyBound) return;
    btn.__lazyBound = true;
    btn.addEventListener('click', function(e){
      e.preventDefault();
      openModalLite();
    });
  }

  // Bind by IDs used earlier
  bindPlusNow('affaitage-fauconnier-plus');
  bindPlusNow('suivi-fauconnier-plus');

  // Also observe DOM in case the plus buttons appear later
  var mo = new MutationObserver(function(){
    bindPlusNow('affaitage-fauconnier-plus');
    bindPlusNow('suivi-fauconnier-plus');
  });
  mo.observe(document.documentElement, { childList:true, subtree:true });
})();
</script>


<!-- === INLINE FAUCONNIER CREATOR (no modal) === -->
<script>
(function(){
  function loadF(){ try { return JSON.parse(localStorage.getItem('rapaces_fauconniers')||'[]'); } catch(e){ return []; } }
  function saveF(arr){ try { localStorage.setItem('rapaces_fauconniers', JSON.stringify(arr)); } catch(e){} try { if (typeof window.saveAllData==='function') window.saveAllData(); } catch(e){} }
  function refreshSelectors(selectIds, autoSelectId){
    var arr = loadF();
    var opts = arr.map(function(f){ return '<option value="'+f.id+'">'+f.nom+'</option>'; }).join('');
    selectIds.forEach(function(id){
      var sel = document.getElementById(id);
      if (!sel) return;
      var keep = sel.value;
      sel.innerHTML = '<option value="">Choisir</option>'+opts;
      if (autoSelectId && sel.querySelector('option[value="'+autoSelectId+'"]')) sel.value = String(autoSelectId);
      else if (keep && sel.querySelector('option[value="'+keep+'"]')) sel.value = keep;
    });
  }
  function makeInlineCreator(selectId){
    var sel = document.getElementById(selectId);
    if (!sel || document.getElementById(selectId+'-inline-wrap')) return;
    var wrap = document.createElement('span');
    wrap.id = selectId+'-inline-wrap';
    wrap.style.marginLeft = '8px';
    wrap.innerHTML = '<button type="button" id="'+selectId+'-show" style="padding:2px 6px;">+ Ajouter</button>'
                   + '<span id="'+selectId+'-box" style="display:none;margin-left:6px;">'
                   +   '<input type="text" id="'+selectId+'-name" placeholder="Nom" style="width:140px;">'
                   +   '<button type="button" id="'+selectId+'-add" style="margin-left:4px;">OK</button>'
                   +   '<button type="button" id="'+selectId+'-cancel" style="margin-left:4px;">Annuler</button>'
                   + '</span>';
    sel.parentNode.insertBefore(wrap, sel.nextSibling);
    var btnShow = document.getElementById(selectId+'-show');
    var box = document.getElementById(selectId+'-box');
    var input = document.getElementById(selectId+'-name');
    var btnAdd = document.getElementById(selectId+'-add');
    var btnCancel = document.getElementById(selectId+'-cancel');

    btnShow.addEventListener('click', function(e){ e.preventDefault(); box.style.display=''; input.focus(); });
    btnCancel.addEventListener('click', function(e){ e.preventDefault(); input.value=''; box.style.display='none'; });
    btnAdd.addEventListener('click', function(e){
      e.preventDefault();
      var nom = (input.value||'').trim();
      if (!nom){ alert('Saisis un nom'); input.focus(); return; }
      var arr = loadF();
      var id = Date.now();
      arr.push({ id:id, nom:nom });
      saveF(arr);
      refreshSelectors(['affaitage-fauconnier','suivi-fauconnier','chasse-fauconnier','session-fauconnier'], id);
      input.value='';
      box.style.display='none';
    });
  }

  function init(){
    makeInlineCreator('affaitage-fauconnier');
    makeInlineCreator('suivi-fauconnier');
    refreshSelectors(['affaitage-fauconnier','suivi-fauconnier','chasse-fauconnier','session-fauconnier']);
  }

  if (document.readyState==='complete' || document.readyState==='interactive') init();
  else document.addEventListener('DOMContentLoaded', init);
  // Retry a few times if selects appear later
  var n=0, t=setInterval(function(){ n++; try{ init(); }catch(e){} if(n>8) clearInterval(t); }, 700);
})();
</script>


<!-- === FAUCONNIER SYNC + NAME SNAPSHOT FIX === -->
<script>
(function(){
  // Keep window.fauconniers <-> localStorage in sync
  function loadFSync(){
    try {
      var raw = localStorage.getItem('rapaces_fauconniers');
      var arr = raw ? JSON.parse(raw) : [];
      if (!Array.isArray(arr)) arr = [];
      window.fauconniers = arr;
      return arr;
    } catch(e){
      window.fauconniers = window.fauconniers || [];
      return window.fauconniers;
    }
  }
  function saveFSync(arr){
    try { localStorage.setItem('rapaces_fauconniers', JSON.stringify(arr)); } catch(e){}
    window.fauconniers = arr.slice();
    try { if (typeof window.saveAllData==='function') window.saveAllData(); } catch(e){}
  }
  function getSelInfo(selectId){
    var sel = document.getElementById(selectId);
    if (!sel) return { id:null, name:null };
    var id = sel.value ? parseInt(sel.value) : null;
    var name = null;
    if (id != null){
      // take label from option text
      var opt = sel.options[sel.selectedIndex];
      if (opt) name = opt.textContent || opt.innerText || null;
    }
    return { id:id, name:name };
  }
  function refreshAllSelectors(autoId){
    var arr = loadFSync();
    var opts = arr.map(function(f){ return '<option value="'+f.id+'">'+f.nom+'</option>'; }).join('');
    ['affaitage-fauconnier','suivi-fauconnier','chasse-fauconnier','session-fauconnier'].forEach(function(id){
      var sel = document.getElementById(id);
      if (!sel) return;
      var keep = sel.value;
      sel.innerHTML = '<option value="">Choisir</option>'+opts;
      if (autoId && sel.querySelector('option[value="'+autoId+'"]')) sel.value = String(autoId);
      else if (keep && sel.querySelector('option[value="'+keep+'"]')) sel.value = keep;
    });
  }

  // Patch inline creator to also sync window.fauconniers
  function patchInlineCreator(){
    ['affaitage-fauconnier','suivi-fauconnier'].forEach(function(selectId){
      var addBtn = document.getElementById(selectId+'-add');
      var input = document.getElementById(selectId+'-name');
      if (addBtn && !addBtn.__patched){
        addBtn.__patched = true;
        var origHandler = addBtn.onclick;
        addBtn.onclick = null;
        addBtn.addEventListener('click', function(e){
          e.preventDefault();
          var nom = (input && input.value || '').trim();
          if (!nom){ alert('Saisis un nom'); if (input) input.focus(); return; }
          var arr = loadFSync();
          var id = Date.now();
          arr.push({ id:id, nom:nom });
          saveFSync(arr);
          refreshAllSelectors(id);
          if (input) input.value='';
          var box = document.getElementById(selectId+'-box'); if (box) box.style.display='none';
        });
      }
    });
  }

  // Capture snapshot on add (Affaitage & Suivi & Chasse)
  function patchAdd(fnName, selectId, arrName, updateFnName){
    if (typeof window[fnName] !== 'function' || window['__snap_'+fnName]) return;
    window['__snap_'+fnName] = true;
    var orig = window[fnName];
    window[fnName] = function(){
      var before = (window[arrName]||[]).length;
      var res; try { res = orig.apply(this, arguments); } catch(e){}
      try {
        var arr = window[arrName]||[];
        if (arr.length > before){
          var last = arr[arr.length-1];
          var info = getSelInfo(selectId);
          if (info.id != null){
            last.fauconnierId = info.id;
            last.fauconnierName = info.name || (function(){
              var f = (window.fauconniers||[]).find(function(x){return x.id===info.id;});
              return f ? f.nom : null;
            })();
            try { if (typeof window.saveAllData==='function') window.saveAllData(); } catch(e){}
            if (typeof window[updateFnName]==='function') window[updateFnName]();
          }
        }
      } catch(e){}
      return res;
    };
  }

  // Rendering decorators: prefer stored name
  function decorateAff(){
    var list = document.getElementById('affaitage-list'); if (!list) return;
    var items = Array.from(list.querySelectorAll('.entry-item'));
    if (!items.length) return;
    var arr = (window.affaitageEntries||[]).slice().sort(function(a,b){ return new Date(b.date+'T'+b.time) - new Date(a.date+'T'+a.time); });
    items.forEach(function(node, idx){
      var a = arr[idx]; if (!a) return;
      var name = a.fauconnierName;
      if (!name && a.fauconnierId){
        var f = (window.fauconniers||[]).find(function(x){ return x.id===a.fauconnierId; });
        name = f ? f.nom : null;
      }
      if (name){
        var content = node.querySelector('.content') || node;
        var line = content.querySelector('.fc-line');
        if (!line){
          line = document.createElement('div'); line.className='fc-line';
          content.appendChild(line);
        }
        line.innerHTML = '<strong>👤 Fauconnier:</strong> '+name;
      }
    });
  }
  function decorateSuivi(){
    var list = document.getElementById('entry-list'); if (!list) return;
    var items = Array.from(list.querySelectorAll('.entry-item .content'));
    if (!items.length) return;
    var arr = (window.entries||[]).slice().sort(function(a,b){ return new Date(b.date+'T'+b.time) - new Date(a.date+'T'+a.time); });
    items.forEach(function(content, idx){
      var e = arr[idx]; if (!e) return;
      var name = e.fauconnierName;
      if (!name && e.fauconnierId){
        var f = (window.fauconniers||[]).find(function(x){ return x.id===e.fauconnierId; });
        name = f ? f.nom : null;
      }
      if (name && content.innerHTML.indexOf('👤 Fauconnier:') === -1){
        var div = document.createElement('div');
        div.innerHTML = '<strong>👤 Fauconnier:</strong> '+name;
        content.appendChild(div);
      }
    });
  }
  function decorateChasse(){
    var list = document.getElementById('chasse-list'); if (!list) return;
    var items = Array.from(list.querySelectorAll('.entry-item .content'));
    if (!items.length) return;
    var arr = (window.chasseEntries||[]).slice().sort(function(a,b){ return new Date(b.date+'T'+b.time) - new Date(a.date+'T'+a.time); });
    items.forEach(function(content, idx){
      var c = arr[idx]; if (!c) return;
      var name = c.fauconnierName;
      if (!name && c.fauconnierId){
        var f = (window.fauconniers||[]).find(function(x){ return x.id===c.fauconnierId; });
        name = f ? f.nom : null;
      }
      if (name && content.innerHTML.indexOf('👤 Fauconnier:') === -1){
        var div = document.createElement('div');
        div.innerHTML = '<strong>👤 Fauconnier:</strong> '+name;
        content.appendChild(div);
      }
    });
  }

  function hookUpdate(fnName, decorator){
    if (typeof window[fnName] !== 'function' || window['__dec_'+fnName]) return;
    window['__dec_'+fnName] = true;
    var orig = window[fnName];
    window[fnName] = function(){
      var res; try { res = orig.apply(this, arguments); } catch(e){}
      try { decorator(); } catch(e){}
      return res;
    };
  }

  function init(){
    // initial sync to ensure lookups work
    loadFSync();
    refreshAllSelectors();
    patchInlineCreator();
    patchAdd('addAffaitage','affaitage-fauconnier','affaitageEntries','updateAffaitageList');
    patchAdd('addEntry','suivi-fauconnier','entries','updateEntryList');
    patchAdd('addChasse','chasse-fauconnier','chasseEntries','updatechasseList');

    // decorate on renders
    hookUpdate('updateAffaitageList', decorateAff);
    hookUpdate('updateEntryList', decorateSuivi);
    hookUpdate('updatechasseList', decorateChasse);
    // first pass
    setTimeout(function(){ try{ decorateAff(); decorateSuivi(); decorateChasse(); }catch(e){} }, 400);
  }

  if (document.readyState==='complete' || document.readyState==='interactive') init();
  else document.addEventListener('DOMContentLoaded', init);
})();
</script>


<!-- === INLINE ADD UX IMPROVEMENTS: prefill, Enter to submit, dedupe === -->
<script>
(function(){
  function loadF(){ try { return JSON.parse(localStorage.getItem('rapaces_fauconniers')||'[]'); } catch(e){ return []; } }
  function saveF(arr){ try { localStorage.setItem('rapaces_fauconniers', JSON.stringify(arr)); } catch(e){} try { if (typeof window.saveAllData==='function') window.saveAllData(); } catch(e){} }
  function refreshSelectors(selectIds, autoId){
    var arr = loadF();
    var opts = arr.map(function(f){ return '<option value="'+f.id+'">'+f.nom+'</option>'; }).join('');
    selectIds.forEach(function(id){
      var sel = document.getElementById(id);
      if (!sel) return;
      var keep = sel.value;
      sel.innerHTML = '<option value="">Choisir</option>'+opts;
      if (autoId && sel.querySelector('option[value="'+autoId+'"]')) sel.value = String(autoId);
      else if (keep && sel.querySelector('option[value="'+keep+'"]')) sel.value = keep;
    });
  }

  function attachEnhancedInline(selectId){
    var sel = document.getElementById(selectId);
    var show = document.getElementById(selectId+'-show');
    var box  = document.getElementById(selectId+'-box');
    var input= document.getElementById(selectId+'-name');
    var add  = document.getElementById(selectId+'-add');
    var cancel=document.getElementById(selectId+'-cancel');
    if (!sel || !show || !box || !input || !add || !cancel) return;
    if (show.__enhanced) return;
    show.__enhanced = true;

    // Prefill with current selection text on open
    show.addEventListener('click', function(){
      try {
        if (sel && sel.selectedIndex > 0){
          var t = sel.options[sel.selectedIndex].textContent || sel.options[sel.selectedIndex].innerText || '';
          input.value = t.trim();
        }
      } catch(e){}
      box.style.display = '';
      setTimeout(function(){ input.focus(); input.select(); }, 10);
    });

    // Enter = OK, Esc = Cancel
    input.addEventListener('keydown', function(ev){
      if (ev.key === 'Enter'){ ev.preventDefault(); add.click(); }
      else if (ev.key === 'Escape'){ ev.preventDefault(); cancel.click(); }
    });

    // Enhanced add: dedupe by name (case-insensitive)
    add.addEventListener('click', function(e){
      e.preventDefault();
      var nom = (input.value||'').trim();
      if (!nom){
        // fallback: use current selection text if any
        try {
          if (sel && sel.selectedIndex > 0){
            nom = (sel.options[sel.selectedIndex].textContent||'').trim();
          }
        } catch(e){}
      }
      if (!nom){ alert('Saisis un nom'); input.focus(); return; }

      var arr = loadF();
      var existing = arr.find(function(f){ return (f.nom||'').toLowerCase() === nom.toLowerCase(); });
      var id;
      if (existing){
        id = existing.id;
      } else {
        id = Date.now();
        arr.push({ id:id, nom:nom });
        saveF(arr);
      }
      refreshSelectors(['affaitage-fauconnier','suivi-fauconnier','chasse-fauconnier','session-fauconnier'], id);
      box.style.display = 'none';
      input.value = '';
    });
  }

  function init(){
    ['affaitage-fauconnier','suivi-fauconnier'].forEach(attachEnhancedInline);
  }
  if (document.readyState==='complete' || document.readyState==='interactive') init();
  else document.addEventListener('DOMContentLoaded', init);

  // Retry binding a few times if DOM is late
  var n=0, t=setInterval(function(){ n++; try{ init(); }catch(e){} if(n>10) clearInterval(t); }, 700);
})();
</script>


<!-- === STRONG OVERRIDE: '+ Ajouter' click handler (capture) === -->
<script>
(function(){
  function loadF(){ try { return JSON.parse(localStorage.getItem('rapaces_fauconniers')||'[]'); } catch(e){ return []; } }
  function saveF(arr){ try { localStorage.setItem('rapaces_fauconniers', JSON.stringify(arr)); } catch(e){} try { if (typeof window.saveAllData==='function') window.saveAllData(); } catch(e){} }
  function refreshSelectors(selectIds, autoId){
    var arr = loadF();
    var opts = arr.map(function(f){ return '<option value="'+f.id+'">'+f.nom+'</option>'; }).join('');
    selectIds.forEach(function(id){
      var sel = document.getElementById(id);
      if (!sel) return;
      var keep = sel.value;
      sel.innerHTML = '<option value="">Choisir</option>'+opts;
      if (autoId && sel.querySelector('option[value="'+autoId+'"]')) sel.value = String(autoId);
      else if (keep && sel.querySelector('option[value="'+keep+'"]')) sel.value = keep;
    });
  }
  function bindCapture(selectId){
    var add = document.getElementById(selectId+'-add');
    var input = document.getElementById(selectId+'-name');
    var sel = document.getElementById(selectId);
    if (!add || add.__captureBound) return;
    add.__captureBound = true;
    add.addEventListener('click', function(e){
      // kill any existing listeners that might show the old alert
      e.preventDefault();
      if (typeof e.stopImmediatePropagation === 'function') e.stopImmediatePropagation();
      e.stopPropagation();

      // compute name
      var nom = (input && input.value || '').trim();
      if (!nom && sel && sel.selectedIndex > 0){
        var t = sel.options[sel.selectedIndex].textContent || sel.options[sel.selectedIndex].innerText || '';
        nom = t.trim();
      }
      if (!nom){
        alert('Saisis un nom');
        try { input && input.focus(); } catch(_){}
        return;
      }
      // dedupe (case-insensitive)
      var arr = loadF();
      var existing = arr.find(function(f){ return (f.nom||'').toLowerCase() === nom.toLowerCase(); });
      var id;
      if (existing){ id = existing.id; }
      else { id = Date.now(); arr.push({ id:id, nom:nom }); saveF(arr); }
      refreshSelectors(['affaitage-fauconnier','suivi-fauconnier','chasse-fauconnier','session-fauconnier'], id);
      var box = document.getElementById(selectId+'-box'); if (box) box.style.display='none';
      if (input) input.value='';
    }, true); // CAPTURE phase
  }
  function init(){
    ['affaitage-fauconnier','suivi-fauconnier'].forEach(bindCapture);
  }
  if (document.readyState==='complete' || document.readyState==='interactive') init();
  else document.addEventListener('DOMContentLoaded', init);
  var n=0, t=setInterval(function(){ n++; try{ init(); }catch(e){} if(n>10) clearInterval(t); }, 600);
})();
</script>


<!-- === FORCE DISPLAY OF STORED FAUCONNIER NAME (replace 'Fauconnier supprimé') === -->
<script>
(function(){
  function fixAffaitageNames(){
    var list = document.getElementById('affaitage-list'); if (!list) return;
    var items = Array.from(list.querySelectorAll('.entry-item'));
    if (!items.length) return;
    var arr = (window.affaitageEntries||[]).slice().sort(function(a,b){ return new Date(b.date+'T'+b.time)-new Date(a.date+'T'+a.time); });
    items.forEach(function(node, idx){
      var a = arr[idx]; if (!a) return;
      var name = a.fauconnierName || null;
      if (!name && a.fauconnierId){
        var f = (window.fauconniers||[]).find(function(x){ return x.id===a.fauconnierId; });
        name = f ? f.nom : null;
      }
      if (!name) return;
      // Find any existing "Fauconnier:" line and normalize it to the correct name
      var content = node.querySelector('.content') || node;
      var lines = Array.from(content.childNodes);
      var found = false;
      lines.forEach(function(n){
        if (n.nodeType===1){
          var txt = n.textContent || '';
          if (txt.trim().toLowerCase().startsWith('fauconnier') || txt.indexOf('👤 Fauconnier:')>=0){
            // replace
            n.innerHTML = '<strong>👤 Fauconnier:</strong> '+name;
            if (found) { try{ n.remove(); }catch(e){} } // remove duplicates
            found = true;
          }
        }
      });
      if (!found){
        var div = document.createElement('div');
        div.innerHTML = '<strong>👤 Fauconnier:</strong> '+name;
        content.appendChild(div);
      }
    });
  }
  function hook(fn){
    if (typeof window[fn] !== 'function' || window['__fix_'+fn]) return;
    window['__fix_'+fn] = true;
    var orig = window[fn];
    window[fn] = function(){
      var res; try { res = orig.apply(this, arguments); } catch(e){}
      try { fixAffaitageNames(); } catch(e){}
      return res;
    };
  }
  function init(){
    hook('updateAffaitageList');
    setTimeout(fixAffaitageNames, 400);
  }
  if (document.readyState==='complete' || document.readyState==='interactive') init();
  else document.addEventListener('DOMContentLoaded', init);
})();
</script>


<!-- === FINAL FEATURES PACK: poids auto, filtre par oiseau, Jour N robuste, photo en édition === -->
<script>
(function(){
  function onReady(fn){
    if (document.readyState === 'interactive' || document.readyState === 'complete') fn();
    else document.addEventListener('DOMContentLoaded', fn);
  }

  // ---------- Poids auto (Affaitage) + fallback si vide à l'enregistrement ----------
  function autoFillWeight(){
    var sel = document.getElementById('affaitage-rapace');
    var input = document.getElementById('affaitage-poids');
    if (!sel || !input) return;
    function compute(){
      var rid = parseInt(sel.value||'0'); if (!rid) return;
      var list = (window.affaitageEntries||[]).filter(a=>a.rapaceId===rid && a.poids!=null);
      list.sort((a,b)=> new Date(b.date+'T'+b.time)-new Date(a.date+'T'+a.time));
      var val = null;
      if (list.length) val = list[0].poids;
      else {
        var R = (window.rapaces||[]).find(r=>r.id===rid);
        val = (R && (R.poidsVol || R.poidsChasse || R.poidsPlein)) || null;
      }
      if (val!=null) input.value = val;
    }
    sel.addEventListener('change', compute);
    // initialise si vide
    if (!input.value) compute();
  }
  function fallbackWeightOnSave(){
    if (typeof window.addAffaitage !== 'function' || window.__fallbackWeightHook) return;
    window.__fallbackWeightHook = true;
    var orig = window.addAffaitage;
    window.addAffaitage = function(){
      // avant l'appel : si vide, pré-remplir une valeur par défaut (sans bloquer l'utilisateur)
      try {
        var sel = document.getElementById('affaitage-rapace');
        var input = document.getElementById('affaitage-poids');
        if (sel && input && !input.value){
          var rid = parseInt(sel.value||'0');
          if (rid){
            var list = (window.affaitageEntries||[]).filter(a=>a.rapaceId===rid && a.poids!=null);
            list.sort((a,b)=> new Date(b.date+'T'+b.time)-new Date(a.date+'T'+a.time));
            var val = null;
            if (list.length) val = list[0].poids;
            else {
              var R = (window.rapaces||[]).find(r=>r.id===rid);
              val = (R && (R.poidsVol || R.poidsChasse || R.poidsPlein)) || null;
            }
            if (val!=null) input.value = val;
          }
        }
      } catch(e){}
      var res; try { res = orig.apply(this, arguments); } catch(e){}
      return res;
    };
  }

  // ---------- Jour N + Filtre par oiseau (Affaitage) ----------
  function sessionStartDateFor(rapaceId, untilDateTime){
    var arr = (window.affaitageEntries||[]).filter(a=>a.rapaceId===rapaceId);
    if (!arr.length) return null;
    arr.sort((a,b)=> new Date(a.date+'T'+a.time) - new Date(b.date+'T'+b.time));
    var start = null;
    for (var i=0;i<arr.length;i++){
      var dt = new Date(arr[i].date+'T'+arr[i].time);
      if (untilDateTime && dt > untilDateTime) break;
      if (!start) start = dt;
      if (arr[i].repriseAffaitage) start = dt;
      if (arr[i].finAffaitage) start = null;
    }
    return start;
  }
  function filterAndDecorateAffList(){
    var list = document.getElementById('affaitage-list'); if (!list) return;
    var ridSel = document.getElementById('affaitage-rapace');
    var rid = ridSel && ridSel.value ? parseInt(ridSel.value) : null;

    // Construire l'ordre des données comme la liste (récents d'abord)
    var arr = (window.affaitageEntries||[]).slice().sort(function(a,b){
      return new Date(b.date+'T'+b.time) - new Date(a.date+'T'+a.time);
    });

    var items = Array.from(list.querySelectorAll('.entry-item'));
    items.forEach(function(node, idx){
      var a = arr[idx]; if (!a) return;
      // Filtre par oiseau
      node.style.display = (!rid || a.rapaceId===rid) ? '' : 'none';
      // Badge Jour N (robuste)
      var dateEl = node.querySelector('.date');
      if (dateEl && !dateEl.__jourDecorated){
        var dt = new Date(a.date+'T'+a.time);
        var start = sessionStartDateFor(a.rapaceId, dt);
        if (start){
          var d = Math.floor((dt-start)/(1000*60*60*24))+1;
          var badge = document.createElement('span');
          badge.className = 'session-status';
          badge.style.cssText = 'background:#e3f2fd;color:#1e3c72;border:1px solid #2a5298;margin-left:6px;padding:2px 6px;border-radius:10px;font-size:12px;';
          badge.textContent = 'Jour '+d;
          dateEl.appendChild(badge);
        }
        dateEl.__jourDecorated = true;
      }
    });
  }
  function hookAffList(){
    if (typeof window.updateAffaitageList !== 'function' || window.__affFilterHook) return;
    window.__affFilterHook = true;
    var orig = window.updateAffaitageList;
    window.updateAffaitageList = function(){
      var res; try { res = orig.apply(this, arguments); } catch(e){}
      try { filterAndDecorateAffList(); } catch(e){}
      return res;
    };
  }

  // ---------- Photo lors de l'édition d'une entrée d'Affaitage ----------
  function injectPhotoIntoEditModal(){
    // Cherche une modale ouverte courante et y ajoute un champ photo si on détecte "affaitage"
    var modal = document.querySelector('.modal, .dialog, .swal2-popup');
    if (!modal) return;
    if (modal.__photoInjected) return;

    // On insère un input file + logique d'enregistrement
    var fileWrap = document.createElement('div');
    fileWrap.style.marginTop = '8px';
    fileWrap.innerHTML = '<label style="display:block;margin-bottom:4px;">📷 Photo :</label>'
                       + '<input type="file" id="aff-edit-photo" accept="image/*">';
    modal.appendChild(fileWrap);
    modal.__photoInjected = true;

    var input = fileWrap.querySelector('#aff-edit-photo');
    input.addEventListener('change', function(ev){
      var f = ev.target.files && ev.target.files[0]; if (!f) return;
      var r = new FileReader();
      r.onload = function(e){
        // Trouver l'entrée en cours d'édition : on prend la plus récente sélectionnée (dernier bouton "modifier" cliqué)
        var idx = window.__lastEditedAffIdx;
        if (idx==null){
          // fallback : rien à faire
          return;
        }
        // retrouver l'entrée correspondante dans l'ordre récent -> ancien
        var arr = (window.affaitageEntries||[]).slice().sort(function(a,b){
          return new Date(b.date+'T'+b.time) - new Date(a.date+'T'+a.time);
        });
        var entry = arr[idx];
        if (!entry) return;
        entry.photo = e.target.result;
        try { if (typeof window.saveAllData==='function') window.saveAllData(); } catch(e){}
        if (typeof window.updateAffaitageList==='function') window.updateAffaitageList();
      };
      r.readAsDataURL(f);
    });
  }
  function listenEditClicks(){
    // Capture les clics sur le bouton "modifier" (jaune) de chaque ligne : mémorise l'index et injecte le champ photo
    document.addEventListener('click', function(e){
      var target = e.target;
      if (!target) return;
      var isEdit = /modifier|edit/i.test(target.textContent||'') || target.classList.contains('btn-warning');
      if (!isEdit) return;
      // Quel item ?
      var item = target.closest('.entry-item');
      if (!item) return;
      var list = document.getElementById('affaitage-list'); if (!list) return;

      var items = Array.from(list.querySelectorAll('.entry-item'));
      var idx = items.indexOf(item);
      if (idx>=0) window.__lastEditedAffIdx = idx;

      // Tente l'injection après un léger délai (le temps que la modale s'ouvre)
      setTimeout(injectPhotoIntoEditModal, 200);
    }, true);
  }

  onReady(function(){
    autoFillWeight();
    fallbackWeightOnSave();
    hookAffList();
    // 1er rendu
    setTimeout(filterAndDecorateAffList, 500);
    var sel = document.getElementById('affaitage-rapace');
    if (sel) sel.addEventListener('change', filterAndDecorateAffList);

    listenEditClicks(); // pour l'édition photo
  });
})();
</script>


<!-- 🔄 Firestore Sync (RAPACE2, ESM) — single-file final -->
<script>
// 0) One-time ID capture from query/hash: ?id=1214  (keeps URL clean after)
(function(){
  try{
    const qp = new URLSearchParams(location.search || location.hash.slice(1));
    const id = qp.get("id");
    if (id) {
      localStorage.setItem("firebaseUserId", id);
      // Clean URL
      if (history && history.replaceState) history.replaceState(null, "", location.pathname);
    }
    const showStatus = qp.get("status") === "1";
    if (showStatus) localStorage.setItem("showSyncBadge","1");
  }catch(e){}
})();
</script>

<style>
  /* Tiny status badge (hidden by default). Show with ?status=1 or localStorage.showSyncBadge="1" */
  #sync-badge {
    position: fixed; right: 10px; bottom: 10px;
    background: #0b1222; color: #e5e7eb;
    border: 1px solid #334155; border-radius: 10px;
    padding: 6px 10px; font: 12px ui-sans-serif, system-ui;
    box-shadow: 0 10px 30px rgba(0,0,0,.3);
    display: none; z-index: 99999;
  }
  #sync-badge b { color: #22c55e }
  #sync-badge .warn { color: #f59e0b }
  #sync-badge .err { color: #ef4444 }
</style>
<div id="sync-badge">🔄 <span id="sync-status" class="warn">init…</span></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

// RAPACE2 config (pré-intégrée)
const firebaseConfig = {
  apiKey: "AIzaSyB8wRYLE0weQn9tlCFV7JfjcJg5pdszz7Hk",
  authDomain: "rapace2-e7641.firebaseapp.com",
  projectId: "rapace2-e7641",
  storageBucket: "rapace2-e7641.firebasestorage.app",
  messagingSenderId: "477211338737",
  appId: "1:477211338737:web:09e4ad761ea0dceca2c650",
  measurementId: "G-BL923V0D14"
};

// Optional tiny badge
const badge = document.getElementById("sync-badge");
const statusEl = document.getElementById("sync-status");
try {
  if (localStorage.getItem("showSyncBadge") === "1") badge.style.display = "inline-flex";
} catch {}

const setStatus = (txt, cls) => {
  if (!statusEl) return;
  statusEl.textContent = txt;
  statusEl.className = cls || "";
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Helpers
const dump = () => {
  const o = {};
  for (let i = 0; i < localStorage.length; i++) {
    const k = localStorage.key(i);
    o[k] = localStorage.getItem(k);
  }
  return o;
};
const restore = (d) => {
  if (!d || typeof d !== "object") return;
  Object.entries(d).forEach(([k, v]) => {
    try { localStorage.setItem(k, v); } catch {}
  });
};
const uid = () => {
  try { return localStorage.getItem("firebaseUserId") || ""; } catch { return ""; }
};
const ts = () => {
  const d = new Date(), p = (n) => String(n).padStart(2,"0");
  return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())}_${p(d.getHours())}-${p(d.getMinutes())}-${p(d.getSeconds())}`;
};
const ref = (id) => doc(db, "users", id);
const bkpCol = (id) => collection(db, "users", id, "backups");

async function uploadNow(){
  const id = uid(); if (!id) { setStatus("ID requis", "warn"); return; }
  const d = dump();
  await setDoc(ref(id), { localStorageDump: d, updatedAt: serverTimestamp() }, { merge: true });
  await setDoc(doc(bkpCol(id), ts()), { dump: d, createdAt: serverTimestamp() });
  setStatus("sync ok", "");
}

async function downloadNow(){
  const id = uid(); if (!id) { setStatus("ID requis", "warn"); return; }
  const snap = await getDoc(ref(id));
  if (snap.exists()) {
    const data = snap.data();
    if (data && data.localStorageDump) restore(data.localStorageDump);
    setStatus("restauré", "");
  } else {
    setStatus("premier upload…", "warn");
  }
}

function startAuto(){
  // immediate upload 30s cadence
  setInterval(() => {
    uploadNow().catch((e)=>{ console.error("[SYNC upload]", e); setStatus("erreur", "err"); });
  }, 30_000);
}

window.addEventListener("DOMContentLoaded", async () => {
  try {
    if (uid()) { await downloadNow(); }
    startAuto();
  } catch (e) {
    console.error("[SYNC bootstrap]", e);
    setStatus("erreur", "err");
  }
});

// React to ID changes (if your app sets it later)
window.addEventListener("storage", (e) => {
  if (e.key === "firebaseUserId" && e.newValue) {
    downloadNow().catch(()=>{});
  }
});

// Expose manual actions for debugging if needed
window.__sync = { uploadNow, downloadNow };
</script>

</body>
</html>